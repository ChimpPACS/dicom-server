{"version":3,"file":"702.bundle.3f0816d0ec0acf54e586.js","mappings":"6YA2BA,MAAM,UAAEA,EAAS,QAAEC,EAAO,cAAEC,GAAkBC,EAAAA,QAY9C,SAASC,EAAeC,GACtB,IAAKA,IAAgBA,EAAYC,OAC/B,MAAO,GAGT,MAAMC,EAAU,GAmBhB,OAjBAF,EAAYG,SAAQC,GAClBF,EAAQG,KAAK,CACXC,iBAAkBX,EAAUS,EAAU,aACtCG,KAAMZ,EAAUS,EAAU,aAC1BI,KAAMb,EAAUS,EAAU,aAC1BK,UAAWd,EAAUS,EAAU,cAAgB,GAC/CM,IAAKf,EAAUS,EAAU,cAAgB,GACzCO,YAAaC,EAAAA,QAAAA,SAAehB,EAAQQ,EAAU,eAAiB,GAC/DS,UAAWC,OAAOnB,EAAUS,EAAU,eAAiB,EACvDW,YAAapB,EAAUS,EAAU,cAAgB,GACjDY,WACErB,EACEE,EAAcO,EAAU,YAAaA,EAAU,eAC5C,OAIJF,CACT,CA2CAe,eAAeC,EACbC,EACAb,EACAc,EACAC,GAOA,aALyBF,EAAeG,iBAAiB,CACvDhB,sBAAkBiB,EAClBC,YAAaH,GAIjB,CAsCA,SAASI,EAAUC,GAAsB,IAAdC,EAAOC,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EACpC,IAAKF,EACH,OAEF,MAAMG,EAAuB,CAC3B,WACA,YAEAC,KAAK,MAED,iBAAEC,GAAqBJ,EACvBK,EAAeC,GACZF,GAAoBE,EAAS,IAAGA,KAAWA,EAG9CC,EAAa,CAEjBC,YAAaH,EAAaN,EAAOf,aAEjC,WAAYqB,EAAaN,EAAOU,WAChCC,gBAAiBL,EAAaN,EAAOY,iBACrCC,iBAAkBP,EAAaN,EAAOc,kBACtCC,kBAAmBf,EAAOgB,kBAE1BC,MAAOjB,EAAOiB,OAAS,IACvBC,OAAQlB,EAAOkB,QAAU,EACzBC,eAAiD,IAAlClB,EAAQmB,sBACvBC,aAAclB,GAIhB,GAAIH,EAAOsB,WAAatB,EAAOuB,QAC7Bf,EAAWgB,UAAa,GAAExB,EAAOsB,aAAatB,EAAOuB,eAChD,GAAIvB,EAAOsB,UAAW,CAC3B,MAAMG,EAAQ,IAAIC,KACZC,EAAKC,OAAOH,EAAMI,WAAWC,SAAS,EAAG,KACzCC,EAAKH,OAAOH,EAAMO,WAAa,GAAGF,SAAS,EAAG,KAE9CG,EAAY,GADLR,EAAMS,gBACQH,IAAKJ,IAEhCnB,EAAWgB,UAAa,GAAExB,EAAOsB,aAAaW,GAChD,MAAO,GAAIjC,EAAOuB,QAAS,CACzB,MAAMY,EAAc,WAEpB3B,EAAWgB,UAAa,GAAEW,KAAcnC,EAAOuB,SACjD,CAGA,GAAIvB,EAAOpB,iBAAkB,CAC3B,IAAIwD,EAAYpC,EAAOpB,iBACvBwD,EAAYC,MAAMC,QAAQF,GAAaA,EAAUhC,OAASgC,EAC1DA,EAAYA,EAAUG,QAAQ,YAAa,MAC3C/B,EAAWgC,iBAAmBJ,CAChC,CAGA,MAAMK,EAAQ,CAAC,EAOf,OANAC,OAAOC,KAAKnC,GAAY/B,SAAQmE,SACN/C,IAApBW,EAAWoC,IAA0C,KAApBpC,EAAWoC,KAC9CH,EAAMG,GAAOpC,EAAWoC,GAC1B,IAGKH,CACT,CCnMe,SAASI,EAAUC,GAK/B,IALgC,SACjCC,EAAQ,MACRC,EAAK,OACLC,EAAM,UACNC,GAAY,GACbJ,EACC,IAAKC,EACH,OAGF,GAAIA,EAASI,IACX,OAAOJ,EAASI,IAGlB,MAAMC,EAAgBF,EAAY,qBAAuB,iBAEzD,GAAKD,EAAOG,IAA4C,YAA1BH,EAAOG,GAUnC,OCXW,SAA0BL,EAAUE,EAAQD,GAEzD,MAAMK,EAtCR,SAAqCN,EAAUE,EAAQD,GACrD,MAAMM,EANR,SAAgCP,EAAUE,GACxC,MAAM,iBAAET,EAAgB,kBAAEe,EAAiB,eAAEC,GAAmBT,EAChE,MAAQ,GAAEE,EAAOQ,oBAAoBjB,YAA2Be,eAA+BC,GACjG,CAGwBE,CAAuBX,EAAUE,GAIvD,MAAQ,GAAEK,YAFVN,EAAQA,GAAS,GAGnB,CAgCcW,CAA4BZ,EAAUE,EAAQD,GAE1D,GAAKK,EAIL,MAAQ,UAASA,GACnB,CDEWO,CAAiBb,EAAUE,EAAQD,GAVuB,CACjE,MAAMa,EAzCV,SAA8BZ,EAAQF,GACpC,MAAM,iBAAEP,EAAgB,kBAAEe,EAAiB,eAAEC,GAAmBT,EAC1D/C,EAAS,GAEfA,EAAOrB,KAAK,oBACZqB,EAAOrB,KAAM,YAAW6D,KACxBxC,EAAOrB,KAAM,aAAY4E,KACzBvD,EAAOrB,KAAM,aAAY6E,KACzBxD,EAAOrB,KAAK,iCACZqB,EAAOrB,KAAK,oBAEZ,MAAMmF,EAAc9D,EAAOI,KAAK,KAEhC,MAAQ,GAAE6C,EAAOc,eAAeD,GAClC,CA2BoBE,CAAqBf,EAAQF,GAE7C,IAAIkB,EAAU,YAAcJ,EAK5B,YAJchE,IAAVmD,IACFiB,GAAW,UAAYjB,GAGlBiB,CACT,CAGF,C,eE/Ce,MAAMC,EASnBC,YACEC,EACAC,GAIA,IAHAC,EAAOpE,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EACXqE,EAAYrE,UAAA3B,OAAA,EAAA2B,UAAA,QAAAL,EACZ2E,EAAYtE,UAAA3B,OAAA,EAAA2B,UAAA,QAAAL,EAEZ4E,KAAKL,OAASA,EACdK,KAAKJ,iBAAmBA,EACxBI,KAAKH,QAAUA,EACfG,KAAKF,aAAeA,EACpBE,KAAKD,aAAeA,CACtB,CAEAjF,iBACE,MAAMmF,QAAoBD,KAAKE,UACzBC,QAAiBH,KAAKI,KAAKH,GAGjC,aAF2BD,KAAKK,QAAQF,EAG1C,CAMArF,iBAAiBwF,GACf,IAAIC,EACJ,IAAK,MAAMC,KAAUF,EACnB,IAEE,GADAC,QAAeC,IACXD,GAAUA,EAAOzG,OACnB,KAEJ,CAAE,MAAO2G,GACP,MAAMA,CACR,CAGF,GAAIH,EAAQI,OAAOC,OAASJ,EAC1B,MAAM,IAAIK,MAAM,iCAGlB,OAAOL,CACT,CAGAzF,mBAAoB,CACpBA,gBAAiB,CACjBA,WAAWmF,GAAc,CACzBnF,cAAcqF,GAAW,ECtDZ,MAAMU,UAAmCpB,EACtDqB,aACE,MAAM,iBAAElB,EAAgB,QAAEC,GAAYG,KAEhCxE,EAAU,CACdoE,qBAGI,kBAAEmB,GAAsBlB,EAK9B,OAJIkB,IACFvF,EAA2B,kBAAIuF,GAG1BvF,CACT,CAKA,cACE,MAAM8E,EAAU,IACV,iBACJV,EACAC,SAAS,kBAAEkB,GAAsB,CAAC,EAAC,OACnCpB,GACEK,KAEAe,GACFT,EAAQpG,KACNyF,EAAOqB,uBAAuBC,KAAKtB,EAAQ,CACzCC,mBACAmB,uBAKNT,EAAQpG,KACNyF,EAAOuB,sBAAsBD,KAAKtB,EAAQ,CAAEC,4BAGvCU,CACT,CAEAxF,WAAWmF,GACT,MAAMK,EAAUN,KAAKmB,aAErB,OADenB,KAAKoB,WAAWd,EAEjC,CAEAxF,cAAcqF,GACZ,OAAOA,CACT,ECxBa,MAAMkB,UAAoC5B,EAIvD,iBACE,MAAM6B,EAAa,IACb,iBACJ1B,EACAC,SAAS,kBAAEkB,GAAsB,CAAC,EAAC,OACnCpB,GACEK,KAEJ,GAAIe,EAAmB,CACrB,MAAMvF,EAAU,CACdoE,mBACAvE,YAAa,CAAEyD,kBAAmBiC,IAEpCO,EAAWpH,KAAKyF,EAAO4B,gBAAgBN,KAAKtB,EAAQnE,GACtD,CAEA8F,EAAWpH,KAAKyF,EAAO4B,gBAAgBN,KAAKtB,EAAQ,CAAEC,4BAE/C0B,CACT,CAEAxG,gBACE,MAAMwG,EAAatB,KAAKwB,gBAClBjB,QAAeP,KAAKoB,WAAWE,GAC/BxB,EAAeE,KAAKF,aACpBC,EAAeC,KAAKD,cAEpB,kBAAE0B,GAAsBC,EAAAA,QAAAA,KAAAA,oBACxBC,EAAcpB,EAAOqB,IAAIH,GAE/B,OAAOI,EAAAA,EAAAA,IACLF,EACA7B,GACEgC,EAAAA,GAAAA,mBAAAA,0BACF/B,EAEJ,CAEAjF,WAAWmF,GACT,MAAM,OAAEN,EAAM,iBAAEC,GAAqBI,KAI/B+B,EAxEV,SACEpC,EACAC,EACAoC,GAEA,OAAO/D,OAAOgE,OAAO,CACnBC,QAAOA,IACEF,EAAsBlI,OAAS,EAExCgB,aACE,MAAMiG,EAAoBiB,EAAsBG,QAChD,OAAOxC,EAAOqB,uBAAuB,CACnCpB,mBACAmB,qBAEJ,GAEJ,CAuD8BqB,CACxBzC,EACAC,EAJyBK,EAAY2B,KAAIS,GAAKA,EAAEvD,qBAQ5CwD,EAAW,GAEjB,KAAOP,EAAkBG,WACvBI,EAASpI,KAAK6H,EAAkBrB,QAGlC,MAAO,CACLT,cACAqC,WAEJ,CAEAxH,cAAauD,GAA4B,IAA3B,YAAE4B,EAAW,SAAEqC,GAAUjE,EACrC,MAAO,CACL4B,cACAqC,WAEJ,ECvEF,QAzBAxH,eACEE,EACAb,EACAoI,GAKA,MAKMC,EAAyB,KAJL,IAAxBD,EACIlB,EACAR,GAGJ7F,EACAb,EAXKsB,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EACCA,UAAA3B,OAAA,EAAA2B,UAAA,QAAAL,EACAK,UAAA3B,OAAA,EAAA2B,UAAA,QAAAL,GAgBZ,aAFmBoH,EAAuBC,UAG5C,EClCMC,EAAa,wBAEbC,EAAwB,IAAIC,IAa3B,SAAS1B,EACdlG,EACA+C,EACAwE,EACA1C,EACAC,EACAC,GAMA,IAAK/E,EACH,MAAM,IAAI4F,MACP,GAAE8B,wDAGP,IAAK3E,EACH,MAAM,IAAI6C,MACP,GAAE8B,0DAKP,GAAIC,EAAsBE,IAAI9E,GAC5B,OAAO4E,EAAsBG,IAAI/E,GAInC,MAAMgF,EAAU,IAAIC,SAAQ,CAACC,EAASC,KACpCC,EACEnI,EACA+C,EACAwE,EACA1C,EACAC,EACAC,GACAqD,MAAK,SAASC,GACdJ,EAAQI,EACV,GAAGH,EAAO,IAMZ,OAFAP,EAAsBW,IAAIvF,EAAkBgF,GAErCA,CACT,CASO,SAASQ,EAA2BxF,GACrC4E,EAAsBE,IAAI9E,IAC5B4E,EAAsBa,OAAOzF,EAEjC,CCnEe,MAAM0F,UAAyBC,EAAAA,IAAAA,eAiB5ChE,YAAYiE,GACVC,MAAMD,GACN3D,KAAK6D,WAAaF,EAAWE,UAC/B,CAQA/I,uBAAuBU,GACrB,IAAKwE,KAAK6D,WAAY,OAAOD,MAAMzI,iBAAiBK,GAEpD,MAAMsI,QAAqBF,MAAMzI,iBAAiBK,IAC5C,YAAEH,GAAgBG,EAExB,IAAKH,EAAa,OAAOyI,EAEzB,MAAMC,EAAc/D,KAAKgE,cAAc3I,GAgBvC,OAfiByI,EAAaG,QAAOC,IACnC,IAAK,MAAM/F,KAAOF,OAAOC,KAAKuF,EAAiBU,iBAC7C,IACGnE,KAAKoE,WACJjG,EACA4F,EACAG,EACAT,EAAiBU,iBAGnB,OAAO,EAGX,OAAO,CAAI,GAGf,CAEArJ,sBAAsBU,GACpB,IAAKwE,KAAK6D,WAAY,OAAOD,MAAMrC,gBAAgB/F,GAEnD,MAAMsI,QAAqBF,MAAMrC,gBAAgB/F,IAC3C,YAAEH,GAAgBG,EACxB,IAAKH,EAAa,OAAOyI,EACzB,MAAMC,EAAc/D,KAAKgE,cAAc3I,GAkBvC,OAhBiByI,EAAaG,QAAOI,IACnC,IAAK,MAAMlG,KAAOF,OAAOC,KAAKuF,EAAiBa,kBAC7C,IACGtE,KAAKoE,WACJjG,EACA4F,EACAM,EACAZ,EAAiBa,kBAGnB,OAAO,EAGX,OAAO,CAAI,GAIf,CAcAC,cAAcC,EAASC,GACrB,GAAI7G,MAAMC,QAAQ2G,GAChB,OAAOA,EAAQE,MAAKC,GAAQ3E,KAAKuE,cAAcI,EAAMF,KAEvD,GAAI7G,MAAMC,QAAQ4G,GAChB,OAAOA,EAAOC,MAAKE,GAAc5E,KAAKuE,cAAcC,EAASI,KAK/D,GAHIH,GAAQI,aACVJ,EAASA,EAAOI,YAEG,iBAAVJ,EAAoB,CAC7B,GAAsB,IAAlBA,EAAO3K,OAAc,OAAO,EAChC,GAAuB,IAAnB0K,EAAQ1K,QAA4B,MAAZ0K,EAAiB,OAAO,EACpD,GAAmB,MAAfA,EAAQ,IAA8C,MAAhCA,EAAQA,EAAQ1K,OAAS,GAEjD,OAAoE,GAA7D2K,EAAOK,QAAQN,EAAQO,UAAU,EAAGP,EAAQ1K,OAAS,IACvD,GAAoC,MAAhC0K,EAAQA,EAAQ1K,OAAS,GAClC,OAAoE,GAA7D2K,EAAOK,QAAQN,EAAQO,UAAU,EAAGP,EAAQ1K,OAAS,IACvD,GAAmB,MAAf0K,EAAQ,GACjB,OACEC,EAAOK,QAAQN,EAAQO,UAAU,MACjCN,EAAO3K,OAAS0K,EAAQ1K,OAAS,CAGvC,CACA,OAAO0K,IAAYC,CACrB,CAGAO,iBAAiBC,EAAOnJ,GACtB,IAAKA,EAAO,OAAO,EACnB,MAAMoJ,EAAOD,EAAMH,QAAQ,KAC3B,IAAc,IAAVI,EAAa,OAAOlF,KAAKuE,cAAcU,EAAOnJ,GAClD,MAAMqJ,EAAQF,EAAMF,UAAU,EAAGG,GAC3BE,EAAMH,EAAMF,UAAUG,EAAO,GACnC,QAASC,GAASrJ,GAASqJ,MAAYC,GAAOtJ,GAASsJ,EACzD,CAWAhB,WAAWjG,EAAa9C,EAAa6I,EAAOmB,GAC1C,MAAMC,EAASD,EAAgBlH,IAAQA,EACvC,IAAK9C,EAAa,OAAO,EACzB,MAAMkK,EAAYlK,EAAY8C,IAAQ9C,EAAYiK,GAClD,IAAKC,EAAW,OAAO,EACvB,MAAMC,EAAYtB,EAAM/F,IAAQ+F,EAAMoB,GACtC,IAAKE,EAAW,OAAO,EACvB,GAAoB,MAAhBA,EAAUC,GACZ,OAAOzF,KAAKgF,iBAAiBO,EAAWC,EAAUE,MAAM,IAE1D,MAAM5J,EAAQ0J,EAAUE,MACxB,OAAO1F,KAAKuE,cAAcgB,EAAWzJ,EACvC,CAGAkI,cAAc3I,GACZ,MAAM0I,EAAc,CAAC,EAIrB,OAHA9F,OAAO0H,QAAQtK,GAAarB,SAAQqE,IAAkB,IAAhBF,EAAKrC,GAAMuC,EAC/C0F,EAAY5F,EAAIyH,eAAiB9J,CAAK,IAEjCiI,CACT,EAlKmBN,EACZU,gBAAkB,CACvB0B,iBAAkB,WAClBC,YAAa,WACb,WAAY,MACZC,iBAAkB,WAClBC,UAAW,WACXC,kBAAmB,WACnBC,gBAAiB,YARAzC,EAWZa,iBAAmB,CACxB6B,kBAAmB,WACnBC,aAAc,WACdC,SAAU,YCRd,MAqDA,EArDqBC,CAAC9H,EAAQjD,KAC5B,MAAM,SAAEyD,EAAQ,WAAEuH,GAAe/H,GAC3B,SACJF,EAAQ,IACRkI,EAAM,YAAW,YACjBC,EAAc,aAAY,YAC1BC,EAAc,YACdH,WAAYI,EAAY,SACtBpL,EACEO,EAAQwC,EAASkI,GACvB,IAAK1K,EAAO,OAEZ,GAAIA,EAAM8K,kBAAmB,OAAO9K,EAAM8K,kBAC1C,GAAI9K,EAAM+K,aAAc,CACtB,MAAMC,EAAOrM,EAAAA,QAAAA,UAAgBqB,EAAM+K,aAAcH,GAEjD,OADA5K,EAAM8K,kBAAoBG,IAAIC,gBAAgBF,GACvChL,EAAM8K,iBACf,CACA,IACGL,IACe,IAAfA,IAA0D,IAAnCA,EAAWzB,QAAQ6B,GAE3C,OAAI7K,EAAMmL,iBACDnL,EAAMmL,mBAAmB7D,MAAK8D,IACnCpL,EAAM8K,kBAAoBG,IAAIC,gBAC5B,IAAIG,KAAK,CAACD,GAAM,CAAEE,KAAMV,KAEnB5K,EAAM8K,0BAGjBS,QAAQC,KAAK,qBAAsBd,EAAK,OAAQlI,GAIlD,MAAM,iBAAEP,EAAgB,kBAAEe,EAAiB,eAAEC,GAAmBT,EAC1DiJ,EACHzL,GAASA,EAAMyL,aACf,UAASzI,eAA+BC,IAAiB0H,IACtDe,GAAyC,IAA9BD,EAAYzC,QAAQ,KAC/B2C,GAAgD,IAApCF,EAAYzC,QAAQ,WAKtC,MAAY,cAAR0B,GAA+B,yBAARA,EACjB,GAAExH,aAAoBjB,YAA2Be,eAA+BC,aAJxFwI,GACCE,EAAY,IAAMD,EAAW,IAAM,KAAQ,UAASd,IAQvC,EC/ClB,SAASgB,EAAe5L,EAAOwC,EAAUqJ,GAIvC,GACG7L,EAAMyL,YAAYK,WAAW,SAC7B9L,EAAMyL,YAAYK,WAAW,MAoBhC,GAA6B,MAAzB9L,EAAMyL,YAAY,IAChBI,EAAe3I,SAAS4I,WAAW,QAAS,CAE9C,MAAMlJ,EAAM,IAAIqI,IAAIY,EAAe3I,UACnClD,EAAMyL,YAAe,GAAE7I,EAAImJ,SAAS/L,EAAMyL,aAC5C,MAvBuD,YAAnDI,EAAeG,aAAaC,mBAC9BjM,EAAMyL,YAAe,GAAEI,EAAe3I,oBAAoBV,EAASP,oBAAoBjC,EAAMyL,cAE1C,WAAnDI,EAAeG,aAAaC,oBAC3BJ,EAAeG,aAAaC,qBAE7BjM,EAAMyL,YAAe,GAAEI,EAAe3I,oBAAoBV,EAASP,2BAA2BO,EAASQ,qBAAqBhD,EAAMyL,cAqBxI,CCzBA,MAAM,oBAAES,EAAmB,UAAEC,GAAcvG,EAAAA,QAAAA,MAErC,kBAAED,EAAiB,oBAAEyG,GAAwBF,EAE7CG,EACJ,qDACIC,EAA4B,oBAC5BC,EAA4B,sBAE5BC,EAAmBC,EAAAA,QAAAA,iBAezB,SAASC,EAAkBb,EAAgBc,GACzC,MAAM,SACJC,EAAQ,SACR1J,EAAQ,oBACRuD,EAAmB,sBACnB5F,EAAqB,iBACrBf,EAAgB,eAChB+M,EAAc,WACd9E,EAAU,WACV0C,GACEoB,EAEEiB,EAAqBC,KAAKC,MAAMD,KAAKE,UAAUpB,IAE/ChE,EAAa,CACjBjF,IAAKgK,EACL7E,aACA0C,aACAyC,QAASP,EAA0BQ,yBACnCC,iBAAkBC,EAAAA,EAAAA,uBAGdC,EAAa,CACjB1K,IAAKM,EACL6E,aACA0C,aACAyC,QAASP,EAA0BQ,yBACnCC,iBAAkBC,EAAAA,EAAAA,uBAKdE,EAAqBxF,EACvB,IAAIJ,EAAiBE,GACrB,IAAID,EAAAA,IAAAA,eAAmBC,GAErB2F,EAAqBzF,EACvB,IAAIJ,EAAiB2F,GACrB,IAAI1F,EAAAA,IAAAA,eAAmB0F,GAErBG,EAAiB,CACrBC,WAAYnL,IAAuB,IAAtB,OAAE9C,EAAM,MAAEkO,GAAOpL,EAC5B,MAAQqL,kBAAmBC,GAA4BpO,EACjDqO,EAAyBnP,EAAAA,QAAAA,WAC7BgP,EAAMI,OAAO,sBAGTH,EACHE,EAAuB9P,QAAU8P,GAClCD,EAKF,OAHED,GAAqB9L,MAAMC,QAAQ6L,GAC/BA,EACA,CAACA,EACwB,EAEjCD,MAAO,CACL1P,QAAS,CACPuB,UAAWA,EAAU2F,OACrBlG,OAAQD,eAAegP,GACrB,MAAMd,EAAUP,EAA0BQ,yBACtCD,IACFK,EAAmBL,QAAUA,GAG/B,MAAM,iBAAE7O,EAAgB,kBAAEc,KAAsB8O,GAC9CzO,EAAUwO,EAAY,CACpBnN,wBACAf,sBACI,CAAC,EAST,OAAOhC,QAPeoQ,EACpBX,EACAjO,EACAA,EACA2O,GAIJ,EACAnQ,eAAgBA,EAAeqH,QAEjCoD,OAAQ,CAENtJ,OAAQD,eAAeX,GACrB,MAAM6O,EAAUP,EAA0BQ,yBACtCD,IACFK,EAAmBL,QAAUA,GAQ/B,OXvEH,SAA8BiB,GACnC,MAAM5F,EAAS,GAkBf,OAhBI4F,GAAcA,EAAWnQ,QAC3BmQ,EAAWjQ,SAAQiQ,GACjB5F,EAAOnK,KAAK,CACVC,iBAAkBX,EAAUyQ,EAAW,aACvChP,kBAAmBzB,EAAUyQ,EAAW,aACxC5D,SAAU7M,EAAUyQ,EAAW,aAC/BC,aAAc1Q,EAAUyQ,EAAW,aACnCE,WAAY1P,EAAAA,QAAAA,WAAiBjB,EAAUyQ,EAAW,cAClDG,mBAAoBzP,OAAOnB,EAAUyQ,EAAW,cAChDrP,YAAapB,EAAUyQ,EAAW,kBAKxCpI,EAAAA,EAAAA,IAAgBwC,GAETA,CACT,CWmDiBgG,OXrBV,SAAuBrP,EAAgB4E,GAG5C,MACMvE,EAAc,CAClBuB,aAF2B,CAAC,WAAY,YAAYjB,KAAK,MAK3D,OAAOX,EAAeuG,gBAAgB,CAAE3B,mBAAkBvE,eAC5D,CWOgCiP,CACpBjB,EACAlP,GAIJ,GAGFO,UAAW,CACTK,OAAQA,CAACZ,EAAkBe,KACzB,MAAM8N,EAAUP,EAA0BQ,yBACtCD,IACFK,EAAmBL,QAAUA,GAG/BgB,EAAAA,UACE5O,EACAiO,EACAlP,EACA,KACAe,EACD,IAIPqP,SAAU,CAYRC,UAAWjP,GACF+K,EAAa,CAAEtH,WAAUuH,cAAchL,GAEhDuM,YAAahN,UAA6C,IAAtC,iBAAEiD,EAAgB,YAAEwJ,GAAakD,EACnD,MAAMjP,EAAU,CACdkP,WAAW,EACXnD,cACAxJ,oBAEF,OAAOsL,EAAmBpC,iBAAiBzL,GAAS4H,MAAKuH,GAC1CA,GAAOA,EAAI,SAAOvP,GAE/B,EAEJiJ,OAAQ,CACNuG,SAAU9P,iBAMC,IANM,iBACfiD,EAAgB,QAChB8B,EAAO,aACPC,EAAY,aACZC,EAAY,aACZ8K,GAAe,GAChBpP,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EACH,MAAMuN,EAAUP,EAA0BQ,yBAK1C,GAJID,IACFM,EAAmBN,QAAUA,IAG1BjL,EACH,MAAM,IAAI6C,MACR,+DAIJ,OAAI2B,EACKgH,EAAeuB,6BACpB/M,EACA8B,EACAC,EACAC,EACA8K,GAIGtB,EAAewB,4BACpBhN,EACA8B,EACAC,EACAC,EACA8K,EAEJ,IAIJG,MAAO,CACLC,MAAOnQ,MAAOoQ,EAASC,KACrB,MAAMnC,EAAUP,EAA0BQ,yBAK1C,GAJID,IACFM,EAAmBN,QAAUA,GAG3BkC,aAAmBE,YAAa,CAClC,MAAM5P,EAAU,CACd6P,SAAU,CAACH,GACXC,iBAGI7B,EAAmBgC,eAAe9P,EAC1C,KAAO,CACL,MAAM+P,EAAO,CACXC,2BACEN,EAAQO,MAAMD,2BAA2B9F,MAC3CgG,wBAAyBR,EAAQS,YACjCC,2BAA4BV,EAAQnM,eACpC8M,kBAAmBxD,EACnBF,yBACAC,6BAGI0D,EAAgB5D,EAAoBqD,GACpCQ,EAAY,IAAI9D,EAAU6D,GAEhCC,EAAUC,KAAO9D,EAAoBgD,GAErC,MAEM1P,EAAU,CACd6P,SAAU,CAHSU,EAAUE,SAI7Bd,iBAGI7B,EAAmBgC,eAAe9P,EAC1C,IAIJuP,4BAA6BjQ,MAC3BiD,EACA8B,EACAC,EACAC,EACA8K,KAEA,MAaMqB,SAVahL,EACjBoI,EACAvL,GAL0B,EAO1B8B,EACAC,EACAC,IAIwC6B,IAAIH,GAExC0K,EAAwB,CAAC,EACzBC,EAAqB,CAAC,EAE5BF,EAA6BlS,SAAQsE,IAC9B6N,EAAsB7N,EAASQ,qBAClCqN,EAAsB7N,EAASQ,mBAAqB,CAClDf,iBAAkBO,EAASP,iBAC3B3B,iBAAkBkC,EAASlC,iBAC3B0C,kBAAmBR,EAASQ,kBAC5BuN,kBAAmB/N,EAAS+N,kBAC5BC,aAAchO,EAASgO,aACvBC,WAAYjO,EAASiO,WACrBZ,YAAarN,EAASqN,YACtBa,aAAclO,EAASkO,aACvBC,SAAUnO,EAASmO,WAIlBL,EAAmB9N,EAASQ,qBAC/BsN,EAAmB9N,EAASQ,mBAAqB,IAGnD,MAAMU,EAAU+J,EAAemD,uBAAuB,CACpDpO,aAGFA,EAASkB,QAAUA,EAEnB8I,EAAiBqE,iBAAiBnN,EAAS,CACzCzB,mBACAe,kBAAmBR,EAASQ,kBAC5BC,eAAgBT,EAASS,iBAG3BqN,EAAmB9N,EAASQ,mBAAmB5E,KAAKoE,EAAS,IAI/D,MAAMsO,EAAiB3O,OAAO4O,OAAOV,GACrCW,EAAAA,QAAAA,kBAAqCF,EAAgB/B,GAErD5M,OAAOC,KAAKkO,GAAoBpS,SAAQ+G,GACtC+L,EAAAA,QAAAA,aACEV,EAAmBrL,GACnB8J,IAEH,EAGHC,6BAA8BhQ,eAC5BiD,EACA8B,EACAC,EACAC,GAEG,IADH8K,EAAYpP,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,IAAAA,UAAA,GAEZ,MAGEwE,YAAakM,EACb7J,SAAUyK,SACF7L,EACRoI,EACAvL,GAP0B,EAS1B8B,EACAC,EACAC,GASIiN,EAAsB1O,IAC1B,MAAMqD,EAAcF,EAAkBnD,GAGtC,OAAKqJ,EAAeG,aAAamF,SAIjChP,OAAOC,KAAKyD,GAAa3H,SAAQmE,IAC/B,MAAMrC,EAAQ6F,EAAYxD,GAItBrC,GAASA,EAAMyL,cAAgBzL,EAAM4J,QAEvC5J,EAAMmL,iBAAmB,KAEvBS,EAAe5L,EAAO6F,EAAagG,GAEnC,MAAMnM,EAAU,CAIdkP,WAAW,EACXnD,YAAazL,EAAMyL,YAKnBxJ,iBAAkB4D,EAAY5D,kBAGhC,OAAOsL,EAAmBpC,iBAAiBzL,GAAS4H,MAAKuH,IAIvD,MAAMuC,EACHvC,aAAe/M,OACd+M,EAAIjG,MAAKyI,GAAeA,GAAaC,mBACvChS,EAEF,OADAU,EAAM4J,MAAQwH,EACPA,CAAG,GACV,EAEN,IAEKvL,GAzCEA,CAyCS,EA4CpBwK,EAAsBnS,SAAQqT,IAC5BA,EAAQtP,iBAAmBA,CAAgB,IAG7C+O,EAAAA,QAAAA,kBAAqCX,EAAuBtB,GAE5D,MAAMyC,EAA0BP,EAAenL,KAAImB,GACjDA,EAAQK,MAAK1I,KA/Cf,SAAwBA,GACtB,MAAM6S,EAAuB7S,EAAUkH,IAAIoL,GAG3CO,EAAqBvT,SAAQ,CAACsE,EAAUkP,KACtClP,EAASU,SAAW2I,EAAe3I,SACnCV,EAASmP,QAAU9F,EAAe8F,QAElC,MAAMjO,EAAU+J,EAAemD,uBAAuB,CACpDpO,aAMFA,EAASkB,QAAUA,EAKnB8I,EAAiBqE,iBAAiBnN,EAAS,CACzCzB,mBACAe,kBAAmBR,EAASQ,kBAC5BC,eAAgBT,EAASS,gBACzB,IAGJ+N,EAAAA,QAAAA,aAAgCS,EAAsB1C,EACxD,CAoBIS,CAAe5Q,EAAU,YAGvBsI,QAAQ0K,IAAIJ,GApBFR,EAAAA,QAAAA,SACZ/O,EACA8M,GAEI8C,UAAW,CAkBrB,EACApK,2BAA0B,EAC1BqK,yBAAyBC,GACvB,MAAMC,EAASD,EAAWC,OACpBC,EAAW,GAEjB,OAAKD,GAILD,EAAWC,OAAO9T,SAAQsE,IACxB,MAAM0P,EAAiB1P,EAAS0P,eAEhC,GAAIA,EAAiB,EACnB,IAAK,IAAIzP,EAAQ,EAAGA,GAASyP,EAAgBzP,IAAS,CACpD,MAAMiB,EAAUQ,KAAK0M,uBAAuB,CAC1CpO,WACAC,UAEFwP,EAAS7T,KAAKsF,EAChB,KACK,CACL,MAAMA,EAAUQ,KAAK0M,uBAAuB,CAAEpO,aAC9CyP,EAAS7T,KAAKsF,EAChB,KAGKuO,GApBEA,CAqBX,EACArB,uBAAsBuB,GAAsB,IAArB,SAAE3P,EAAQ,MAAEC,GAAO0P,EAMxC,OALiB7P,EAAW,CAC1BE,WACAC,QACAC,OAAQmJ,GAGZ,EACAuG,UAASA,IACAtF,GAQX,OAJID,IACFY,EAAerG,OCxgBJ,SAAUlE,GACvB,MAAO,CACLqF,OAAQA,CAACtG,EAAkBe,IAClB,IAAIkE,SAAQ,CAACC,EAASC,KAE3B,MAEMxE,EAAO,GAAEM,aAAoBjB,YAA2Be,wBAExDqP,EAAM,IAAIC,eAChBD,EAAIE,KAAK,OAAQ3P,GAAK,GAKtB2I,QAAQiH,IAAIH,GAEZA,EAAII,mBAAqB,WAEvB,GAAsB,GAAlBJ,EAAIK,WACN,OAAQL,EAAIM,QACV,KAAK,IACHxL,EAAQkL,EAAIO,cAEZ,MACF,KAAK,IACHxL,EAAO,yDAGf,EACAiL,EAAIQ,MAAM,IAIlB,CDse4BC,CAAe5P,IAGlC6P,EAAAA,EAAAA,OAAyBtF,EAClC,C,eEtgBA,MAAMjB,EAAmBwG,EAAAA,QAAAA,QAAAA,iBAEnBC,EAAW,CACf5U,iBAAkB,mBAClB8B,UAAW,aAGb,IAAI+S,EAAS,CACXC,KAAM,IAYR,MAAMC,EAAmBxQ,GAChBsQ,EAAOC,KAAKvK,MAAKyK,GAAYA,EAASzQ,MAAQA,IAGjD0Q,EAAcA,CAACjR,EAAKrC,KACxB,IAAI/B,EAAU,GAQd,OAPAiV,EAAOC,KAAKrN,KAAIuN,IACdA,EAASpV,QAAQ6H,KAAIyN,IACfA,EAAOlR,KAASrC,GAClB/B,EAAQG,KAAKmV,EACf,GACA,IAEGtV,CAAO,EAGhB,SAASuV,EAAmBC,GAC1B,MAAM,KAAEC,EAAI,SAAExQ,GAAauQ,EAErBhG,EAAiB,CACrBC,WAAY1O,UAAkC,IAA3B,OAAES,EAAM,MAAEkO,EAAK,IAAE/K,GAAKL,EAClCK,IAAKA,EAAM+K,EAAM3G,IAAI,QAC1B,IAAIqM,EAAWD,EAAiBxQ,GAKhC,GAAIyQ,EACF,OAAOA,EAASpV,QAAQ6H,KAAIyN,GACnBA,EAAOtR,mBAIlB,MAAM0R,QAAiBC,MAAMhR,GAC7B,IAAI2E,QAAaoM,EAASE,OAE1B,MAAMC,EAAoBvM,EAAKtJ,QAAQ6H,KACrCsC,GAASA,EAAMnG,mBAGjB,IAAIA,EACAe,EAyBJ,OAxBAuE,EAAKtJ,QAAQC,SAAQkK,IACnBnG,EAAmBmG,EAAMnG,iBAEzBmG,EAAMG,OAAOrK,SAAQqK,IACnBvF,EAAoBuF,EAAOvF,kBAE3BuF,EAAO3J,UAAUV,SAAQsE,IACvB,MAAQI,IAAKc,EAASoL,SAAUiF,GAAqBvR,EAGrDgK,EAAiBqE,iBAAiBnN,EAAS,CACzCzB,mBACAe,oBACAC,eAAgB8Q,EAAiB9Q,gBACjC,GACF,GACF,IAGJiQ,EAAOC,KAAK/U,KAAK,CACfwE,MACA3E,QAAS,IAAIsJ,EAAKtJ,WAGb6V,CAAiB,EAE1BnG,MAAO,CACL1P,QAAS,CACPuB,UAAWA,OACXP,OAAQD,UACN,MAAOqD,EAAKrC,GAASmC,OAAO0H,QAAQmK,GAAO,GACrCC,EAAchB,EAAS5Q,GAK7B,OAFgBiR,EAAYW,EAAajU,GAE1B8F,KAAIyN,IACV,CACL/U,UAAW+U,EAAOnT,gBAClB9B,KAAMiV,EAAOtS,UACbnC,YAAayU,EAAOjT,iBACpB1B,UAAW2U,EAAOW,aAClBnV,WAAYwU,EAAOY,WACnB1V,IAAK8U,EAAOa,UACZ1V,YAAa6U,EAAOrT,YACpB7B,iBAAkBkV,EAAOtR,iBACzBiS,aAAcX,EAAOW,aACrB3V,KAAMgV,EAAOc,aAEf,EAEJvW,eAAgBA,KACdyN,QAAQ+I,MAAM,kCAAkC,GAGpD/L,OAAQ,CAENtJ,OAAQA,KACNsM,QAAQ+I,MAAM,iCAAiC,GAGnD1V,UAAW,CACTK,OAAQA,KACNsM,QAAQ+I,MAAM,oCAAoC,IAIxD7F,SAAU,CAcRC,UAAWjP,GACF+K,EAAatH,EAAUzD,GAEhC8I,OAAQ,CACNuG,SAAU,WAIC,IAJA,iBACT7M,EAAgB,aAChB8M,GAAe,EAAK,WACpBwF,GACD5U,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EACH,IAAKsC,EACH,MAAM,IAAI6C,MACR,+DAIJ,MAAMsD,EAAQkL,EAAY,mBAAoBrR,GAAkB,GAChE,IAAIsG,EAGFA,EADEgM,EACOA,EAAWnM,EAAMG,QAEjBH,EAAMG,OAGjB,MAAM8H,EAAwB9H,EAAOzC,KAAIyC,IACvC,MAAMiM,EAAgB,CACpBvS,iBAAkBmG,EAAMnG,oBACrBsG,GAGL,cADOiM,EAAc5V,UACd4V,CAAa,IAQtBxD,EAAAA,QAAAA,kBACEX,EACAtB,GAWF,MAAM0F,EAAiBlM,EAAOvK,OAC9BuK,EAAOrK,SAAQ,CAACqK,EAAQmJ,KACtB,MAAM9S,EAAY2J,EAAO3J,UAAUkH,KAAItD,IACrC,MAAMkS,EAAM,IACPlS,EAASsM,SACZlM,IAAKJ,EAASI,IACdc,QAASlB,EAASI,OACf2F,KACAH,GAIL,cAFOsM,EAAI9V,iBACJ8V,EAAInM,OACJmM,CAAG,IA7Bd,IAAwBjD,IA+BP7S,EA9BfoS,EAAAA,QAAAA,aAAgCS,EAAsB1C,GA+BlD2C,IAAU+C,EAAiB,IAtBjBzD,EAAAA,QAAAA,SACZ/O,EACA8M,GAEI8C,UAAW,EAkBiC,GAEtD,IAGJ3C,MAAO,CACLC,MAAOA,KACL5D,QAAQ+I,MAAM,yBAAyB,GAG3CxC,yBAAyBC,GACvB,MAAMC,EAASD,EAAWC,OACpBC,EAAW,GAEjB,OAAKD,GAILD,EAAWC,OAAO9T,SAAQsE,IACxB,MAAM0P,EAAiB1P,EAAS0P,eAEhC,GAAIA,EAAiB,EACnB,IAAK,IAAIyC,EAAI,EAAGA,EAAIzC,EAAgByC,IAAK,CACvC,MAAMjR,EAAUpB,EAAW,CACzBE,WACAC,MAAOkS,EACPjS,OAAQ+Q,IAEVxB,EAAS7T,KAAKsF,EAChB,KACK,CACL,MAAMA,EAAUpB,EAAW,CAAEE,WAAUE,OAAQ+Q,IAC/CxB,EAAS7T,KAAKsF,EAChB,KAGKuO,GArBEA,CAsBX,EACArB,uBAAsBjC,GAAsB,IAArB,SAAEnM,EAAQ,MAAEC,GAAOkM,EAKxC,OAJiBrM,EAAW,CAC1BE,WACAC,SAGJ,GAEF,OAAOsQ,EAAAA,EAAAA,OAAyBtF,EAClC,CClQA,MAAMjB,EAAmBwG,EAAAA,QAAAA,QAAAA,kBACnB,OAAE4B,GAAW5D,EAAAA,QAEb6D,EAAiB,CACrBC,IAAI,EACJC,KAAK,EACLC,KAAK,GAGDC,EAAe,SAACC,EAAIC,GACxB,OAAID,IAAOC,EADoBxV,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,EAE9BuV,EAAKC,GAAY,EACd,CACT,EAGMZ,EAAaA,CAACa,EAASC,KAC3B,MAAMC,EAAYF,EAAQxW,UAAU,GAC9B2W,EAAYF,EAAQzW,UAAU,GAC9B4W,EAAYF,EAAU3E,SACtB8E,EAAYF,EAAU5E,SAEtB+E,EAASb,EAAeW,GACxBG,EAASd,EAAeY,GAE9B,OAAIC,GAAUC,EAELV,EAAaK,EAAU9E,aAAc+E,EAAU/E,cAEnDkF,GAAWC,EAGTD,GAAU,EAAI,EAFZT,EAAaM,EAAU/E,aAAc8E,EAAU9E,aAElC,EAGxB,SAASoF,EAAoBC,GAC3B,MAAM,KAAEnC,GAASmC,EAEXpI,EAAiB,CACrBC,WAAYnL,IAAuB,IAAtB,OAAE9C,EAAM,MAAEkO,GAAOpL,EAC5B,MAAQqL,kBAAmBC,GAA4BpO,EAGjDmO,EAFyBD,EAAMI,OAAO,sBAGhBF,EACtBiI,EACJlI,GAAqB9L,MAAMC,QAAQ6L,GAC/BA,EACA,CAACA,GAQP,OALAkI,EAAyB5X,SAAQ+D,IAC/B,MAAMmG,EAAQ4I,EAAAA,QAAAA,SAA4B/O,GAC1CmG,EAAMG,OAASH,EAAMG,OAAOwN,KAAKxB,EAAW,IAGvCuB,CAAwB,EAEjCnI,MAAO,CACL1P,QAAS,CACPuB,UAAWA,OACXP,OAAQQ,GACYuR,EAAAA,QAAAA,uBAEDlL,KAAI7D,IACnB,IAAI+T,EAAe,EACnB,MAAMjX,EAAa,IAAIkX,IAIjB7N,EAAQ4I,EAAAA,QAAAA,SAA4B/O,GAC1CmG,EAAMG,OAAOrK,SAAQqT,IACnByE,GAAgBzE,EAAQ3S,UAAUZ,OAClCe,EAAWmX,IAAI3E,EAAQ3S,UAAU,GAAG+R,SAAS,IAI/C,MAAMwF,EAAgB/N,GAAOG,OAAO,IAAI3J,UAAU,GAElD,GAAIuX,EACF,MAAO,CACL3X,UAAW2X,EAAc/V,gBACzB9B,KAAM6X,EAAclV,UACpBnC,YAAaqX,EAAc7V,iBAC3B7B,IAAK0X,EAAc/B,UACnB1V,YAAaC,EAAAA,QAAAA,SAAewX,EAAcjW,aAC1C7B,iBAAkB8X,EAAclU,iBAChC1D,KAAM4X,EAAc9B,UAEpBzV,UAAWoX,EACXjX,WAAY+C,MAAMsU,KAAKrX,GAAYc,KAAK,KACxCqU,aAAc8B,EAElB,IAGJlY,eAAgBA,KACdyN,QAAQ+I,MAAM,mCAAmC,GAGrD/L,OAAQ,CACNtJ,OAAQ6E,GACQkN,EAAAA,QAAAA,SAA4BlN,GAC7ByE,OAAOzC,KAAIyL,IACtB,MAAM4E,EAAgB5E,GAAS3S,UAAU,GACzC,MAAO,CACLP,iBAAkByF,EAClB3E,kBAAmBgX,EAAcnT,kBACjCuH,SAAU4L,EAAcxF,SACxBvC,aAAc+H,EAAc3F,aAC5BnC,WAAY8H,EAAcE,WAC1B/H,mBAAoBiD,EAAQ3S,UAAUZ,OACtCc,YAAaqX,EAAc5F,kBAC5B,KAIP3R,UAAW,CACTK,OAAQA,KACNsM,QAAQ+I,MAAM,qCAAqC,IAIzD7F,SAAU,CACRC,UAAWjP,IACT,MAAM,SAAE+C,EAAQ,IAAEkI,EAAG,YAAEE,GAAgBnL,EAEjCO,EAAQwC,EAASkI,GACvB,GAAI1K,aAAiB8B,OAAS9B,EAAM,aAAcsP,YAChD,OAAOrE,IAAIC,gBACT,IAAIG,KAAK,CAACrL,EAAM,IAAK,CACnBsL,KAAMV,IAGZ,EAEFrC,OAAQ,CACNuG,SAAU9P,iBAA2D,IAApD,iBAAEiD,EAAgB,aAAE8M,GAAe,GAAOpP,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,CAAC,EAC7D,IAAKsC,EACH,MAAM,IAAI6C,MACR,+DAKJ,MAAMsD,EAAQ4I,EAAAA,QAAAA,SACZ/O,EACA8M,GAIFiC,EAAAA,QAAAA,gBAAmC4D,EAAO0B,aAAc,CACtDrU,mBACA8M,iBAGF3G,EAAMG,OAAOrK,SAAQqT,IACnB,MAAM,kBAAEvO,GAAsBuO,EAExBgF,EAAehF,EAAQ3S,UAAU,GAAGsT,eAAiB,EAE3DX,EAAQ3S,UAAUV,SAAQ,CAACsE,EAAUkP,KACnC,MACE9O,IAAKc,EAAO,iBACZzB,EAAgB,kBAChBe,EAAiB,eACjBC,GACET,EAEJA,EAASkB,QAAUA,EAGnB8I,EAAiBqE,iBAAiBnN,EAAS,CACzCzB,mBACAe,oBACAC,iBACAuT,WAAYD,EAAe7E,EAAQ,GACnC,IAGJV,EAAAA,QAAAA,gBAAmC4D,EAAO6B,gBAAiB,CACzDxU,mBACAe,oBACA+L,gBACA,GAEN,IAGJG,MAAO,CACLC,MAAOuH,IACL,MAAMC,EAAa/Q,EAAAA,QAAAA,KAAAA,cAAyB8Q,GAG5C,IAAIE,EAAY3L,IAAIC,gBAAgByL,GACpCE,OAAOC,SAASC,OAAOH,EAAU,GAGrC9E,yBAAyBC,GACvB,MAAMC,EAASD,EAAWC,OACpBC,EAAW,GAEjB,OAAKD,GAILD,EAAWC,OAAO9T,SAAQsE,IACxB,MAAM0P,EAAiB1P,EAAS0P,eAChC,GAAIA,EAAiB,EAEnB,IAAK,IAAIyC,EAAI,EAAGA,GAAKzC,EAAgByC,IAAK,CACxC,MAAMjR,EAAUQ,KAAK0M,uBAAuB,CAC1CpO,WACAC,MAAOkS,IAET1C,EAAS7T,KAAKsF,EAChB,KACK,CACL,MAAMA,EAAUQ,KAAK0M,uBAAuB,CAAEpO,aAC9CyP,EAAS7T,KAAKsF,EAChB,KAGKuO,GApBEA,CAqBX,EACArB,uBAAsBjC,GAAsB,IAArB,SAAEnM,EAAQ,MAAEC,GAAOkM,EACxC,MAAM,iBAAE1M,EAAgB,kBAAEe,EAAiB,eAAEC,GAAmBT,EAOhE,IAAIkB,EANmBsN,EAAAA,QAAAA,YACrB/O,EACAe,EACAC,GAG2BL,IAM7B,YAJctD,IAAVmD,IACFiB,GAAY,UAASjB,KAGhBiB,CACT,EACA+D,6BACE8D,QAAQiH,IAAI,6CACd,GAEF,OAAOO,EAAAA,EAAAA,OAAyBtF,EAClC,CC/OA,SAASuJ,GACPC,EACAC,GAEA,MAAM,KAAExD,GAASuD,EACjB,IAAIE,EAEJ,MAAM1J,EAAiB,CACrBC,WAAY1O,UAA6B,IAAtB,OAAES,EAAM,MAAEkO,GAAOpL,EAC9BuR,EAAoB,GAGxB,MAAMhG,EACJH,EAAM3G,IAAI,sBAAwB2G,EAAM3G,IAAI,qBAC9C,IAAK8G,EACH,MAAM,IAAIhJ,MAAO,wCAAuC4O,MAG1D,MAAM9Q,EAAM+K,EAAM3G,IAAI,OAEtB,IAAKpE,EACH,MAAM,IAAIkC,MAAO,eAAc4O,MAC1B,CACL,MAAMC,QAAiBC,MAAMhR,GAC7B,IAAI2E,QAAaoM,EAASE,OAC1B,IAAKtM,EAAK6P,SAASC,WAAW,GAC5B,MAAM,IAAIvS,MAAM,yCAGlBqS,EAAmBzK,EACjBnF,EAAK6P,QAAQC,SAAS,GACtBH,GAEFpD,EAAoBhG,EAAuBwJ,MAAM,IACnD,CACA,OAAOxD,CAAiB,EAE1BnG,MAAO,CACL1P,QAAS,CACPgB,OAAQQ,GAAU0X,EAAiBxJ,MAAM1P,QAAQgB,OAAOQ,IAE1D8I,OAAQ,CACNtJ,OAAQ,kBAAakY,EAAiBxJ,MAAMpF,OAAOtJ,UAAOU,UAAQ,GAEpEf,UAAW,CACTK,OAAQA,CAACZ,EAAkBe,IACzB+X,EAAiBxJ,MAAM/O,UAAUK,OAC/BZ,EACAe,KAIRqP,SAAU,CACRC,UAAW,kBAAayI,EAAiB1I,SAASC,aAAU/O,UAAQ,EACpE4I,OAAQ,CACNuG,SAAU,kBACRqI,EAAiB1I,SAASlG,OAAOuG,YAASnP,UAAQ,IAGxDuP,MAAO,CACLC,MAAO,kBAAagI,EAAiBjI,SAAMvP,UAAQ,GAErD8H,2BAA4B,kBAC1B0P,EAAiB1P,8BAA2B9H,UAAQ,EACtDmS,yBAA0B,kBACxBqF,EAAiBrF,4BAAyBnS,UAAQ,EACpDiR,uBAAwB,kBACtBuG,EAAiBvG,0BAAuBjR,UAAQ,GAEpD,OAAOoT,EAAAA,EAAAA,OAAyBtF,EAClC,CC5CA,SAzBA,WACE,MAAO,CACL,CACEiG,KAAM,WACNpI,KAAM,SACNiM,iBAAkB7K,GAEpB,CACEgH,KAAM,gBACNpI,KAAM,SACNiM,iBAAkBP,IAEpB,CACEtD,KAAM,YACNpI,KAAM,UACNiM,iBAAkB/D,GAEpB,CACEE,KAAM,aACNpI,KAAM,WACNiM,iBAAkB3B,GAGxB,E,qYChCe,SAAS4B,GAAOjV,GAAsB,IAArB,gBAAEkV,GAAiBlV,EACjD,MAAM,eAAEmV,GAAmBD,EAAgBE,UACpCC,EAAgBC,IAAqBC,EAAAA,GAAAA,UAAS,KAC9CC,EAAaC,IAAkBF,EAAAA,GAAAA,UAAS,CAC7CG,cAAe,GACfC,QAAS,CAAC,EACVC,OAAQ,CAAC,IAoBX,OAhBAC,EAAAA,GAAAA,YAAU,KACR,MAAQC,YAAaC,GAAWZ,EAAea,UAC7Cb,EAAe9C,OAAO4D,mBACtB,IAAMX,EAAkBH,EAAee,iBAAiB,eAElDJ,YAAaK,GAAWhB,EAAea,UAC7Cb,EAAe9C,OAAO+D,yBACtB,IAAMX,EAAe,IAAKN,EAAekB,UAG3C,MAAO,KACLN,IACAI,GAAQ,CACT,GACA,CAAChB,IAGFmB,GAAAA,cAAAA,GAAAA,SAAA,KACGjB,EAAe9R,KAAI,CAACgT,EAASpH,KAC5B,MAAM,GAAEqH,EAAE,UAAEC,EAAS,eAAEC,GAAmBH,EAM1C,IAAII,EAUJ,MAT4B,WAAxBD,EAAe3N,OACjB4N,EAAWnB,EAAYG,QAAQa,IAW/BF,GAAAA,cAAA,OAAKxW,IAAK0W,EAAII,UAAWC,KAAW,SAClCP,GAAAA,cAACG,EAASK,GAAA,CACRN,GAAIA,GACAE,EAAc,CAClBK,OAAQvB,EACRmB,SAAUA,EACVK,cAAeC,GAAQ9B,EAAe+B,kBAAkBD,GACxD/B,gBAAiBA,KAEf,IAKhB,CCxCA,MAAM,mBAAEiC,GAAkB,gBAAEC,GAAe,gBAAEC,IAAoBC,GAAAA,QAEjE,SAASC,GAAYvX,GAaO,IAbN,iBAEpBwX,EAAgB,gBAChBtC,EAAe,eACfuC,EAAc,gBACdC,EAAe,UAEfC,EAAS,iBACTC,EAAgB,WAChBC,EAAa,GAAE,YACfC,EAAc,GAAE,uBAChBC,GAAyB,EAAK,wBAC9BC,GAA0B,GAC3BhY,EACC,MAAOiY,IAAaC,EAAAA,GAAAA,KACdC,GAAWC,EAAAA,GAAAA,MACX7D,GAAW8D,EAAAA,GAAAA,OA6BX,EAAEC,IAAMC,EAAAA,GAAAA,OACR,KAAEC,EAAI,KAAEC,IAASC,EAAAA,GAAAA,OAEhBC,EAAsBC,IAA2BrD,EAAAA,GAAAA,UACtD0C,EAAUU,uBAGN,uBAAEE,GAA2B3D,EAAgBE,UAE7C,kBAAE0D,EAAiB,eAAEC,GAAmBtB,EAIxCuB,EAAc,CAClB,CACEC,MAAOX,EAAE,gBACTY,KAAM,OACNC,QAASA,IACPX,EAAK,CACHY,QAASC,GAAAA,GACTJ,MAAO,oBACPK,aAAc,CAAEC,cAXFC,QAWiBC,YAVnBD,QAalB,CACEP,MAAOX,EAAE,sBACTY,KAAM,WACNC,QAASA,IACPX,EAAK,CACHS,MAAOX,EAAE,yCACTc,QAASM,GAAAA,GACTJ,aAAc,CACZP,eAAgBtB,EAAekC,0BAC7BZ,GAEFD,oBACAzB,gBAAiBA,KACjBF,sBACAC,mBACAwC,SAAUA,KACRC,EAAAA,GAAAA,aACAA,EAAAA,GAAAA,UACApB,GAAM,EAERqB,SAAU1N,IAAqC,IAApC,kBAAE0M,EAAiB,SAAEiB,GAAU3N,EACxCkL,GAAAA,QAAAA,eAAoByC,EAAStc,OAC7Bga,EAAeuC,WAAWlB,GAC1BL,GAAM,EAERwB,QAASA,IAAMxC,EAAeyC,yBAC9BC,cAAeN,EAAAA,QAMrB5B,EAAUmC,MACZpB,EAAYnd,KAAK,CACfod,MAAOX,EAAE,iBACTY,KAAM,YACNC,QAAS1c,UACP0b,EACG,wBAAuBkC,mBAAmB/F,OAAOC,SAAS+F,QAC5D,KAUPzE,EAAAA,GAAAA,YAAU,KACR0E,SAASC,KAAKC,UAAU9G,IAAI,YAC5B4G,SAASC,KAAKC,UAAU9G,IAAI,mBACrB,KACL4G,SAASC,KAAKC,UAAUC,OAAO,YAC/BH,SAASC,KAAKC,UAAUC,OAAO,kBAAkB,IAElD,IAEH,MAAMC,EAAenE,IACnB,MAAMoE,EAAQpD,EAAiBqD,eAAerE,GAE9C,IAAKoE,EACH,MAAM,IAAIrY,MACP,GAAEiU,6HAIP,IAAI4C,EACJ,IAAIwB,IAASA,EAAME,UAGjB,MAAM,IAAIvY,MACP,qCAAoCiU,6EAIzC,OAPE4C,EAAUwB,EAAME,UAOX,CAAEF,QAAOxB,UAAS,EAGrB2B,EAAevE,IACnB,MAAM,QAAE4C,EAAO,MAAEwB,GAAUD,EAAanE,GAExC,MAAO,CACLA,GAAIoE,EAAMpE,GACVwE,SAAUJ,EAAMI,SAChBC,UAAWL,EAAMK,UACjBC,MAAON,EAAMM,MACb/J,KAAMyJ,EAAMzJ,KACZiI,UACD,GAGHvD,EAAAA,GAAAA,YAAU,KACR,MAAM,YAAEC,GAAgB+C,EAAuB7C,UAC7CmF,GAAAA,EAAAA,OAAAA,kBAKA,KACEvC,GAAwB,EAAM,IAIlC,MAAO,KACL9C,GAAa,CACd,GACA,CAAC+C,IAEJ,MASMuC,EAAsBvD,EAAWtU,IAAIwX,GACrCM,EAAuBvD,EAAYvU,IAAIwX,GACvCO,EAAqB3D,EAAUpU,KAXJgY,IAC/B,MAAM,MAAEX,GAAUD,EAAaY,EAAkBC,WAEjD,MAAO,CACLV,UAAWF,EAAME,UACjBW,qBAAsBF,EAAkBE,qBACzC,IAOH,OACEnF,GAAAA,cAAA,WACEA,GAAAA,cAACoF,GAAAA,GAAM,CACL1C,YAAaA,EACb2C,kBAAmB1D,EAAU2D,cAC7BC,oBAlLsBA,KAC1B,MAAM,SAAEC,GAAavH,EACfwH,EAAgBD,EAASrV,QAAQ,IAAK,GAQtCuV,EADQ,IAAIC,gBAAgB3H,OAAOC,SAAS7X,QAC1B+H,IAAI,aAEtByX,EAAc,IAAID,iBACD,IAAnBF,GACFG,EAAYC,OAAO,cAAeL,EAASpV,UAAUqV,EAAgB,IAGnEC,GACFE,EAAYC,OAAO,YAAaH,GAGlC7D,EAAS,CACP2D,SAAU,IACVpf,OAAQ0f,mBAAmBF,EAAYG,aACvC,EA2JEC,cAAerE,EAAUsE,eAEzBjG,GAAAA,cAACkG,GAAAA,GAAa,CAACC,QAAQ,mBACrBnG,GAAAA,cAAA,OAAKM,UAAU,gCACbN,GAAAA,cAACrB,GAAO,CAACC,gBAAiBA,OAIhCoB,GAAAA,cAAA,OACEM,UAAU,mFACV8F,MAAO,CAAEC,OAAQ,sBAEjBrG,GAAAA,cAACA,GAAAA,SAAc,KACZqC,GACCrC,GAAAA,cAACsG,GAAAA,GAAwB,CAAChG,UAAU,2BAGrCwE,EAAoB3f,OACnB6a,GAAAA,cAACkG,GAAAA,GAAa,CAACC,QAAQ,cACrBnG,GAAAA,cAACuG,GAAAA,GAAS,CACRC,KAAK,OACLC,eAAgBhF,EAAyB,KAAO,EAChDiF,KAAM5B,EACNlG,gBAAiBA,KAGnB,KAEJoB,GAAAA,cAAA,OAAKM,UAAU,+BACbN,GAAAA,cAAA,OAAKM,UAAU,oFACbN,GAAAA,cAACkG,GAAAA,GAAa,CAACC,QAAQ,QACrBnG,GAAAA,cAACsB,EAAgB,CACf1C,gBAAiBA,EACjBoG,mBAAoBA,EACpB5D,gBAAiBA,OAKxB2D,EAAqB5f,OACpB6a,GAAAA,cAACkG,GAAAA,GAAa,CAACC,QAAQ,eACrBnG,GAAAA,cAACuG,GAAAA,GAAS,CACRC,KAAK,QACLC,eAAgB/E,EAA0B,KAAO,EACjDgF,KAAM3B,EACNnG,gBAAiBA,KAGnB,OAKd,CAEAqC,GAAa0F,UAAY,CAEvBzF,iBAAkB0F,KAAAA,MAAgB,CAChCrC,eAAgBqC,KAAAA,KAAAA,aACfC,WACHzF,gBAAiBwF,KAAAA,WAAqBE,GAAAA,GACtClI,gBAAiBgI,KAAAA,WAAqBG,GAAAA,GAEtCxF,WAAYqF,KAAAA,MACZpF,YAAaoF,KAAAA,MACbnF,uBAAwBmF,KAAAA,KAAAA,WACxBlF,wBAAyBkF,KAAAA,KAAAA,WAEzBI,SAAUJ,KAAAA,UAAoB,CAACA,KAAAA,KAAgBA,KAAAA,OAAiBC,YAGlE,YClSA,MAAM,mBAAEI,GAAkB,WAAEC,IAAephB,EAAAA,QAM3C,SAASqhB,GAAiBzd,GAMvB,IANwB,gBACzBkV,EAAe,YACfwI,EAAW,0BACXC,EAAyB,kCACzBC,EAAiC,WACjCC,GACD7d,EACC,MAAM,uBACJ6Y,EAAsB,kBACtBiF,EAAiB,sBACjBC,GACE7I,EAAgBE,UAId,kBAAE/J,IAAsB2S,EAAAA,GAAAA,QAE5B,oBAAEC,EAAmB,UAAEtG,GACvBuG,IACEC,EAAAA,GAAAA,OACGC,EAAeC,IAAoB9I,EAAAA,GAAAA,UAAS,YAC5C+I,EAA2BC,IAAgChJ,EAAAA,GAAAA,UAAS,IACtElK,KAEEmT,EAAkBC,IAAuBlJ,EAAAA,GAAAA,UAAS,KAClDmJ,EAAaC,IAAkBpJ,EAAAA,GAAAA,UAAS,KACxCqJ,EAAsBC,IAA2BtJ,EAAAA,GAAAA,UAAS,CAAC,GAC5DuJ,GAAYC,EAAAA,GAAAA,SAAO,IAyBzBlJ,EAAAA,GAAAA,YAAU,KA8CRxK,EAAkB1P,SAAQqjB,GA5C1BviB,eAAsCiD,GAEpC,MAAMuf,QAAwBpB,EAAWzS,MAAM1P,QAAQgB,OAAO,CAC5DZ,iBAAkB4D,IAGpB,IAAIwf,EAAwBD,EAI5B,IACEC,QAA8BvB,EAC5BsB,EAEJ,CAAE,MAAOE,GACPnW,QAAQC,KAAKkW,EACf,CAGA,MAAMC,EADsCF,EAmMjC3b,KAAIsC,IAEV,CACLhI,gBAAiBgI,EAAM5J,UACvByC,UAAWmH,EAAM9J,KACjBgC,iBAAkB8H,EAAMtJ,YACxBoV,aAAc9L,EAAMxJ,UACpB4B,kBAAmB4H,EAAMrJ,WACzBqV,UAAWhM,EAAM3J,IACjByB,YAAakI,EAAM1J,YACnBuD,iBAAkBmG,EAAM/J,iBACxBgW,UAAWjM,EAAM7J,SA7M2BuH,KAAI3H,IACvC,CACLE,iBAAkBF,EAAU8D,iBAC5B3D,KAAMyhB,GAAW5hB,EAAU8C,WAC3BnC,YAAaX,EAAUmC,iBACvBvB,WAAYZ,EAAUqC,kBACtBwV,aAAc7X,EAAU+V,iBAI5B8M,GAAoBY,IAClB,MAAMxQ,EAAM,IAAIwQ,GAChB,IAAK,MAAMxZ,KAASuZ,EAEfC,EAAUhZ,MACTiZ,GAAMA,EAAGxjB,mBAAqB+J,EAAM/J,oBAGtC+S,EAAIhT,KAAKgK,GAGb,OAAOgJ,CAAG,GAEd,CAEiC0Q,CAAuBP,IAAK,GAE5D,CAAC3T,EAAmBsS,KAGvB9H,EAAAA,GAAAA,YAAU,KACmBiI,EAAkB0B,kBAC1B7jB,SAAQc,UACzB,MAAMgjB,EAAmB,CAAC,EACpBjQ,EAAasO,EAAkB4B,mBACnCC,EAAKC,uBAEDlQ,EAAWmO,EAAWtO,yBAAyBC,GAC/CrO,EAAUuO,EAASmQ,KAAKC,MAAMpQ,EAASjU,OAAS,IAGlD0F,IAEFse,EAAiBE,EAAKC,6BAA+BlC,EACnDvc,GAEE2d,EAAUiB,SACZlB,GAAwBmB,IACf,IAAKA,KAAcP,MAGhC,IAEK,KACLX,EAAUiB,SAAU,CAAK,IAG1B,KAGHlK,EAAAA,GAAAA,YAAU,KAER,MACMoK,EAAoBC,GADCpC,EAAkB0B,kBAG3CZ,GAEFrB,GAAmB0C,GAEnBtB,EAAesB,EAAkB,GAEhC,CAACrB,KAGJ/I,EAAAA,GAAAA,YAAU,KAER,MAAMsK,EAA+BrC,EAAkB9H,UACrD8H,EAAkBzL,OAAO+N,oBACzBpb,IACE,MAAM,iBAAEqb,GAAqBrb,EAC7Bqb,EAAiB1kB,SAAQc,UACvB,MAAMgjB,EAAmB,CAAC,EACpBjQ,EAAasO,EAAkB4B,mBACnCC,EAAKC,uBAEDlQ,EAAWmO,EAAWtO,yBAAyBC,GAC/CrO,EAAUuO,EAASmQ,KAAKC,MAAMpQ,EAASjU,OAAS,IAGlD0F,IAEFse,EAAiBE,EAAKC,6BAA+BlC,EACnDvc,EACAwe,EAAKW,iBAEHxB,EAAUiB,SACZlB,GAAwBmB,IACf,IAAKA,KAAcP,MAGhC,GACA,IAMAc,EAAiCzC,EAAkB9H,UACvD8H,EAAkBzL,OAAOmO,sBACzBC,IACE,MAAMR,EAAoBC,GACxBO,EACA7B,GAEFD,EAAesB,EAAkB,IAIrC,MAAO,KACLE,EAA6BrK,cAC7ByK,EAA+BzK,aAAa,CAC7C,GAEA,IAEH,MAAMkH,EAyJR,SACE0D,EACAlC,EACAE,GAEA,MAAMiC,EAAiB,GACjBC,EAAgB,GAChBC,EAAa,GAEnBrC,EAAiB7iB,SAAQkK,IACvB,MAAMib,EAAsBpC,EAAY9Y,QACtCmb,GAAMA,EAAGrhB,mBAAqBmG,EAAM/J,mBAEhCklB,EAAWphB,OAAO4U,OAAO,CAAC,EAAG3O,EAAO,CACxC6Y,YAAaoC,IAGXJ,EAAyBO,SAASpb,EAAM/J,kBAC1C6kB,EAAe9kB,KAAKmlB,IAGpBJ,EAAc/kB,KAAKmlB,GACnBH,EAAWhlB,KAAKmlB,GAClB,IAGF,MAAMhE,EAAO,CACX,CACE7L,KAAM,UACN+J,MAAO,UACPxf,QAASilB,GAEX,CACExP,KAAM,SACN+J,MAAO,SACPxf,QAASklB,GAEX,CACEzP,KAAM,MACN+J,MAAO,MACPxf,QAASmlB,IAIb,OAAO7D,CACT,CAtMekE,CACX7V,EACAmT,EACAE,GA6BF,MAAMyC,EACJxJ,EAAUsG,IAAsBmD,uBAElC,OACE9K,GAAAA,cAAC+K,GAAAA,GAAY,CACXrE,KAAMA,EACN9H,gBAAiBA,EACjBkJ,cAAeA,EACfkD,uBAjNkC1B,IACpC,IAAI2B,EAAmB,GACvB,MAAMC,EAAgBvD,EACtB,IACEsD,EAAmB1I,EAAuB4I,0BACxCD,EACA5B,EAEJ,CAAE,MAAOT,GACPnW,QAAQC,KAAKkW,GACbpB,EAAsBvF,KAAK,CACzBS,MAAO,yBACPyI,QACE,gEACF3Y,KAAM,OACN4Y,SAAU,KAEd,CAEAzD,EAAoB0D,2BAA2BL,EAAiB,EA+L9DJ,6BAA8BA,EAC9B7C,0BAA2BA,EAC3BuD,aApCJ,SAA2BniB,GACzB,MAAMoiB,EAAsBxD,EAA0B2C,SACpDvhB,GAEIqiB,EAAmCD,EAErC,IACKxD,EAA0B1Y,QAC3Boc,GAAWA,IAAYtiB,KAG3B,IAAI4e,EAA2B5e,GAInC,GAFA6e,EAA6BwD,IAExBD,EAAqB,CAExBlE,EACEE,EACApe,GAHmB,EAMvB,CACF,EAcIuiB,WAAYC,IACV7D,EAAiB6D,EAAe,GAIxC,CAEAzE,GAAkBR,UAAY,CAC5B/H,gBAAiBgI,KAAAA,OAAAA,WACjBW,WAAYX,KAAAA,MAAgB,CAC1B3N,yBAA0B2N,KAAAA,KAAAA,aACzBC,WACHO,YAAaR,KAAAA,KAAAA,WACbS,0BAA2BT,KAAAA,KAAAA,WAC3BU,kCAAmCV,KAAAA,KAAAA,YAGrC,YAwBA,SAASgD,GAAgBxB,EAAaE,GACpC,MAAMuD,EAAuB,GACvBC,EAA8B,GAiCpC,OA/BA1D,EACG9Y,QAAOmb,IAAOA,EAAGsB,8BACjB1mB,SAAQolB,IACP,MAAMuB,EAAW1D,EAAqBmC,EAAGnB,uBACnC2C,EAuCZ,SAA2BnU,GACzB,GAAIoU,GAA2BvB,SAAS7S,GAEtC,MAAO,mBAGT,MAAO,WACT,CA9C4BqU,CAAkB1B,EAAG3S,WAGvB,cAAlBmU,EACIJ,EACAC,GAEAvmB,KAAK,CACT+jB,sBAAuBmB,EAAGnB,sBAC1BrjB,YAAawkB,EAAG/S,mBAAqB,GACrCnC,aAAckV,EAAG9S,aACjBjG,SAAU+Y,EAAG3S,SACbtC,WAAYiV,EAAGjN,WACf4O,WAAY3B,EAAG7S,WACfuF,aAAcsN,EAAG4B,eACjBC,UAAW7B,EAAG6B,UACdljB,iBAAkBqhB,EAAGrhB,iBACrB6iB,gBACAD,WACAO,SAAU,CACR9Z,KAAM,aACN6W,sBAAuBmB,EAAGnB,wBAG5B,IAGC,IAAIuC,KAAyBC,EACtC,CAEA,MAAMI,GAA6B,CACjC,KACA,MACA,KACA,WACA,SACA,UCnUF,SAXA,SAAgCM,EAAa3hB,GAC3C,OAAO,IAAIwD,SAAQ,CAACC,EAASC,KAC3B,MAAMke,EAASxI,SAASyI,cAAc,UACtCF,EAAYG,UACTC,kBAAkB,CAAEH,SAAQ5hB,YAC5B4D,MAAK5D,IACJyD,EAAQme,EAAOI,YAAY,IAE5BC,MAAMve,EAAO,GAEpB,ECJA,SAVApI,eAAyCohB,EAAYoB,GACnD,OAAIA,GAAmBA,EAAgBxjB,QAAUwjB,EAAgB,GAAG/iB,IAC3D2hB,EAAWzS,MAAM1P,QAAQgB,OAAO,CACrCkB,UAAWqhB,EAAgB,GAAG/iB,OAGlC8M,QAAQiH,IAAI,mBAAoBgP,GACzBA,EACT,ECUA,SAlBA,SACEpB,EACAC,EACApe,EACA8M,GAIEsR,EAAkB0B,kBAAkB6D,MAClC7T,GAAcA,EAAW9P,mBAAqBA,KAMlDme,EAAW3R,SAASlG,OAAOuG,SAAS,CAAE7M,mBAAkB8M,gBAC1D,ECDA,SAAS8W,GAAwBtjB,GAI9B,IAJ+B,gBAChC0X,EAAe,iBACfF,EAAgB,gBAChBtC,GACDlV,EAGC,MAAM6d,EAAarG,EAAiB+L,iBAAiB,GAC/CC,EAA6B7F,GAAAA,KACjC,KACAE,GAEI4F,EA4BR,SAAyCjM,GACvC,MAAMyL,EAAYzL,EAAiBqD,eACjC,oDAGF,IACE,MAAM,YAAEiI,GAAgBG,EAAUS,QAAQC,0BAC1C,OAAOC,GAAAA,KAA4B,KAAMd,EAC3C,CAAE,MAAOe,GACP,MAAM,IAAIthB,MAAM,6BAClB,CACF,CAvCkCuhB,CAC9BtM,GAEIuM,EAAqCnG,GAAAA,KACzC,KACAC,GAGF,OACEvH,GAAAA,cAACmH,GAAiB,CAChBvI,gBAAiBA,EACjB2I,WAAYA,EACZH,YAAa+F,EACb9F,0BAA2B6F,EAC3B5F,kCAAmCmG,GAGzC,CAwBAT,GAAyBrG,UAAY,CACnCvF,gBAAiBwF,KAAAA,OAAAA,WACjB1F,iBAAkB0F,KAAAA,OAAAA,WAClBhI,gBAAiBgI,KAAAA,OAAAA,YAGnB,YCpEA,SAAS8G,GAAahkB,GAAyC,IAAxC,cAAEikB,EAAa,oBAAEC,GAAqBlkB,EAC3D,MAAM,EAAEsY,IAAMC,EAAAA,GAAAA,IAAe,oBAE7B,OACEjC,GAAAA,cAACA,GAAAA,SAAc,KACbA,GAAAA,cAAC6N,GAAAA,GAAW,CAACC,MAAM,QAAQC,KAAK,WAC9B/N,GAAAA,cAACgO,GAAAA,GAAM,CAAC1N,UAAU,sBAAsBuC,QAAS8K,GAC9C3L,EAAE,eAELhC,GAAAA,cAACgO,GAAAA,GAAM,CAAC1N,UAAU,sBAAsBuC,QAAS+K,GAC9C5L,EAAE,mBAKb,CAEA0L,GAAc/G,UAAY,CACxBgH,cAAe/G,KAAAA,KACfgH,oBAAqBhH,KAAAA,MAGvB8G,GAAcO,aAAe,CAC3BN,cAAeA,IAAMO,MAAM,UAC3BN,oBAAqBA,IAAMM,MAAM,kBAGnC,Y,2BC7BO,MAAMC,GAAgC,CAC3CC,OAAQ,EACRC,cAAe,GC8DjB,SAASC,KACP,OAAOtO,GAAAA,cAAA,OAAKM,UAAU,uBAAsB,aAC9C,CAEA,SA7DAna,eACEyY,EACAwC,EACAmG,EACAgH,EACA1nB,GAEA,MAAM,kBACJ2gB,EAAiB,sBACjBC,EAAqB,gBACrB+G,GACE5P,EAAgBE,SACd2P,EAAkBD,EAAgBE,OAAO,CAC7CC,aAAa,EACbC,aAAa,EACbC,YAAY,EAEZ/L,QAASwL,KAGX,IACE,MAAMzQ,QAA0BuD,EAAgB0N,WAC9C,oBACA,CACEC,gBAAiBR,EACjBhH,aACAyH,uBAAwB,CAAC,iBACzBnoB,WAEF,iCAMFsR,EAAAA,QAAAA,aAAgC,CAAC0F,IAAoB,GAErD,MAAMyL,EAAwB9B,EAAkByH,0BAQhD,OANAxH,EAAsBvF,KAAK,CACzBS,MAAO,gBACPyI,QAAS,kCACT3Y,KAAM,YAGD,CAAC6W,EACV,CAAE,MAAOT,GACPpB,EAAsBvF,KAAK,CACzBS,MAAO,gBACPyI,QAASvC,EAAMuC,SAAW,+BAC1B3Y,KAAM,SAEV,CAAE,QACA+b,EAAgBU,QAAQ,CAAEhP,GAAIuO,GAChC,CACF,EClEMU,GAAuB,KCed,SAASC,GACtB1X,EACA8P,GAEA,MAEM6H,EAFoB7H,EAAkB8H,uBACJhgB,QAAOmb,GAAsB,OAAhBA,EAAG3S,WACvB/H,MAC/B0a,GAAMA,EAAG/S,oBAAsBA,IAEjC,GAAI2X,EAAY,CACd3c,QAAQiH,IAAI,yBAA0B0V,GACtC,MAAM,SAAE1lB,GAAa0lB,GACf,kBACJllB,EAAiB,kBACjBuN,EAAiB,WACjB8F,EAAU,WACV5F,EAAU,aACVD,EAAY,SACZG,GACEnO,EACJ,MAAO,CACLQ,oBACAuN,oBACA8F,aACA5F,aACAD,eACAG,WACAyX,eAAgBF,EAAWtpB,UAAUZ,OAAS,EAElD,CAEA,MAAMwS,ED5CO,SAA+B6P,GAC5C,MAEMgI,EAFoBhI,EAAkB8H,uBACJhgB,QAAOmb,GAAsB,OAAhBA,EAAG3S,WAClB7K,KAAIwd,GAAMA,EAAG9S,eAGnD,OAFwB4R,KAAKkG,OAAOD,EAAiBL,IAE5B,CAC3B,CCqCuBO,CAAsBlI,GAC3C,MAAO,CAAE9P,oBAAmBC,eAC9B,CCnCA,MAAM,kBAAEgY,IAAsB7pB,EAAAA,QAEf,SAAS8pB,GAAqBlmB,GAIjB,IAJkB,gBAC5CkV,EAAe,gBACfwC,EAAe,iBACfF,GACDxX,EACC,MAAOmmB,EAAcjI,IAAuBC,EAAAA,GAAAA,OACtC,oBAAEF,EAAmB,UAAEtG,GAAcwO,GACrC,mBACJC,EAAkB,gBAClBtB,EAAe,sBACf/G,EAAqB,kBACrBD,GACG5I,EAAoCE,UAClCiR,EAAqBC,IAA0B/Q,EAAAA,GAAAA,UAAS,KAE/DM,EAAAA,GAAAA,YAAU,KACR,MAAM0Q,EAAkCC,KACtCF,EACA,KAGFA,EAAuBG,GAAuBL,IAG9C,MAAMM,EAAQN,EAAmB/T,OAAOsU,kBAClCC,EAAWR,EAAmB/T,OAAOwU,sBACrCC,EAAUV,EAAmB/T,OAAO0U,oBACpCC,EAAUZ,EAAmB/T,OAAO4U,oBACpCC,EAAUd,EAAmB/T,OAAO8U,qBACpCC,EAAgB,GAYtB,MAVA,CAACV,EAAOE,EAAUE,EAASE,EAASE,GAASvrB,SAAQ0rB,IACnDD,EAAcvrB,KACZuqB,EAAmBpQ,UAAUqR,GAAK,KAChCd,EACEE,GAAuBL,GACxB,IACAtQ,YACJ,IAGI,KACLsR,EAAczrB,SAAQ2rB,IACpBA,GAAO,IAETf,EAAgCgB,QAAQ,CACzC,GACA,IAkEH,MAyEMC,EAAgCC,IAAuB,IAAtB,IAAEC,EAAG,SAAE/Q,GAAU8Q,EACtD,IAAK9Q,EAAU,CACb,MAAMkO,EAAe,IAAIwB,GACnBsB,EAAc9C,EAAaxe,MAAKuhB,GAAKA,EAAEF,MAAQA,IAErD7C,EAAalpB,SAAQisB,GAAMA,EAAEjR,SAAWiR,EAAEF,MAAQA,IAClDC,EAAYhR,UAAW,EACvB2P,EAAuBzB,EACzB,GAGF,OACEvO,GAAAA,cAAAA,GAAAA,SAAA,KACEA,GAAAA,cAAA,OACEM,UAAU,mDACV,UAAS,sBAETN,GAAAA,cAACuR,GAAAA,GAAgB,CACf5O,MAAM,eACN/D,gBAAiBA,EACjBlQ,KAAMqhB,EACNlN,QA9FY/M,IAAuB,IAAtB,IAAEsb,EAAG,SAAE/Q,GAAUvK,EACpCga,EAAmB0B,kBAAkB3B,EAAalI,oBAAqByJ,GAEvEF,EAA8B,CAAEE,MAAK/Q,YAAW,EA4F1CoR,OAzF6BnY,IAAuB,IAAtB,IAAE8X,EAAG,SAAE/Q,GAAU/G,EACrD,MAAM+X,EAAcvB,EAAmB4B,eAAeN,GAIhDO,EAAkBC,IAAuB,IAAtB,OAAEC,EAAM,MAAE1qB,GAAOyqB,EACxC,GACO,SADCC,EAAO3R,GAEX4P,EAAmBgC,OACjBV,EACA,IACKC,KACAlqB,IAEL,GAINqnB,EAAgBU,QAAQ,CAAEhP,GAAI,oBAAqB,EAGrDsO,EAAgBE,OAAO,CACrBxO,GAAI,mBACJ2O,YAAY,EACZD,aAAa,EACbD,aAAa,EACb7L,QAASiP,GAAAA,GACT/O,aAAc,CACZL,MAAO,wBACPqP,eAAe,EACf7qB,MAAO,CAAEyd,MAAOyM,EAAYzM,OAAS,IACrCV,KAAM+N,IAAyB,IAAxB,MAAE9qB,EAAK,SAAE+qB,GAAUD,EAWxB,OACEjS,GAAAA,cAAA,OAAKM,UAAU,uBACbN,GAAAA,cAACmS,GAAAA,GAAK,CACJC,WAAS,EACTlS,GAAG,aACHI,UAAU,oCACV7N,KAAK,OACL4f,mBAAmB,OACnBlrB,MAAOA,EAAMyd,MACb0N,SAnBkBC,IACtBA,EAAMC,UACNN,GAAS/qB,IAAS,IAAMA,EAAOyd,MAAO2N,EAAME,OAAOtrB,SAAS,EAkBxDurB,WAfoBH,IACN,UAAdA,EAAM/oB,KACRmoB,EAAgB,CAAExqB,QAAO0qB,OAAQ,CAAE3R,GAAI,SACzC,IAcM,EAGVyS,QAAS,CAEP,CAAEzS,GAAI,SAAU0S,KAAM,SAAUngB,KAAM,WACtC,CAAEyN,GAAI,OAAQ0S,KAAM,OAAQngB,KAAM,cAEpC+Q,SAAUmO,IAEZ,KA4BA3R,GAAAA,cAAA,OAAKM,UAAU,2BACbN,GAAAA,cAAC0N,GAAa,CACZC,cApKRxnB,iBACE,MAAMooB,EAAeuB,EAAmB+C,kBAExClD,GAAkBpB,EAAcuB,EAClC,EAiKQgD,yBA/JR3sB,iBACE2pB,EAAmBiD,mBACrB,EA8JQnF,oBA5JRznB,iBAEE,MAAM6sB,EAAiB3R,EAAUsG,GAC3B4G,EAAeuB,EAAmB+C,kBAClC3Z,EAAasO,EAAkB4B,mBACnC4J,EAAelI,uBAAuB,IAElCmI,EAAsB1E,EAAajf,QACvCgiB,GAAKpY,EAAW9P,mBAAqBkoB,EAAE4B,oBAGzC,GAAID,EAAoB9tB,QAAU,EAOhC,YANAsiB,EAAsBvF,KAAK,CACzBS,MAAO,kBACPyI,QAAS,kDACT3Y,KAAM,OACN4Y,SAAU,MAKd,MAAM8H,QJtFK,SACb3E,EAAe9kB,GAEf,IADA,iBAAEwX,GAAkBxX,EAEpB,OAAO,IAAI2E,SAAQ,SAAUC,EAASC,GACpC,IAAI6kB,EAEJ,MAoCMC,EAAkB/pB,OAAOC,KAAK2X,EAAiBoS,eAClDhkB,QAAOmb,IACN,MAAM8I,EACJrS,EAAiBsS,eAAe/I,IAAK8I,cAGvC,OADEA,GAAeE,cAAgBF,GAAelpB,QAC7B,IAEpB4C,KAAIwd,IACI,CACLtjB,MAAOsjB,EACP7F,MAAO6F,EACPiJ,YAAajJ,MAInB2I,EAAW5E,EAAgBE,OAAO,CAChCG,YAAY,EACZD,aAAa,EACb9L,QAASiP,GAAAA,GACT4B,iBAAiB,EACjBhF,aAAa,EACb3L,aAAc,CACZL,MAAO,iCACPxb,MAAO,CACLyd,MAAO,GACPgP,eAAgB1S,EAAiB2S,kBAEnC7B,eAAe,EACf8B,QAjEiBC,KAEnBvF,EAAgBU,QAAQ,CAAEhP,GAAIkT,IAE9B9kB,EAAQ,CACNujB,OAAQ1D,GAA8BC,OACtCjnB,WAAOV,EACPmtB,oBAAgBntB,GAChB,EA0DAksB,QAAS,CACP,CAAEzS,GAAI,SAAU0S,KAAM,SAAUngB,KAAM,WACtC,CAAEyN,GAAI,OAAQ0S,KAAM,OAAQngB,KAAM,cAGpC+Q,SAvDsB1N,IAAuB,IAAtB,OAAE+b,EAAM,MAAE1qB,GAAO2O,EAE1C,OADA0Y,EAAgBU,QAAQ,CAAEhP,GAAIkT,IACtBvB,EAAO3R,IACb,IAAK,OACH5R,EAAQ,CACNujB,OAAQ1D,GAA8BE,cACtClnB,MAAOA,EAAMyd,MACbgP,eAAgBzsB,EAAMysB,iBAExB,MACF,IAAK,SACHtlB,EAAQ,CACNujB,OAAQ1D,GAA8BC,OACtCjnB,WAAOV,EACPmtB,oBAAgBntB,IAEZ,EAwCRyd,KAAM5K,IAAyB,IAAxB,MAAEnS,EAAK,SAAE+qB,GAAU5Y,EAcxB,OACE0G,GAAAA,cAAAA,GAAAA,SAAA,KACEA,GAAAA,cAAA,OAAKM,UAAU,uBACZ+S,EAAgBluB,OAAS,GACxB6a,GAAAA,cAACgU,GAAAA,GAAM,CACLC,mBAAmB,EACnB3T,UAAU,oCACVzZ,QAASwsB,EACTa,YACEb,EAAgBtjB,MACdokB,GAAUA,EAAOhtB,QAAUA,EAAMysB,iBACjCF,YAEJvsB,MAAOA,EAAMysB,eACbtB,SAAUvB,IACRmB,GAASkC,IAAK,IAAMA,EAAGR,eAAgB7C,EAAI5pB,SAAS,EAEtDktB,aAAa,KAInBrU,GAAAA,cAAA,OAAKM,UAAU,uBACbN,GAAAA,cAACmS,GAAAA,GAAK,CACJC,WAAS,EACT9R,UAAU,oCACV7N,KAAK,OACLyhB,YAAY,oBACZ7B,mBAAmB,OACnBlrB,MAAOA,EAAMyd,MACb0N,SA1CgBC,IACtBA,EAAMC,UACNN,GAAS/qB,IAAS,IAAMA,EAAOyd,MAAO2N,EAAME,OAAOtrB,SAAS,EAyCtDurB,WAvCkBH,IACN,UAAdA,EAAM/oB,MACRglB,EAAgBU,QAAQ,CAAEhP,GAAIkT,IAC9B9kB,EAAQ,CACNujB,OAAQ1D,GAA8BE,cACtClnB,MAAOA,EAAMyd,QAEjB,EAiCM0P,UAAQ,KAGX,IAKb,GACF,CI/C+BC,CAAyB/F,EAAiB,CACnEtN,qBAGF,GAAIiS,EAAatB,SAAW1D,GAA8BE,cAAe,CACvE,MAGM9G,EAHcrG,EAAiB+L,eACnCkG,EAAaS,gBAEgB,GAUzB/sB,EAAUuoB,QANS3oB,IAAvB0sB,EAAahsB,OAA8C,KAAvBgsB,EAAahsB,MAC7C,0BACAgsB,EAAahsB,MAMjBqgB,GAGF,OAAOgN,GACL5V,EACAwC,EACAmG,EACA0L,EACApsB,EAEJ,CACF,KA6GF,CAMA,SAASspB,GAAuBL,GAO9B,OANqBA,EAAmB+C,kBAEA5lB,KAAI,CAACqkB,EAAGzY,IAalD,SAAkCwY,EAAaxY,EAAO4b,GACpD,MACEC,YAAaC,EAAe,IAC5BvD,EACAxM,MAAOgQ,EAAS,KAChBniB,EAAI,SACJoiB,EAAQ,aACRC,EAAY,QACZC,GACE1D,EAEE2D,EAAYF,IAAe,GAC3BlQ,EAAQgQ,GAAaG,GAASnC,MAAQoC,GAAWpC,MAAQ,UAC/D,IAAI8B,EAAcC,GAAmB,GACrC,GAAIG,EAAc,CAChB,MAAMG,EAAW,GACjBH,EAAazvB,SAAQ6vB,IACfA,GAAMtC,OAAShO,GAAOqQ,EAAS1vB,KAAK2vB,EAAKtC,KAAK,IAEpD8B,EAAc,IAAIO,KAAaP,EACjC,CACIK,GAAWA,GAASnC,OAAShO,IAC/B8P,EAAc,CAACK,EAAQnC,QAAS8B,IAGlC,MAAO,CACLtD,MACAxM,QACAgQ,YACAO,gBAAiB1iB,EACjBiiB,cACAC,kBACAtU,SAAUwU,EACVE,UACAD,eAEJ,CAhDIM,CAAyB9D,EAAGzY,EAAOiX,EAAmBuF,cAI1D,CAZAzF,GAAsBjJ,UAAY,CAChC/H,gBAAiBgI,KAAAA,WAAqBG,GAAAA,GAAiBF,YChMzD,SAtCA,SAAuBnd,GAIpB,IAJqB,gBACtB0X,EAAe,iBACfF,EAAgB,gBAChBtC,GACDlV,EAWC,MAAO,CACL,CACEmR,KAAM,aACN6J,SAAU,eACVC,UAAW,UACXC,MAAO,UACPJ,UAAWwI,GAAAA,KAA8B,KAAM,CAC7C5L,kBACAF,mBACAtC,qBAGJ,CACE/D,KAAM,UACN6J,SAAU,aACVC,UAAW,UACXC,MAAO,eACP0Q,eAAgB,eAChB9Q,UA5B4B+Q,IAE5BvV,GAAAA,cAAC4P,GAAqB,CACpBxO,gBAAiBA,EACjBxC,gBAAiBA,EACjBsC,iBAAkBA,KA0B1B,E,wDC1CMhB,G,+CAAKsV,GCILC,GAAsB,QAEtBC,GAAe/rB,GACZA,EAAS0P,eAAiB,EAG7Bsc,GAAiB5vB,IACrB,MAAM4D,EAAW5D,EAAU,GACrB6vB,EAAW,IAAIC,GAAAA,EAAS9vB,IAG5BoB,MAAO2uB,EAAiB,4BACxBC,IACEC,EAAAA,GAAAA,GAA4BjwB,GAGhC6vB,EAASK,cAAc,CACrB3M,sBAAuBsM,EAASxE,IAChC5T,WAAY7T,EAAS6T,WACrB5F,WAAYjO,EAASiO,WACrBzN,kBAAmBR,EAASQ,kBAC5Bf,iBAAkBO,EAASP,iBAC3BuO,aAAchO,EAASgO,cAAgB,EACvCue,UAAWvsB,EAASwsB,UACpBnf,YAAarN,EAASqN,YACtBU,kBAAmB/N,EAAS+N,mBAAqB,GACjDI,SAAUnO,EAASmO,SACnB4d,aAAcA,GAAa/rB,GAC3B2iB,UAAWwJ,EAAoB,gBAAarvB,EAC5C4lB,eAAgBtmB,EAAUZ,OAC1BixB,kBAAoB,GAAElW,4BAA4BuV,KAClDK,oBACAC,4BAA6BA,GAA+B,OA8B9D,OAxBEH,EAASS,QAAO,CAACC,EAAGC,KAGfC,SAASF,EAAE/G,iBAAmB,IAAMiH,SAASD,EAAEhH,iBAAmB,KAqBlEqG,CAAQ,EAGXa,GAAwB/kB,GACR,OAAbA,GAAkC,OAAbA,GAAkC,OAAbA,EAsBnD,SAASglB,GAAyB3wB,GAEhC,IAAKA,IAAcA,EAAUZ,OAC3B,MAAM,IAAI8G,MAAM,8BAGlB,MAAMmc,EAAc,GACduO,EA1BR,SAAyB5wB,GACvB,MAAM6wB,EAA6B,IAAIxZ,IAMvC,OALArX,EAAUV,SAAQsE,IAChBitB,EAA2BvZ,IAAI1T,EAASqN,YAAY,IAEjC/N,MAAMsU,KAAKqZ,EAGlC,CAkBuBC,CAAgB9wB,GAM/B+wB,EAAqB,GAiC3B,GAhCA/wB,EAAUV,SAAQsE,IAEhB,KAAKotB,EAAAA,GAAAA,GAAQptB,EAASqN,eAAiBrN,EAASqtB,KAC9C,OAGF,IAAI9d,EAEAwc,GAAa/rB,IACfuP,EAAayc,GAAe,CAAChsB,IAE7BuP,EAAW+c,cAAc,CACvBU,eACAM,QAAQ,EACR5K,eAAgB1iB,EAAS0P,eACzB6d,eAAgBvtB,EAAS4lB,eACzB4H,oBAAqBxtB,EAASytB,sBAEhChP,EAAY7iB,KAAK2T,IACRud,GAAsB9sB,EAASmO,WACxCoB,EAAayc,GAAe,CAAChsB,IAC7BuP,EAAW+c,cAAc,CACvBU,eACAO,eAAgBvtB,EAAS4lB,eACzB4H,oBAAqBxtB,EAASytB,sBAEhChP,EAAY7iB,KAAK2T,IAEjB4d,EAAmBvxB,KAAKoE,EAC1B,IAGEmtB,EAAmB3xB,OAAQ,CAC7B,MAAM+T,EAAayc,GAAemB,GAClC5d,EAAWme,aAAa,mBAAoBtxB,EAAU,GAAGqD,kBACzD8P,EAAW+c,cAAc,CACvBU,iBAEFvO,EAAY7iB,KAAK2T,EACnB,CAEA,OAAOkP,CACT,CAEA,MAAMuO,GAAe,CACnBW,GAAAA,EAAAA,gCACAA,GAAAA,EAAAA,uCACAA,GAAAA,EAAAA,qCACAA,GAAAA,EAAAA,kDACAA,GAAAA,EAAAA,gDACAA,GAAAA,EAAAA,gDACAA,GAAAA,EAAAA,8CACAA,GAAAA,EAAAA,eACAA,GAAAA,EAAAA,uBACAA,GAAAA,EAAAA,sCACAA,GAAAA,EAAAA,iCACAA,GAAAA,EAAAA,eACAA,GAAAA,EAAAA,uBACAA,GAAAA,EAAAA,4BACAA,GAAAA,EAAAA,sCACAA,GAAAA,EAAAA,uBACAA,GAAAA,EAAAA,0BACAA,GAAAA,EAAAA,6BACAA,GAAAA,EAAAA,gDACAA,GAAAA,EAAAA,oDACAA,GAAAA,EAAAA,oDACAA,GAAAA,EAAAA,gDACAA,GAAAA,EAAAA,6BACAA,GAAAA,EAAAA,uBACAA,GAAAA,EAAAA,kCACAA,GAAAA,EAAAA,wBACAA,GAAAA,EAAAA,+BACAA,GAAAA,EAAAA,+BACAA,GAAAA,EAAAA,gCACAA,GAAAA,EAAAA,gDACAA,GAAAA,EAAAA,8CACAA,GAAAA,EAAAA,mEACAA,GAAAA,EAAAA,iEACAA,GAAAA,EAAAA,4BACAA,GAAAA,EAAAA,yBACAA,GAAAA,EAAAA,4BACAA,GAAAA,EAAAA,0BACAA,GAAAA,EAAAA,6BACAA,GAAAA,EAAAA,0CACAA,GAAAA,EAAAA,2BACAA,GAAAA,EAAAA,8BACAA,GAAAA,EAAAA,sCACAA,GAAAA,EAAAA,uCACAA,GAAAA,EAAAA,iCACAA,GAAAA,EAAAA,mCACAA,GAAAA,EAAAA,uCACAA,GAAAA,EAAAA,wBACAA,GAAAA,EAAAA,uCACAA,GAAAA,EAAAA,eACAA,GAAAA,EAAAA,yBAaF,SAVA,WACE,MAAO,CACL,CACEzc,KAAM4a,GACNkB,gBACAD,6BAGN,ECnNe,SAASa,KACtB,OACEvX,GAAAA,cAAA,QAAMM,UAAU,wDAEpB,CCAA,SAASkX,GAAc9tB,GAMpB,IANqB,KACtB+tB,EAAI,QACJC,EAAO,UACPpX,EAAS,gBACT1B,KACG+Y,GACJjuB,EACC,MAAOkuB,EAAQC,IAAa5Y,EAAAA,GAAAA,WAAS,IAE/B,uBACJsD,EAAsB,eACtB1D,GACGD,EAAoCE,SAEnCgZ,EAAsBA,KACtBF,GACFC,GAAU,EACZ,GAGFtY,EAAAA,GAAAA,YAAU,KACR,MAAM,YAAEC,GAAgB+C,EAAuB7C,UAC7C6C,EAAuBxG,OAAOgc,kBAC9BhH,IACE,MAAM,SAAEiH,GAAajH,CAAG,IAI5B,MAAO,KACLvR,GAAa,CACd,GACA,CAAC+C,KAEJhD,EAAAA,GAAAA,YAAU,KACRvB,OAAOia,iBAAiB,QAASH,GAC1B,KACL9Z,OAAOka,oBAAoB,QAASJ,EAAoB,IAEzD,CAACF,IAEJ,MACMO,EAAkBP,EAASQ,GAAAA,GAAqB,KAetD,OACEpY,GAAAA,cAACqY,GAAAA,GAAa,CACZnY,GAAG,SACH0E,MAAM,cACNhC,KAAK,cACLlC,cArByB4X,IAAMT,GAAWD,GAsB1CtX,UAAWA,EACXiY,QAASZ,EAAKY,QACdC,gBACsB,OAApBL,GACEnY,GAAAA,cAACmY,EAAe,CACdV,KAAMA,EACNC,QAASA,EACTe,YA1BiBC,IACzB7Z,EAAe+B,kBAAkB,CAC/B+X,gBAAiB,SACjBC,SAAU,CACR,CACEC,YAAa,wBACbC,eAAgB,IAAKJ,GACrBvS,QAAS,aAGb,IAoBA9F,SAAUuX,EACVnlB,KAAK,UAGX,CAEA+kB,GAAe7Q,UAAY,CACzB8Q,KAAM7Q,KAAAA,OACN8Q,QAAS9Q,KAAAA,OACTmS,eAAgBnS,KAAAA,KAChBhI,gBAAiBgI,KAAAA,WAAqBG,GAAAA,IAGxCyQ,GAAevJ,aAAe,CAC5BwJ,KAAM,EACNC,QAAS,EACTqB,eAAgBA,QAGlB,YChGA,GAAeC,GAAW,GC8GnB,SAASC,GACdC,EACA3G,EACA4G,EACAC,GAIA,MAAMC,EAAW,CAAEH,gBAAe3G,SAE5B+G,EAnED,SACLH,EACAT,EACAU,GAEA,MAAM,QAAEG,GAAYb,EAOdc,EALN,kBApDK,SAAsBL,EAAeM,GAC1C,GAAKA,EAIL,OAAON,EAAMppB,MAAKupB,GAAQA,EAAKpZ,KAAOuZ,GACxC,CA+CUC,CAAaP,EAAOC,GAAgBG,SA9BvC,SACLJ,EACAE,GAEA,OAAKF,EAGEA,EAAMppB,MACXupB,IAASA,EAAKK,UAAYL,EAAKK,SAASN,EAASH,iBAH1C,IAKX,CAqBUU,CAAgBT,EAAOT,EAC/B,CAEemB,GAEf,IAAIpQ,EAAU+P,EAAOztB,OACjButB,EAAO7P,EAAQtiB,MAEnB,MAAQsiB,EAAQzd,MACdstB,EAAO7P,EAAQtiB,MAEXmyB,GACFE,EAAOM,SAETrQ,EAAU+P,EAAOztB,OAKnB,OAFA2G,QAAQiH,IAAI,cAAe2f,GAAMpZ,IAAM,QAEhCoZ,CACT,CAsCeS,CAASZ,EAAOE,EAAUD,GAEvC,IAAKE,EACH,OAGF,IAAKA,EAAKU,MAER,OADAtnB,QAAQC,KAAK,4BAA6B2mB,GACnC,GAGT,IAAIW,EAAY,GAiBhB,OAhBAX,EAAKU,MAAM30B,SAAQ2K,IACjB,MAAM,WAAEkqB,EAAU,SAAEP,EAAQ,QAAEJ,GAAYvpB,EAE1C,IAAK2pB,GAAYA,EAAST,GACxB,GAAIgB,EACFD,EAAY,IACPA,KACAhB,GAAaC,EAAe3G,EAAO4G,EAAOI,QAE1C,CACL,MAAMY,EAmBP,SACLnqB,EACAqpB,GAEA,MAAMe,EAA2B,IAC5BpqB,EACH7I,MAAOkyB,EAASH,eAAe/xB,OAGT,gBAApB6I,EAAKqqB,YAAiCD,EAAQE,YAChDF,EAAQE,UAAY,gBAEjBtqB,EAAK6hB,SACRuI,EAAQvI,OAAS,CAAC0I,EAASna,KACzB,MAAM,MAAEmS,EAAQ,CAAC,GAAMnS,GACjB,OAAEoa,EAAS,CAAC,GAAMjI,EACxB6H,EAAQK,QAAUD,EAAOC,QAEzBra,EAAe0T,UACf,MAAMjC,EAASzR,EAAgB,KAAIma,EAAQF,YAAc,aACrDxI,EACFA,EAAO6I,KAAKta,EAAgBga,EAASG,EAASlB,GAE9C3mB,QAAQC,KAAK,wBAAyB4nB,EACxC,GAIJ,OAAOH,CACT,CAhDsBO,CAAU3qB,EAAMqpB,GAC9BY,EAAU10B,KAAK40B,EACjB,CACF,IAGKF,CACT,C,gBCvIe,MAAMW,GAKnB7vB,YACE6T,EACAwC,GACA,KAPFA,qBAAe,OACftC,cAAQ,OACRmb,eAAS,EAMP5uB,KAAKyT,SAAWF,EAAgBE,SAChCzT,KAAK+V,gBAAkBA,CACzB,CAEAyZ,mBACExvB,KAAKyT,SAAS0P,gBAAgBU,QAAQ,CAAEhP,GAAI,gBAC9C,CASA4a,gBACEC,EACAC,EACAC,GAEA,IAAK5vB,KAAKyT,SAAS0P,gBAEjB,YADA9b,QAAQC,KAAK,0DAIf,MAAM,MAAE4f,EAAK,QAAEgH,EAAO,OAAEE,EAAM,MAAEN,EAAK,cAAED,GAAkB6B,EAEzDroB,QAAQiH,IAAI,qBAAsBwf,GAClC,MAAMa,EAAQkB,GACZhC,GAAiB6B,EACjBxI,EACA4G,EACAM,GAGFpuB,KAAKyT,SAAS0P,gBAAgBU,QAAQ,CAAEhP,GAAI,iBAC5C7U,KAAKyT,SAAS0P,gBAAgBE,OAAO,CACnCxO,GAAI,eACJ0O,aAAa,EACbuM,kBAAkB,EAClBC,cAAc,EACdC,gBAAiBT,GAAsBU,oBACrCL,EACA1I,GAAOiI,OACPQ,GAEFzI,QACAzP,QAASyY,GAAAA,EAITC,eAAgBA,IACdnwB,KAAKyT,SAAS0P,gBAAgBU,QAAQ,CAAEhP,GAAI,iBAE9C8C,aAAc,CACZgX,QACAd,gBACAC,QACA5G,QACAgH,UACAkC,UAAWlJ,GAAOiI,OAElB1G,QAASA,KACPzoB,KAAKyT,SAAS0P,gBAAgBU,QAAQ,CAAEhP,GAAI,gBAAiB,EAS/Dwb,cAAeA,CAAC1rB,EAAMuqB,EAASlB,KACxBkB,EAAQhB,QAIbluB,KAAKyvB,gBACH,IACKC,EACHtB,OAAQc,EAAQhB,SAElByB,EACAC,GATAvoB,QAAQC,KAAK,yBAA0B3C,EAAMuqB,EAASlB,EAUvD,EAIHsC,UAAWA,CAAC3rB,EAAMuqB,EAASlB,KACzBhuB,KAAK+V,gBAAgBwa,IAAI5rB,EAAM,IAC1BkpB,KACAqB,EACHlB,YACA,IAIV,EA1GmBuB,GA4GZiB,mBAAqB,KACnB,CACLC,EAAG,EACHC,EAAG,IA/GYnB,GAmHZoB,yBAA2BC,IAAe,CAC/CH,EAAGG,GAAeA,EAAYC,cAAclxB,OAAO,GACnD+wB,EAAGE,GAAeA,EAAYC,cAAclxB,OAAO,KArHlC4vB,GAwHZuB,2BAA6B1B,IAClC,GAAIA,EAAS,CACX,MAAM2B,EAAqB3B,EAAQ4B,wBACnC,MAAO,CACLP,EAAGM,EAAmBN,EACtBC,EAAGK,EAAmBL,EAE1B,CAEA,MAAO,CACLD,OAAGr1B,EACHs1B,OAAGt1B,EACJ,EApIgBm0B,GAuIZ0B,yBAA2B,WAA0B,IAAzBC,EAAMz1B,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,GAAI2zB,EAAO3zB,UAAA3B,OAAA,EAAA2B,UAAA,QAAAL,EACrD,MAAM+1B,EAAY5B,GAAsBuB,2BAA2B1B,GAEnE,IAAK,IAAIgC,EAAa,EAAGA,EAAaF,EAAOp3B,OAAQs3B,IAAc,CACjE,MAAMC,EAAQ,CACZZ,EAAGS,EAAOE,GAAY,IAAMF,EAAOE,GAAe,EAClDV,EAAGQ,EAAOE,GAAY,IAAMF,EAAOE,GAAe,GAEpD,GACE7B,GAAsB+B,iBAAiBD,IACvC9B,GAAsB+B,iBAAiBH,GAEvC,MAAO,CACLV,EAAGY,EAAMZ,EAAIU,EAAUV,EACvBC,EAAGW,EAAMX,EAAIS,EAAUT,EAG7B,CACF,EAzJmBnB,GA2JZ+B,iBAAoBC,GAEvBA,GAA8B,iBAAbA,EAAOd,GAAsC,iBAAbc,EAAOb,EA7JzCnB,GAoKZU,oBAAsB,CAACuB,EAAcZ,EAAaa,KAWvD,MAAMC,EAVN,kBACQnC,GAAsB0B,yBAC1BO,EACAC,SAEIlC,GAAsBoB,yBAAyBC,SAC/CrB,GAAsBuB,2BAA2BW,SACjDlC,GAAsBiB,oBAC9B,CAEyBmB,GAEzB,IAAIvT,EAAUsT,EAAiBhxB,OAC3BkxB,EAAWxT,EAAQtiB,MAEvB,MAAQsiB,EAAQzd,MACdixB,EAAWxT,EAAQtiB,MAEfyzB,GAAsB+B,iBAAiBM,IACzCF,EAAiBjD,SAEnBrQ,EAAUsT,EAAiBhxB,OAG7B,OAAOkxB,CAAQ,EC7MnB,MA8BA,GA9B2B,CACzB/c,GAAI,0BACJgd,kBAAmB,mBACnB/D,MAAO,CAEL,CACEjZ,GAAI,yBACJyZ,SAAUjwB,IAAA,IAAC,eAAEyzB,GAAgBzzB,EAAA,QAAOyzB,CAAc,EAClDnD,MAAO,CACL,CACEpV,MAAO,qBACPgU,SAAU,CACR,CACEC,YAAa,uBAInB,CACEjU,MAAO,YACPgU,SAAU,CACR,CACEC,YAAa,6B,uCChB3B,MAIMuE,GAA0B,CAAEC,QAAU,UACtCC,GAAW,CACfC,kBAAoB,SACjBH,IAGL,SAASI,GAAa9zB,GAA0C,IAAzC,OAAE+zB,EAAM,MAAEC,EAAK,WAAEC,EAAU,SAAEC,GAAUl0B,EAC5D,OACEsW,GAAAA,cAAA,OACEM,UAAWud,KACT,2EAEFzX,MAAOgX,IAEPpd,GAAAA,cAAA,OAAKM,UAAU,eACbN,GAAAA,cAAA,SACE8d,IAAKL,EACLnd,UAAU,4DAEVN,GAAAA,cAAA,QAAMM,UAAU,iDAAgD,SAKpEN,GAAAA,cAAA,OAAKM,UAAU,eACbN,GAAAA,cAAA,SACE8d,IAAKJ,EACLpd,UAAU,4DAEVN,GAAAA,cAAA,QAAMM,UAAU,iDAAgD,QAKpEN,GAAAA,cAAA,OAAKM,UAAU,eACbN,GAAAA,cAAA,SACE8d,IAAKH,EACLrd,UAAU,4DAEVN,GAAAA,cAAA,QAAMM,UAAU,iDAAgD,aAKpEN,GAAAA,cAAA,OAAKM,UAAU,oBACbN,GAAAA,cAAA,SACE8d,IAAKF,EACLtd,UAAU,4DAEVN,GAAAA,cAAA,QAAMM,UAAU,iDAAgD,WAO1E,CAiKA,SA/JA,SAAsBxK,GAAW,IAAV,KAAE2hB,GAAM3hB,EAC7B,MAAMioB,GAAUtV,EAAAA,GAAAA,UACVuV,GAAYvV,EAAAA,GAAAA,WAEXwV,EAAeC,IAAoBjf,EAAAA,GAAAA,UAAS,OAC5Ckf,EAAcC,IAAmBnf,EAAAA,GAAAA,UAAS,OAC1Cof,EAAmBC,IAAwBrf,EAAAA,GAAAA,UAAS,OACpDsf,EAAiBC,IAAsBvf,EAAAA,GAAAA,UAAS,OA6BvDM,EAAAA,GAAAA,YAAU,KACHwe,GAAStU,UAIdsU,EAAQtU,QAAQgV,SAAS,GACzBV,EAAQtU,QAAQiV,gBAAgB,GAAE,GACjC,CAACjH,KAKJlY,EAAAA,GAAAA,YAAU,KACR,MAAMof,EAAkBzO,MACtB,IAAM6N,EAAQtU,QAAQiV,gBAAgB,IACtC,KAKF,OAFA1gB,OAAOia,iBAAiB,SAAU0G,GAE3B,KACLA,EAAgB1N,SAChBjT,OAAOka,oBAAoB,SAAUyG,EAAgB,CACtD,GACA,IAEH,MAAMC,GAAMC,EAAAA,GAAAA,cACVvlB,IAAsB,IAArB,MAAET,EAAK,MAAEuN,GAAO9M,EACf,MAAMwlB,EAAMrH,EAAK5e,GAEjB,OACEmH,GAAAA,cAAA,OACEoG,MAAO,IAAKA,KAAUkX,IACtBhd,UAAWud,KACT,wIAnIiB,kBAsInBr0B,IAAM,eAAcqP,KAEpBmH,GAAAA,cAAA,OAAKM,UAAU,eAAewe,EAAI,IAClC9e,GAAAA,cAAA,OAAKM,UAAU,eAAewe,EAAI,IAClC9e,GAAAA,cAAA,OAAKM,UAAU,eAAewe,EAAI,IAClC9e,GAAAA,cAAA,OAAKM,UAAU,oBAAoBwe,EAAI,IACnC,GAGV,CAACrH,IAOGsH,GAAmBF,EAAAA,GAAAA,cAAY,IAAwB,OAAlBZ,GAAwB,CACjEA,IAQIe,GAAcH,EAAAA,GAAAA,cAClBhmB,IACE,MAAMomB,EAAe,CACnBhB,EAAciB,YACdf,EAAae,YACbb,EAAkBa,YAClBX,EAAgBW,aAGZ/Y,EAAU6X,EAAUvU,QAAQ0V,WAAW,MAG7C,OAFAhZ,EAAQiZ,KAAOC,iBAAiBrB,EAAUvU,SAAS2V,KAE5C3H,EAAK5e,GACT5L,KAAI,CAACqyB,EAASzmB,KACb,MAAM0mB,EAAkBpZ,EAAQqZ,YAAYF,GAASG,MAErD,OAhLW,GA+KMlW,KAAKmW,KAAKH,EAAkBN,EAAapmB,IAGxD,GA/Kc,CAgLG,IAGpB8mB,QAAO,CAACC,EAAWC,IAActW,KAAKkG,IAAImQ,EAAWC,IAAW,GAErE,CAACpI,EAAM4G,EAAmBJ,EAAeM,EAAiBJ,IAG5D,OACEne,GAAAA,cAAA,WACEA,GAAAA,cAAA,UACEoG,MAAO,CAAE0Z,WAAY,SAAU7C,SAAU,YACzC3c,UAAU,YACVwd,IAAKE,IAEPhe,GAAAA,cAACwd,GAAa,CACZC,OAzHSsC,IACTA,GACF7B,EAAiB6B,EACnB,EAuHIrC,MArHQqC,IACRA,GACF3B,EAAgB2B,EAClB,EAmHIpC,WAjHaoC,IACbA,GACFzB,EAAqByB,EACvB,EA+GInC,SA7GWmC,IACXA,GACFvB,EAAmBuB,EACrB,IA4GE/f,GAAAA,cAAA,OACEM,UAAU,iDACV8F,MAAO,CAAEC,OAAQ,UAEhB0Y,KACC/e,GAAAA,cAACggB,GAAAA,GAAI,CACHlC,IAAKC,EACL1X,OAAQ,IACR4Z,UAAWxI,EAAKtyB,OAChB+6B,SAAUlB,EACVS,MAAO,OACPnf,UAAU,kBAETse,IAMb,GCrNQ/I,SAAQA,IAAKjiB,EAAAA,SACbP,oBAAmBA,IAAKtG,EAAAA,QAAAA,MAC1B,QAAEozB,IAAY9sB,GAoLpB,SAAS+sB,GAAyBC,EAAMpqB,GACtC,MAAMwhB,EAAO,GA8Cb,OA5CA4I,EAAKh7B,SAAQi7B,IACX,GAAmB,OAAfA,EAAQxvB,GAAa,CACvB2mB,EAAKlyB,KAAK,CACP,GAAE+6B,EAAQC,YAAYD,EAAQzuB,MAC/ByuB,EAAQxvB,GACRwvB,EAAQE,QACR,KAGF,MAAM,OAAEtoB,GAAWooB,EAEnBpoB,EAAO7S,SAAQ,CAAC2K,EAAM6I,KACpB,MAAM4nB,EAAuBL,GAAyBpwB,EAAMiG,GAE5DwhB,EAAKlyB,KAAK,CACP,GAAEyK,EAAK,GAAGuwB,uBACX,GACC,SAAQ1nB,IACT,KAGF4e,EAAKlyB,QAAQk7B,EAAqB,GAEtC,KAAO,CACL,GAAmB,OAAfH,EAAQxvB,GACV,IACE,MAAMe,EAAM9E,EAAAA,QAAAA,KAAAA,IAAAA,YAA2BuzB,EAAQzuB,KAAK6uB,gBAC9CC,EAAkB1qB,EAASpE,GACjCyuB,EAAQxvB,GAAK6vB,EAAgB7vB,EAC/B,CAAE,MAAO+X,GACPnW,QAAQmW,MACL,iDAAgDyX,EAAQE,WAE7D,CAEF/I,EAAKlyB,KAAK,CACP,GAAE+6B,EAAQC,YAAYD,EAAQzuB,MAC/ByuB,EAAQxvB,GACRwvB,EAAQE,QACRF,EAAQn5B,OAEZ,KAGKswB,CACT,CAWA,SAASmJ,GAAQ3qB,GAAqB,IAAX4qB,EAAK/5B,UAAA3B,OAAA,QAAAsB,IAAAK,UAAA,GAAAA,UAAA,GAAG,EAGjC,MAAMg6B,EAAWx3B,OAAOC,KAAK0M,GAE7B,IAAIsqB,EAAY,GAEhB,IAAK,IAAIzkB,EAAI,EAAGA,EAAI+kB,EAAO/kB,IACzBykB,GAAa,IAGXM,EAAQ,IACVN,GAAa,KAGf,MAAM9I,EAAO,GACb,IAAK,IAAI3b,EAAI,EAAGA,EAAIglB,EAAS37B,OAAQ2W,IAAK,CACxC,IAAI0kB,EAAUM,EAAShlB,GAEvB,GAAgB,WAAZ0kB,EACF,SAGF,MAAMF,EAAUH,GAAQK,GAExB,IAAIr5B,EAAQ8O,EAASuqB,GAErB,GAAIF,GAA0B,OAAfA,EAAQxvB,GAAvB,CACE,MAAMiwB,GAoGKC,EApGqB75B,EAqG7B8B,MAAMC,QAAQ83B,GAAiBA,EAAgB,CAACA,IAjG7CC,EAAW,CACfpvB,IAAKyuB,EAAQzuB,IACb0uB,YACAzvB,GAAIwvB,EAAQxvB,GACZ0vB,UACAtoB,OAAQ,IAKV,GAFAuf,EAAKlyB,KAAK07B,GAEI,OAAV95B,EAEF,SAGF45B,EAAgB17B,SAAQ2K,IACtB,MAAMkxB,EAAeN,GAAQ5wB,EAAM6wB,EAAQ,GAEvCK,EAAa/7B,SAEfg8B,GAAaD,GACbD,EAAS/oB,OAAO3S,KAAK27B,GACvB,GAIJ,MAuCA,GArCIj4B,MAAMC,QAAQ/B,IACZA,EAAMhC,OAAS,GAAwB,iBAAZgC,EAAM,KACnCA,EAAQA,EAAMH,KAAK,OAIF,iBAAVG,IACTA,EAAQA,EAAM4e,YAGK,iBAAV5e,IACK,OAAVA,EACFA,EAAQ,IAEa,iBAAVA,EACLA,EAAM+K,aACR/K,EAAQ,gBACCA,EAAMyL,YACfzL,EAAS,gBACAA,EAAM+I,WACf/I,EAAQA,EAAM+I,YAEdwC,QAAQC,KAAM,uBAAsBxL,SAAaq5B,MACjD9tB,QAAQC,KAAKxL,GACbA,EAAQ,MAGVuL,QAAQC,KAAM,uBAAsBxL,SAAaq5B,MACjDr5B,EAAQ,MAQdq5B,EAAUA,EAAQr3B,QAAQ,WAAY,IAClCm3B,EACF7I,EAAKlyB,KAAK,CACRsM,IAAKyuB,EAAQzuB,IACb0uB,YACAzvB,GAAIwvB,EAAQxvB,GACZ0vB,UACAr5B,cAEG,CAEL,MAAMi6B,EAAQ,kBACd,GAAIZ,EAAQa,MAAMD,GAAQ,CACxB,MAAMvvB,EAAO,IAAG2uB,EAAQpwB,UAAU,EAAG,MAAMowB,EAAQpwB,UAAU,EAAG,MAChEqnB,EAAKlyB,KAAK,CACRsM,MACA0uB,YACAzvB,GAAI,GACJ0vB,QAAS,cACTr5B,SAEJ,CACF,CACF,CASF,IAAiB65B,EAPf,OAAOvJ,CACT,CAUA,SAAS0J,GAAaG,GACpBA,EAAQpkB,MAAK,CAACoZ,EAAGC,IACXD,EAAEzkB,IAAM0kB,EAAE1kB,KACJ,EAGH,GAEX,CAEA,SA3XwBnI,IAA4C,IAA3C,YAAE0e,EAAW,sBAAEkB,GAAuB5f,EAO7D,MAAM63B,EAA8C,IAAInkB,IAAI,CAAC,KAG3DokB,EACAC,IACExiB,EAAAA,GAAAA,UAASqK,IACN4N,EAAgBwK,IAAqBziB,EAAAA,GAAAA,UAAS,IAC9C0iB,EAAaC,IAAkB3iB,EAAAA,GAAAA,UAAS,IAOzC4iB,GAAiBpZ,EAAAA,GAAAA,QAAO,MAExBqZ,EAAmB1Z,EAAYrY,MACnC0a,GAAMA,EAAGnB,wBAA0BkY,IAG/BO,EAA6BD,aA+UNjM,GA9U7B,MAAMmM,EAAmBD,GAAgBD,EAAiB3oB,OAAOhU,OAAS,EAEpE88B,GAAiBC,EAAAA,GAAAA,UAAQ,KAC7B9Z,EAAYlL,MAAK,CAACoZ,EAAGC,IAAMD,EAAE3e,aAAe4e,EAAE5e,eACvCyQ,EAAYnb,KAAIiM,IACrB,MAAM,sBACJoQ,EAAqB,WACrB9L,EAAU,WACV5F,EAAU,aACVD,EAAY,kBACZD,EAAiB,SACjBI,GACEoB,EAGEipB,EAAW,GAAE3kB,KAAc5F,IAAa6G,MAAM,KAAK,GAIzD,MAAO,CACLtX,MAAOmiB,EACP1E,MAAQ,GAAEjN,MAAiBG,OAAcJ,IACzCzR,YANWm8B,KAAOD,EAAS,mBACJE,OAAO,oBAM/B,MAEF,CAACja,IAEEqP,GAAOyK,EAAAA,GAAAA,UAAQ,KACnB,IAAIjsB,EAEFA,EADE8rB,EACSD,EAAiB3oB,OAAO+d,EAAiB,GAEzC4K,EAAiBn4B,UAAYm4B,EAE1C,MAAMzB,EAsKV,SAAuBpqB,GACrB,MAAMqrB,EAAUV,GAAQ3qB,GAKxB,OAFAkrB,GAAaG,GAENA,CACT,CA7KiBgB,CAAcrsB,GAC3B,OAAOmqB,GAAyBC,EAAMpqB,EAAS,GAC9C,CAACihB,EAAgBsK,IAEde,GAAeL,EAAAA,GAAAA,UAAQ,KAC3B,IAAKP,EACH,OAAOlK,EAGT,MAAM+K,EAAuBb,EAAY1wB,cACzC,OAAOwmB,EAAKnoB,QAAOwvB,GACVA,EAAIa,QAAO,CAAC8C,EAASC,EAAKC,IAC3BF,IAKAlB,EAA+BrzB,IAAIy0B,GAC9BF,EAGFA,GAAWC,EAAIzxB,cAAc0Z,SAAS6X,MAC5C,IACH,GACD,CAAC/K,EAAMkK,IAEJiB,GAA0BV,EAAAA,GAAAA,UAAQ,IAC/BhS,KAAS0R,EAAgB,MAC/B,IAQH,OANAriB,EAAAA,GAAAA,YAAU,IACD,KACLqjB,GAAyB3R,QAAQ,GAElC,IAGDjR,GAAAA,cAAA,OAAKM,UAAU,6BACbN,GAAAA,cAAA,OAAKM,UAAU,wCACbN,GAAAA,cAAA,OAAKM,UAAU,oCACbN,GAAAA,cAAC6iB,GAAAA,GAAU,CAACC,QAAQ,WAAWxiB,UAAU,QAAO,UAGhDN,GAAAA,cAAA,OAAKM,UAAU,aACbN,GAAAA,cAACgU,GAAAA,GAAM,CACL9T,GAAG,uBACHmU,aAAa,EACb/B,SA7FWnrB,IACrBs6B,EAAiCt6B,EAAMA,OACvCu6B,EAAkB,EAAE,EA4FV76B,QAASo7B,EACT96B,MAAO86B,EAAelyB,MACpB0a,GAAMA,EAAGtjB,QAAUq6B,IAErBlhB,UAAU,iBAIhBN,GAAAA,cAAA,OAAKM,UAAU,oCACZ0hB,GACChiB,GAAAA,cAAC6iB,GAAAA,GAAU,CAACC,QAAQ,WAAWxiB,UAAU,QAAO,mBAIjD0hB,GACChiB,GAAAA,cAAA,OAAKM,UAAU,QACbN,GAAAA,cAAC+iB,GAAAA,GAAU,CACT57B,MAAO+vB,EACP1tB,IAAKg4B,EACLlP,SAAUnrB,IACRu6B,EAAkBlL,SAASrvB,GAAO,EAEpC67B,SAAU,EACVC,SAAUnB,EAAiB3oB,OAAOhU,OAClC+9B,KAAM,EACNC,eAAe,SACfC,cAAc,OACdC,WAAY,eAMtBrjB,GAAAA,cAAA,OAAKM,UAAU,wBACfN,GAAAA,cAAA,OAAKM,UAAU,4BAEbN,GAAAA,cAAA,SAAOM,UAAU,8BACfN,GAAAA,cAAA,QAAMM,UAAU,oDACdN,GAAAA,cAACsjB,GAAAA,GAAI,CAACzoB,KAAK,iBAEbmF,GAAAA,cAAA,SACE8d,IAAK+D,EACLpvB,KAAK,OACL6N,UAAU,mRACV4T,YAAY,qBACZ5B,SAAUC,GAASqQ,EAAwBrQ,EAAME,OAAOtrB,OACxDo8B,aAAa,QAEfvjB,GAAAA,cAAA,QAAMM,UAAU,qDACdN,GAAAA,cAACsjB,GAAAA,GAAI,CACHzoB,KAAK,mBACLyF,UAAWud,KACT,iBACA8D,EAAc,GAAK,UAErB9e,QAASA,KACPgf,EAAepY,QAAQtiB,MAAQ,GAC/By7B,EAAwB,GAAG,OAMrC5iB,GAAAA,cAACwjB,GAAa,CAAC/L,KAAM8K,IACjB,ECnHV,GA1D0BkB,CACxB1jB,EACAwC,EACAmhB,KAEA,MAAM,oBAAE/b,EAAmB,UAAEtG,EAAS,OAAEsiB,GAAW5jB,EAC7C6jB,EAASrhB,EAAuBshB,YAChC,WAAEC,EAAU,WAAEC,EAAU,eAAEC,GAAmBJ,GAC7C,SAAE5L,GAAazV,EAAuB0hB,oBACtCC,EAAQlM,EAASmM,OAAOJ,GACxBK,EAAW,GAAEJ,KAAkBF,KAAcC,IAC7CM,EAAYX,EAAYG,WACxBS,EAAW,GAAEN,KAAkBF,IAC/BS,EAAoB,IAAKF,EAAUE,mBACnCC,EAA+B,IAChCH,EAAUG,8BAETC,EAAwB,IAAKJ,EAAUI,wBACvC,KAAEhN,EAAI,QAAEC,GAAYwM,EAAMQ,kBAAkBC,WAC5CC,EACJV,EAAM7iB,UAAUlc,SAAW4a,EAAMsB,UAAUlc,QAC3C4a,EAAM4jB,OAAOkB,UAAYpN,GACzB1X,EAAM4jB,OAAOmB,UAAYpN,EAE3B8M,EAA6BF,GAAWV,EAEpCQ,GAAWQ,IACbL,EAAkBH,GAAW,IAAKrkB,IAGpC,IAAK,IAAIglB,EAAM,EAAGA,EAAMhlB,EAAMsB,UAAUlc,OAAQ4/B,IAAO,CACrD,MAAMC,EAAWjlB,EAAMsB,UAAU0jB,IAC3B,kBAAEE,EAAiB,uBAAEna,GAA2Bka,EACtD,GAAKC,EACL,IAAK,IAAInpB,EAAI,EAAGA,EAAImpB,EAAkB9/B,OAAQ2W,IAAK,CACjD,MAAMopB,EAAgBpa,EAAuBhP,GACxCopB,IACDH,IAAQpd,GAA6B,IAAN7L,IACjC2oB,EACG,GAAET,wBACDkB,GAEFD,EAAkBnpB,IAAIoE,KACxBukB,EACG,GAAET,KAAkBiB,EAAkBnpB,GAAGoE,MAAM+kB,EAAkBnpB,GAC/DqpB,yBAA2B,KAC5BD,GAER,CACF,CAEA,MAAO,CACLV,+BACAD,oBACAE,wBACD,ECvDUW,GAAuBA,CAClC7iB,EACA8iB,EACAna,EACAoa,EACAz+B,KAEA,MAAM0+B,EAAqBF,IAAsBC,GACjD,GAAIC,EAAoB,MAAO,IAAKA,GACpC,MAAM,WAAEzB,EAAU,WAAEC,GAAexhB,EAAuBshB,WAGrDh9B,EAAQ2+B,YACX3+B,EAAQ2+B,UAAY,IAAIH,EAAoBI,mBAG9C,MAAMC,EAAUnjB,EAAuBojB,mBACrC7B,EACAC,EACAl9B,GAEF,GAAI6+B,EAAS,CACX,MAAM5a,EAAyB4a,EAAQE,gBAAgB34B,KACrD+b,GAAMA,EAAGM,wBAGX,OADAziB,EAAQ2+B,UAAUjgC,QAAQulB,GACnB,CACLA,yBACAma,kBAAmBS,EAAQE,gBAAgB34B,KACzC+b,GAAMA,EAAGic,oBAEXY,gBAAiB,IACZH,EAAQG,iBAGjB,CACA,MAAO,CAAC,CAAC,EAqDX,GAzCgCC,CAC9B/lB,EAAKrW,EAELg6B,KAC4C,IAF5C,QAAEmB,EAAO,QAAEC,GAASp7B,EAGpB,MAAM,UAAE2X,GAActB,EAEhBslB,EAAsB,IADV3B,EAAYG,WACawB,qBACrCI,EAAmB,GAEzB,IAAK,MAAMT,KAAY3jB,EACrB,GAAI2jB,EAASM,WAAY,CACvB,MAAMS,EAAiB,IAClBf,EACHa,gBAAiB,IAAKb,EAASa,kBAEjCR,EAAoBL,EAASM,YAAcS,SAGpCA,EAAeC,kBACfD,EAAeF,gBAAgBG,UACxC,CAGF,IAAK,IAAIlH,EAAM,EAAGA,EAAM+F,EAAS/F,IAC/B,IAAK,IAAI4D,EAAM,EAAGA,EAAMoC,EAASpC,IAAO,CACtC,MAAMuD,EAAMvD,EAAM5D,EAAMgG,EAElBE,EAAWK,EADEhkB,IAAY4kB,IAAMX,YAAe,GAAE5C,KAAO5D,KAEzDkG,GAAUla,wBACZ2a,EAAiBlgC,QAAQy/B,EAASla,uBAEtC,CAMF,OAFAua,EAAoBI,iBAAmBA,EAEhC,CAAEJ,sBAAqB,E,gBCtFhC,MAAM,kCAAEa,IAAsCpgC,EAAAA,QAmBxCqgC,GAA2BC,GAC/BA,IACyB,uBAAxBA,EAAQvN,aACiB,0BAAxBuN,EAAQvN,aAisBZ,GA/rBuBnvB,IAGkD,IAHjD,gBACtBkV,EAAe,gBACfwC,GACiC1X,EACjC,MAAM,qBACJ28B,EAAoB,mBACpBvW,EAAkB,uBAClBvN,EAAsB,sBACtBkF,EAAqB,oBACrBG,EAAmB,kBACnBJ,EAAiB,iBACjB8e,EAAgB,eAChBznB,GACGD,EAAoCE,SAGnCynB,EAAwB,IAAI3L,GAChChc,EACAwC,GAGIuR,EAAU,CASdmI,gBAAkBj0B,IAChB,MAAM,oBACJ2/B,EAAmB,QACnB/L,EAAO,MACPlI,EAAK,cACL2G,EAAa,sBACb+B,EAAwB,IACtBp0B,EAEE4/B,EAAe,IAAK5/B,GAEtB2/B,GACFl9B,OAAO4U,OACLuoB,EACAJ,EAAqBl4B,IAAIq4B,EAAqBE,KAKlD,MAAM,SAAE1O,EAAQ,MAAEkM,GAAU3hB,EAAuB0hB,oBACnDwC,EAAavN,cAAgB,CAC3B3G,QACAyF,WACAkM,WACGhL,GAGLqN,EAAsBzL,gBACpB2L,EACAhM,EACAQ,EACD,EAIHJ,iBAAkBA,KAChB0L,EAAsB1L,kBAAkB,EAG1C8L,oBAAqB7wB,IAA2B,IAA1B,KAAE8c,EAAI,MAAEjQ,EAAK,KAAElQ,GAAMqD,EACzC2R,EAAsBvF,KAAK,CACzBS,MAAOA,EACPyI,QAASwH,EACTngB,KAAMA,GACN,EAEJsgB,kBAAmBA,KACjBjD,EAAmB8W,OAAO,EAO5BC,cAAeA,KACb,MAAM,SACJ7O,EACA+L,WAAY+C,EAAgB,MAC5B5C,GACE3hB,EAAuB0hB,oBACrB8C,EAAiBC,IACrB,IAAKA,EAAO9mB,GAAI,OAChB,MAAM,SAAE0Y,EAAQ,MAAEoB,GAAUgN,EAAOtO,OAASsO,EACxChN,GACFA,EAAM30B,QAAQ0hC,GAEhB,MAAME,EAAYrO,GAAU7oB,OAAOo2B,IACnC,IAAKc,EAAW,OAChB,MAAM,WAAEnD,EAAU,WAAEC,EAAU,QAAEmD,GAAYD,EAAUnO,eAChDzY,IACFyjB,GAAcA,IAAe9L,EAAS9X,SACxBzZ,IAAfs9B,GAA4BA,IAAe+C,GAC1CI,GAAWA,IAAYhD,EAAMhkB,IACjCrB,EAAesoB,UAAUH,EAAO9mB,GAAIG,EAAS,EAE/C/W,OAAO4O,OAAO2G,EAAeuoB,cAAc/hC,QAAQ0hC,EAAe,EA2BpEM,mBAAoB/tB,IAMkB,IANjB,eACnB0qB,EAAiB,GAAE,WACnBF,EAAU,QACVoD,EAAO,WACPnD,EAAU,MACVuD,GAAQ,GACchuB,EACtB,IAIE,MAAMyG,EAAQ6H,EAAoBic,WAC5BD,EAASrhB,EAAuBshB,YAEpC7L,SAAUuP,GACRhlB,EAAuB0hB,oBACrBuD,EAAkBC,GACtB1nB,EACAwC,EACA+jB,IAEI,6BACJ9B,EAA4B,kBAC5BD,EAAiB,sBACjBE,GACE+C,EAEJ,GAAK1D,GAME,QAAmBr9B,IAAfs9B,QAAwCt9B,IAAZygC,EAAuB,CAE5D,MAAMQ,EAAa,GAAE1D,GACnBJ,EAAOI,kBAAkBF,IAC3BC,EAAaS,EAA6BkD,IAAY3D,UACxD,OATED,EAAaF,EAAOE,gBACJr9B,IAAZygC,QAAwCzgC,IAAfs9B,IAC3BA,EAAaH,EAAOG,YASxB,MAAM4D,EACJ5D,GACAxhB,EAAuBqlB,cAAc9D,EAAY,CAC/CoD,UACAnD,eAGAC,GACFzhB,EAAuBslB,kBAAkB7D,GAG3C,MAAM8D,EAAiB,GACrBvlB,EAAuBshB,WAAWG,kBAChCF,KAAc6D,GAAe,IAE3BI,GAAmBT,GAAS/C,EAAkBuD,GAkCpD,GA/BEhE,IAAeF,EAAOE,YACtB6D,IAAgB/D,EAAOG,YACtBC,GAQDzhB,EAAuBylB,YAAYlE,EAAY,CAC7CW,wBACAyC,UACAnD,WAAY4D,EACZI,oBAEEA,GACFngB,EAAoBjZ,IAAI41B,EAAkBuD,KAZ5CvlB,EAAuBylB,YAAYlE,EAAY,CAC7CoD,UACAnD,WAAY4D,WAiBTlD,EACJ,GAAET,GAAkBJ,EAAOI,qCAE9BsC,EAAiBjwB,MAAMmxB,GAEvB7U,EAAQkU,cAActkB,EAAuB0hB,qBAEzCH,IAAeF,EAAOE,WAAY,CACpC,MAAM,SAAE9L,GAAazV,EAAuB0hB,oBAG5C7iB,EAAgBwa,IAAI2L,EAAYU,WAAWC,gBAG3C9mB,EAAgBwa,IAAI5D,EAASiQ,WAAWE,gBAC1C,CACA,OAAO,CACT,CAAE,MAAOr8B,GAQP,OAPA6mB,EAAQkU,cAActkB,EAAuB0hB,qBAC7Cxc,EAAsBvF,KAAK,CACzBS,MAAO,yBACPyI,QAAS,6CACT3Y,KAAM,QACN4Y,SAAU,OAEL,CACT,GAGF+c,sBAAuBxW,IAGe,IAHd,WACtBkS,EAAU,WACVC,GACsBnS,EACtB,MAAM,SACJoG,EACA+L,WAAYsE,EAAiB,YAC7BC,GACE/lB,EAAuB0hB,qBACrB,sBAAEmE,GAA0B9B,EAAiBzC,WAC7CiE,EAAiB,GACrBQ,EAAYl/B,oBACV06B,KAA2B,EAAbC,IAClB,GACE/L,EAAS9X,KAAO4jB,QACAr9B,IAAfs9B,GAA4BA,IAAesE,EAiB5C,OATA/B,EAAiBjwB,MAAM,CACrB+xB,sBAAuB,IAClBA,EACH,CAACN,GAAgB,CACfhE,WAAY9L,EAAS9X,GACrB6jB,WAAYsE,MAIX1V,EAAQ0U,mBAAmB,CAChCvD,aACAC,aACAuD,OAAO,IAnBT,CAEA,MAAMiB,EAAgBH,EAAsBN,IAAkB,CAC5DhE,WAAY,WAEd,OAAOnR,EAAQ0U,mBAAmBkB,EACpC,CAeA,EAGFC,WAAYvW,IAAmB,IAAlB,UAAEwW,GAAWxW,EACxB,MAAM,WACJ6R,EACAC,WAAY2E,GACVnmB,EAAuBshB,YACrB,SAAE7L,GAAazV,EAAuB0hB,oBAC5C,IACE,IAAIF,EAAa2E,EAAgBD,EACjC1E,GAAc,GAAKA,EAAa/L,EAASmM,OAAOh/B,OAChD4+B,GAAc0E,EAEd,GAA2C,aAAvCzQ,EAASmM,OAAOJ,GAAYjqB,OAC9B,OAAO6Y,EAAQ0U,mBAAmB,CAChCvD,aACAC,eAINtc,EAAsBvF,KAAK,CACzBS,MAAO,eACPyI,QAAS,qDACT3Y,KAAM,OACN4Y,SAAU,KACV,EAMJsd,sBAAuBxX,IAA0B,IAAzB,QAAE0T,EAAO,QAAEC,GAAS3T,EAC1C,MAAM,SAAE6G,GAAazV,EAAuB0hB,oBACtClL,EAAiBf,EAASiQ,WAAWlP,eAC3C,IAAkE,IAA9D3X,EAAgBwa,IAAI7C,EAAgB,CAAE8L,UAASC,YAQjD,YAPApyB,QAAQiH,IACN,gCACAof,EACA8L,EACAC,GA2BJ9mB,OAAO4qB,YArBgBC,KACrB,MAAM9oB,EAAQ6H,EAAoBic,WAC5BiF,EAAchD,GAClB/lB,EACA,CAAE8kB,UAASC,WACXwB,GAEIlB,EAAuB2D,GAAAA,KAC3B,KACAxmB,EACAumB,EAAYzD,qBAGdzd,EAAoBohB,UAAU,CAC5BnE,UACAC,UACAM,yBAEFkB,EAAiBjwB,MAAMyyB,EAAY,GAGH,EAAE,EAGtCG,cACE,MAAMC,EAAoBthB,EAAoBic,YACxC,oBAAElc,EAAmB,UAAEtG,EAAS,OAAEsiB,GAAWuF,GAC7C,uBACJpe,EAAsB,kBACtBma,EAAiB,gBACjBY,GACExkB,EAAUsG,GAEd,GAAuB,IAAnBgc,EAAOmB,SAAoC,IAAnBnB,EAAOkB,QAAe,CAEhD,MAAM,6BAAEsE,GAAiC7C,EAAiBzC,WAE1D,IAAKsF,EAA6BxF,OAChC,OAIF,MAAMyF,EACJD,EAA6BxhB,oBAMzBsD,EACJH,EAAuB3lB,OAAS,EAC5B,GACA2lB,EACG7d,KAAIqc,GACH/G,EAAuB4I,0BACrBie,EACA9f,KAGH+f,OAKHjE,EAAwBla,IAC5B,MAAM8Z,EAAW/Z,EAAiBlb,MAChCi1B,GAAYA,EAAS9Z,gBAAkBA,IAGzC,OAAO8Z,EACH,CAAEa,kBAAiBZ,uBAAsBD,GACzCmE,EAA6B9nB,UAAU6J,EAAc,EAGrDoe,EAAgB1hB,EAAoB2hB,0BACxCJ,GAIFvhB,EAAoBohB,UAAU,CAC5BnE,QAASsE,EAA6BxF,OAAOkB,QAC7CC,QAASqE,EAA6BxF,OAAOmB,QAC7Cnd,oBAAqByhB,EACrBE,gBACAlE,wBAEJ,KAAO,CAILkB,EAAiBjwB,MAAM,CACrB8yB,6BAA8BD,IAKhC,MAAM9D,EAAuBA,KACpB,CACLta,yBACAma,oBACAY,oBAKJje,EAAoBohB,UAAU,CAC5BnE,QAAS,EACTC,QAAS,EACTM,yBAcFc,GACEte,GARwC4hB,KAExClD,EAAiBjwB,MAAM,CACrB8yB,6BAFmC,CAAC,GAGpC,GAON,CACF,EAoBAM,gBAAgBC,GACdC,GAAAA,EAAAA,SAAiBD,EAAYE,GAAIF,EAAY7iC,QAC/C,EAEAgjC,qBACE,MAAM,oBAAEliB,EAAmB,UAAEtG,GAAcuG,EAAoBic,WACzDiG,EAA6BzoB,EAAUsG,IACvC,uBAAEmD,GAA2Bgf,EAE7B1hB,EAAcZ,EAAkB0B,mBAChC,eAAE6gB,GAAmBnrB,EAAgBE,SAErCwK,EAAwBwB,EAAuB,GACrDif,EAAe7nB,KAAK,CAClBY,QAASknB,GACThnB,aAAc,CACZoF,cACAkB,wBACAwK,QAASiW,EAAe5nB,MAE1BQ,MAAO,qBAEX,EAOAsnB,eAAgBA,KACd,MAAMC,EAAWjmB,SAASkmB,uBAAuB,oBACjD,IAAK,IAAIruB,EAAI,EAAGA,EAAIouB,EAAS/kC,OAAQ2W,IACnCouB,EAASl6B,KAAK8L,GAAGqI,UAAUimB,OAAO,SACpC,EAGFC,8BAA+BA,KAC7B,MAAM,oBAAE1iB,EAAmB,UAAEtG,GAAcuG,EAAoBic,WAE/D,IACGxiB,GACDsG,EAAsB,GACtBA,EAAsBtG,EAAUlc,OAAS,EAEzC,OAGF,MACMmlC,EADiBjpB,EAAUsG,GAEhBmD,uBAAuB,GAElCyf,EAAgBtmB,SAASumB,cAAc,wBAE7C,IAAKD,EACH,OAGF,MAAME,EAAsBF,EAAclO,wBAEpCvyB,EAAYma,SAASumB,cACxB,cAAaF,KAGhB,IAAKxgC,EACH,OAGF,MAAM4gC,EAAkB5gC,EAAUuyB,wBAIhCqO,EAAgBC,KAAOF,EAAoBE,KAC3CD,EAAgBC,KAAOF,EAAoBG,QAK7C9gC,EAAU+gC,eAAe,CAAEC,SAAU,UAAW,EAGlDC,yBAA0BC,IAGY,IAHX,UACzBvC,EAAS,0BACTwC,GAC+BD,EAC/B,MAAME,EAAqB,CACzB,KACA,MACA,KACA,WACA,SACA,UAKIC,EAAW5oB,EAAuB6oB,4BAClCC,EAAqB,IAAI7jB,EAAkB0B,mBAEjDmiB,EAAmBnuB,KAAKiuB,GAExB,MAAM,oBAAExjB,EAAmB,UAAEtG,GAAcuG,EAAoBic,YAEzD,uBAAE/Y,GAA2BzJ,EAAUsG,GAM7C,IAAI2jB,EAEJ,IACEA,EAP4BD,EAAmBE,WAAUryB,GACzD4R,EAAuBH,SAASzR,EAAWoQ,yBAMKmf,EAChD6C,GAAyB,GACzBA,EAAwBD,EAAmBlmC,SAIxC8lC,GACAC,EAAmBvgB,SAClB0gB,EAAmBC,GAAuBxzB,WAL9CwzB,GAAyB7C,GAY3B,GACE6C,EAAwB,GACxBA,GAAyBD,EAAmBlmC,OAE5C,OAGF,MAAM,sBAAEmkB,GAA0B+hB,EAChCC,GAGF,IAAIrgB,EAAmB,GAEvB,IACEA,EAAmB1I,EAAuB4I,0BACxCxD,EACA2B,EAEJ,CAAE,MAAOT,GACPnW,QAAQC,KAAKkW,GACbpB,EAAsBvF,KAAK,CACzBS,MAAO,gCACPyI,QACE,iHACF3Y,KAAM,OACN4Y,SAAU,KAEd,CAEAzD,EAAoB0D,2BAA2BL,GAE/C2d,YAAW,IAAMjW,EAAQ0X,iCAAiC,EAAE,GAI1DmB,EAAc,CAClB1Q,gBAAiB,CACf2Q,UAAW9Y,EAAQmI,iBAErBD,iBAAkB,CAChB4Q,UAAW9Y,EAAQkI,kBAErB9H,kBAAmB,CACjB0Y,UAAW9Y,EAAQI,kBACnB2Y,cAAe,GACf7kC,QAAS,CAAC,GAEZ8/B,oBAAqB,CACnB8E,UAAW9Y,EAAQgU,oBACnB+E,cAAe,GACf7kC,QAAS,CAAC,GAEZwgC,mBAAoB,CAClBoE,UAAW9Y,EAAQ0U,mBACnBqE,cAAe,GACf7kC,QAAS,CAAC,GAEZuhC,sBAAuB,CACrBqD,UAAW9Y,EAAQyV,sBACnBsD,cAAe,GACf7kC,QAAS,CAAC,GAEZ4iC,gBAAiB,CACfgC,UAAW9Y,EAAQ8W,gBACnBiC,cAAe,GACf7kC,QAAS,CAAC,GAEZ8kC,UAAW,CACTF,UAAW9Y,EAAQ6V,WACnBkD,cAAe,GACf7kC,QAAS,CAAE4hC,UAAW,IAExBmD,cAAe,CACbH,UAAW9Y,EAAQ6V,WACnBkD,cAAe,GACf7kC,QAAS,CAAE4hC,WAAY,IAEzBE,sBAAuB,CACrB8C,UAAW9Y,EAAQgW,sBACnB+C,cAAe,GACf7kC,QAAS,CAAC,GAEZoiC,YAAa,CACXwC,UAAW9Y,EAAQsW,YACnByC,cAAe,GACf7kC,QAAS,CAAC,GAEZgjC,mBAAoB,CAClB4B,UAAW9Y,EAAQkX,oBAErBkB,yBAA0B,CACxBU,UAAW9Y,EAAQoY,yBACnBW,cAAe,GACf7kC,QAAS,CAAC,IAId,MAAO,CACL8rB,UACA6Y,cACAK,eAAgB,UACjB,EC/dH,GA7P6C,CAC3CC,6BAA6B,EAC7B5rB,GAAI,eACJja,YAAa,4CACb4U,KAAM,MACNkxB,sBAAuB,CACrB,CACE7rB,GAAI,kBACJ8rB,OAAQ,GACRC,UAAW,gCACXC,WAAY,CACVC,YAAa,KAInBC,aAAc,CAAC,WACfC,oBAAqB,CACnBC,oBAAqB,CACnBC,oBAAqB,CACnB,CACEN,UAAW,iBACXC,WAAY,CACVC,YAAa,CAAEhlC,MAAO,KAK1B,CACE8kC,UAAW,sBACXD,OAAQ,GACRE,WAAY,CACVM,QAAQ,OAMlBC,gBAAiB,CACf5G,gBAAiB,CACf6G,aAAc,QACdC,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,sBACJilB,yBAA0B,KAIhChB,OAAQ,CACN,CACEjkB,GAAI,MACJ2sB,gBAAiB,CACfv0B,QAAS,CACPw0B,oBAAqB,IAGzBpI,kBAAmB,CACjBqI,WAAY,OACZpI,WAAY,CACVlN,KAAM,EACNC,QAAS,IAGbrW,UAAW,CACT,CACEwkB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,yBAIV,CACE2lB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACE+c,wBAAyB,EACzBjlB,GAAI,yBAIV,CACE2lB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACE+c,wBAAyB,EACzBjlB,GAAI,yBAIV,CACE2lB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACE+c,wBAAyB,EACzBjlB,GAAI,2BAQd,CACEA,GAAI,MAEJ8sB,kBAAmB,EACnBC,mBAAoB,EAEpBJ,gBAAiB,CACfv0B,QAAS,CACPw0B,oBAAqB,IAGzBpI,kBAAmB,CACjBqI,WAAY,OACZpI,WAAY,CACVlN,KAAM,EACNC,QAAS,IAGbrW,UAAW,CACT,CACEwkB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,yBAIV,CACE2lB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,sBACJilB,wBAAyB,KAI/B,CACEU,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,sBACJilB,wBAAyB,OAQnC,CACEjlB,GAAI,MACJ8sB,kBAAmB,EACnBC,mBAAoB,EACpBJ,gBAAiB,CACfv0B,QAAS,CACPw0B,oBAAqB,IAGzBpI,kBAAmB,CACjBqI,WAAY,OACZpI,WAAY,CACVlN,KAAM,EACNC,QAAS,IAGbrW,UAAW,CACT,CACEwkB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,yBAIV,CACE2lB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACE+c,wBAAyB,EACzBjlB,GAAI,2BAQd,CACEA,GAAI,MACJ8sB,kBAAmB,EACnBC,mBAAoB,EACpBJ,gBAAiB,CACfv0B,QAAS,CACPw0B,oBAAqB,IAGzBpI,kBAAmB,CACjBqI,WAAY,OACZpI,WAAY,CACVlN,KAAM,EACNC,QAAS,IAGbrW,UAAW,CACT,CACEwkB,gBAAiB,CACf8G,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,4BAOhBgtB,0BAA2B,GChQvBC,GAAkB,CACtBjtB,GAAI,UACJktB,QAAQ,EAIRtB,6BAA6B,EAC7BjxB,KAAM,UACNwyB,YAAa,2BACbC,aAAc,aACdC,YAAa,CAAC,EACdC,WAAY,CAAC,EACbzB,sBAAuB,GACvBK,aAAc,CAAC,WAIfc,yBAA0B,EAG1BT,gBAAiB,CACf5G,gBAAiB,CACf6G,aAAc,QACdC,YAAa,UACbC,oBAAoB,GAEtBxkB,YAAa,CACX,CACElI,GAAI,sBACJilB,yBAA0B,KAIhCkH,oBAAqB,CACnBC,oBAAqB,CAEnBC,oBAAqB,CAGnB,CACEN,UAAW,iBACXC,WAAY,CACVC,YAAa,CAAEhlC,MAAO,KAK1B,CACE8kC,UAAW,sBACXD,OAAQ,GACRE,WAAY,CACVM,QAAQ,OAQlBrI,OAAQ,CACN,CACEtpB,KAAM,UACN6pB,kBAAmB,CACjBqI,WAAY,OACZpI,WAAY,CACVlN,KAAM,EACNC,QAAS,IAGbrW,UAAW,CACT,CACEwkB,gBAAiB,CACf6G,aAAc,QACdC,YAAa,UAGbc,oBAAqB,CACnB7I,OAAQ,wBAQZxc,YAAa,CACX,CACElI,GAAI,0BAKZmtB,YAAa,8BAmBnB,SAdA,WACE,MAAO,CACL,CACExyB,KAAMsyB,GAAgBjtB,GACtB8X,SAAUmV,IAGZ,CACEtyB,KAAM6yB,GAASxtB,GACf8X,SAAU0V,IAGhB,ECxDA,SAhDA,WACE,MAAO/rB,IAAaC,EAAAA,GAAAA,KACdC,GAAWC,EAAAA,GAAAA,MAIX6rB,EAAYhsB,EAAUisB,YAE5B,OACE5tB,GAAAA,cAAA,OAAKoG,MAAO,CAAEqZ,MAAO,OAAQpZ,OAAQ,SACnCrG,GAAAA,cAAA,OAAKM,UAAU,uDACbN,GAAAA,cAAA,OAAKM,UAAU,2EACbN,GAAAA,cAAA,OACEM,UAAU,qBACVutB,IAAI,kBACJC,IAAI,SAEN9tB,GAAAA,cAAA,OAAKM,UAAU,8BACZqtB,EACEr+B,QACC0Z,GACoB,cAAlBA,EAAG+kB,YACe,eAAlB/kB,EAAG+kB,aAEN9gC,KAAIwd,GACHzK,GAAAA,cAAA,OAAKxW,IAAKihB,EAAGsjB,YACX/tB,GAAAA,cAAA,MAAIM,UAAU,cAAcmK,EAAGujB,cAC/BhuB,GAAAA,cAACgO,GAAAA,GAAM,CACL1N,UAAWC,KAAW,YAAa,QACnCsC,QAASA,KACPhB,EAAS,CACP2D,SAAU,IACVpf,OAAS,eAAcqkB,EAAGsjB,cAC1B,GAGHtjB,EAAGsjB,YAEN/tB,GAAAA,cAAA,iBAQlB,E,gBC9CA,MAAMrM,GAAmBwG,EAAAA,QAAAA,QAAAA,iBCFzB,MAAMxG,GAAmBC,EAAAA,QAAAA,iBAmDzB,MAAMq6B,GAAyBn4B,IAA6C,IAA5C,kBAAE3L,EAAiB,iBAAEf,GAAkB0M,EACrE,MAAM,UAAE/P,GAAcoS,EAAAA,QAAAA,UACpB/O,EACAe,GAIF,GAAiB,OADApE,EAAU,GAAG+R,SAE5B,OAEF,MAAMsB,EAAWrT,EAAUkH,KAAItD,GAAYA,EAASkB,UAC9CqjC,EAAwB,GAQ9B,GAPA90B,EAAS/T,SAAQwF,IACf,MAAMsjC,ED5DK,SACbtjC,GAEA,MAAMujC,EAAgBz6B,GAAiBxF,IAAI,WAAYtD,GAEvD,IAAKujC,EACH,MAAM,IAAIniC,MAAM,+BAGlB,QAC+BxF,IAA7B2nC,EAAc5wB,iBACe/W,IAA7B2nC,EAAcx2B,iBACkBnR,IAAhC2nC,EAAcC,oBACmB5nC,IAAjC2nC,EAAcE,qBACU7nC,IAAxB2nC,EAAcG,QACbH,EAAcI,6CAEa/nC,IAD5B2nC,EAAcI,uCAAuC,GAClDC,2BAE0BhoC,IAD7B2nC,EAAcI,uCAAuC,GAClDE,4BAC+BjoC,IAAlC2nC,EAAcO,sBACoBloC,IAAlC2nC,EAAcQ,sBACoBnoC,IAAlC2nC,EAAcS,sBAE0BpoC,IADvC2nC,EAAcI,uCAAuC,GACnDM,uCAEmCroC,IADpC2nC,EAAcI,uCAAuC,GAClDO,6BAEL,MAAM,IAAI9iC,MAAM,iCAGlB,MAAMkiC,EAAqC,CACzCG,eAAgBF,EAAcE,eAC9BC,MAAOH,EAAcG,MACrBE,qBACEL,EAAcI,uCAAuC,GAClDC,qBACLC,sBACEN,EAAcI,uCAAuC,GAClDE,sBACLI,iCACEV,EAAcI,uCAAuC,GAClDM,iCACLC,6BACEX,EAAcI,uCAAuC,GAClDO,6BACLJ,gBAAiBP,EAAcO,gBAC/BN,cAAeD,EAAcC,cAC7B7wB,WAAY4wB,EAAc5wB,WAC1B5F,WAAYw2B,EAAcx2B,WAC1Bg3B,gBAAiBR,EAAcQ,gBAC/BC,gBAAiBT,EAAcS,iBAGjC,GACET,EAAc,eACgB3nC,IAA9B2nC,EAAc,UACdA,EAAc,gBACgB3nC,IAA9B2nC,EAAc,UACd,CACA,MAAMY,EAAiD,CACrDC,eAAgBb,EAAc,SAC9Bc,iCAAkCd,EAAc,WAElDD,EAAiBgB,uBAAyBH,CAC5C,CA4BA,OA1BIZ,EAAc,kBAA6C3nC,IAA9B2nC,EAAc,cAC7CD,EAAiBiB,+BAAiChB,EAAc,aAIhEA,EAAciB,yBACuB5oC,IAArC2nC,EAAciB,qBAEdlB,EAAiBkB,mBAAqBjB,EAAciB,oBAIpDjB,EAAckB,0BACwB7oC,IAAtC2nC,EAAckB,sBAEdnB,EAAiBmB,oBAAsBlB,EAAckB,qBAGnDlB,EAAcmB,iBAA2C9oC,IAA7B2nC,EAAcmB,aAC5CpB,EAAiBoB,WAAanB,EAAcmB,YAG1CnB,EAAcoB,kBAA6C/oC,IAA9B2nC,EAAcoB,cAC7CrB,EAAiBqB,YAAcpB,EAAcoB,aAGxCrB,CACT,CClC6BsB,CAA6B5kC,GAClDsjC,GACFD,EAAsB3oC,KAAK4oC,EAC7B,KAGGD,EAAsB/oC,OACzB,OAIF,IAAIuqC,EACJ,IACEA,GAAoBC,EAAAA,GAAAA,GAA2BzB,EACjD,CAAE,MAAOrlB,GACPnW,QAAQiH,IAAIkP,EACd,CAEK6mB,GAILxB,EAAsB7oC,SAAQ,CAAC8oC,EAAkBt1B,KAC/ClF,GAAiBi8B,kBACfx2B,EAASP,GACT,gBACA62B,EAAkB72B,GACnB,GACD,ECnDJ,GA3BqD,CAInDqH,GAAE,GACF2vB,gBDZa,SAAanmC,GAAgD,IAA/C,gBAAEkV,EAAe,cAAE2U,EAAgB,CAAC,GAAG7pB,EAClE,MAAM,iBAAE48B,GAAqB1nB,EAAgBE,SAE7C3G,EAAAA,QAAAA,UACEA,EAAAA,QAAAA,OAAAA,gBACA81B,IAKF91B,EAAAA,QAAAA,UACEA,EAAAA,QAAAA,OAAAA,eACA81B,IAMF3H,EAAiBwJ,SAAS,oBAAqB,CAAEC,iBAAiB,IAOlEzJ,EAAiBwJ,SAAS,wBAAyB,CAAEC,iBAAiB,IAItEzJ,EAAiBwJ,SAAS,+BAAgC,CACxDC,iBAAiB,IAMnBzJ,EAAiBwJ,SAAS,wBAAyB,CAAEC,iBAAiB,IAKtEzJ,EAAiBwJ,SAAS,sBAAuB,CAAEC,iBAAiB,GACtE,EC7BEC,qBAAoB,GACpBC,wBCnBa,SAAAvmC,GAKZ,IALqB,gBACtBkV,EAAe,iBACfsC,EAAgB,gBAChBE,EAAe,eACfD,GACDzX,EAWC,MAAO,CAGL,CACEmR,KAAM,eACNqF,GAAI,eACJsE,UAhBJ,SAAkCkU,GAChC,OAAOzX,GAAa,CAClBrC,kBACAsC,mBACAE,kBACAD,oBACGuX,GAEP,GAWF,EDLEwX,eAAc,GACdC,yBAAwB,GACxBC,yBAAwB,GACxBC,iBEzBa,SAAyB3mC,GAAuC,IAAtC,gBAAE0X,EAAe,gBAAExC,GAAiBlV,EAC3E,MAAO,CACL,CACEmR,KAAM,eACNy1B,iBAAkB/Y,GAClBgZ,aAAcA,QAEhB,CACE11B,KAAM,cACNy1B,iBAAkBjY,GAAAA,GAClBkY,aAAcA,QAEhB,CACE11B,KAAM,kBACNy1B,iBAAkBjY,GAAAA,GAClBkY,aAAcA,QAEhB,CACE11B,KAAM,mBACNy1B,iBAAkBE,GAClBD,aAAcA,QAEhB,CACE11B,KAAM,sBACNy1B,iBAAkBG,GAClBF,aAAcA,CAACxf,EAAK2f,EAAYC,KAAlBJ,GAEhB,CACE11B,KAAM,cACNy1B,iBAAkBjY,GAAAA,GAClBkY,aAAcA,QAGpB,EFPEK,kBAAiB,GACjBC,iBAAgBnnC,GAAsB,IAArB,gBAAEkV,GAAiBlV,EAClC,MAAO,CACL,CACEmR,KAAM,SACNuS,QAAS,CACP/F,0BAAyBA,KAIjC,EAEAypB,uBG9Ba,WACb,MAAO,CACL,CACEj2B,KAAM,YACN1T,MAAO,CACL+Y,GAAI,eACJ6wB,OAAQ,CACN,CACEC,KAAM,UACNhqB,SAAUA,IACRhH,GAAAA,cAAA,MAAIoG,MAAO,CAAE0H,MAAO,UAAW,0BAQzC,CACEjT,KAAM,cACN1T,MAAO,CACL+Y,GAAI,eACJ6wB,OAAQ,CACN,CACEC,KAAM,eACNhqB,SAAUiqB,OAMlB,CACEp2B,KAAM,UACN1T,MAAO,CAqCL,CACE+Y,GAAI,mBACJ4C,QAAS,SAAU4V,GACjB,GAAIrtB,KAAK6lC,YAAc7lC,KAAK6lC,UAAUxY,GAAQ,OAAO,KAErD,MAAM,SAAE/uB,GAAa+uB,EACfvxB,EACJwC,GAAY0B,KAAK4gC,UACbtiC,EAAS0B,KAAK4gC,WACd5gC,KAAK8lC,UAAqC,mBAAlB9lC,KAAK8lC,SAC3B9lC,KAAK8lC,SAASzY,GACd,KACR,OAAKvxB,EAGH6Y,GAAAA,cAAA,QACEM,UAAU,6BACV8F,MAAO,CAAE0H,MAAOziB,KAAKyiB,YAASrnB,GAC9Bkc,MAAOtX,KAAKsX,OAAS,IAEpBtX,KAAKuZ,OACJ5E,GAAAA,cAAA,QAAMM,UAAU,iBAAiBjV,KAAKuZ,OAExC5E,GAAAA,cAAA,QAAMM,UAAU,cAAcnZ,IAXf,IAcrB,GAGF,CACE+Y,GAAI,mBAMJkxB,UAAW,SAAU/K,GAEnB,MAAMgL,EAAe,IAAKhmC,MAC1BgmC,EAAalY,MAAQ9tB,KAAK8tB,MAAMlsB,KAAIqsB,IAAQ,IAAMA,MAElD,IAAK,MAAMA,KAAQ+X,EAAalY,MAAO,CACrC,MAAQa,MAAOsX,GAAkBhY,EACjCA,EAAKU,MAAQ,GACb,IAAK,MAAMhqB,KAAQshC,EACjBhY,EAAKU,MAAMz0B,KAAK8gC,EAAqB+K,UAAUphC,GAEnD,CACA,OAAOqhC,CACT,KAKV,E","sources":["webpack:///../../../extensions/default/src/DicomWebDataSource/qido.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/getImageId.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/getWADORSImageId.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoader.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoaderSync.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoaderAsync.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadata.js","webpack:///../../../extensions/default/src/DicomWebDataSource/retrieveStudyMetadata.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/StaticWadoClient.ts","webpack:///../../../extensions/default/src/utils/getDirectURL.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/fixBulkDataURI.ts","webpack:///../../../extensions/default/src/DicomWebDataSource/index.js","webpack:///../../../extensions/default/src/DicomWebDataSource/dcm4cheeReject.js","webpack:///../../../extensions/default/src/DicomJSONDataSource/index.js","webpack:///../../../extensions/default/src/DicomLocalDataSource/index.js","webpack:///../../../extensions/default/src/DicomWebProxyDataSource/index.js","webpack:///../../../extensions/default/src/getDataSourcesModule.js","webpack:///../../../extensions/default/src/Toolbar/Toolbar.tsx","webpack:///../../../extensions/default/src/ViewerLayout/index.tsx","webpack:///../../../extensions/default/src/Panels/PanelStudyBrowser.tsx","webpack:///../../../extensions/default/src/Panels/getImageSrcFromImageId.js","webpack:///../../../extensions/default/src/Panels/getStudiesForPatientByMRN.js","webpack:///../../../extensions/default/src/Panels/requestDisplaySetCreationForStudy.js","webpack:///../../../extensions/default/src/Panels/WrappedPanelStudyBrowser.tsx","webpack:///../../../extensions/default/src/Panels/ActionButtons.tsx","webpack:///../../../extensions/default/src/Panels/createReportDialogPrompt.tsx","webpack:///../../../extensions/default/src/Actions/createReportAsync.tsx","webpack:///../../../extensions/default/src/utils/getNextSRSeriesNumber.js","webpack:///../../../extensions/default/src/utils/findSRWithSameSeriesDescription.ts","webpack:///../../../extensions/default/src/Panels/PanelMeasurementTable.tsx","webpack:///../../../extensions/default/src/getPanelModule.tsx","webpack:///../../../extensions/default/src/id.js","webpack:///../../../extensions/default/src/getSopClassHandlerModule.js","webpack:///../../../extensions/default/src/Toolbar/ToolbarDivider.tsx","webpack:///../../../extensions/default/src/Toolbar/ToolbarLayoutSelector.tsx","webpack:///../../../extensions/default/src/Toolbar/ToolbarSplitButton.tsx","webpack:///../../../extensions/default/src/CustomizableContextMenu/ContextMenuItemsBuilder.ts","webpack:///../../../extensions/default/src/CustomizableContextMenu/ContextMenuController.tsx","webpack:///../../../extensions/default/src/CustomizableContextMenu/defaultContextMenu.ts","webpack:///../../../extensions/default/src/DicomTagBrowser/DicomTagTable.tsx","webpack:///../../../extensions/default/src/DicomTagBrowser/DicomTagBrowser.tsx","webpack:///../../../extensions/default/src/utils/reuseCachedLayouts.ts","webpack:///../../../extensions/default/src/findViewportsByPosition.ts","webpack:///../../../extensions/default/src/commandsModule.ts","webpack:///../../../extensions/default/src/hpMNGrid.ts","webpack:///../../../extensions/default/src/getHangingProtocolModule.js","webpack:///../../../extensions/default/src/Panels/DataSourceSelector.tsx","webpack:///../../../extensions/default/src/getPTImageIdInstanceMetadata.ts","webpack:///../../../extensions/default/src/init.ts","webpack:///../../../extensions/default/src/index.ts","webpack:///../../../extensions/default/src/getLayoutTemplateModule.js","webpack:///../../../extensions/default/src/getToolbarModule.tsx","webpack:///../../../extensions/default/src/getCustomizationModule.tsx"],"sourcesContent":["/**\r\n * QIDO - Query based on ID for DICOM Objects\r\n * search for studies, series and instances by patient ID, and receive their\r\n * unique identifiers for further usage.\r\n *\r\n * Quick: https://www.dicomstandard.org/dicomweb/query-qido-rs/\r\n * Standard: http://dicom.nema.org/medical/dicom/current/output/html/part18.html#sect_10.6\r\n *\r\n * Routes:\r\n * ==========\r\n * /studies?\r\n * /studies/{studyInstanceUid}/series?\r\n * /studies/{studyInstanceUid}/series/{seriesInstanceUid}/instances?\r\n *\r\n * Query Parameters:\r\n * ================\r\n * | KEY              | VALUE              |\r\n * |------------------|--------------------|\r\n * | {attributeId}    | {value}            |\r\n * | includeField     | {attribute} or all |\r\n * | fuzzymatching    | true OR false      |\r\n * | limit            | {number}           |\r\n * | offset           | {number}           |\r\n */\r\nimport { DICOMWeb, utils } from '@ohif/core';\r\nimport { sortStudySeries } from '@ohif/core/src/utils/sortStudy';\r\n\r\nconst { getString, getName, getModalities } = DICOMWeb;\r\n\r\n/**\r\n * Parses resulting data from a QIDO call into a set of Study MetaData\r\n *\r\n * @param {Array} qidoStudies - An array of study objects. Each object contains a keys for DICOM tags.\r\n * @param {object} qidoStudies[0].qidoStudy - An object where each key is the DICOM Tag group+element\r\n * @param {object} qidoStudies[0].qidoStudy[dicomTag] - Optional object that represents DICOM Tag\r\n * @param {string} qidoStudies[0].qidoStudy[dicomTag].vr - Value Representation\r\n * @param {string[]} qidoStudies[0].qidoStudy[dicomTag].Value - Optional string array representation of the DICOM Tag's value\r\n * @returns {Array} An array of Study MetaData objects\r\n */\r\nfunction processResults(qidoStudies) {\r\n  if (!qidoStudies || !qidoStudies.length) {\r\n    return [];\r\n  }\r\n\r\n  const studies = [];\r\n\r\n  qidoStudies.forEach(qidoStudy =>\r\n    studies.push({\r\n      studyInstanceUid: getString(qidoStudy['0020000D']),\r\n      date: getString(qidoStudy['00080020']), // YYYYMMDD\r\n      time: getString(qidoStudy['00080030']), // HHmmss.SSS (24-hour, minutes, seconds, fractional seconds)\r\n      accession: getString(qidoStudy['00080050']) || '', // short string, probably a number?\r\n      mrn: getString(qidoStudy['00100020']) || '', // medicalRecordNumber\r\n      patientName: utils.formatPN(getName(qidoStudy['00100010'])) || '',\r\n      instances: Number(getString(qidoStudy['00201208'])) || 0, // number\r\n      description: getString(qidoStudy['00081030']) || '',\r\n      modalities:\r\n        getString(\r\n          getModalities(qidoStudy['00080060'], qidoStudy['00080061'])\r\n        ) || '',\r\n    })\r\n  );\r\n\r\n  return studies;\r\n}\r\n\r\n/**\r\n * Parses resulting data from a QIDO call into a set of Study MetaData\r\n *\r\n * @param {Array} qidoSeries - An array of study objects. Each object contains a keys for DICOM tags.\r\n * @param {object} qidoSeries[0].qidoSeries - An object where each key is the DICOM Tag group+element\r\n * @param {object} qidoSeries[0].qidoSeries[dicomTag] - Optional object that represents DICOM Tag\r\n * @param {string} qidoSeries[0].qidoSeries[dicomTag].vr - Value Representation\r\n * @param {string[]} qidoSeries[0].qidoSeries[dicomTag].Value - Optional string array representation of the DICOM Tag's value\r\n * @returns {Array} An array of Study MetaData objects\r\n */\r\nexport function processSeriesResults(qidoSeries) {\r\n  const series = [];\r\n\r\n  if (qidoSeries && qidoSeries.length) {\r\n    qidoSeries.forEach(qidoSeries =>\r\n      series.push({\r\n        studyInstanceUid: getString(qidoSeries['0020000D']),\r\n        seriesInstanceUid: getString(qidoSeries['0020000E']),\r\n        modality: getString(qidoSeries['00080060']),\r\n        seriesNumber: getString(qidoSeries['00200011']),\r\n        seriesDate: utils.formatDate(getString(qidoSeries['00080021'])),\r\n        numSeriesInstances: Number(getString(qidoSeries['00201209'])),\r\n        description: getString(qidoSeries['0008103E']),\r\n      })\r\n    );\r\n  }\r\n\r\n  sortStudySeries(series);\r\n\r\n  return series;\r\n}\r\n\r\n/**\r\n *\r\n * @param {object} dicomWebClient - Client similar to what's provided by `dicomweb-client` library\r\n * @param {function} dicomWebClient.searchForStudies -\r\n * @param {string} [studyInstanceUid]\r\n * @param {string} [seriesInstanceUid]\r\n * @param {string} [queryParamaters]\r\n * @returns {Promise<results>} - Promise that resolves results\r\n */\r\nasync function search(\r\n  dicomWebClient,\r\n  studyInstanceUid,\r\n  seriesInstanceUid,\r\n  queryParameters\r\n) {\r\n  let searchResult = await dicomWebClient.searchForStudies({\r\n    studyInstanceUid: undefined,\r\n    queryParams: queryParameters,\r\n  });\r\n\r\n  return searchResult;\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} studyInstanceUID - ID of study to return a list of series for\r\n * @returns {Promise} - Resolves SeriesMetadata[] in study\r\n */\r\nexport function seriesInStudy(dicomWebClient, studyInstanceUID) {\r\n  // Series Description\r\n  // Already included?\r\n  const commaSeparatedFields = ['0008103E', '00080021'].join(',');\r\n  const queryParams = {\r\n    includefield: commaSeparatedFields,\r\n  };\r\n\r\n  return dicomWebClient.searchForSeries({ studyInstanceUID, queryParams });\r\n}\r\n\r\nexport default function searchStudies(server, filter) {\r\n  const queryParams = getQIDOQueryParams(\r\n    filter,\r\n    server.qidoSupportsIncludeField\r\n  );\r\n  const options = {\r\n    queryParams,\r\n  };\r\n\r\n  return dicomWeb.searchForStudies(options).then(resultDataToStudies);\r\n}\r\n\r\n/**\r\n * Produces a QIDO URL given server details and a set of specified search filter\r\n * items\r\n *\r\n * @param filter\r\n * @param serverSupportsQIDOIncludeField\r\n * @returns {string} The URL with encoded filter query data\r\n */\r\nfunction mapParams(params, options = {}) {\r\n  if (!params) {\r\n    return;\r\n  }\r\n  const commaSeparatedFields = [\r\n    '00081030', // Study Description\r\n    '00080060', // Modality\r\n    // Add more fields here if you want them in the result\r\n  ].join(',');\r\n\r\n  const { supportsWildcard } = options;\r\n  const withWildcard = value => {\r\n    return supportsWildcard && value ? `*${value}*` : value;\r\n  };\r\n\r\n  const parameters = {\r\n    // Named\r\n    PatientName: withWildcard(params.patientName),\r\n    //PatientID: withWildcard(params.patientId),\r\n    '00100020': withWildcard(params.patientId), // Temporarily to make the tests pass with dicomweb-server.. Apparently it's broken?\r\n    AccessionNumber: withWildcard(params.accessionNumber),\r\n    StudyDescription: withWildcard(params.studyDescription),\r\n    ModalitiesInStudy: params.modalitiesInStudy,\r\n    // Other\r\n    limit: params.limit || 101,\r\n    offset: params.offset || 0,\r\n    fuzzymatching: options.supportsFuzzyMatching === true,\r\n    includefield: commaSeparatedFields, // serverSupportsQIDOIncludeField ? commaSeparatedFields : 'all',\r\n  };\r\n\r\n  // build the StudyDate range parameter\r\n  if (params.startDate && params.endDate) {\r\n    parameters.StudyDate = `${params.startDate}-${params.endDate}`;\r\n  } else if (params.startDate) {\r\n    const today = new Date();\r\n    const DD = String(today.getDate()).padStart(2, '0');\r\n    const MM = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!\r\n    const YYYY = today.getFullYear();\r\n    const todayStr = `${YYYY}${MM}${DD}`;\r\n\r\n    parameters.StudyDate = `${params.startDate}-${todayStr}`;\r\n  } else if (params.endDate) {\r\n    const oldDateStr = `19700102`;\r\n\r\n    parameters.StudyDate = `${oldDateStr}-${params.endDate}`;\r\n  }\r\n\r\n  // Build the StudyInstanceUID parameter\r\n  if (params.studyInstanceUid) {\r\n    let studyUids = params.studyInstanceUid;\r\n    studyUids = Array.isArray(studyUids) ? studyUids.join() : studyUids;\r\n    studyUids = studyUids.replace(/[^0-9.]+/g, '\\\\');\r\n    parameters.StudyInstanceUID = studyUids;\r\n  }\r\n\r\n  // Clean query params of undefined values.\r\n  const final = {};\r\n  Object.keys(parameters).forEach(key => {\r\n    if (parameters[key] !== undefined && parameters[key] !== '') {\r\n      final[key] = parameters[key];\r\n    }\r\n  });\r\n\r\n  return final;\r\n}\r\n\r\nexport { mapParams, search, processResults };\r\n","import getWADORSImageId from './getWADORSImageId';\r\n\r\nfunction buildInstanceWadoUrl(config, instance) {\r\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\r\n  const params = [];\r\n\r\n  params.push('requestType=WADO');\r\n  params.push(`studyUID=${StudyInstanceUID}`);\r\n  params.push(`seriesUID=${SeriesInstanceUID}`);\r\n  params.push(`objectUID=${SOPInstanceUID}`);\r\n  params.push('contentType=application/dicom');\r\n  params.push('transferSyntax=*');\r\n\r\n  const paramString = params.join('&');\r\n\r\n  return `${config.wadoUriRoot}?${paramString}`;\r\n}\r\n\r\n/**\r\n * Obtain an imageId for Cornerstone from an image instance\r\n *\r\n * @param instance\r\n * @param frame\r\n * @param thumbnail\r\n * @returns {string} The imageId to be used by Cornerstone\r\n */\r\nexport default function getImageId({\r\n  instance,\r\n  frame,\r\n  config,\r\n  thumbnail = false,\r\n}) {\r\n  if (!instance) {\r\n    return;\r\n  }\r\n\r\n  if (instance.url) {\r\n    return instance.url;\r\n  }\r\n\r\n  const renderingAttr = thumbnail ? 'thumbnailRendering' : 'imageRendering';\r\n\r\n  if (!config[renderingAttr] || config[renderingAttr] === 'wadouri') {\r\n    const wadouri = buildInstanceWadoUrl(config, instance);\r\n\r\n    let imageId = 'dicomweb:' + wadouri;\r\n    if (frame !== undefined) {\r\n      imageId += '&frame=' + frame;\r\n    }\r\n\r\n    return imageId;\r\n  } else {\r\n    return getWADORSImageId(instance, config, frame); // WADO-RS Retrieve Frame\r\n  }\r\n}\r\n","function buildInstanceWadoRsUri(instance, config) {\r\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\r\n  return `${config.wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/instances/${SOPInstanceUID}`;\r\n}\r\n\r\nfunction buildInstanceFrameWadoRsUri(instance, config, frame) {\r\n  const baseWadoRsUri = buildInstanceWadoRsUri(instance, config);\r\n\r\n  frame = frame || 1;\r\n\r\n  return `${baseWadoRsUri}/frames/${frame}`;\r\n}\r\n\r\n// function getWADORSImageUrl(instance, frame) {\r\n//   const wadorsuri = buildInstanceFrameWadoRsUri(instance, config, frame);\r\n\r\n//   if (!wadorsuri) {\r\n//     return;\r\n//   }\r\n\r\n//   // Use null to obtain an imageId which represents the instance\r\n//   if (frame === null) {\r\n//     wadorsuri = wadorsuri.replace(/frames\\/(\\d+)/, '');\r\n//   } else {\r\n//     // We need to sum 1 because WADO-RS frame number is 1-based\r\n//     frame = frame ? parseInt(frame) + 1 : 1;\r\n\r\n//     // Replaces /frame/1 by /frame/{frame}\r\n//     wadorsuri = wadorsuri.replace(/frames\\/(\\d+)/, `frames/${frame}`);\r\n//   }\r\n\r\n//   return wadorsuri;\r\n// }\r\n\r\n/**\r\n * Obtain an imageId for Cornerstone based on the WADO-RS scheme\r\n *\r\n * @param {object} instanceMetada metadata object (InstanceMetadata)\r\n * @param {(string\\|number)} [frame] the frame number\r\n * @returns {string} The imageId to be used by Cornerstone\r\n */\r\nexport default function getWADORSImageId(instance, config, frame) {\r\n  //const uri = getWADORSImageUrl(instance, frame);\r\n  const uri = buildInstanceFrameWadoRsUri(instance, config, frame);\r\n\r\n  if (!uri) {\r\n    return;\r\n  }\r\n\r\n  return `wadors:${uri}`;\r\n}\r\n","/**\r\n * Class to define inheritance of load retrieve strategy.\r\n * The process can be async load (lazy) or sync load\r\n *\r\n * There are methods that must be implemented at consumer level\r\n * To retrieve study call execLoad\r\n */\r\nexport default class RetrieveMetadataLoader {\r\n  /**\r\n   * @constructor\r\n   * @param {Object} client The dicomweb-client.\r\n   * @param {Array} studyInstanceUID Study instance ui to be retrieved\r\n   * @param {Object} [filters] - Object containing filters to be applied on retrieve metadata process\r\n   * @param {string} [filter.seriesInstanceUID] - series instance uid to filter results against\r\n   * @param {Function} [sortSeries] - Custom sort function for series\r\n   */\r\n  constructor(\r\n    client,\r\n    studyInstanceUID,\r\n    filters = {},\r\n    sortCriteria,\r\n    sortFunction\r\n  ) {\r\n    this.client = client;\r\n    this.studyInstanceUID = studyInstanceUID;\r\n    this.filters = filters;\r\n    this.sortCriteria = sortCriteria;\r\n    this.sortFunction = sortFunction;\r\n  }\r\n\r\n  async execLoad() {\r\n    const preLoadData = await this.preLoad();\r\n    const loadData = await this.load(preLoadData);\r\n    const postLoadData = await this.posLoad(loadData);\r\n\r\n    return postLoadData;\r\n  }\r\n\r\n  /**\r\n   * It iterates over given loaders running each one. Loaders parameters must be bind when getting it.\r\n   * @param {Array} loaders - array of loader to retrieve data.\r\n   */\r\n  async runLoaders(loaders) {\r\n    let result;\r\n    for (const loader of loaders) {\r\n      try {\r\n        result = await loader();\r\n        if (result && result.length) {\r\n          break; // closes iterator in case data is retrieved successfully\r\n        }\r\n      } catch (e) {\r\n        throw e;\r\n      }\r\n    }\r\n\r\n    if (loaders.next().done && !result) {\r\n      throw new Error('RetrieveMetadataLoader failed');\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // Methods to be overwrite\r\n  async configLoad() {}\r\n  async preLoad() {}\r\n  async load(preLoadData) {}\r\n  async posLoad(loadData) {}\r\n}\r\n","// import { api } from 'dicomweb-client';\r\n// import DICOMWeb from '../../../DICOMWeb/';\r\nimport { createStudyFromSOPInstanceList } from './studyInstanceHelpers';\r\nimport RetrieveMetadataLoader from './retrieveMetadataLoader';\r\n\r\n/**\r\n * Class for sync load of study metadata.\r\n * It inherits from RetrieveMetadataLoader\r\n *\r\n * A list of loaders (getLoaders) can be created so, it will be applied a fallback load strategy.\r\n * I.e Retrieve metadata using all loaders possibilities.\r\n */\r\nexport default class RetrieveMetadataLoaderSync extends RetrieveMetadataLoader {\r\n  getOptions() {\r\n    const { studyInstanceUID, filters } = this;\r\n\r\n    const options = {\r\n      studyInstanceUID,\r\n    };\r\n\r\n    const { seriesInstanceUID } = filters;\r\n    if (seriesInstanceUID) {\r\n      options['seriesInstanceUID'] = seriesInstanceUID;\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  /**\r\n   * @returns {Array} Array of loaders. To be consumed as queue\r\n   */\r\n  *getLoaders() {\r\n    const loaders = [];\r\n    const {\r\n      studyInstanceUID,\r\n      filters: { seriesInstanceUID } = {},\r\n      client,\r\n    } = this;\r\n\r\n    if (seriesInstanceUID) {\r\n      loaders.push(\r\n        client.retrieveSeriesMetadata.bind(client, {\r\n          studyInstanceUID,\r\n          seriesInstanceUID,\r\n        })\r\n      );\r\n    }\r\n\r\n    loaders.push(\r\n      client.retrieveStudyMetadata.bind(client, { studyInstanceUID })\r\n    );\r\n\r\n    yield* loaders;\r\n  }\r\n\r\n  async load(preLoadData) {\r\n    const loaders = this.getLoaders();\r\n    const result = this.runLoaders(loaders);\r\n    return result;\r\n  }\r\n\r\n  async posLoad(loadData) {\r\n    return loadData;\r\n  }\r\n}\r\n","import dcmjs from 'dcmjs';\r\nimport {\r\n  sortStudySeries,\r\n  sortingCriteria,\r\n} from '@ohif/core/src/utils/sortStudy';\r\nimport RetrieveMetadataLoader from './retrieveMetadataLoader';\r\n\r\n/**\r\n * Creates an immutable series loader object which loads each series sequentially using the iterator interface\r\n * @param {DICOMWebClient} dicomWebClient The DICOMWebClient instance to be used for series load\r\n * @param {string} studyInstanceUID The Study Instance UID from which series will be loaded\r\n * @param {Array} seriesInstanceUIDList A list of Series Instance UIDs\r\n * @returns {Object} Returns an object which supports loading of instances from each of given Series Instance UID\r\n */\r\nfunction makeSeriesAsyncLoader(\r\n  client,\r\n  studyInstanceUID,\r\n  seriesInstanceUIDList\r\n) {\r\n  return Object.freeze({\r\n    hasNext() {\r\n      return seriesInstanceUIDList.length > 0;\r\n    },\r\n    async next() {\r\n      const seriesInstanceUID = seriesInstanceUIDList.shift();\r\n      return client.retrieveSeriesMetadata({\r\n        studyInstanceUID,\r\n        seriesInstanceUID,\r\n      });\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Class for async load of study metadata.\r\n * It inherits from RetrieveMetadataLoader\r\n *\r\n * It loads the one series and then append to seriesLoader the others to be consumed/loaded\r\n */\r\nexport default class RetrieveMetadataLoaderAsync extends RetrieveMetadataLoader {\r\n  /**\r\n   * @returns {Array} Array of preLoaders. To be consumed as queue\r\n   */\r\n  *getPreLoaders() {\r\n    const preLoaders = [];\r\n    const {\r\n      studyInstanceUID,\r\n      filters: { seriesInstanceUID } = {},\r\n      client,\r\n    } = this;\r\n\r\n    if (seriesInstanceUID) {\r\n      const options = {\r\n        studyInstanceUID,\r\n        queryParams: { SeriesInstanceUID: seriesInstanceUID },\r\n      };\r\n      preLoaders.push(client.searchForSeries.bind(client, options));\r\n    }\r\n    // Fallback preloader\r\n    preLoaders.push(client.searchForSeries.bind(client, { studyInstanceUID }));\r\n\r\n    yield* preLoaders;\r\n  }\r\n\r\n  async preLoad() {\r\n    const preLoaders = this.getPreLoaders();\r\n    const result = await this.runLoaders(preLoaders);\r\n    const sortCriteria = this.sortCriteria;\r\n    const sortFunction = this.sortFunction;\r\n\r\n    const { naturalizeDataset } = dcmjs.data.DicomMetaDictionary;\r\n    const naturalized = result.map(naturalizeDataset);\r\n\r\n    return sortStudySeries(\r\n      naturalized,\r\n      sortCriteria ||\r\n        sortingCriteria.seriesSortCriteria.seriesInfoSortingCriteria,\r\n      sortFunction\r\n    );\r\n  }\r\n\r\n  async load(preLoadData) {\r\n    const { client, studyInstanceUID } = this;\r\n\r\n    const seriesInstanceUIDs = preLoadData.map(s => s.SeriesInstanceUID);\r\n\r\n    const seriesAsyncLoader = makeSeriesAsyncLoader(\r\n      client,\r\n      studyInstanceUID,\r\n      seriesInstanceUIDs\r\n    );\r\n\r\n    const promises = [];\r\n\r\n    while (seriesAsyncLoader.hasNext()) {\r\n      promises.push(seriesAsyncLoader.next());\r\n    }\r\n\r\n    return {\r\n      preLoadData,\r\n      promises,\r\n    };\r\n  }\r\n\r\n  async posLoad({ preLoadData, promises }) {\r\n    return {\r\n      preLoadData,\r\n      promises,\r\n    };\r\n  }\r\n}\r\n","import RetrieveMetadataLoaderSync from './retrieveMetadataLoaderSync';\r\nimport RetrieveMetadataLoaderAsync from './retrieveMetadataLoaderAsync';\r\n\r\n/**\r\n * Retrieve Study metadata from a DICOM server. If the server is configured to use lazy load, only the first series\r\n * will be loaded and the property \"studyLoader\" will be set to let consumer load remaining series as needed.\r\n *\r\n * @param {Object} dicomWebClient The dicomweb-client.\r\n * @param {string} studyInstanceUid The Study Instance UID of the study which needs to be loaded\r\n * @param {Object} [filters] - Object containing filters to be applied on retrieve metadata process\r\n * @param {string} [filter.seriesInstanceUID] - series instance uid to filter results against\r\n * @returns {Object} A study descriptor object\r\n */\r\nasync function RetrieveMetadata(\r\n  dicomWebClient,\r\n  studyInstanceUid,\r\n  enableStudyLazyLoad,\r\n  filters = {},\r\n  sortCriteria,\r\n  sortFunction\r\n) {\r\n  const RetrieveMetadataLoader =\r\n    enableStudyLazyLoad !== false\r\n      ? RetrieveMetadataLoaderAsync\r\n      : RetrieveMetadataLoaderSync;\r\n\r\n  const retrieveMetadataLoader = new RetrieveMetadataLoader(\r\n    dicomWebClient,\r\n    studyInstanceUid,\r\n    filters,\r\n    sortCriteria,\r\n    sortFunction\r\n  );\r\n  const data = await retrieveMetadataLoader.execLoad();\r\n\r\n  return data;\r\n}\r\n\r\nexport default RetrieveMetadata;\r\n","import RetrieveMetadata from './wado/retrieveMetadata.js';\r\n\r\nconst moduleName = 'RetrieveStudyMetadata';\r\n// Cache for promises. Prevents unnecessary subsequent calls to the server\r\nconst StudyMetaDataPromises = new Map();\r\n\r\n/**\r\n * Retrieves study metadata\r\n *\r\n * @param {Object} server Object with server configuration parameters\r\n * @param {string} StudyInstanceUID The UID of the Study to be retrieved\r\n * @param {boolean} enabledStudyLazyLoad Whether the study metadata should be loaded asynchronusly.\r\n * @param {function} storeInstancesCallback A callback used to store the retrieved instance metadata.\r\n * @param {Object} [filters] - Object containing filters to be applied on retrieve metadata process\r\n * @param {string} [filter.seriesInstanceUID] - series instance uid to filter results against\r\n * @returns {Promise} that will be resolved with the metadata or rejected with the error\r\n */\r\nexport function retrieveStudyMetadata(\r\n  dicomWebClient,\r\n  StudyInstanceUID,\r\n  enableStudyLazyLoad,\r\n  filters,\r\n  sortCriteria,\r\n  sortFunction\r\n) {\r\n  // @TODO: Whenever a study metadata request has failed, its related promise will be rejected once and for all\r\n  // and further requests for that metadata will always fail. On failure, we probably need to remove the\r\n  // corresponding promise from the \"StudyMetaDataPromises\" map...\r\n\r\n  if (!dicomWebClient) {\r\n    throw new Error(\r\n      `${moduleName}: Required 'dicomWebClient' parameter not provided.`\r\n    );\r\n  }\r\n  if (!StudyInstanceUID) {\r\n    throw new Error(\r\n      `${moduleName}: Required 'StudyInstanceUID' parameter not provided.`\r\n    );\r\n  }\r\n\r\n  // Already waiting on result? Return cached promise\r\n  if (StudyMetaDataPromises.has(StudyInstanceUID)) {\r\n    return StudyMetaDataPromises.get(StudyInstanceUID);\r\n  }\r\n\r\n  // Create a promise to handle the data retrieval\r\n  const promise = new Promise((resolve, reject) => {\r\n    RetrieveMetadata(\r\n      dicomWebClient,\r\n      StudyInstanceUID,\r\n      enableStudyLazyLoad,\r\n      filters,\r\n      sortCriteria,\r\n      sortFunction\r\n    ).then(function(data) {\r\n      resolve(data);\r\n    }, reject);\r\n  });\r\n\r\n  // Store the promise in cache\r\n  StudyMetaDataPromises.set(StudyInstanceUID, promise);\r\n\r\n  return promise;\r\n}\r\n\r\n/**\r\n * Delete the cached study metadata retrieval promise to ensure that the browser will\r\n * re-retrieve the study metadata when it is next requested\r\n *\r\n * @param {String} StudyInstanceUID The UID of the Study to be removed from cache\r\n *\r\n */\r\nexport function deleteStudyMetadataPromise(StudyInstanceUID) {\r\n  if (StudyMetaDataPromises.has(StudyInstanceUID)) {\r\n    StudyMetaDataPromises.delete(StudyInstanceUID);\r\n  }\r\n}\r\n","import { api } from 'dicomweb-client';\r\n\r\n/**\r\n * An implementation of the static wado client, that fetches data from\r\n * a static response rather than actually doing real queries.  This allows\r\n * fast encoding of test data, but because it is static, anything actually\r\n * performing searches doesn't work.  This version fixes the query issue\r\n * by manually implementing a query option.\r\n */\r\nexport default class StaticWadoClient extends api.DICOMwebClient {\r\n  static studyFilterKeys = {\r\n    studyinstanceuid: '0020000D',\r\n    patientname: '00100010',\r\n    '00100020': 'mrn',\r\n    studydescription: '00081030',\r\n    studydate: '00080020',\r\n    modalitiesinstudy: '00080061',\r\n    accessionnumber: '00080050',\r\n  };\r\n\r\n  static seriesFilterKeys = {\r\n    seriesinstanceuid: '0020000E',\r\n    seriesnumber: '00200011',\r\n    modality: '00080060',\r\n  };\r\n\r\n  constructor(qidoConfig) {\r\n    super(qidoConfig);\r\n    this.staticWado = qidoConfig.staticWado;\r\n  }\r\n\r\n  /**\r\n   * Replace the search for studies remote query with a local version which\r\n   * retrieves a complete query list and then sub-selects from it locally.\r\n   * @param {*} options\r\n   * @returns\r\n   */\r\n  async searchForStudies(options) {\r\n    if (!this.staticWado) return super.searchForStudies(options);\r\n\r\n    const searchResult = await super.searchForStudies(options);\r\n    const { queryParams } = options;\r\n\r\n    if (!queryParams) return searchResult;\r\n\r\n    const lowerParams = this.toLowerParams(queryParams);\r\n    const filtered = searchResult.filter(study => {\r\n      for (const key of Object.keys(StaticWadoClient.studyFilterKeys)) {\r\n        if (\r\n          !this.filterItem(\r\n            key,\r\n            lowerParams,\r\n            study,\r\n            StaticWadoClient.studyFilterKeys\r\n          )\r\n        ) {\r\n          return false;\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return filtered;\r\n  }\r\n\r\n  async searchForSeries(options) {\r\n    if (!this.staticWado) return super.searchForSeries(options);\r\n\r\n    const searchResult = await super.searchForSeries(options);\r\n    const { queryParams } = options;\r\n    if (!queryParams) return searchResult;\r\n    const lowerParams = this.toLowerParams(queryParams);\r\n\r\n    const filtered = searchResult.filter(series => {\r\n      for (const key of Object.keys(StaticWadoClient.seriesFilterKeys)) {\r\n        if (\r\n          !this.filterItem(\r\n            key,\r\n            lowerParams,\r\n            series,\r\n            StaticWadoClient.seriesFilterKeys\r\n          )\r\n        ) {\r\n          return false;\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n\r\n    return filtered;\r\n  }\r\n\r\n  /**\r\n   * Compares values, matching any instance of desired to any instance of\r\n   * actual by recursively go through the paired set of values.  That is,\r\n   * this is O(m*n) where m is how many items in desired and n is the length of actual\r\n   * Then, at the individual item node, compares the Alphabetic name if present,\r\n   * and does a sub-string matching on string values, and otherwise does an\r\n   * exact match comparison.\r\n   *\r\n   * @param {*} desired\r\n   * @param {*} actual\r\n   * @returns true if the values match\r\n   */\r\n  compareValues(desired, actual) {\r\n    if (Array.isArray(desired)) {\r\n      return desired.find(item => this.compareValues(item, actual));\r\n    }\r\n    if (Array.isArray(actual)) {\r\n      return actual.find(actualItem => this.compareValues(desired, actualItem));\r\n    }\r\n    if (actual?.Alphabetic) {\r\n      actual = actual.Alphabetic;\r\n    }\r\n    if (typeof actual == 'string') {\r\n      if (actual.length === 0) return true;\r\n      if (desired.length === 0 || desired === '*') return true;\r\n      if (desired[0] === '*' && desired[desired.length - 1] === '*') {\r\n        // console.log(`Comparing ${actual} to ${desired.substring(1, desired.length - 1)}`)\r\n        return actual.indexOf(desired.substring(1, desired.length - 1)) != -1;\r\n      } else if (desired[desired.length - 1] === '*') {\r\n        return actual.indexOf(desired.substring(0, desired.length - 1)) != -1;\r\n      } else if (desired[0] === '*') {\r\n        return (\r\n          actual.indexOf(desired.substring(1)) ===\r\n          actual.length - desired.length + 1\r\n        );\r\n      }\r\n    }\r\n    return desired === actual;\r\n  }\r\n\r\n  /** Compares a pair of dates to see if the value is within the range */\r\n  compareDateRange(range, value) {\r\n    if (!value) return true;\r\n    const dash = range.indexOf('-');\r\n    if (dash === -1) return this.compareValues(range, value);\r\n    const start = range.substring(0, dash);\r\n    const end = range.substring(dash + 1);\r\n    return (!start || value >= start) && (!end || value <= end);\r\n  }\r\n\r\n  /**\r\n   * Filters the return list by the query parameters.\r\n   *\r\n   * @param anyCaseKey - a possible search key\r\n   * @param queryParams -\r\n   * @param {*} study\r\n   * @param {*} sourceFilterMap\r\n   * @returns\r\n   */\r\n  filterItem(key: string, queryParams, study, sourceFilterMap) {\r\n    const altKey = sourceFilterMap[key] || key;\r\n    if (!queryParams) return true;\r\n    const testValue = queryParams[key] || queryParams[altKey];\r\n    if (!testValue) return true;\r\n    const valueElem = study[key] || study[altKey];\r\n    if (!valueElem) return false;\r\n    if (valueElem.vr == 'DA') {\r\n      return this.compareDateRange(testValue, valueElem.Value[0]);\r\n    }\r\n    const value = valueElem.Value;\r\n    return this.compareValues(testValue, value);\r\n  }\r\n\r\n  /** Converts the query parameters to lower case query parameters */\r\n  toLowerParams(queryParams: Record<string, unknown>): Record<string, unknown> {\r\n    const lowerParams = {};\r\n    Object.entries(queryParams).forEach(([key, value]) => {\r\n      lowerParams[key.toLowerCase()] = value;\r\n    });\r\n    return lowerParams;\r\n  }\r\n}\r\n","import { utils } from '@ohif/core';\r\n\r\n/**\r\n * Generates a URL that can be used for direct retrieve of the bulkdata\r\n *\r\n * @param {object} params\r\n * @param {string} params.tag is the tag name of the URL to retrieve\r\n * @param {string} params.defaultPath path for the pixel data url\r\n * @param {object} params.instance is the instance object that the tag is in\r\n * @param {string} params.defaultType is the mime type of the response\r\n * @param {string} params.singlepart is the type of the part to retrieve\r\n * @param {string} params.fetchPart unknown?\r\n * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\r\n *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\r\n */\r\nconst getDirectURL = (config, params) => {\r\n  const { wadoRoot, singlepart } = config;\r\n  const {\r\n    instance,\r\n    tag = 'PixelData',\r\n    defaultPath = '/pixeldata',\r\n    defaultType = 'video/mp4',\r\n    singlepart: fetchPart = 'video',\r\n  } = params;\r\n  const value = instance[tag];\r\n  if (!value) return undefined;\r\n\r\n  if (value.DirectRetrieveURL) return value.DirectRetrieveURL;\r\n  if (value.InlineBinary) {\r\n    const blob = utils.b64toBlob(value.InlineBinary, defaultType);\r\n    value.DirectRetrieveURL = URL.createObjectURL(blob);\r\n    return value.DirectRetrieveURL;\r\n  }\r\n  if (\r\n    !singlepart ||\r\n    (singlepart !== true && singlepart.indexOf(fetchPart) === -1)\r\n  ) {\r\n    if (value.retrieveBulkData) {\r\n      return value.retrieveBulkData().then(arr => {\r\n        value.DirectRetrieveURL = URL.createObjectURL(\r\n          new Blob([arr], { type: defaultType })\r\n        );\r\n        return value.DirectRetrieveURL;\r\n      });\r\n    }\r\n    console.warn('Unable to retrieve', tag, 'from', instance);\r\n    return undefined;\r\n  }\r\n\r\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\r\n  const BulkDataURI =\r\n    (value && value.BulkDataURI) ||\r\n    `series/${SeriesInstanceUID}/instances/${SOPInstanceUID}${defaultPath}`;\r\n  const hasQuery = BulkDataURI.indexOf('?') !== -1;\r\n  const hasAccept = BulkDataURI.indexOf('accept=') !== -1;\r\n  const acceptUri =\r\n    BulkDataURI +\r\n    (hasAccept ? '' : (hasQuery ? '&' : '?') + `accept=${defaultType}`);\r\n\r\n  if (tag === 'PixelData' || tag === 'EncapsulatedDocument') {\r\n    return `${wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/instances/${SOPInstanceUID}/rendered`;\r\n  }\r\n\r\n  // The DICOMweb standard states that the default is multipart related, and then\r\n  // separately states that the accept parameter is the URL parameter equivalent of the accept header.\r\n  return acceptUri;\r\n};\r\n\r\nexport default getDirectURL;\r\n","/**\r\n * Modifies a bulkDataURI to ensure it is absolute based on the DICOMWeb configuration and\r\n * instance data. The modification is in-place.\r\n *\r\n * If the bulkDataURI is relative to the series or study (according to the DICOM standard),\r\n * it is made absolute by prepending the relevant paths.\r\n *\r\n * In scenarios where the bulkDataURI is a server-relative path (starting with '/'), the function\r\n * handles two cases:\r\n *\r\n * 1. If the wado root is absolute (starts with 'http'), it prepends the wado root to the bulkDataURI.\r\n * 2. If the wado root is relative, no changes are needed as the bulkDataURI is already correctly relative to the server root.\r\n *\r\n * @param value - The object containing BulkDataURI to be fixed.\r\n * @param instance - The object (DICOM instance data) containing StudyInstanceUID and SeriesInstanceUID.\r\n * @param dicomWebConfig - The DICOMWeb configuration object, containing wadoRoot and potentially bulkDataURI.relativeResolution.\r\n * @returns The function modifies `value` in-place, it does not return a value.\r\n */\r\nfunction fixBulkDataURI(value, instance, dicomWebConfig) {\r\n  // in case of the relative path, make it absolute. The current DICOM standard says\r\n  // the bulkdataURI is relative to the series. However, there are situations where\r\n  // it can be relative to the study too\r\n  if (\r\n    !value.BulkDataURI.startsWith('http') &&\r\n    !value.BulkDataURI.startsWith('/')\r\n  ) {\r\n    if (dicomWebConfig.bulkDataURI?.relativeResolution === 'studies') {\r\n      value.BulkDataURI = `${dicomWebConfig.wadoRoot}/studies/${instance.StudyInstanceUID}/${value.BulkDataURI}`;\r\n    } else if (\r\n      dicomWebConfig.bulkDataURI?.relativeResolution === 'series' ||\r\n      !dicomWebConfig.bulkDataURI?.relativeResolution\r\n    ) {\r\n      value.BulkDataURI = `${dicomWebConfig.wadoRoot}/studies/${instance.StudyInstanceUID}/series/${instance.SeriesInstanceUID}/${value.BulkDataURI}`;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  // in case it is relative path but starts at the server (e.g., /bulk/1e, note the missing http\r\n  // in the beginning and the first character is /) There are two scenarios, whether the wado root\r\n  // is absolute or relative. In case of absolute, we need to prepend the wado root to the bulkdata\r\n  // uri (e.g., bulkData: /bulk/1e, wado root: http://myserver.com/dicomweb, output: http://myserver.com/bulk/1e)\r\n  // and in case of relative wado root, we need to prepend the bulkdata uri to the wado root (e.g,. bulkData: /bulk/1e\r\n  // wado root: /dicomweb, output: /bulk/1e)\r\n  if (value.BulkDataURI[0] === '/') {\r\n    if (dicomWebConfig.wadoRoot.startsWith('http')) {\r\n      // Absolute wado root\r\n      const url = new URL(dicomWebConfig.wadoRoot);\r\n      value.BulkDataURI = `${url.origin}${value.BulkDataURI}`;\r\n    } else {\r\n      // Relative wado root, we don't need to do anything, bulkdata uri is already correct\r\n    }\r\n  }\r\n}\r\n\r\nexport { fixBulkDataURI };\r\n","import { api } from 'dicomweb-client';\r\nimport {\r\n  DicomMetadataStore,\r\n  IWebApiDataSource,\r\n  utils,\r\n  errorHandler,\r\n  classes,\r\n} from '@ohif/core';\r\n\r\nimport {\r\n  mapParams,\r\n  search as qidoSearch,\r\n  seriesInStudy,\r\n  processResults,\r\n  processSeriesResults,\r\n} from './qido.js';\r\nimport dcm4cheeReject from './dcm4cheeReject';\r\n\r\nimport getImageId from './utils/getImageId';\r\nimport dcmjs from 'dcmjs';\r\nimport {\r\n  retrieveStudyMetadata,\r\n  deleteStudyMetadataPromise,\r\n} from './retrieveStudyMetadata.js';\r\nimport StaticWadoClient from './utils/StaticWadoClient';\r\nimport getDirectURL from '../utils/getDirectURL';\r\nimport { fixBulkDataURI } from './utils/fixBulkDataURI';\r\n\r\nconst { DicomMetaDictionary, DicomDict } = dcmjs.data;\r\n\r\nconst { naturalizeDataset, denaturalizeDataset } = DicomMetaDictionary;\r\n\r\nconst ImplementationClassUID =\r\n  '2.25.270695996825855179949881587723571202391.2.0.0';\r\nconst ImplementationVersionName = 'OHIF-VIEWER-2.0.0';\r\nconst EXPLICIT_VR_LITTLE_ENDIAN = '1.2.840.10008.1.2.1';\r\n\r\nconst metadataProvider = classes.MetadataProvider;\r\n\r\n/**\r\n *\r\n * @param {string} name - Data source name\r\n * @param {string} wadoUriRoot - Legacy? (potentially unused/replaced)\r\n * @param {string} qidoRoot - Base URL to use for QIDO requests\r\n * @param {string} wadoRoot - Base URL to use for WADO requests\r\n * @param {boolean} qidoSupportsIncludeField - Whether QIDO supports the \"Include\" option to request additional fields in response\r\n * @param {string} imageRengering - wadors | ? (unsure of where/how this is used)\r\n * @param {string} thumbnailRendering - wadors | ? (unsure of where/how this is used)\r\n * @param {bool} supportsReject - Whether the server supports reject calls (i.e. DCM4CHEE)\r\n * @param {bool} lazyLoadStudy - \"enableStudyLazyLoad\"; Request series meta async instead of blocking\r\n * @param {string|bool} singlepart - indicates of the retrieves can fetch singlepart.  Options are bulkdata, video, image or boolean true\r\n */\r\nfunction createDicomWebApi(dicomWebConfig, userAuthenticationService) {\r\n  const {\r\n    qidoRoot,\r\n    wadoRoot,\r\n    enableStudyLazyLoad,\r\n    supportsFuzzyMatching,\r\n    supportsWildcard,\r\n    supportsReject,\r\n    staticWado,\r\n    singlepart,\r\n  } = dicomWebConfig;\r\n\r\n  const dicomWebConfigCopy = JSON.parse(JSON.stringify(dicomWebConfig));\r\n\r\n  const qidoConfig = {\r\n    url: qidoRoot,\r\n    staticWado,\r\n    singlepart,\r\n    headers: userAuthenticationService.getAuthorizationHeader(),\r\n    errorInterceptor: errorHandler.getHTTPErrorHandler(),\r\n  };\r\n\r\n  const wadoConfig = {\r\n    url: wadoRoot,\r\n    staticWado,\r\n    singlepart,\r\n    headers: userAuthenticationService.getAuthorizationHeader(),\r\n    errorInterceptor: errorHandler.getHTTPErrorHandler(),\r\n  };\r\n\r\n  // TODO -> Two clients sucks, but its better than 1000.\r\n  // TODO -> We'll need to merge auth later.\r\n  const qidoDicomWebClient = staticWado\r\n    ? new StaticWadoClient(qidoConfig)\r\n    : new api.DICOMwebClient(qidoConfig);\r\n\r\n  const wadoDicomWebClient = staticWado\r\n    ? new StaticWadoClient(wadoConfig)\r\n    : new api.DICOMwebClient(wadoConfig);\r\n\r\n  const implementation = {\r\n    initialize: ({ params, query }) => {\r\n      const { StudyInstanceUIDs: paramsStudyInstanceUIDs } = params;\r\n      const queryStudyInstanceUIDs = utils.splitComma(\r\n        query.getAll('StudyInstanceUIDs')\r\n      );\r\n\r\n      const StudyInstanceUIDs =\r\n        (queryStudyInstanceUIDs.length && queryStudyInstanceUIDs) ||\r\n        paramsStudyInstanceUIDs;\r\n      const StudyInstanceUIDsAsArray =\r\n        StudyInstanceUIDs && Array.isArray(StudyInstanceUIDs)\r\n          ? StudyInstanceUIDs\r\n          : [StudyInstanceUIDs];\r\n      return StudyInstanceUIDsAsArray;\r\n    },\r\n    query: {\r\n      studies: {\r\n        mapParams: mapParams.bind(),\r\n        search: async function(origParams) {\r\n          const headers = userAuthenticationService.getAuthorizationHeader();\r\n          if (headers) {\r\n            qidoDicomWebClient.headers = headers;\r\n          }\r\n\r\n          const { studyInstanceUid, seriesInstanceUid, ...mappedParams } =\r\n            mapParams(origParams, {\r\n              supportsFuzzyMatching,\r\n              supportsWildcard,\r\n            }) || {};\r\n\r\n          const results = await qidoSearch(\r\n            qidoDicomWebClient,\r\n            undefined,\r\n            undefined,\r\n            mappedParams\r\n          );\r\n\r\n          return processResults(results);\r\n        },\r\n        processResults: processResults.bind(),\r\n      },\r\n      series: {\r\n        // mapParams: mapParams.bind(),\r\n        search: async function(studyInstanceUid) {\r\n          const headers = userAuthenticationService.getAuthorizationHeader();\r\n          if (headers) {\r\n            qidoDicomWebClient.headers = headers;\r\n          }\r\n\r\n          const results = await seriesInStudy(\r\n            qidoDicomWebClient,\r\n            studyInstanceUid\r\n          );\r\n\r\n          return processSeriesResults(results);\r\n        },\r\n        // processResults: processResults.bind(),\r\n      },\r\n      instances: {\r\n        search: (studyInstanceUid, queryParameters) => {\r\n          const headers = userAuthenticationService.getAuthorizationHeader();\r\n          if (headers) {\r\n            qidoDicomWebClient.headers = headers;\r\n          }\r\n\r\n          qidoSearch.call(\r\n            undefined,\r\n            qidoDicomWebClient,\r\n            studyInstanceUid,\r\n            null,\r\n            queryParameters\r\n          );\r\n        },\r\n      },\r\n    },\r\n    retrieve: {\r\n      /**\r\n       * Generates a URL that can be used for direct retrieve of the bulkdata\r\n       *\r\n       * @param {object} params\r\n       * @param {string} params.tag is the tag name of the URL to retrieve\r\n       * @param {object} params.instance is the instance object that the tag is in\r\n       * @param {string} params.defaultType is the mime type of the response\r\n       * @param {string} params.singlepart is the type of the part to retrieve\r\n       * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\r\n       *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\r\n       */\r\n      directURL: params => {\r\n        return getDirectURL({ wadoRoot, singlepart }, params);\r\n      },\r\n      bulkDataURI: async ({ StudyInstanceUID, BulkDataURI }) => {\r\n        const options = {\r\n          multipart: false,\r\n          BulkDataURI,\r\n          StudyInstanceUID,\r\n        };\r\n        return qidoDicomWebClient.retrieveBulkData(options).then(val => {\r\n          const ret = (val && val[0]) || undefined;\r\n          return ret;\r\n        });\r\n      },\r\n      series: {\r\n        metadata: async ({\r\n          StudyInstanceUID,\r\n          filters,\r\n          sortCriteria,\r\n          sortFunction,\r\n          madeInClient = false,\r\n        } = {}) => {\r\n          const headers = userAuthenticationService.getAuthorizationHeader();\r\n          if (headers) {\r\n            wadoDicomWebClient.headers = headers;\r\n          }\r\n\r\n          if (!StudyInstanceUID) {\r\n            throw new Error(\r\n              'Unable to query for SeriesMetadata without StudyInstanceUID'\r\n            );\r\n          }\r\n\r\n          if (enableStudyLazyLoad) {\r\n            return implementation._retrieveSeriesMetadataAsync(\r\n              StudyInstanceUID,\r\n              filters,\r\n              sortCriteria,\r\n              sortFunction,\r\n              madeInClient\r\n            );\r\n          }\r\n\r\n          return implementation._retrieveSeriesMetadataSync(\r\n            StudyInstanceUID,\r\n            filters,\r\n            sortCriteria,\r\n            sortFunction,\r\n            madeInClient\r\n          );\r\n        },\r\n      },\r\n    },\r\n\r\n    store: {\r\n      dicom: async (dataset, request) => {\r\n        const headers = userAuthenticationService.getAuthorizationHeader();\r\n        if (headers) {\r\n          wadoDicomWebClient.headers = headers;\r\n        }\r\n\r\n        if (dataset instanceof ArrayBuffer) {\r\n          const options = {\r\n            datasets: [dataset],\r\n            request,\r\n          };\r\n\r\n          await wadoDicomWebClient.storeInstances(options);\r\n        } else {\r\n          const meta = {\r\n            FileMetaInformationVersion:\r\n              dataset._meta.FileMetaInformationVersion.Value,\r\n            MediaStorageSOPClassUID: dataset.SOPClassUID,\r\n            MediaStorageSOPInstanceUID: dataset.SOPInstanceUID,\r\n            TransferSyntaxUID: EXPLICIT_VR_LITTLE_ENDIAN,\r\n            ImplementationClassUID,\r\n            ImplementationVersionName,\r\n          };\r\n\r\n          const denaturalized = denaturalizeDataset(meta);\r\n          const dicomDict = new DicomDict(denaturalized);\r\n\r\n          dicomDict.dict = denaturalizeDataset(dataset);\r\n\r\n          const part10Buffer = dicomDict.write();\r\n\r\n          const options = {\r\n            datasets: [part10Buffer],\r\n            request,\r\n          };\r\n\r\n          await wadoDicomWebClient.storeInstances(options);\r\n        }\r\n      },\r\n    },\r\n\r\n    _retrieveSeriesMetadataSync: async (\r\n      StudyInstanceUID,\r\n      filters,\r\n      sortCriteria,\r\n      sortFunction,\r\n      madeInClient\r\n    ) => {\r\n      const enableStudyLazyLoad = false;\r\n\r\n      // data is all SOPInstanceUIDs\r\n      const data = await retrieveStudyMetadata(\r\n        wadoDicomWebClient,\r\n        StudyInstanceUID,\r\n        enableStudyLazyLoad,\r\n        filters,\r\n        sortCriteria,\r\n        sortFunction\r\n      );\r\n\r\n      // first naturalize the data\r\n      const naturalizedInstancesMetadata = data.map(naturalizeDataset);\r\n\r\n      const seriesSummaryMetadata = {};\r\n      const instancesPerSeries = {};\r\n\r\n      naturalizedInstancesMetadata.forEach(instance => {\r\n        if (!seriesSummaryMetadata[instance.SeriesInstanceUID]) {\r\n          seriesSummaryMetadata[instance.SeriesInstanceUID] = {\r\n            StudyInstanceUID: instance.StudyInstanceUID,\r\n            StudyDescription: instance.StudyDescription,\r\n            SeriesInstanceUID: instance.SeriesInstanceUID,\r\n            SeriesDescription: instance.SeriesDescription,\r\n            SeriesNumber: instance.SeriesNumber,\r\n            SeriesTime: instance.SeriesTime,\r\n            SOPClassUID: instance.SOPClassUID,\r\n            ProtocolName: instance.ProtocolName,\r\n            Modality: instance.Modality,\r\n          };\r\n        }\r\n\r\n        if (!instancesPerSeries[instance.SeriesInstanceUID]) {\r\n          instancesPerSeries[instance.SeriesInstanceUID] = [];\r\n        }\r\n\r\n        const imageId = implementation.getImageIdsForInstance({\r\n          instance,\r\n        });\r\n\r\n        instance.imageId = imageId;\r\n\r\n        metadataProvider.addImageIdToUIDs(imageId, {\r\n          StudyInstanceUID,\r\n          SeriesInstanceUID: instance.SeriesInstanceUID,\r\n          SOPInstanceUID: instance.SOPInstanceUID,\r\n        });\r\n\r\n        instancesPerSeries[instance.SeriesInstanceUID].push(instance);\r\n      });\r\n\r\n      // grab all the series metadata\r\n      const seriesMetadata = Object.values(seriesSummaryMetadata);\r\n      DicomMetadataStore.addSeriesMetadata(seriesMetadata, madeInClient);\r\n\r\n      Object.keys(instancesPerSeries).forEach(seriesInstanceUID =>\r\n        DicomMetadataStore.addInstances(\r\n          instancesPerSeries[seriesInstanceUID],\r\n          madeInClient\r\n        )\r\n      );\r\n    },\r\n\r\n    _retrieveSeriesMetadataAsync: async (\r\n      StudyInstanceUID,\r\n      filters,\r\n      sortCriteria,\r\n      sortFunction,\r\n      madeInClient = false\r\n    ) => {\r\n      const enableStudyLazyLoad = true;\r\n      // Get Series\r\n      const {\r\n        preLoadData: seriesSummaryMetadata,\r\n        promises: seriesPromises,\r\n      } = await retrieveStudyMetadata(\r\n        wadoDicomWebClient,\r\n        StudyInstanceUID,\r\n        enableStudyLazyLoad,\r\n        filters,\r\n        sortCriteria,\r\n        sortFunction\r\n      );\r\n\r\n      /**\r\n       * naturalizes the dataset, and adds a retrieve bulkdata method\r\n       * to any values containing BulkDataURI.\r\n       * @param {*} instance\r\n       * @returns naturalized dataset, with retrieveBulkData methods\r\n       */\r\n      const addRetrieveBulkData = instance => {\r\n        const naturalized = naturalizeDataset(instance);\r\n\r\n        // if we konw the server doesn't use bulkDataURI, then don't\r\n        if (!dicomWebConfig.bulkDataURI?.enabled) {\r\n          return naturalized;\r\n        }\r\n\r\n        Object.keys(naturalized).forEach(key => {\r\n          const value = naturalized[key];\r\n\r\n          // The value.Value will be set with the bulkdata read value\r\n          // in which case it isn't necessary to re-read this.\r\n          if (value && value.BulkDataURI && !value.Value) {\r\n            // Provide a method to fetch bulkdata\r\n            value.retrieveBulkData = () => {\r\n              // handle the scenarios where bulkDataURI is relative path\r\n              fixBulkDataURI(value, naturalized, dicomWebConfig);\r\n\r\n              const options = {\r\n                // The bulkdata fetches work with either multipart or\r\n                // singlepart, so set multipart to false to let the server\r\n                // decide which type to respond with.\r\n                multipart: false,\r\n                BulkDataURI: value.BulkDataURI,\r\n                // The study instance UID is required if the bulkdata uri\r\n                // is relative - that isn't disallowed by DICOMweb, but\r\n                // isn't well specified in the standard, but is needed in\r\n                // any implementation that stores static copies of the metadata\r\n                StudyInstanceUID: naturalized.StudyInstanceUID,\r\n              };\r\n              // Todo: this needs to be from wado dicom web client\r\n              return qidoDicomWebClient.retrieveBulkData(options).then(val => {\r\n                // There are DICOM PDF cases where the first ArrayBuffer in the array is\r\n                // the bulk data and DICOM video cases where the second ArrayBuffer is\r\n                // the bulk data. Here we play it safe and do a find.\r\n                const ret =\r\n                  (val instanceof Array &&\r\n                    val.find(arrayBuffer => arrayBuffer?.byteLength)) ||\r\n                  undefined;\r\n                value.Value = ret;\r\n                return ret;\r\n              });\r\n            };\r\n          }\r\n        });\r\n        return naturalized;\r\n      };\r\n\r\n      // Async load series, store as retrieved\r\n      function storeInstances(instances) {\r\n        const naturalizedInstances = instances.map(addRetrieveBulkData);\r\n\r\n        // Adding instanceMetadata to OHIF MetadataProvider\r\n        naturalizedInstances.forEach((instance, index) => {\r\n          instance.wadoRoot = dicomWebConfig.wadoRoot;\r\n          instance.wadoUri = dicomWebConfig.wadoUri;\r\n\r\n          const imageId = implementation.getImageIdsForInstance({\r\n            instance,\r\n          });\r\n\r\n          // Adding imageId to each instance\r\n          // Todo: This is not the best way I can think of to let external\r\n          // metadata handlers know about the imageId that is stored in the store\r\n          instance.imageId = imageId;\r\n\r\n          // Adding UIDs to metadataProvider\r\n          // Note: storing imageURI in metadataProvider since stack viewports\r\n          // will use the same imageURI\r\n          metadataProvider.addImageIdToUIDs(imageId, {\r\n            StudyInstanceUID,\r\n            SeriesInstanceUID: instance.SeriesInstanceUID,\r\n            SOPInstanceUID: instance.SOPInstanceUID,\r\n          });\r\n        });\r\n\r\n        DicomMetadataStore.addInstances(naturalizedInstances, madeInClient);\r\n      }\r\n\r\n      function setSuccessFlag() {\r\n        const study = DicomMetadataStore.getStudy(\r\n          StudyInstanceUID,\r\n          madeInClient\r\n        );\r\n        study.isLoaded = true;\r\n      }\r\n\r\n      // Google Cloud Healthcare doesn't return StudyInstanceUID, so we need to add\r\n      // it manually here\r\n      seriesSummaryMetadata.forEach(aSeries => {\r\n        aSeries.StudyInstanceUID = StudyInstanceUID;\r\n      });\r\n\r\n      DicomMetadataStore.addSeriesMetadata(seriesSummaryMetadata, madeInClient);\r\n\r\n      const seriesDeliveredPromises = seriesPromises.map(promise =>\r\n        promise.then(instances => {\r\n          storeInstances(instances);\r\n        })\r\n      );\r\n      await Promise.all(seriesDeliveredPromises);\r\n      setSuccessFlag();\r\n    },\r\n    deleteStudyMetadataPromise,\r\n    getImageIdsForDisplaySet(displaySet) {\r\n      const images = displaySet.images;\r\n      const imageIds = [];\r\n\r\n      if (!images) {\r\n        return imageIds;\r\n      }\r\n\r\n      displaySet.images.forEach(instance => {\r\n        const NumberOfFrames = instance.NumberOfFrames;\r\n\r\n        if (NumberOfFrames > 1) {\r\n          for (let frame = 1; frame <= NumberOfFrames; frame++) {\r\n            const imageId = this.getImageIdsForInstance({\r\n              instance,\r\n              frame,\r\n            });\r\n            imageIds.push(imageId);\r\n          }\r\n        } else {\r\n          const imageId = this.getImageIdsForInstance({ instance });\r\n          imageIds.push(imageId);\r\n        }\r\n      });\r\n\r\n      return imageIds;\r\n    },\r\n    getImageIdsForInstance({ instance, frame }) {\r\n      const imageIds = getImageId({\r\n        instance,\r\n        frame,\r\n        config: dicomWebConfig,\r\n      });\r\n      return imageIds;\r\n    },\r\n    getConfig() {\r\n      return dicomWebConfigCopy;\r\n    },\r\n  };\r\n\r\n  if (supportsReject) {\r\n    implementation.reject = dcm4cheeReject(wadoRoot);\r\n  }\r\n\r\n  return IWebApiDataSource.create(implementation);\r\n}\r\n\r\nexport { createDicomWebApi };\r\n","export default function (wadoRoot) {\r\n  return {\r\n    series: (StudyInstanceUID, SeriesInstanceUID) => {\r\n      return new Promise((resolve, reject) => {\r\n        // Reject because of Quality. (Seems the most sensible out of the options)\r\n        const CodeValueAndCodeSchemeDesignator = `113001%5EDCM`;\r\n\r\n        const url = `${wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/reject/${CodeValueAndCodeSchemeDesignator}`;\r\n\r\n        const xhr = new XMLHttpRequest();\r\n        xhr.open('POST', url, true);\r\n\r\n        //Send the proper header information along with the request\r\n        // TODO -> Auth when we re-add authorization.\r\n\r\n        console.log(xhr);\r\n\r\n        xhr.onreadystatechange = function () {\r\n          //Call a function when the state changes.\r\n          if (xhr.readyState == 4) {\r\n            switch (xhr.status) {\r\n              case 204:\r\n                resolve(xhr.responseText);\r\n\r\n                break;\r\n              case 404:\r\n                reject('Your dataSource does not support reject functionality');\r\n            }\r\n          }\r\n        };\r\n        xhr.send();\r\n      });\r\n    },\r\n  };\r\n}\r\n","import { DicomMetadataStore, IWebApiDataSource } from '@ohif/core';\r\nimport OHIF from '@ohif/core';\r\n\r\nimport getImageId from '../DicomWebDataSource/utils/getImageId';\r\nimport getDirectURL from '../utils/getDirectURL';\r\n\r\nconst metadataProvider = OHIF.classes.MetadataProvider;\r\n\r\nconst mappings = {\r\n  studyInstanceUid: 'StudyInstanceUID',\r\n  patientId: 'PatientID',\r\n};\r\n\r\nlet _store = {\r\n  urls: [],\r\n  // {\r\n  //   url: url1\r\n  //   studies: [Study1, Study2], // if multiple studies\r\n  // }\r\n  // {\r\n  //   url: url2\r\n  //   studies: [Study1],\r\n  // }\r\n  // }\r\n};\r\n\r\nconst getMetaDataByURL = url => {\r\n  return _store.urls.find(metaData => metaData.url === url);\r\n};\r\n\r\nconst findStudies = (key, value) => {\r\n  let studies = [];\r\n  _store.urls.map(metaData => {\r\n    metaData.studies.map(aStudy => {\r\n      if (aStudy[key] === value) {\r\n        studies.push(aStudy);\r\n      }\r\n    });\r\n  });\r\n  return studies;\r\n};\r\n\r\nfunction createDicomJSONApi(dicomJsonConfig) {\r\n  const { name, wadoRoot } = dicomJsonConfig;\r\n\r\n  const implementation = {\r\n    initialize: async ({ params, query, url }) => {\r\n      if (!url) url = query.get('url');\r\n      let metaData = getMetaDataByURL(url);\r\n\r\n      // if we have already cached the data from this specific url\r\n      // We are only handling one StudyInstanceUID to run; however,\r\n      // all studies for patientID will be put in the correct tab\r\n      if (metaData) {\r\n        return metaData.studies.map(aStudy => {\r\n          return aStudy.StudyInstanceUID;\r\n        });\r\n      }\r\n\r\n      const response = await fetch(url);\r\n      let data = await response.json();\r\n\r\n      const studyInstanceUIDs = data.studies.map(\r\n        study => study.StudyInstanceUID\r\n      );\r\n\r\n      let StudyInstanceUID;\r\n      let SeriesInstanceUID;\r\n      data.studies.forEach(study => {\r\n        StudyInstanceUID = study.StudyInstanceUID;\r\n\r\n        study.series.forEach(series => {\r\n          SeriesInstanceUID = series.SeriesInstanceUID;\r\n\r\n          series.instances.forEach(instance => {\r\n            const { url: imageId, metadata: naturalizedDicom } = instance;\r\n\r\n            // Add imageId specific mapping to this data as the URL isn't necessarliy WADO-URI.\r\n            metadataProvider.addImageIdToUIDs(imageId, {\r\n              StudyInstanceUID,\r\n              SeriesInstanceUID,\r\n              SOPInstanceUID: naturalizedDicom.SOPInstanceUID,\r\n            });\r\n          });\r\n        });\r\n      });\r\n\r\n      _store.urls.push({\r\n        url,\r\n        studies: [...data.studies],\r\n      });\r\n\r\n      return studyInstanceUIDs;\r\n    },\r\n    query: {\r\n      studies: {\r\n        mapParams: () => { },\r\n        search: async param => {\r\n          const [key, value] = Object.entries(param)[0];\r\n          const mappedParam = mappings[key];\r\n\r\n          // todo: should fetch from dicomMetadataStore\r\n          const studies = findStudies(mappedParam, value);\r\n\r\n          return studies.map(aStudy => {\r\n            return {\r\n              accession: aStudy.AccessionNumber,\r\n              date: aStudy.StudyDate,\r\n              description: aStudy.StudyDescription,\r\n              instances: aStudy.NumInstances,\r\n              modalities: aStudy.Modalities,\r\n              mrn: aStudy.PatientID,\r\n              patientName: aStudy.PatientName,\r\n              studyInstanceUid: aStudy.StudyInstanceUID,\r\n              NumInstances: aStudy.NumInstances,\r\n              time: aStudy.StudyTime,\r\n            };\r\n          });\r\n        },\r\n        processResults: () => {\r\n          console.debug(' DICOMJson QUERY processResults');\r\n        },\r\n      },\r\n      series: {\r\n        // mapParams: mapParams.bind(),\r\n        search: () => {\r\n          console.debug(' DICOMJson QUERY SERIES SEARCH');\r\n        },\r\n      },\r\n      instances: {\r\n        search: () => {\r\n          console.debug(' DICOMJson QUERY instances SEARCH');\r\n        },\r\n      },\r\n    },\r\n    retrieve: {\r\n      /**\r\n       * Generates a URL that can be used for direct retrieve of the bulkdata\r\n       *\r\n       * @param {object} params\r\n       * @param {string} params.tag is the tag name of the URL to retrieve\r\n       * @param {string} params.defaultPath path for the pixel data url\r\n       * @param {object} params.instance is the instance object that the tag is in\r\n       * @param {string} params.defaultType is the mime type of the response\r\n       * @param {string} params.singlepart is the type of the part to retrieve\r\n       * @param {string} params.fetchPart unknown?\r\n       * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\r\n       *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\r\n       */\r\n      directURL: params => {\r\n        return getDirectURL(wadoRoot, params);\r\n      },\r\n      series: {\r\n        metadata: ({\r\n          StudyInstanceUID,\r\n          madeInClient = false,\r\n          customSort,\r\n        } = {}) => {\r\n          if (!StudyInstanceUID) {\r\n            throw new Error(\r\n              'Unable to query for SeriesMetadata without StudyInstanceUID'\r\n            );\r\n          }\r\n\r\n          const study = findStudies('StudyInstanceUID', StudyInstanceUID)[0];\r\n          let series;\r\n\r\n          if (customSort) {\r\n            series = customSort(study.series);\r\n          } else {\r\n            series = study.series;\r\n          }\r\n\r\n          const seriesSummaryMetadata = series.map(series => {\r\n            const seriesSummary = {\r\n              StudyInstanceUID: study.StudyInstanceUID,\r\n              ...series,\r\n            };\r\n            delete seriesSummary.instances;\r\n            return seriesSummary;\r\n          });\r\n\r\n          // Async load series, store as retrieved\r\n          function storeInstances(naturalizedInstances) {\r\n            DicomMetadataStore.addInstances(naturalizedInstances, madeInClient);\r\n          }\r\n\r\n          DicomMetadataStore.addSeriesMetadata(\r\n            seriesSummaryMetadata,\r\n            madeInClient\r\n          );\r\n\r\n          function setSuccessFlag() {\r\n            const study = DicomMetadataStore.getStudy(\r\n              StudyInstanceUID,\r\n              madeInClient\r\n            );\r\n            study.isLoaded = true;\r\n          }\r\n\r\n          const numberOfSeries = series.length;\r\n          series.forEach((series, index) => {\r\n            const instances = series.instances.map(instance => {\r\n              const obj = {\r\n                ...instance.metadata,\r\n                url: instance.url,\r\n                imageId: instance.url,\r\n                ...series,\r\n                ...study,\r\n              };\r\n              delete obj.instances;\r\n              delete obj.series;\r\n              return obj;\r\n            });\r\n            storeInstances(instances);\r\n            if (index === numberOfSeries - 1) setSuccessFlag();\r\n          });\r\n        },\r\n      },\r\n    },\r\n    store: {\r\n      dicom: () => {\r\n        console.debug(' DICOMJson store dicom');\r\n      },\r\n    },\r\n    getImageIdsForDisplaySet(displaySet) {\r\n      const images = displaySet.images;\r\n      const imageIds = [];\r\n\r\n      if (!images) {\r\n        return imageIds;\r\n      }\r\n\r\n      displaySet.images.forEach(instance => {\r\n        const NumberOfFrames = instance.NumberOfFrames;\r\n\r\n        if (NumberOfFrames > 1) {\r\n          for (let i = 0; i < NumberOfFrames; i++) {\r\n            const imageId = getImageId({\r\n              instance,\r\n              frame: i,\r\n              config: dicomJsonConfig,\r\n            });\r\n            imageIds.push(imageId);\r\n          }\r\n        } else {\r\n          const imageId = getImageId({ instance, config: dicomJsonConfig });\r\n          imageIds.push(imageId);\r\n        }\r\n      });\r\n\r\n      return imageIds;\r\n    },\r\n    getImageIdsForInstance({ instance, frame }) {\r\n      const imageIds = getImageId({\r\n        instance,\r\n        frame,\r\n      });\r\n      return imageIds;\r\n    },\r\n  };\r\n  return IWebApiDataSource.create(implementation);\r\n}\r\n\r\nexport { createDicomJSONApi };\r\n","import { DicomMetadataStore, IWebApiDataSource, utils } from '@ohif/core';\r\nimport OHIF from '@ohif/core';\r\nimport dcmjs from 'dcmjs';\r\n\r\nconst metadataProvider = OHIF.classes.MetadataProvider;\r\nconst { EVENTS } = DicomMetadataStore;\r\n\r\nconst END_MODALITIES = {\r\n  SR: true,\r\n  SEG: true,\r\n  DOC: true,\r\n};\r\n\r\nconst compareValue = (v1, v2, def = 0) => {\r\n  if (v1 === v2) return def;\r\n  if (v1 < v2) return -1;\r\n  return 1;\r\n};\r\n\r\n// Sorting SR modalities to be at the end of series list\r\nconst customSort = (seriesA, seriesB) => {\r\n  const instanceA = seriesA.instances[0];\r\n  const instanceB = seriesB.instances[0];\r\n  const modalityA = instanceA.Modality;\r\n  const modalityB = instanceB.Modality;\r\n\r\n  const isEndA = END_MODALITIES[modalityA];\r\n  const isEndB = END_MODALITIES[modalityB];\r\n\r\n  if (isEndA && isEndB) {\r\n    // Compare by series date\r\n    return compareValue(instanceA.SeriesNumber, instanceB.SeriesNumber);\r\n  }\r\n  if (!isEndA && !isEndB) {\r\n    return compareValue(instanceB.SeriesNumber, instanceA.SeriesNumber);\r\n  }\r\n  return isEndA ? -1 : 1;\r\n};\r\n\r\nfunction createDicomLocalApi(dicomLocalConfig) {\r\n  const { name } = dicomLocalConfig;\r\n\r\n  const implementation = {\r\n    initialize: ({ params, query }) => {\r\n      const { StudyInstanceUIDs: paramsStudyInstanceUIDs } = params;\r\n      const queryStudyInstanceUIDs = query.getAll('StudyInstanceUIDs');\r\n\r\n      const StudyInstanceUIDs =\r\n        queryStudyInstanceUIDs || paramsStudyInstanceUIDs;\r\n      const StudyInstanceUIDsAsArray =\r\n        StudyInstanceUIDs && Array.isArray(StudyInstanceUIDs)\r\n          ? StudyInstanceUIDs\r\n          : [StudyInstanceUIDs];\r\n\r\n      // Put SRs at the end of series list to make sure images are loaded first\r\n      StudyInstanceUIDsAsArray.forEach(StudyInstanceUID => {\r\n        const study = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n        study.series = study.series.sort(customSort);\r\n      });\r\n\r\n      return StudyInstanceUIDsAsArray;\r\n    },\r\n    query: {\r\n      studies: {\r\n        mapParams: () => {},\r\n        search: params => {\r\n          const studyUIDs = DicomMetadataStore.getStudyInstanceUIDs();\r\n\r\n          return studyUIDs.map(StudyInstanceUID => {\r\n            let numInstances = 0;\r\n            const modalities = new Set();\r\n\r\n            // Calculating the number of instances in the study and modalities\r\n            // present in the study\r\n            const study = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n            study.series.forEach(aSeries => {\r\n              numInstances += aSeries.instances.length;\r\n              modalities.add(aSeries.instances[0].Modality);\r\n            });\r\n\r\n            // first instance in the first series\r\n            const firstInstance = study?.series[0]?.instances[0];\r\n\r\n            if (firstInstance) {\r\n              return {\r\n                accession: firstInstance.AccessionNumber,\r\n                date: firstInstance.StudyDate,\r\n                description: firstInstance.StudyDescription,\r\n                mrn: firstInstance.PatientID,\r\n                patientName: utils.formatPN(firstInstance.PatientName),\r\n                studyInstanceUid: firstInstance.StudyInstanceUID,\r\n                time: firstInstance.StudyTime,\r\n                //\r\n                instances: numInstances,\r\n                modalities: Array.from(modalities).join('/'),\r\n                NumInstances: numInstances,\r\n              };\r\n            }\r\n          });\r\n        },\r\n        processResults: () => {\r\n          console.debug(' DICOMLocal QUERY processResults');\r\n        },\r\n      },\r\n      series: {\r\n        search: studyInstanceUID => {\r\n          const study = DicomMetadataStore.getStudy(studyInstanceUID);\r\n          return study.series.map(aSeries => {\r\n            const firstInstance = aSeries?.instances[0];\r\n            return {\r\n              studyInstanceUid: studyInstanceUID,\r\n              seriesInstanceUid: firstInstance.SeriesInstanceUID,\r\n              modality: firstInstance.Modality,\r\n              seriesNumber: firstInstance.SeriesNumber,\r\n              seriesDate: firstInstance.SeriesDate,\r\n              numSeriesInstances: aSeries.instances.length,\r\n              description: firstInstance.SeriesDescription,\r\n            };\r\n          });\r\n        },\r\n      },\r\n      instances: {\r\n        search: () => {\r\n          console.debug(' DICOMLocal QUERY instances SEARCH');\r\n        },\r\n      },\r\n    },\r\n    retrieve: {\r\n      directURL: params => {\r\n        const { instance, tag, defaultType } = params;\r\n\r\n        const value = instance[tag];\r\n        if (value instanceof Array && value[0] instanceof ArrayBuffer) {\r\n          return URL.createObjectURL(\r\n            new Blob([value[0]], {\r\n              type: defaultType,\r\n            })\r\n          );\r\n        }\r\n      },\r\n      series: {\r\n        metadata: async ({ StudyInstanceUID, madeInClient = false } = {}) => {\r\n          if (!StudyInstanceUID) {\r\n            throw new Error(\r\n              'Unable to query for SeriesMetadata without StudyInstanceUID'\r\n            );\r\n          }\r\n\r\n          // Instances metadata already added via local upload\r\n          const study = DicomMetadataStore.getStudy(\r\n            StudyInstanceUID,\r\n            madeInClient\r\n          );\r\n\r\n          // Series metadata already added via local upload\r\n          DicomMetadataStore._broadcastEvent(EVENTS.SERIES_ADDED, {\r\n            StudyInstanceUID,\r\n            madeInClient,\r\n          });\r\n\r\n          study.series.forEach(aSeries => {\r\n            const { SeriesInstanceUID } = aSeries;\r\n\r\n            const isMultiframe = aSeries.instances[0].NumberOfFrames > 1;\r\n\r\n            aSeries.instances.forEach((instance, index) => {\r\n              const {\r\n                url: imageId,\r\n                StudyInstanceUID,\r\n                SeriesInstanceUID,\r\n                SOPInstanceUID,\r\n              } = instance;\r\n\r\n              instance.imageId = imageId;\r\n\r\n              // Add imageId specific mapping to this data as the URL isn't necessarily WADO-URI.\r\n              metadataProvider.addImageIdToUIDs(imageId, {\r\n                StudyInstanceUID,\r\n                SeriesInstanceUID,\r\n                SOPInstanceUID,\r\n                frameIndex: isMultiframe ? index : 1,\r\n              });\r\n            });\r\n\r\n            DicomMetadataStore._broadcastEvent(EVENTS.INSTANCES_ADDED, {\r\n              StudyInstanceUID,\r\n              SeriesInstanceUID,\r\n              madeInClient,\r\n            });\r\n          });\r\n        },\r\n      },\r\n    },\r\n    store: {\r\n      dicom: naturalizedReport => {\r\n        const reportBlob = dcmjs.data.datasetToBlob(naturalizedReport);\r\n\r\n        //Create a URL for the binary.\r\n        var objectUrl = URL.createObjectURL(reportBlob);\r\n        window.location.assign(objectUrl);\r\n      },\r\n    },\r\n    getImageIdsForDisplaySet(displaySet) {\r\n      const images = displaySet.images;\r\n      const imageIds = [];\r\n\r\n      if (!images) {\r\n        return imageIds;\r\n      }\r\n\r\n      displaySet.images.forEach(instance => {\r\n        const NumberOfFrames = instance.NumberOfFrames;\r\n        if (NumberOfFrames > 1) {\r\n          // in multiframe we start at frame 1\r\n          for (let i = 1; i <= NumberOfFrames; i++) {\r\n            const imageId = this.getImageIdsForInstance({\r\n              instance,\r\n              frame: i,\r\n            });\r\n            imageIds.push(imageId);\r\n          }\r\n        } else {\r\n          const imageId = this.getImageIdsForInstance({ instance });\r\n          imageIds.push(imageId);\r\n        }\r\n      });\r\n\r\n      return imageIds;\r\n    },\r\n    getImageIdsForInstance({ instance, frame }) {\r\n      const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\r\n      const storedInstance = DicomMetadataStore.getInstance(\r\n        StudyInstanceUID,\r\n        SeriesInstanceUID,\r\n        SOPInstanceUID\r\n      );\r\n\r\n      let imageId = storedInstance.url;\r\n\r\n      if (frame !== undefined) {\r\n        imageId += `&frame=${frame}`;\r\n      }\r\n\r\n      return imageId;\r\n    },\r\n    deleteStudyMetadataPromise() {\r\n      console.log('deleteStudyMetadataPromise not implemented');\r\n    },\r\n  };\r\n  return IWebApiDataSource.create(implementation);\r\n}\r\n\r\nexport { createDicomLocalApi };\r\n","import { IWebApiDataSource } from '@ohif/core';\r\nimport { createDicomWebApi } from '../DicomWebDataSource/index';\r\n\r\n/**\r\n * This datasource is initialized with a url that returns a JSON object with a\r\n * dicomWeb datasource configuration array present in a \"servers\" object.\r\n *\r\n * Only the first array item is parsed, if there are multiple items in the\r\n * dicomWeb configuration array\r\n *\r\n */\r\nfunction createDicomWebProxyApi(\r\n  dicomWebProxyConfig,\r\n  UserAuthenticationService\r\n) {\r\n  const { name } = dicomWebProxyConfig;\r\n  let dicomWebDelegate = undefined;\r\n\r\n  const implementation = {\r\n    initialize: async ({ params, query }) => {\r\n      let studyInstanceUIDs = [];\r\n\r\n      // there seem to be a couple of variations of the case for this parameter\r\n      const queryStudyInstanceUIDs =\r\n        query.get('studyInstanceUIDs') || query.get('studyInstanceUids');\r\n      if (!queryStudyInstanceUIDs) {\r\n        throw new Error(`No studyInstanceUids in request for '${name}'`);\r\n      }\r\n\r\n      const url = query.get('url');\r\n\r\n      if (!url) {\r\n        throw new Error(`No url for '${name}'`);\r\n      } else {\r\n        const response = await fetch(url);\r\n        let data = await response.json();\r\n        if (!data.servers?.dicomWeb?.[0]) {\r\n          throw new Error('Invalid configuration returned by url');\r\n        }\r\n\r\n        dicomWebDelegate = createDicomWebApi(\r\n          data.servers.dicomWeb[0],\r\n          UserAuthenticationService\r\n        );\r\n        studyInstanceUIDs = queryStudyInstanceUIDs.split(';');\r\n      }\r\n      return studyInstanceUIDs;\r\n    },\r\n    query: {\r\n      studies: {\r\n        search: params => dicomWebDelegate.query.studies.search(params),\r\n      },\r\n      series: {\r\n        search: (...args) => dicomWebDelegate.query.series.search(...args),\r\n      },\r\n      instances: {\r\n        search: (studyInstanceUid, queryParameters) =>\r\n          dicomWebDelegate.query.instances.search(\r\n            studyInstanceUid,\r\n            queryParameters\r\n          ),\r\n      },\r\n    },\r\n    retrieve: {\r\n      directURL: (...args) => dicomWebDelegate.retrieve.directURL(...args),\r\n      series: {\r\n        metadata: (...args) =>\r\n          dicomWebDelegate.retrieve.series.metadata(...args),\r\n      },\r\n    },\r\n    store: {\r\n      dicom: (...args) => dicomWebDelegate.store(...args),\r\n    },\r\n    deleteStudyMetadataPromise: (...args) =>\r\n      dicomWebDelegate.deleteStudyMetadataPromise(...args),\r\n    getImageIdsForDisplaySet: (...args) =>\r\n      dicomWebDelegate.getImageIdsForDisplaySet(...args),\r\n    getImageIdsForInstance: (...args) =>\r\n      dicomWebDelegate.getImageIdsForInstance(...args),\r\n  };\r\n  return IWebApiDataSource.create(implementation);\r\n}\r\n\r\nexport { createDicomWebProxyApi };\r\n","// TODO: Pull in IWebClientApi from @ohif/core\r\n// TODO: Use constructor to create an instance of IWebClientApi\r\n// TODO: Use existing DICOMWeb configuration (previously, appConfig, to configure instance)\r\n\r\nimport { createDicomWebApi } from './DicomWebDataSource/index.js';\r\nimport { createDicomJSONApi } from './DicomJSONDataSource/index.js';\r\nimport { createDicomLocalApi } from './DicomLocalDataSource/index.js';\r\nimport { createDicomWebProxyApi } from './DicomWebProxyDataSource/index.js';\r\n\r\n/**\r\n *\r\n */\r\nfunction getDataSourcesModule() {\r\n  return [\r\n    {\r\n      name: 'dicomweb',\r\n      type: 'webApi',\r\n      createDataSource: createDicomWebApi,\r\n    },\r\n    {\r\n      name: 'dicomwebproxy',\r\n      type: 'webApi',\r\n      createDataSource: createDicomWebProxyApi,\r\n    },\r\n    {\r\n      name: 'dicomjson',\r\n      type: 'jsonApi',\r\n      createDataSource: createDicomJSONApi,\r\n    },\r\n    {\r\n      name: 'dicomlocal',\r\n      type: 'localApi',\r\n      createDataSource: createDicomLocalApi,\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getDataSourcesModule;\r\n","import React, { useEffect, useState } from 'react';\r\nimport classnames from 'classnames';\r\n\r\nexport default function Toolbar({ servicesManager }) {\r\n  const { toolbarService } = servicesManager.services;\r\n  const [toolbarButtons, setToolbarButtons] = useState([]);\r\n  const [buttonState, setButtonState] = useState({\r\n    primaryToolId: '',\r\n    toggles: {},\r\n    groups: {},\r\n  });\r\n\r\n  // Could track buttons and state separately...?\r\n  useEffect(() => {\r\n    const { unsubscribe: unsub1 } = toolbarService.subscribe(\r\n      toolbarService.EVENTS.TOOL_BAR_MODIFIED,\r\n      () => setToolbarButtons(toolbarService.getButtonSection('primary'))\r\n    );\r\n    const { unsubscribe: unsub2 } = toolbarService.subscribe(\r\n      toolbarService.EVENTS.TOOL_BAR_STATE_MODIFIED,\r\n      () => setButtonState({ ...toolbarService.state })\r\n    );\r\n\r\n    return () => {\r\n      unsub1();\r\n      unsub2();\r\n    };\r\n  }, [toolbarService]);\r\n\r\n  return (\r\n    <>\r\n      {toolbarButtons.map((toolDef, index) => {\r\n        const { id, Component, componentProps } = toolDef;\r\n        // TODO: ...\r\n\r\n        // isActive if:\r\n        // - id is primary?\r\n        // - id is in list of \"toggled on\"?\r\n        let isActive;\r\n        if (componentProps.type === 'toggle') {\r\n          isActive = buttonState.toggles[id];\r\n        }\r\n        // Also need... to filter list for splitButton, and set primary based on most recently clicked\r\n        // Also need to kill the radioGroup button's magic logic\r\n        // Everything should be reactive off these props, so commands can inform ToolbarService\r\n\r\n        // These can... Trigger toolbar events based on updates?\r\n        // Then sync using useEffect, or simply modify the state here?\r\n        return (\r\n          // The margin for separating the tools on the toolbar should go here and NOT in each individual component (button) item.\r\n          // This allows for the individual items to be included in other UI components where perhaps alternative margins are desired.\r\n          <div key={id} className={classnames('mr-1')}>\r\n            <Component\r\n              id={id}\r\n              {...componentProps}\r\n              bState={buttonState}\r\n              isActive={isActive}\r\n              onInteraction={args => toolbarService.recordInteraction(args)}\r\n              servicesManager={servicesManager}\r\n            />\r\n          </div>\r\n        );\r\n      })}\r\n    </>\r\n  );\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { useLocation } from 'react-router';\r\n\r\nimport {\r\n  SidePanel,\r\n  ErrorBoundary,\r\n  UserPreferences,\r\n  AboutModal,\r\n  Header,\r\n  useModal,\r\n  LoadingIndicatorProgress,\r\n} from '@ohif/ui';\r\nimport i18n from '@ohif/i18n';\r\nimport {\r\n  ServicesManager,\r\n  HangingProtocolService,\r\n  hotkeys,\r\n  CommandsManager,\r\n} from '@ohif/core';\r\nimport { useAppConfig } from '@state';\r\nimport Toolbar from '../Toolbar/Toolbar';\r\n\r\nconst { availableLanguages, defaultLanguage, currentLanguage } = i18n;\r\n\r\nfunction ViewerLayout({\r\n  // From Extension Module Params\r\n  extensionManager,\r\n  servicesManager,\r\n  hotkeysManager,\r\n  commandsManager,\r\n  // From Modes\r\n  viewports,\r\n  ViewportGridComp,\r\n  leftPanels = [],\r\n  rightPanels = [],\r\n  leftPanelDefaultClosed = false,\r\n  rightPanelDefaultClosed = false,\r\n}): React.FunctionComponent {\r\n  const [appConfig] = useAppConfig();\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n\r\n  const onClickReturnButton = () => {\r\n    const { pathname } = location;\r\n    const dataSourceIdx = pathname.indexOf('/', 1);\r\n    // const search =\r\n    //   dataSourceIdx === -1\r\n    //     ? undefined\r\n    //     : `datasources=${pathname.substring(dataSourceIdx + 1)}`;\r\n\r\n    // Todo: Handle parameters in a better way.\r\n    const query = new URLSearchParams(window.location.search);\r\n    const configUrl = query.get('configUrl');\r\n\r\n    const searchQuery = new URLSearchParams();\r\n    if (dataSourceIdx !== -1) {\r\n      searchQuery.append('datasources', pathname.substring(dataSourceIdx + 1));\r\n    }\r\n\r\n    if (configUrl) {\r\n      searchQuery.append('configUrl', configUrl);\r\n    }\r\n\r\n    navigate({\r\n      pathname: '/',\r\n      search: decodeURIComponent(searchQuery.toString()),\r\n    });\r\n  };\r\n\r\n  const { t } = useTranslation();\r\n  const { show, hide } = useModal();\r\n\r\n  const [showLoadingIndicator, setShowLoadingIndicator] = useState(\r\n    appConfig.showLoadingIndicator\r\n  );\r\n\r\n  const { hangingProtocolService } = servicesManager.services;\r\n\r\n  const { hotkeyDefinitions, hotkeyDefaults } = hotkeysManager;\r\n  const versionNumber = process.env.VERSION_NUMBER;\r\n  const buildNumber = process.env.BUILD_NUM;\r\n\r\n  const menuOptions = [\r\n    {\r\n      title: t('Header:About'),\r\n      icon: 'info',\r\n      onClick: () =>\r\n        show({\r\n          content: AboutModal,\r\n          title: 'About OHIF Viewer',\r\n          contentProps: { versionNumber, buildNumber },\r\n        }),\r\n    },\r\n    {\r\n      title: t('Header:Preferences'),\r\n      icon: 'settings',\r\n      onClick: () =>\r\n        show({\r\n          title: t('UserPreferencesModal:User Preferences'),\r\n          content: UserPreferences,\r\n          contentProps: {\r\n            hotkeyDefaults: hotkeysManager.getValidHotkeyDefinitions(\r\n              hotkeyDefaults\r\n            ),\r\n            hotkeyDefinitions,\r\n            currentLanguage: currentLanguage(),\r\n            availableLanguages,\r\n            defaultLanguage,\r\n            onCancel: () => {\r\n              hotkeys.stopRecord();\r\n              hotkeys.unpause();\r\n              hide();\r\n            },\r\n            onSubmit: ({ hotkeyDefinitions, language }) => {\r\n              i18n.changeLanguage(language.value);\r\n              hotkeysManager.setHotkeys(hotkeyDefinitions);\r\n              hide();\r\n            },\r\n            onReset: () => hotkeysManager.restoreDefaultBindings(),\r\n            hotkeysModule: hotkeys,\r\n          },\r\n        }),\r\n    },\r\n  ];\r\n\r\n  if (appConfig.oidc) {\r\n    menuOptions.push({\r\n      title: t('Header:Logout'),\r\n      icon: 'power-off',\r\n      onClick: async () => {\r\n        navigate(\r\n          `/logout?redirect_uri=${encodeURIComponent(window.location.href)}`\r\n        );\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set body classes (tailwindcss) that don't allow vertical\r\n   * or horizontal overflow (no scrolling). Also guarantee window\r\n   * is sized to our viewport.\r\n   */\r\n  useEffect(() => {\r\n    document.body.classList.add('bg-black');\r\n    document.body.classList.add('overflow-hidden');\r\n    return () => {\r\n      document.body.classList.remove('bg-black');\r\n      document.body.classList.remove('overflow-hidden');\r\n    };\r\n  }, []);\r\n\r\n  const getComponent = id => {\r\n    const entry = extensionManager.getModuleEntry(id);\r\n\r\n    if (!entry) {\r\n      throw new Error(\r\n        `${id} is not a valid entry for an extension module, please check your configuration or make sure the extension is registered.`\r\n      );\r\n    }\r\n\r\n    let content;\r\n    if (entry && entry.component) {\r\n      content = entry.component;\r\n    } else {\r\n      throw new Error(\r\n        `No component found from extension ${id}. Check the reference string to the extension in your Mode configuration`\r\n      );\r\n    }\r\n\r\n    return { entry, content };\r\n  };\r\n\r\n  const getPanelData = id => {\r\n    const { content, entry } = getComponent(id);\r\n\r\n    return {\r\n      id: entry.id,\r\n      iconName: entry.iconName,\r\n      iconLabel: entry.iconLabel,\r\n      label: entry.label,\r\n      name: entry.name,\r\n      content,\r\n    };\r\n  };\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = hangingProtocolService.subscribe(\r\n      HangingProtocolService.EVENTS.PROTOCOL_CHANGED,\r\n\r\n      // Todo: right now to set the loading indicator to false, we need to wait for the\r\n      // hangingProtocolService to finish applying the viewport matching to each viewport,\r\n      // however, this might not be the only approach to set the loading indicator to false. we need to explore this further.\r\n      () => {\r\n        setShowLoadingIndicator(false);\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [hangingProtocolService]);\r\n\r\n  const getViewportComponentData = viewportComponent => {\r\n    const { entry } = getComponent(viewportComponent.namespace);\r\n\r\n    return {\r\n      component: entry.component,\r\n      displaySetsToDisplay: viewportComponent.displaySetsToDisplay,\r\n    };\r\n  };\r\n\r\n  const leftPanelComponents = leftPanels.map(getPanelData);\r\n  const rightPanelComponents = rightPanels.map(getPanelData);\r\n  const viewportComponents = viewports.map(getViewportComponentData);\r\n\r\n  return (\r\n    <div>\r\n      <Header\r\n        menuOptions={menuOptions}\r\n        isReturnEnabled={!!appConfig.showStudyList}\r\n        onClickReturnButton={onClickReturnButton}\r\n        WhiteLabeling={appConfig.whiteLabeling}\r\n      >\r\n        <ErrorBoundary context=\"Primary Toolbar\">\r\n          <div className=\"relative flex justify-center\">\r\n            <Toolbar servicesManager={servicesManager} />\r\n          </div>\r\n        </ErrorBoundary>\r\n      </Header>\r\n      <div\r\n        className=\"bg-black flex flex-row items-stretch w-full overflow-hidden flex-nowrap relative\"\r\n        style={{ height: 'calc(100vh - 52px' }}\r\n      >\r\n        <React.Fragment>\r\n          {showLoadingIndicator && (\r\n            <LoadingIndicatorProgress className=\"h-full w-full bg-black\" />\r\n          )}\r\n          {/* LEFT SIDEPANELS */}\r\n          {leftPanelComponents.length ? (\r\n            <ErrorBoundary context=\"Left Panel\">\r\n              <SidePanel\r\n                side=\"left\"\r\n                activeTabIndex={leftPanelDefaultClosed ? null : 0}\r\n                tabs={leftPanelComponents}\r\n                servicesManager={servicesManager}\r\n              />\r\n            </ErrorBoundary>\r\n          ) : null}\r\n          {/* TOOLBAR + GRID */}\r\n          <div className=\"flex flex-col flex-1 h-full\">\r\n            <div className=\"flex items-center justify-center flex-1 h-full overflow-hidden bg-black relative\">\r\n              <ErrorBoundary context=\"Grid\">\r\n                <ViewportGridComp\r\n                  servicesManager={servicesManager}\r\n                  viewportComponents={viewportComponents}\r\n                  commandsManager={commandsManager}\r\n                />\r\n              </ErrorBoundary>\r\n            </div>\r\n          </div>\r\n          {rightPanelComponents.length ? (\r\n            <ErrorBoundary context=\"Right Panel\">\r\n              <SidePanel\r\n                side=\"right\"\r\n                activeTabIndex={rightPanelDefaultClosed ? null : 0}\r\n                tabs={rightPanelComponents}\r\n                servicesManager={servicesManager}\r\n              />\r\n            </ErrorBoundary>\r\n          ) : null}\r\n        </React.Fragment>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nViewerLayout.propTypes = {\r\n  // From extension module params\r\n  extensionManager: PropTypes.shape({\r\n    getModuleEntry: PropTypes.func.isRequired,\r\n  }).isRequired,\r\n  commandsManager: PropTypes.instanceOf(CommandsManager),\r\n  servicesManager: PropTypes.instanceOf(ServicesManager),\r\n  // From modes\r\n  leftPanels: PropTypes.array,\r\n  rightPanels: PropTypes.array,\r\n  leftPanelDefaultClosed: PropTypes.bool.isRequired,\r\n  rightPanelDefaultClosed: PropTypes.bool.isRequired,\r\n  /** Responsible for rendering our grid of viewports; provided by consuming application */\r\n  children: PropTypes.oneOfType([PropTypes.node, PropTypes.func]).isRequired,\r\n};\r\n\r\nexport default ViewerLayout;\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { StudyBrowser, useImageViewer, useViewportGrid } from '@ohif/ui';\r\nimport { utils } from '@ohif/core';\r\n\r\nconst { sortStudyInstances, formatDate } = utils;\r\n\r\n/**\r\n *\r\n * @param {*} param0\r\n */\r\nfunction PanelStudyBrowser({\r\n  servicesManager,\r\n  getImageSrc,\r\n  getStudiesForPatientByMRN,\r\n  requestDisplaySetCreationForStudy,\r\n  dataSource,\r\n}) {\r\n  const {\r\n    hangingProtocolService,\r\n    displaySetService,\r\n    uiNotificationService,\r\n  } = servicesManager.services;\r\n  // Normally you nest the components so the tree isn't so deep, and the data\r\n  // doesn't have to have such an intense shape. This works well enough for now.\r\n  // Tabs --> Studies --> DisplaySets --> Thumbnails\r\n  const { StudyInstanceUIDs } = useImageViewer();\r\n  const [\r\n    { activeViewportIndex, viewports },\r\n    viewportGridService,\r\n  ] = useViewportGrid();\r\n  const [activeTabName, setActiveTabName] = useState('primary');\r\n  const [expandedStudyInstanceUIDs, setExpandedStudyInstanceUIDs] = useState([\r\n    ...StudyInstanceUIDs,\r\n  ]);\r\n  const [studyDisplayList, setStudyDisplayList] = useState([]);\r\n  const [displaySets, setDisplaySets] = useState([]);\r\n  const [thumbnailImageSrcMap, setThumbnailImageSrcMap] = useState({});\r\n  const isMounted = useRef(true);\r\n\r\n  const onDoubleClickThumbnailHandler = displaySetInstanceUID => {\r\n    let updatedViewports = [];\r\n    const viewportIndex = activeViewportIndex;\r\n    try {\r\n      updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\r\n        viewportIndex,\r\n        displaySetInstanceUID\r\n      );\r\n    } catch (error) {\r\n      console.warn(error);\r\n      uiNotificationService.show({\r\n        title: 'Thumbnail Double Click',\r\n        message:\r\n          'The selected display sets could not be added to the viewport.',\r\n        type: 'info',\r\n        duration: 3000,\r\n      });\r\n    }\r\n\r\n    viewportGridService.setDisplaySetsForViewports(updatedViewports);\r\n  };\r\n\r\n  // ~~ studyDisplayList\r\n  useEffect(() => {\r\n    // Fetch all studies for the patient in each primary study\r\n    async function fetchStudiesForPatient(StudyInstanceUID) {\r\n      // current study qido\r\n      const qidoForStudyUID = await dataSource.query.studies.search({\r\n        studyInstanceUid: StudyInstanceUID,\r\n      });\r\n\r\n      let qidoStudiesForPatient = qidoForStudyUID;\r\n\r\n      // try to fetch the prior studies based on the patientID if the\r\n      // server can respond.\r\n      try {\r\n        qidoStudiesForPatient = await getStudiesForPatientByMRN(\r\n          qidoForStudyUID\r\n        );\r\n      } catch (error) {\r\n        console.warn(error);\r\n      }\r\n\r\n      const mappedStudies = _mapDataSourceStudies(qidoStudiesForPatient);\r\n      const actuallyMappedStudies = mappedStudies.map(qidoStudy => {\r\n        return {\r\n          studyInstanceUid: qidoStudy.StudyInstanceUID,\r\n          date: formatDate(qidoStudy.StudyDate),\r\n          description: qidoStudy.StudyDescription,\r\n          modalities: qidoStudy.ModalitiesInStudy,\r\n          numInstances: qidoStudy.NumInstances,\r\n        };\r\n      });\r\n\r\n      setStudyDisplayList(prevArray => {\r\n        const ret = [...prevArray];\r\n        for (const study of actuallyMappedStudies) {\r\n          if (\r\n            !prevArray.find(\r\n              it => it.studyInstanceUid === study.studyInstanceUid\r\n            )\r\n          ) {\r\n            ret.push(study);\r\n          }\r\n        }\r\n        return ret;\r\n      });\r\n    }\r\n\r\n    StudyInstanceUIDs.forEach(sid => fetchStudiesForPatient(sid));\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [StudyInstanceUIDs, getStudiesForPatientByMRN]);\r\n\r\n  // // ~~ Initial Thumbnails\r\n  useEffect(() => {\r\n    const currentDisplaySets = displaySetService.activeDisplaySets;\r\n    currentDisplaySets.forEach(async dSet => {\r\n      const newImageSrcEntry = {};\r\n      const displaySet = displaySetService.getDisplaySetByUID(\r\n        dSet.displaySetInstanceUID\r\n      );\r\n      const imageIds = dataSource.getImageIdsForDisplaySet(displaySet);\r\n      const imageId = imageIds[Math.floor(imageIds.length / 2)];\r\n\r\n      // TODO: Is it okay that imageIds are not returned here for SR displaySets?\r\n      if (imageId) {\r\n        // When the image arrives, render it and store the result in the thumbnailImgSrcMap\r\n        newImageSrcEntry[dSet.displaySetInstanceUID] = await getImageSrc(\r\n          imageId\r\n        );\r\n        if (isMounted.current) {\r\n          setThumbnailImageSrcMap(prevState => {\r\n            return { ...prevState, ...newImageSrcEntry };\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return () => {\r\n      isMounted.current = false;\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // ~~ displaySets\r\n  useEffect(() => {\r\n    // TODO: Are we sure `activeDisplaySets` will always be accurate?\r\n    const currentDisplaySets = displaySetService.activeDisplaySets;\r\n    const mappedDisplaySets = _mapDisplaySets(\r\n      currentDisplaySets,\r\n      thumbnailImageSrcMap\r\n    );\r\n    sortStudyInstances(mappedDisplaySets);\r\n\r\n    setDisplaySets(mappedDisplaySets);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [thumbnailImageSrcMap]);\r\n\r\n  // ~~ subscriptions --> displaySets\r\n  useEffect(() => {\r\n    // DISPLAY_SETS_ADDED returns an array of DisplaySets that were added\r\n    const SubscriptionDisplaySetsAdded = displaySetService.subscribe(\r\n      displaySetService.EVENTS.DISPLAY_SETS_ADDED,\r\n      data => {\r\n        const { displaySetsAdded } = data;\r\n        displaySetsAdded.forEach(async dSet => {\r\n          const newImageSrcEntry = {};\r\n          const displaySet = displaySetService.getDisplaySetByUID(\r\n            dSet.displaySetInstanceUID\r\n          );\r\n          const imageIds = dataSource.getImageIdsForDisplaySet(displaySet);\r\n          const imageId = imageIds[Math.floor(imageIds.length / 2)];\r\n\r\n          // TODO: Is it okay that imageIds are not returned here for SR displaysets?\r\n          if (imageId) {\r\n            // When the image arrives, render it and store the result in the thumbnailImgSrcMap\r\n            newImageSrcEntry[dSet.displaySetInstanceUID] = await getImageSrc(\r\n              imageId,\r\n              dSet.initialViewport\r\n            );\r\n            if (isMounted.current) {\r\n              setThumbnailImageSrcMap(prevState => {\r\n                return { ...prevState, ...newImageSrcEntry };\r\n              });\r\n            }\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    // TODO: Will this always hold _all_ the displaySets we care about?\r\n    // DISPLAY_SETS_CHANGED returns `DisplaySerService.activeDisplaySets`\r\n    const SubscriptionDisplaySetsChanged = displaySetService.subscribe(\r\n      displaySetService.EVENTS.DISPLAY_SETS_CHANGED,\r\n      changedDisplaySets => {\r\n        const mappedDisplaySets = _mapDisplaySets(\r\n          changedDisplaySets,\r\n          thumbnailImageSrcMap\r\n        );\r\n        setDisplaySets(mappedDisplaySets);\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      SubscriptionDisplaySetsAdded.unsubscribe();\r\n      SubscriptionDisplaySetsChanged.unsubscribe();\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  const tabs = _createStudyBrowserTabs(\r\n    StudyInstanceUIDs,\r\n    studyDisplayList,\r\n    displaySets\r\n  );\r\n\r\n  // TODO: Should not fire this on \"close\"\r\n  function _handleStudyClick(StudyInstanceUID) {\r\n    const shouldCollapseStudy = expandedStudyInstanceUIDs.includes(\r\n      StudyInstanceUID\r\n    );\r\n    const updatedExpandedStudyInstanceUIDs = shouldCollapseStudy\r\n      ? // eslint-disable-next-line prettier/prettier\r\n        [\r\n          ...expandedStudyInstanceUIDs.filter(\r\n            stdyUid => stdyUid !== StudyInstanceUID\r\n          ),\r\n        ]\r\n      : [...expandedStudyInstanceUIDs, StudyInstanceUID];\r\n\r\n    setExpandedStudyInstanceUIDs(updatedExpandedStudyInstanceUIDs);\r\n\r\n    if (!shouldCollapseStudy) {\r\n      const madeInClient = true;\r\n      requestDisplaySetCreationForStudy(\r\n        displaySetService,\r\n        StudyInstanceUID,\r\n        madeInClient\r\n      );\r\n    }\r\n  }\r\n\r\n  const activeDisplaySetInstanceUIDs =\r\n    viewports[activeViewportIndex]?.displaySetInstanceUIDs;\r\n\r\n  return (\r\n    <StudyBrowser\r\n      tabs={tabs}\r\n      servicesManager={servicesManager}\r\n      activeTabName={activeTabName}\r\n      onDoubleClickThumbnail={onDoubleClickThumbnailHandler}\r\n      activeDisplaySetInstanceUIDs={activeDisplaySetInstanceUIDs}\r\n      expandedStudyInstanceUIDs={expandedStudyInstanceUIDs}\r\n      onClickStudy={_handleStudyClick}\r\n      onClickTab={clickedTabName => {\r\n        setActiveTabName(clickedTabName);\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\nPanelStudyBrowser.propTypes = {\r\n  servicesManager: PropTypes.object.isRequired,\r\n  dataSource: PropTypes.shape({\r\n    getImageIdsForDisplaySet: PropTypes.func.isRequired,\r\n  }).isRequired,\r\n  getImageSrc: PropTypes.func.isRequired,\r\n  getStudiesForPatientByMRN: PropTypes.func.isRequired,\r\n  requestDisplaySetCreationForStudy: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default PanelStudyBrowser;\r\n\r\n/**\r\n * Maps from the DataSource's format to a naturalized object\r\n *\r\n * @param {*} studies\r\n */\r\nfunction _mapDataSourceStudies(studies) {\r\n  return studies.map(study => {\r\n    // TODO: Why does the data source return in this format?\r\n    return {\r\n      AccessionNumber: study.accession,\r\n      StudyDate: study.date,\r\n      StudyDescription: study.description,\r\n      NumInstances: study.instances,\r\n      ModalitiesInStudy: study.modalities,\r\n      PatientID: study.mrn,\r\n      PatientName: study.patientName,\r\n      StudyInstanceUID: study.studyInstanceUid,\r\n      StudyTime: study.time,\r\n    };\r\n  });\r\n}\r\n\r\nfunction _mapDisplaySets(displaySets, thumbnailImageSrcMap) {\r\n  const thumbnailDisplaySets = [];\r\n  const thumbnailNoImageDisplaySets = [];\r\n\r\n  displaySets\r\n    .filter(ds => !ds.excludeFromThumbnailBrowser)\r\n    .forEach(ds => {\r\n      const imageSrc = thumbnailImageSrcMap[ds.displaySetInstanceUID];\r\n      const componentType = _getComponentType(ds.Modality);\r\n\r\n      const array =\r\n        componentType === 'thumbnail'\r\n          ? thumbnailDisplaySets\r\n          : thumbnailNoImageDisplaySets;\r\n\r\n      array.push({\r\n        displaySetInstanceUID: ds.displaySetInstanceUID,\r\n        description: ds.SeriesDescription || '',\r\n        seriesNumber: ds.SeriesNumber,\r\n        modality: ds.Modality,\r\n        seriesDate: ds.SeriesDate,\r\n        seriesTime: ds.SeriesTime,\r\n        numInstances: ds.numImageFrames,\r\n        countIcon: ds.countIcon,\r\n        StudyInstanceUID: ds.StudyInstanceUID,\r\n        componentType,\r\n        imageSrc,\r\n        dragData: {\r\n          type: 'displayset',\r\n          displaySetInstanceUID: ds.displaySetInstanceUID,\r\n          // .. Any other data to pass\r\n        },\r\n      });\r\n    });\r\n\r\n  return [...thumbnailDisplaySets, ...thumbnailNoImageDisplaySets];\r\n}\r\n\r\nconst thumbnailNoImageModalities = [\r\n  'SR',\r\n  'SEG',\r\n  'SM',\r\n  'RTSTRUCT',\r\n  'RTPLAN',\r\n  'RTDOSE',\r\n];\r\n\r\nfunction _getComponentType(Modality) {\r\n  if (thumbnailNoImageModalities.includes(Modality)) {\r\n    // TODO probably others.\r\n    return 'thumbnailNoImage';\r\n  }\r\n\r\n  return 'thumbnail';\r\n}\r\n\r\n/**\r\n *\r\n * @param {string[]} primaryStudyInstanceUIDs\r\n * @param {object[]} studyDisplayList\r\n * @param {string} studyDisplayList.studyInstanceUid\r\n * @param {string} studyDisplayList.date\r\n * @param {string} studyDisplayList.description\r\n * @param {string} studyDisplayList.modalities\r\n * @param {number} studyDisplayList.numInstances\r\n * @param {object[]} displaySets\r\n * @returns tabs - The prop object expected by the StudyBrowser component\r\n */\r\nfunction _createStudyBrowserTabs(\r\n  primaryStudyInstanceUIDs,\r\n  studyDisplayList,\r\n  displaySets\r\n) {\r\n  const primaryStudies = [];\r\n  const recentStudies = [];\r\n  const allStudies = [];\r\n\r\n  studyDisplayList.forEach(study => {\r\n    const displaySetsForStudy = displaySets.filter(\r\n      ds => ds.StudyInstanceUID === study.studyInstanceUid\r\n    );\r\n    const tabStudy = Object.assign({}, study, {\r\n      displaySets: displaySetsForStudy,\r\n    });\r\n\r\n    if (primaryStudyInstanceUIDs.includes(study.studyInstanceUid)) {\r\n      primaryStudies.push(tabStudy);\r\n    } else {\r\n      // TODO: Filter allStudies to dates within one year of current date\r\n      recentStudies.push(tabStudy);\r\n      allStudies.push(tabStudy);\r\n    }\r\n  });\r\n\r\n  const tabs = [\r\n    {\r\n      name: 'primary',\r\n      label: 'Primary',\r\n      studies: primaryStudies,\r\n    },\r\n    {\r\n      name: 'recent',\r\n      label: 'Recent',\r\n      studies: recentStudies,\r\n    },\r\n    {\r\n      name: 'all',\r\n      label: 'All',\r\n      studies: allStudies,\r\n    },\r\n  ];\r\n\r\n  return tabs;\r\n}\r\n","/**\r\n * @param {*} cornerstone\r\n * @param {*} imageId\r\n */\r\nfunction getImageSrcFromImageId(cornerstone, imageId) {\r\n  return new Promise((resolve, reject) => {\r\n    const canvas = document.createElement('canvas');\r\n    cornerstone.utilities\r\n      .loadImageToCanvas({ canvas, imageId })\r\n      .then(imageId => {\r\n        resolve(canvas.toDataURL());\r\n      })\r\n      .catch(reject);\r\n  });\r\n}\r\nexport default getImageSrcFromImageId;\r\n","async function getStudiesForPatientByMRN(dataSource, qidoForStudyUID) {\r\n  if (qidoForStudyUID && qidoForStudyUID.length && qidoForStudyUID[0].mrn) {\r\n    return dataSource.query.studies.search({\r\n      patientId: qidoForStudyUID[0].mrn,\r\n    });\r\n  }\r\n  console.log('No mrn found for', qidoForStudyUID);\r\n  return qidoForStudyUID;\r\n}\r\n\r\nexport default getStudiesForPatientByMRN;\r\n","function requestDisplaySetCreationForStudy(\r\n  dataSource,\r\n  displaySetService,\r\n  StudyInstanceUID,\r\n  madeInClient\r\n) {\r\n  // TODO: is this already short-circuited by the map of Retrieve promises?\r\n  if (\r\n    displaySetService.activeDisplaySets.some(\r\n      displaySet => displaySet.StudyInstanceUID === StudyInstanceUID\r\n    )\r\n  ) {\r\n    return;\r\n  }\r\n\r\n  dataSource.retrieve.series.metadata({ StudyInstanceUID, madeInClient });\r\n}\r\n\r\nexport default requestDisplaySetCreationForStudy;\r\n","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\n//\r\nimport PanelStudyBrowser from './PanelStudyBrowser';\r\nimport getImageSrcFromImageId from './getImageSrcFromImageId';\r\nimport getStudiesForPatientByMRN from './getStudiesForPatientByMRN';\r\nimport requestDisplaySetCreationForStudy from './requestDisplaySetCreationForStudy';\r\n\r\n/**\r\n * Wraps the PanelStudyBrowser and provides features afforded by managers/services\r\n *\r\n * @param {object} params\r\n * @param {object} commandsManager\r\n * @param {object} extensionManager\r\n */\r\nfunction WrappedPanelStudyBrowser({\r\n  commandsManager,\r\n  extensionManager,\r\n  servicesManager,\r\n}) {\r\n  // TODO: This should be made available a different way; route should have\r\n  // already determined our datasource\r\n  const dataSource = extensionManager.getDataSources()[0];\r\n  const _getStudiesForPatientByMRN = getStudiesForPatientByMRN.bind(\r\n    null,\r\n    dataSource\r\n  );\r\n  const _getImageSrcFromImageId = _createGetImageSrcFromImageIdFn(\r\n    extensionManager\r\n  );\r\n  const _requestDisplaySetCreationForStudy = requestDisplaySetCreationForStudy.bind(\r\n    null,\r\n    dataSource\r\n  );\r\n\r\n  return (\r\n    <PanelStudyBrowser\r\n      servicesManager={servicesManager}\r\n      dataSource={dataSource}\r\n      getImageSrc={_getImageSrcFromImageId}\r\n      getStudiesForPatientByMRN={_getStudiesForPatientByMRN}\r\n      requestDisplaySetCreationForStudy={_requestDisplaySetCreationForStudy}\r\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Grabs cornerstone library reference using a dependent command from\r\n * the @ohif/extension-cornerstone extension. Then creates a helper function\r\n * that can take an imageId and return an image src.\r\n *\r\n * @param {func} getCommand - CommandManager's getCommand method\r\n * @returns {func} getImageSrcFromImageId - A utility function powered by\r\n * cornerstone\r\n */\r\nfunction _createGetImageSrcFromImageIdFn(extensionManager) {\r\n  const utilities = extensionManager.getModuleEntry(\r\n    '@ohif/extension-cornerstone.utilityModule.common'\r\n  );\r\n\r\n  try {\r\n    const { cornerstone } = utilities.exports.getCornerstoneLibraries();\r\n    return getImageSrcFromImageId.bind(null, cornerstone);\r\n  } catch (ex) {\r\n    throw new Error('Required command not found');\r\n  }\r\n}\r\n\r\nWrappedPanelStudyBrowser.propTypes = {\r\n  commandsManager: PropTypes.object.isRequired,\r\n  extensionManager: PropTypes.object.isRequired,\r\n  servicesManager: PropTypes.object.isRequired,\r\n};\r\n\r\nexport default WrappedPanelStudyBrowser;\r\n","import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { useTranslation } from 'react-i18next';\r\n\r\nimport { Button, ButtonGroup } from '@ohif/ui';\r\n\r\nfunction ActionButtons({ onExportClick, onCreateReportClick }) {\r\n  const { t } = useTranslation('MeasurementTable');\r\n\r\n  return (\r\n    <React.Fragment>\r\n      <ButtonGroup color=\"black\" size=\"inherit\">\r\n        <Button className=\"px-2 py-2 text-base\" onClick={onExportClick}>\r\n          {t('Export CSV')}\r\n        </Button>\r\n        <Button className=\"px-2 py-2 text-base\" onClick={onCreateReportClick}>\r\n          {t('Create Report')}\r\n        </Button>\r\n      </ButtonGroup>\r\n    </React.Fragment>\r\n  );\r\n}\r\n\r\nActionButtons.propTypes = {\r\n  onExportClick: PropTypes.func,\r\n  onCreateReportClick: PropTypes.func,\r\n};\r\n\r\nActionButtons.defaultProps = {\r\n  onExportClick: () => alert('Export'),\r\n  onCreateReportClick: () => alert('Create Report'),\r\n};\r\n\r\nexport default ActionButtons;\r\n","/* eslint-disable react/display-name */\r\nimport React from 'react';\r\nimport { Dialog, Input, Select } from '@ohif/ui';\r\n\r\nexport const CREATE_REPORT_DIALOG_RESPONSE = {\r\n  CANCEL: 0,\r\n  CREATE_REPORT: 1,\r\n};\r\n\r\nexport default function createReportDialogPrompt(\r\n  uiDialogService,\r\n  { extensionManager }\r\n) {\r\n  return new Promise(function (resolve, reject) {\r\n    let dialogId = undefined;\r\n\r\n    const _handleClose = () => {\r\n      // Dismiss dialog\r\n      uiDialogService.dismiss({ id: dialogId });\r\n      // Notify of cancel action\r\n      resolve({\r\n        action: CREATE_REPORT_DIALOG_RESPONSE.CANCEL,\r\n        value: undefined,\r\n        dataSourceName: undefined,\r\n      });\r\n    };\r\n\r\n    /**\r\n     *\r\n     * @param {string} param0.action - value of action performed\r\n     * @param {string} param0.value - value from input field\r\n     */\r\n    const _handleFormSubmit = ({ action, value }) => {\r\n      uiDialogService.dismiss({ id: dialogId });\r\n      switch (action.id) {\r\n        case 'save':\r\n          resolve({\r\n            action: CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT,\r\n            value: value.label,\r\n            dataSourceName: value.dataSourceName,\r\n          });\r\n          break;\r\n        case 'cancel':\r\n          resolve({\r\n            action: CREATE_REPORT_DIALOG_RESPONSE.CANCEL,\r\n            value: undefined,\r\n            dataSourceName: undefined,\r\n          });\r\n          break;\r\n      }\r\n    };\r\n\r\n    const dataSourcesOpts = Object.keys(extensionManager.dataSourceMap)\r\n      .filter(ds => {\r\n        const configuration =\r\n          extensionManager.dataSourceDefs[ds]?.configuration;\r\n        const supportsStow =\r\n          configuration?.supportsStow ?? configuration?.wadoRoot;\r\n        return supportsStow;\r\n      })\r\n      .map(ds => {\r\n        return {\r\n          value: ds,\r\n          label: ds,\r\n          placeHolder: ds,\r\n        };\r\n      });\r\n\r\n    dialogId = uiDialogService.create({\r\n      centralize: true,\r\n      isDraggable: false,\r\n      content: Dialog,\r\n      useLastPosition: false,\r\n      showOverlay: true,\r\n      contentProps: {\r\n        title: 'Provide a name for your report',\r\n        value: {\r\n          label: '',\r\n          dataSourceName: extensionManager.activeDataSource,\r\n        },\r\n        noCloseButton: true,\r\n        onClose: _handleClose,\r\n        actions: [\r\n          { id: 'cancel', text: 'Cancel', type: 'primary' },\r\n          { id: 'save', text: 'Save', type: 'secondary' },\r\n        ],\r\n        // TODO: Should be on button press...\r\n        onSubmit: _handleFormSubmit,\r\n        body: ({ value, setValue }) => {\r\n          const onChangeHandler = event => {\r\n            event.persist();\r\n            setValue(value => ({ ...value, label: event.target.value }));\r\n          };\r\n          const onKeyPressHandler = event => {\r\n            if (event.key === 'Enter') {\r\n              uiDialogService.dismiss({ id: dialogId });\r\n              resolve({\r\n                action: CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT,\r\n                value: value.label,\r\n              });\r\n            }\r\n          };\r\n          return (\r\n            <>\r\n              <div className=\"p-4 bg-primary-dark\">\r\n                {dataSourcesOpts.length > 1 && (\r\n                  <Select\r\n                    closeMenuOnSelect={true}\r\n                    className=\"mr-2 bg-black border-primary-main\"\r\n                    options={dataSourcesOpts}\r\n                    placeholder={\r\n                      dataSourcesOpts.find(\r\n                        option => option.value === value.dataSourceName\r\n                      ).placeHolder\r\n                    }\r\n                    value={value.dataSourceName}\r\n                    onChange={evt => {\r\n                      setValue(v => ({ ...v, dataSourceName: evt.value }));\r\n                    }}\r\n                    isClearable={false}\r\n                  />\r\n                )}\r\n              </div>\r\n              <div className=\"p-4 bg-primary-dark\">\r\n                <Input\r\n                  autoFocus\r\n                  className=\"mt-2 bg-black border-primary-main\"\r\n                  type=\"text\"\r\n                  placeholder=\"Enter Report Name\"\r\n                  containerClassName=\"mr-2\"\r\n                  value={value.label}\r\n                  onChange={onChangeHandler}\r\n                  onKeyPress={onKeyPressHandler}\r\n                  required\r\n                />\r\n              </div>\r\n            </>\r\n          );\r\n        },\r\n      },\r\n    });\r\n  });\r\n}\r\n","import React from 'react';\r\nimport { DicomMetadataStore } from '@ohif/core';\r\n\r\n/**\r\n *\r\n * @param {*} servicesManager\r\n * @param {*} dataSource\r\n * @param {*} measurements\r\n * @param {*} options\r\n * @returns {string[]} displaySetInstanceUIDs\r\n */\r\nasync function createReportAsync(\r\n  servicesManager,\r\n  commandsManager,\r\n  dataSource,\r\n  measurements,\r\n  options\r\n) {\r\n  const {\r\n    displaySetService,\r\n    uiNotificationService,\r\n    uiDialogService,\r\n  } = servicesManager.services;\r\n  const loadingDialogId = uiDialogService.create({\r\n    showOverlay: true,\r\n    isDraggable: false,\r\n    centralize: true,\r\n    // TODO: Create a loading indicator component + zeplin design?\r\n    content: Loading,\r\n  });\r\n\r\n  try {\r\n    const naturalizedReport = await commandsManager.runCommand(\r\n      'storeMeasurements',\r\n      {\r\n        measurementData: measurements,\r\n        dataSource,\r\n        additionalFindingTypes: ['ArrowAnnotate'],\r\n        options,\r\n      },\r\n      'CORNERSTONE_STRUCTURED_REPORT'\r\n    );\r\n\r\n    // The \"Mode\" route listens for DicomMetadataStore changes\r\n    // When a new instance is added, it listens and\r\n    // automatically calls makeDisplaySets\r\n    DicomMetadataStore.addInstances([naturalizedReport], true);\r\n\r\n    const displaySetInstanceUID = displaySetService.getMostRecentDisplaySet();\r\n\r\n    uiNotificationService.show({\r\n      title: 'Create Report',\r\n      message: 'Measurements saved successfully',\r\n      type: 'success',\r\n    });\r\n\r\n    return [displaySetInstanceUID];\r\n  } catch (error) {\r\n    uiNotificationService.show({\r\n      title: 'Create Report',\r\n      message: error.message || 'Failed to store measurements',\r\n      type: 'error',\r\n    });\r\n  } finally {\r\n    uiDialogService.dismiss({ id: loadingDialogId });\r\n  }\r\n}\r\n\r\nfunction Loading() {\r\n  return <div className=\"text-primary-active\">Loading...</div>;\r\n}\r\n\r\nexport default createReportAsync;\r\n","const MIN_SR_SERIES_NUMBER = 4700;\r\n\r\nexport default function getNextSRSeriesNumber(displaySetService) {\r\n  const activeDisplaySets = displaySetService.getActiveDisplaySets();\r\n  const srDisplaySets = activeDisplaySets.filter(ds => ds.Modality === 'SR');\r\n  const srSeriesNumbers = srDisplaySets.map(ds => ds.SeriesNumber);\r\n  const maxSeriesNumber = Math.max(...srSeriesNumbers, MIN_SR_SERIES_NUMBER);\r\n\r\n  return maxSeriesNumber + 1;\r\n}\r\n","import { DisplaySetService, Types } from '@ohif/core';\r\n\r\nimport getNextSRSeriesNumber from './getNextSRSeriesNumber';\r\n\r\n/**\r\n * Find an SR having the same series description.\r\n * This is used by the store service in order to store DICOM SR's having the\r\n * same Series Description into a single series under consecutive instance numbers\r\n * That way, they are all organized as a set and could have tools to view\r\n * \"prior\" SR instances.\r\n *\r\n * @param SeriesDescription - is the description to look for\r\n * @param displaySetService - the display sets to search for DICOM SR in\r\n * @returns SeriesMetadata from a DICOM SR having the same series description\r\n */\r\nexport default function findSRWithSameSeriesDescription(\r\n  SeriesDescription: string,\r\n  displaySetService: DisplaySetService\r\n): Types.SeriesMetadata {\r\n  const activeDisplaySets = displaySetService.getActiveDisplaySets();\r\n  const srDisplaySets = activeDisplaySets.filter(ds => ds.Modality === 'SR');\r\n  const sameSeries = srDisplaySets.find(\r\n    ds => ds.SeriesDescription === SeriesDescription\r\n  );\r\n  if (sameSeries) {\r\n    console.log('Storing to same series', sameSeries);\r\n    const { instance } = sameSeries;\r\n    const {\r\n      SeriesInstanceUID,\r\n      SeriesDescription,\r\n      SeriesDate,\r\n      SeriesTime,\r\n      SeriesNumber,\r\n      Modality,\r\n    } = instance;\r\n    return {\r\n      SeriesInstanceUID,\r\n      SeriesDescription,\r\n      SeriesDate,\r\n      SeriesTime,\r\n      SeriesNumber,\r\n      Modality,\r\n      InstanceNumber: sameSeries.instances.length + 1,\r\n    };\r\n  }\r\n\r\n  const SeriesNumber = getNextSRSeriesNumber(displaySetService);\r\n  return { SeriesDescription, SeriesNumber };\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { utils, ServicesManager } from '@ohif/core';\r\nimport { MeasurementTable, Dialog, Input, useViewportGrid } from '@ohif/ui';\r\nimport ActionButtons from './ActionButtons';\r\nimport debounce from 'lodash.debounce';\r\n\r\nimport createReportDialogPrompt, {\r\n  CREATE_REPORT_DIALOG_RESPONSE,\r\n} from './createReportDialogPrompt';\r\nimport createReportAsync from '../Actions/createReportAsync';\r\nimport findSRWithSameSeriesDescription from '../utils/findSRWithSameSeriesDescription';\r\n\r\nconst { downloadCSVReport } = utils;\r\n\r\nexport default function PanelMeasurementTable({\r\n  servicesManager,\r\n  commandsManager,\r\n  extensionManager,\r\n}): React.FunctionComponent {\r\n  const [viewportGrid, viewportGridService] = useViewportGrid();\r\n  const { activeViewportIndex, viewports } = viewportGrid;\r\n  const {\r\n    measurementService,\r\n    uiDialogService,\r\n    uiNotificationService,\r\n    displaySetService,\r\n  } = (servicesManager as ServicesManager).services;\r\n  const [displayMeasurements, setDisplayMeasurements] = useState([]);\r\n\r\n  useEffect(() => {\r\n    const debouncedSetDisplayMeasurements = debounce(\r\n      setDisplayMeasurements,\r\n      100\r\n    );\r\n    // ~~ Initial\r\n    setDisplayMeasurements(_getMappedMeasurements(measurementService));\r\n\r\n    // ~~ Subscription\r\n    const added = measurementService.EVENTS.MEASUREMENT_ADDED;\r\n    const addedRaw = measurementService.EVENTS.RAW_MEASUREMENT_ADDED;\r\n    const updated = measurementService.EVENTS.MEASUREMENT_UPDATED;\r\n    const removed = measurementService.EVENTS.MEASUREMENT_REMOVED;\r\n    const cleared = measurementService.EVENTS.MEASUREMENTS_CLEARED;\r\n    const subscriptions = [];\r\n\r\n    [added, addedRaw, updated, removed, cleared].forEach(evt => {\r\n      subscriptions.push(\r\n        measurementService.subscribe(evt, () => {\r\n          debouncedSetDisplayMeasurements(\r\n            _getMappedMeasurements(measurementService)\r\n          );\r\n        }).unsubscribe\r\n      );\r\n    });\r\n\r\n    return () => {\r\n      subscriptions.forEach(unsub => {\r\n        unsub();\r\n      });\r\n      debouncedSetDisplayMeasurements.cancel();\r\n    };\r\n  }, []);\r\n\r\n  async function exportReport() {\r\n    const measurements = measurementService.getMeasurements();\r\n\r\n    downloadCSVReport(measurements, measurementService);\r\n  }\r\n\r\n  async function clearMeasurements() {\r\n    measurementService.clearMeasurements();\r\n  }\r\n\r\n  async function createReport(): Promise<any> {\r\n    // filter measurements that are added to the active study\r\n    const activeViewport = viewports[activeViewportIndex];\r\n    const measurements = measurementService.getMeasurements();\r\n    const displaySet = displaySetService.getDisplaySetByUID(\r\n      activeViewport.displaySetInstanceUIDs[0]\r\n    );\r\n    const trackedMeasurements = measurements.filter(\r\n      m => displaySet.StudyInstanceUID === m.referenceStudyUID\r\n    );\r\n\r\n    if (trackedMeasurements.length <= 0) {\r\n      uiNotificationService.show({\r\n        title: 'No Measurements',\r\n        message: 'No Measurements are added to the current Study.',\r\n        type: 'info',\r\n        duration: 3000,\r\n      });\r\n      return;\r\n    }\r\n\r\n    const promptResult = await createReportDialogPrompt(uiDialogService, {\r\n      extensionManager,\r\n    });\r\n\r\n    if (promptResult.action === CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT) {\r\n      const dataSources = extensionManager.getDataSources(\r\n        promptResult.dataSourceName\r\n      );\r\n      const dataSource = dataSources[0];\r\n\r\n      const SeriesDescription =\r\n        // isUndefinedOrEmpty\r\n        promptResult.value === undefined || promptResult.value === ''\r\n          ? 'Research Derived Series' // default\r\n          : promptResult.value; // provided value\r\n\r\n      // Re-use an existing series having the same series description to avoid\r\n      // creating too many series instances.\r\n      const options = findSRWithSameSeriesDescription(\r\n        SeriesDescription,\r\n        displaySetService\r\n      );\r\n\r\n      return createReportAsync(\r\n        servicesManager,\r\n        commandsManager,\r\n        dataSource,\r\n        trackedMeasurements,\r\n        options\r\n      );\r\n    }\r\n  }\r\n\r\n  const jumpToImage = ({ uid, isActive }) => {\r\n    measurementService.jumpToMeasurement(viewportGrid.activeViewportIndex, uid);\r\n\r\n    onMeasurementItemClickHandler({ uid, isActive });\r\n  };\r\n\r\n  const onMeasurementItemEditHandler = ({ uid, isActive }) => {\r\n    const measurement = measurementService.getMeasurement(uid);\r\n    //Todo: why we are jumping to image?\r\n    // jumpToImage({ id, isActive });\r\n\r\n    const onSubmitHandler = ({ action, value }) => {\r\n      switch (action.id) {\r\n        case 'save': {\r\n          measurementService.update(\r\n            uid,\r\n            {\r\n              ...measurement,\r\n              ...value,\r\n            },\r\n            true\r\n          );\r\n        }\r\n      }\r\n      uiDialogService.dismiss({ id: 'enter-annotation' });\r\n    };\r\n\r\n    uiDialogService.create({\r\n      id: 'enter-annotation',\r\n      centralize: true,\r\n      isDraggable: false,\r\n      showOverlay: true,\r\n      content: Dialog,\r\n      contentProps: {\r\n        title: 'Enter your annotation',\r\n        noCloseButton: true,\r\n        value: { label: measurement.label || '' },\r\n        body: ({ value, setValue }) => {\r\n          const onChangeHandler = event => {\r\n            event.persist();\r\n            setValue(value => ({ ...value, label: event.target.value }));\r\n          };\r\n\r\n          const onKeyPressHandler = event => {\r\n            if (event.key === 'Enter') {\r\n              onSubmitHandler({ value, action: { id: 'save' } });\r\n            }\r\n          };\r\n          return (\r\n            <div className=\"p-4 bg-primary-dark\">\r\n              <Input\r\n                autoFocus\r\n                id=\"annotation\"\r\n                className=\"mt-2 bg-black border-primary-main\"\r\n                type=\"text\"\r\n                containerClassName=\"mr-2\"\r\n                value={value.label}\r\n                onChange={onChangeHandler}\r\n                onKeyPress={onKeyPressHandler}\r\n              />\r\n            </div>\r\n          );\r\n        },\r\n        actions: [\r\n          // temp: swap button types until colors are updated\r\n          { id: 'cancel', text: 'Cancel', type: 'primary' },\r\n          { id: 'save', text: 'Save', type: 'secondary' },\r\n        ],\r\n        onSubmit: onSubmitHandler,\r\n      },\r\n    });\r\n  };\r\n\r\n  const onMeasurementItemClickHandler = ({ uid, isActive }) => {\r\n    if (!isActive) {\r\n      const measurements = [...displayMeasurements];\r\n      const measurement = measurements.find(m => m.uid === uid);\r\n\r\n      measurements.forEach(m => (m.isActive = m.uid !== uid ? false : true));\r\n      measurement.isActive = true;\r\n      setDisplayMeasurements(measurements);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        className=\"overflow-x-hidden overflow-y-auto ohif-scrollbar\"\r\n        data-cy={'measurements-panel'}\r\n      >\r\n        <MeasurementTable\r\n          title=\"Measurements\"\r\n          servicesManager={servicesManager}\r\n          data={displayMeasurements}\r\n          onClick={jumpToImage}\r\n          onEdit={onMeasurementItemEditHandler}\r\n        />\r\n      </div>\r\n      <div className=\"flex justify-center p-4\">\r\n        <ActionButtons\r\n          onExportClick={exportReport}\r\n          onClearMeasurementsClick={clearMeasurements}\r\n          onCreateReportClick={createReport}\r\n        />\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nPanelMeasurementTable.propTypes = {\r\n  servicesManager: PropTypes.instanceOf(ServicesManager).isRequired,\r\n};\r\n\r\nfunction _getMappedMeasurements(measurementService) {\r\n  const measurements = measurementService.getMeasurements();\r\n\r\n  const mappedMeasurements = measurements.map((m, index) =>\r\n    _mapMeasurementToDisplay(m, index, measurementService.VALUE_TYPES)\r\n  );\r\n\r\n  return mappedMeasurements;\r\n}\r\n\r\n/**\r\n * Map the measurements to the display text.\r\n * Adds finding and site inforamtion to the displayText and/or label,\r\n * and provides as 'displayText' and 'label', while providing the original\r\n * values as baseDisplayText and baseLabel\r\n */\r\nfunction _mapMeasurementToDisplay(measurement, index, types) {\r\n  const {\r\n    displayText: baseDisplayText,\r\n    uid,\r\n    label: baseLabel,\r\n    type,\r\n    selected,\r\n    findingSites,\r\n    finding,\r\n  } = measurement;\r\n\r\n  const firstSite = findingSites?.[0];\r\n  const label = baseLabel || finding?.text || firstSite?.text || '(empty)';\r\n  let displayText = baseDisplayText || [];\r\n  if (findingSites) {\r\n    const siteText = [];\r\n    findingSites.forEach(site => {\r\n      if (site?.text !== label) siteText.push(site.text);\r\n    });\r\n    displayText = [...siteText, ...displayText];\r\n  }\r\n  if (finding && finding?.text !== label) {\r\n    displayText = [finding.text, ...displayText];\r\n  }\r\n\r\n  return {\r\n    uid,\r\n    label,\r\n    baseLabel,\r\n    measurementType: type,\r\n    displayText,\r\n    baseDisplayText,\r\n    isActive: selected,\r\n    finding,\r\n    findingSites,\r\n  };\r\n}\r\n","import React from 'react';\r\nimport { WrappedPanelStudyBrowser, PanelMeasurementTable } from './Panels';\r\n\r\n// TODO:\r\n// - No loading UI exists yet\r\n// - cancel promises when component is destroyed\r\n// - show errors in UI for thumbnails if promise fails\r\n\r\nfunction getPanelModule({\r\n  commandsManager,\r\n  extensionManager,\r\n  servicesManager,\r\n}) {\r\n  const wrappedMeasurementPanel = () => {\r\n    return (\r\n      <PanelMeasurementTable\r\n        commandsManager={commandsManager}\r\n        servicesManager={servicesManager}\r\n        extensionManager={extensionManager}\r\n      />\r\n    );\r\n  };\r\n\r\n  return [\r\n    {\r\n      name: 'seriesList',\r\n      iconName: 'group-layers',\r\n      iconLabel: 'Studies',\r\n      label: 'Studies',\r\n      component: WrappedPanelStudyBrowser.bind(null, {\r\n        commandsManager,\r\n        extensionManager,\r\n        servicesManager,\r\n      }),\r\n    },\r\n    {\r\n      name: 'measure',\r\n      iconName: 'tab-linear',\r\n      iconLabel: 'Measure',\r\n      label: 'Measurements',\r\n      secondaryLabel: 'Measurements',\r\n      component: wrappedMeasurementPanel,\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getPanelModule;\r\n","import packageJson from '../package.json';\r\n\r\nconst id = packageJson.name;\r\n\r\nexport { id };\r\n","import { isImage } from '@ohif/core/src/utils/isImage';\r\nimport sopClassDictionary from '@ohif/core/src/utils/sopClassDictionary';\r\nimport ImageSet from '@ohif/core/src/classes/ImageSet';\r\nimport isDisplaySetReconstructable from '@ohif/core/src/utils/isDisplaySetReconstructable';\r\nimport { id } from './id';\r\n\r\nconst sopClassHandlerName = 'stack';\r\n\r\nconst isMultiFrame = instance => {\r\n  return instance.NumberOfFrames > 1;\r\n};\r\n\r\nconst makeDisplaySet = instances => {\r\n  const instance = instances[0];\r\n  const imageSet = new ImageSet(instances);\r\n\r\n  const {\r\n    value: isReconstructable,\r\n    averageSpacingBetweenFrames,\r\n  } = isDisplaySetReconstructable(instances);\r\n\r\n  // set appropriate attributes to image set...\r\n  imageSet.setAttributes({\r\n    displaySetInstanceUID: imageSet.uid, // create a local alias for the imageSet UID\r\n    SeriesDate: instance.SeriesDate,\r\n    SeriesTime: instance.SeriesTime,\r\n    SeriesInstanceUID: instance.SeriesInstanceUID,\r\n    StudyInstanceUID: instance.StudyInstanceUID,\r\n    SeriesNumber: instance.SeriesNumber || 0,\r\n    FrameRate: instance.FrameTime,\r\n    SOPClassUID: instance.SOPClassUID,\r\n    SeriesDescription: instance.SeriesDescription || '',\r\n    Modality: instance.Modality,\r\n    isMultiFrame: isMultiFrame(instance),\r\n    countIcon: isReconstructable ? 'icon-mpr' : undefined,\r\n    numImageFrames: instances.length,\r\n    SOPClassHandlerId: `${id}.sopClassHandlerModule.${sopClassHandlerName}`,\r\n    isReconstructable,\r\n    averageSpacingBetweenFrames: averageSpacingBetweenFrames || null,\r\n  });\r\n\r\n  // Sort the images in this series if needed\r\n  const shallSort = true; //!OHIF.utils.ObjectPath.get(Meteor, 'settings.public.ui.sortSeriesByIncomingOrder');\r\n  if (shallSort) {\r\n    imageSet.sortBy((a, b) => {\r\n      // Sort by InstanceNumber (0020,0013)\r\n      return (\r\n        (parseInt(a.InstanceNumber) || 0) - (parseInt(b.InstanceNumber) || 0)\r\n      );\r\n    });\r\n  }\r\n\r\n  // Include the first image instance number (after sorted)\r\n  /*imageSet.setAttribute(\r\n    'instanceNumber',\r\n    imageSet.getImage(0).InstanceNumber\r\n  );*/\r\n\r\n  /*const isReconstructable = isDisplaySetReconstructable(series, instances);\r\n\r\n  imageSet.isReconstructable = isReconstructable.value;\r\n\r\n  if (isReconstructable.missingFrames) {\r\n    // TODO -> This is currently unused, but may be used for reconstructing\r\n    // Volumes with gaps later on.\r\n    imageSet.missingFrames = isReconstructable.missingFrames;\r\n  }*/\r\n\r\n  return imageSet;\r\n};\r\n\r\nconst isSingleImageModality = modality => {\r\n  return modality === 'CR' || modality === 'MG' || modality === 'DX';\r\n};\r\n\r\nfunction getSopClassUids(instances) {\r\n  const uniqueSopClassUidsInSeries = new Set();\r\n  instances.forEach(instance => {\r\n    uniqueSopClassUidsInSeries.add(instance.SOPClassUID);\r\n  });\r\n  const sopClassUids = Array.from(uniqueSopClassUidsInSeries);\r\n\r\n  return sopClassUids;\r\n}\r\n\r\n/**\r\n * Basic SOPClassHandler:\r\n * - For all Image types that are stackable, create\r\n *   a displaySet with a stack of images\r\n *\r\n * @param {Array} sopClassHandlerModules List of SOP Class Modules\r\n * @param {SeriesMetadata} series The series metadata object from which the display sets will be created\r\n * @returns {Array} The list of display sets created for the given series object\r\n */\r\nfunction getDisplaySetsFromSeries(instances) {\r\n  // If the series has no instances, stop here\r\n  if (!instances || !instances.length) {\r\n    throw new Error('No instances were provided');\r\n  }\r\n\r\n  const displaySets = [];\r\n  const sopClassUids = getSopClassUids(instances);\r\n\r\n  // Search through the instances (InstanceMetadata object) of this series\r\n  // Split Multi-frame instances and Single-image modalities\r\n  // into their own specific display sets. Place the rest of each\r\n  // series into another display set.\r\n  const stackableInstances = [];\r\n  instances.forEach(instance => {\r\n    // All imaging modalities must have a valid value for sopClassUid (x00080016) or rows (x00280010)\r\n    if (!isImage(instance.SOPClassUID) && !instance.Rows) {\r\n      return;\r\n    }\r\n\r\n    let displaySet;\r\n\r\n    if (isMultiFrame(instance)) {\r\n      displaySet = makeDisplaySet([instance]);\r\n\r\n      displaySet.setAttributes({\r\n        sopClassUids,\r\n        isClip: true,\r\n        numImageFrames: instance.NumberOfFrames,\r\n        instanceNumber: instance.InstanceNumber,\r\n        acquisitionDatetime: instance.AcquisitionDateTime,\r\n      });\r\n      displaySets.push(displaySet);\r\n    } else if (isSingleImageModality(instance.Modality)) {\r\n      displaySet = makeDisplaySet([instance]);\r\n      displaySet.setAttributes({\r\n        sopClassUids,\r\n        instanceNumber: instance.InstanceNumber,\r\n        acquisitionDatetime: instance.AcquisitionDateTime,\r\n      });\r\n      displaySets.push(displaySet);\r\n    } else {\r\n      stackableInstances.push(instance);\r\n    }\r\n  });\r\n\r\n  if (stackableInstances.length) {\r\n    const displaySet = makeDisplaySet(stackableInstances);\r\n    displaySet.setAttribute('studyInstanceUid', instances[0].StudyInstanceUID);\r\n    displaySet.setAttributes({\r\n      sopClassUids,\r\n    });\r\n    displaySets.push(displaySet);\r\n  }\r\n\r\n  return displaySets;\r\n}\r\n\r\nconst sopClassUids = [\r\n  sopClassDictionary.ComputedRadiographyImageStorage,\r\n  sopClassDictionary.DigitalXRayImageStorageForPresentation,\r\n  sopClassDictionary.DigitalXRayImageStorageForProcessing,\r\n  sopClassDictionary.DigitalMammographyXRayImageStorageForPresentation,\r\n  sopClassDictionary.DigitalMammographyXRayImageStorageForProcessing,\r\n  sopClassDictionary.DigitalIntraOralXRayImageStorageForPresentation,\r\n  sopClassDictionary.DigitalIntraOralXRayImageStorageForProcessing,\r\n  sopClassDictionary.CTImageStorage,\r\n  sopClassDictionary.EnhancedCTImageStorage,\r\n  sopClassDictionary.LegacyConvertedEnhancedCTImageStorage,\r\n  sopClassDictionary.UltrasoundMultiframeImageStorage,\r\n  sopClassDictionary.MRImageStorage,\r\n  sopClassDictionary.EnhancedMRImageStorage,\r\n  sopClassDictionary.EnhancedMRColorImageStorage,\r\n  sopClassDictionary.LegacyConvertedEnhancedMRImageStorage,\r\n  sopClassDictionary.UltrasoundImageStorage,\r\n  sopClassDictionary.UltrasoundImageStorageRET,\r\n  sopClassDictionary.SecondaryCaptureImageStorage,\r\n  sopClassDictionary.MultiframeSingleBitSecondaryCaptureImageStorage,\r\n  sopClassDictionary.MultiframeGrayscaleByteSecondaryCaptureImageStorage,\r\n  sopClassDictionary.MultiframeGrayscaleWordSecondaryCaptureImageStorage,\r\n  sopClassDictionary.MultiframeTrueColorSecondaryCaptureImageStorage,\r\n  sopClassDictionary.XRayAngiographicImageStorage,\r\n  sopClassDictionary.EnhancedXAImageStorage,\r\n  sopClassDictionary.XRayRadiofluoroscopicImageStorage,\r\n  sopClassDictionary.EnhancedXRFImageStorage,\r\n  sopClassDictionary.XRay3DAngiographicImageStorage,\r\n  sopClassDictionary.XRay3DCraniofacialImageStorage,\r\n  sopClassDictionary.BreastTomosynthesisImageStorage,\r\n  sopClassDictionary.BreastProjectionXRayImageStorageForPresentation,\r\n  sopClassDictionary.BreastProjectionXRayImageStorageForProcessing,\r\n  sopClassDictionary.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,\r\n  sopClassDictionary.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,\r\n  sopClassDictionary.NuclearMedicineImageStorage,\r\n  sopClassDictionary.VLEndoscopicImageStorage,\r\n  sopClassDictionary.VideoEndoscopicImageStorage,\r\n  sopClassDictionary.VLMicroscopicImageStorage,\r\n  sopClassDictionary.VideoMicroscopicImageStorage,\r\n  sopClassDictionary.VLSlideCoordinatesMicroscopicImageStorage,\r\n  sopClassDictionary.VLPhotographicImageStorage,\r\n  sopClassDictionary.VideoPhotographicImageStorage,\r\n  sopClassDictionary.OphthalmicPhotography8BitImageStorage,\r\n  sopClassDictionary.OphthalmicPhotography16BitImageStorage,\r\n  sopClassDictionary.OphthalmicTomographyImageStorage,\r\n  sopClassDictionary.VLWholeSlideMicroscopyImageStorage,\r\n  sopClassDictionary.PositronEmissionTomographyImageStorage,\r\n  sopClassDictionary.EnhancedPETImageStorage,\r\n  sopClassDictionary.LegacyConvertedEnhancedPETImageStorage,\r\n  sopClassDictionary.RTImageStorage,\r\n  sopClassDictionary.EnhancedUSVolumeStorage,\r\n];\r\n\r\nfunction getSopClassHandlerModule() {\r\n  return [\r\n    {\r\n      name: sopClassHandlerName,\r\n      sopClassUids,\r\n      getDisplaySetsFromSeries,\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getSopClassHandlerModule;\r\n","import React from 'react';\r\n\r\nexport default function ToolbarDivider() {\r\n  return (\r\n    <span className=\"self-center w-4 h-8 mx-2 border-l border-common-dark\" />\r\n  );\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { LayoutSelector as OHIFLayoutSelector, ToolbarButton } from '@ohif/ui';\r\n\r\nimport { ServicesManager } from '@ohif/core';\r\n\r\nfunction LayoutSelector({\r\n  rows,\r\n  columns,\r\n  className,\r\n  servicesManager,\r\n  ...rest\r\n}) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n\r\n  const {\r\n    hangingProtocolService,\r\n    toolbarService,\r\n  } = (servicesManager as ServicesManager).services;\r\n\r\n  const closeOnOutsideClick = () => {\r\n    if (isOpen) {\r\n      setIsOpen(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = hangingProtocolService.subscribe(\r\n      hangingProtocolService.EVENTS.PROTOCOL_CHANGED,\r\n      evt => {\r\n        const { protocol } = evt;\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [hangingProtocolService]);\r\n\r\n  useEffect(() => {\r\n    window.addEventListener('click', closeOnOutsideClick);\r\n    return () => {\r\n      window.removeEventListener('click', closeOnOutsideClick);\r\n    };\r\n  }, [isOpen]);\r\n\r\n  const onInteractionHandler = () => setIsOpen(!isOpen);\r\n  const DropdownContent = isOpen ? OHIFLayoutSelector : null;\r\n\r\n  const onSelectionHandler = props => {\r\n    toolbarService.recordInteraction({\r\n      interactionType: 'action',\r\n      commands: [\r\n        {\r\n          commandName: 'setViewportGridLayout',\r\n          commandOptions: { ...props },\r\n          context: 'DEFAULT',\r\n        },\r\n      ],\r\n    });\r\n  };\r\n\r\n  return (\r\n    <ToolbarButton\r\n      id=\"Layout\"\r\n      label=\"Grid Layout\"\r\n      icon=\"tool-layout\"\r\n      onInteraction={onInteractionHandler}\r\n      className={className}\r\n      rounded={rest.rounded}\r\n      dropdownContent={\r\n        DropdownContent !== null && (\r\n          <DropdownContent\r\n            rows={rows}\r\n            columns={columns}\r\n            onSelection={onSelectionHandler}\r\n          />\r\n        )\r\n      }\r\n      isActive={isOpen}\r\n      type=\"toggle\"\r\n    />\r\n  );\r\n}\r\n\r\nLayoutSelector.propTypes = {\r\n  rows: PropTypes.number,\r\n  columns: PropTypes.number,\r\n  onLayoutChange: PropTypes.func,\r\n  servicesManager: PropTypes.instanceOf(ServicesManager),\r\n};\r\n\r\nLayoutSelector.defaultProps = {\r\n  rows: 3,\r\n  columns: 3,\r\n  onLayoutChange: () => {},\r\n};\r\n\r\nexport default LayoutSelector;\r\n","import { SplitButton } from '@ohif/ui';\r\n\r\nexport default SplitButton;\r\n","import { Types } from '@ohif/ui';\r\nimport { Menu, SelectorProps, MenuItem, ContextMenuProps } from './types';\r\n\r\ntype ContextMenuItem = Types.ContextMenuItem;\r\n\r\n/**\r\n * Finds menu by menu id\r\n *\r\n * @returns Menu having the menuId\r\n */\r\nexport function findMenuById(menus: Menu[], menuId?: string): Menu {\r\n  if (!menuId) {\r\n    return;\r\n  }\r\n\r\n  return menus.find(menu => menu.id === menuId);\r\n}\r\n\r\n/**\r\n * Default finding menu method.  This method will go through\r\n * the list of menus until it finds the first one which\r\n * has no selector, OR has the selector, when applied to the\r\n * check props, return true.\r\n * The selectorProps are a set of provided properties which can be\r\n * passed into the selector function to determine when to display a menu.\r\n * For example, a selector function of:\r\n * `({displayset}) => displaySet?.SeriesDescription?.indexOf?.('Left')!==-1\r\n * would match series descriptions containing 'Left'.\r\n *\r\n * @param {Object[]} menus List of menus\r\n * @param {*} subProps\r\n * @returns\r\n */\r\nexport function findMenuDefault(\r\n  menus: Menu[],\r\n  subProps: Record<string, unknown>\r\n): Menu {\r\n  if (!menus) {\r\n    return null;\r\n  }\r\n  return menus.find(\r\n    menu => !menu.selector || menu.selector(subProps.selectorProps)\r\n  );\r\n}\r\n\r\n/**\r\n * Finds the menu to be used for different scenarios:\r\n * This will first look for a subMenu with the specified subMenuId\r\n * Next it will look for the first menu whose selector returns true.\r\n *\r\n * @param menus - List of menus\r\n * @param props - root props\r\n * @param menuIdFilter - menu id identifier (to be considered on selection)\r\n *      This is intended to support other types of filtering in the future.\r\n */\r\nexport function findMenu(\r\n  menus: Menu[],\r\n  props?: Types.IProps,\r\n  menuIdFilter?: string\r\n) {\r\n  const { subMenu } = props;\r\n\r\n  function* findMenuIterator() {\r\n    yield findMenuById(menus, menuIdFilter || subMenu);\r\n    yield findMenuDefault(menus, props);\r\n  }\r\n\r\n  const findIt = findMenuIterator();\r\n\r\n  let current = findIt.next();\r\n  let menu = current.value;\r\n\r\n  while (!current.done) {\r\n    menu = current.value;\r\n\r\n    if (menu) {\r\n      findIt.return();\r\n    }\r\n    current = findIt.next();\r\n  }\r\n\r\n  console.log('Menu chosen', menu?.id || 'NONE');\r\n\r\n  return menu;\r\n}\r\n\r\n/**\r\n * Returns the menu from a list of possible menus, based on the actual state of component props and tool data nearby.\r\n * This uses the findMenu command above to first find the appropriate\r\n * menu, and then it chooses the actual contents of that menu.\r\n * A menu item can be optional by implementing the 'selector',\r\n * which will be called with the selectorProps, and if it does not return true,\r\n * then the item is excluded.\r\n *\r\n * Other menus can be delegated to by setting the delegating value to\r\n * a string id for another menu.  That menu's content will replace the\r\n * current menu item (only if the item would be included).\r\n *\r\n * This allows single id menus to be chosen by id, but have varying contents\r\n * based on the delegated menus.\r\n *\r\n * Finally, for each item, the adaptItem call is made.  This allows\r\n * items to modify themselves before being displayed, such as\r\n * incorporating additional information from translation sources.\r\n * See the `test-mode` examples for details.\r\n *\r\n * @param selectorProps\r\n * @param {*} event event that originates the context menu\r\n * @param {*} menus List of menus\r\n * @param {*} menuIdFilter\r\n * @returns\r\n */\r\nexport function getMenuItems(\r\n  selectorProps: SelectorProps,\r\n  event: Event,\r\n  menus: Menu[],\r\n  menuIdFilter?: string\r\n): MenuItem[] | void {\r\n  // Include both the check props and the ...check props as one is used\r\n  // by the child menu and the other used by the selector function\r\n  const subProps = { selectorProps, event };\r\n\r\n  const menu = findMenu(menus, subProps, menuIdFilter);\r\n\r\n  if (!menu) {\r\n    return undefined;\r\n  }\r\n\r\n  if (!menu.items) {\r\n    console.warn('Must define items in menu', menu);\r\n    return [];\r\n  }\r\n\r\n  let menuItems = [];\r\n  menu.items.forEach(item => {\r\n    const { delegating, selector, subMenu } = item;\r\n\r\n    if (!selector || selector(selectorProps)) {\r\n      if (delegating) {\r\n        menuItems = [\r\n          ...menuItems,\r\n          ...getMenuItems(selectorProps, event, menus, subMenu),\r\n        ];\r\n      } else {\r\n        const toAdd = adaptItem(item, subProps);\r\n        menuItems.push(toAdd);\r\n      }\r\n    }\r\n  });\r\n\r\n  return menuItems;\r\n}\r\n\r\n/**\r\n * Returns item adapted to be consumed by ContextMenu component\r\n * and then goes through the item to add action behaviour for clicking the item,\r\n * making it compatible with the default ContextMenu display.\r\n *\r\n * @param {Object} item\r\n * @param {Object} subProps\r\n * @returns a MenuItem that is compatible with the base ContextMenu\r\n *    This requires having a label and set of actions to be called.\r\n */\r\nexport function adaptItem(\r\n  item: MenuItem,\r\n  subProps: ContextMenuProps\r\n): ContextMenuItem {\r\n  const newItem: ContextMenuItem = {\r\n    ...item,\r\n    value: subProps.selectorProps?.value,\r\n  };\r\n\r\n  if (item.actionType === 'ShowSubMenu' && !newItem.iconRight) {\r\n    newItem.iconRight = 'chevron-menu';\r\n  }\r\n  if (!item.action) {\r\n    newItem.action = (itemRef, componentProps) => {\r\n      const { event = {} } = componentProps;\r\n      const { detail = {} } = event;\r\n      newItem.element = detail.element;\r\n\r\n      componentProps.onClose();\r\n      const action = componentProps[`on${itemRef.actionType || 'Default'}`];\r\n      if (action) {\r\n        action.call(componentProps, newItem, itemRef, subProps);\r\n      } else {\r\n        console.warn('No action defined for', itemRef);\r\n      }\r\n    };\r\n  }\r\n\r\n  return newItem;\r\n}\r\n","import * as ContextMenuItemsBuilder from './ContextMenuItemsBuilder';\r\nimport ContextMenu from '../../../../platform/ui/src/components/ContextMenu/ContextMenu';\r\nimport { CommandsManager, ServicesManager, Types } from '@ohif/core';\r\nimport { Menu, MenuItem, Point, ContextMenuProps } from './types';\r\n\r\n/**\r\n * The context menu controller is a helper class that knows how\r\n * to manage context menus based on the UI Customization Service.\r\n * There are a few parts to this:\r\n *    1. Basic controls to manage displaying and hiding context menus\r\n *    2. Menu selection services, which use the UI customization service\r\n *       to choose which menu to display\r\n *    3. Menu item adapter services to convert menu items into displayable and actionable items.\r\n *\r\n * The format for a menu is defined in the exported type MenuItem\r\n */\r\nexport default class ContextMenuController {\r\n  commandsManager: CommandsManager;\r\n  services: Types.Services;\r\n  menuItems: Menu[] | MenuItem[];\r\n\r\n  constructor(\r\n    servicesManager: ServicesManager,\r\n    commandsManager: CommandsManager\r\n  ) {\r\n    this.services = servicesManager.services as Obj;\r\n    this.commandsManager = commandsManager;\r\n  }\r\n\r\n  closeContextMenu() {\r\n    this.services.uiDialogService.dismiss({ id: 'context-menu' });\r\n  }\r\n\r\n  /**\r\n   * Figures out which context menu is appropriate to display and shows it.\r\n   *\r\n   * @param contextMenuProps - the context menu properties, see ./types.ts\r\n   * @param viewportElement - the DOM element this context menu is related to\r\n   * @param defaultPointsPosition - a default position to show the context menu\r\n   */\r\n  showContextMenu(\r\n    contextMenuProps: ContextMenuProps,\r\n    viewportElement,\r\n    defaultPointsPosition\r\n  ): void {\r\n    if (!this.services.uiDialogService) {\r\n      console.warn('Unable to show dialog; no UI Dialog Service available.');\r\n      return;\r\n    }\r\n\r\n    const { event, subMenu, menuId, menus, selectorProps } = contextMenuProps;\r\n\r\n    console.log('Getting items from', menus);\r\n    const items = ContextMenuItemsBuilder.getMenuItems(\r\n      selectorProps || contextMenuProps,\r\n      event,\r\n      menus,\r\n      menuId\r\n    );\r\n\r\n    this.services.uiDialogService.dismiss({ id: 'context-menu' });\r\n    this.services.uiDialogService.create({\r\n      id: 'context-menu',\r\n      isDraggable: false,\r\n      preservePosition: false,\r\n      preventCutOf: true,\r\n      defaultPosition: ContextMenuController._getDefaultPosition(\r\n        defaultPointsPosition,\r\n        event?.detail,\r\n        viewportElement\r\n      ),\r\n      event,\r\n      content: ContextMenu,\r\n\r\n      // This naming is part of hte uiDialogService convention\r\n      // Clicking outside simpy closes the dialog box.\r\n      onClickOutside: () =>\r\n        this.services.uiDialogService.dismiss({ id: 'context-menu' }),\r\n\r\n      contentProps: {\r\n        items,\r\n        selectorProps,\r\n        menus,\r\n        event,\r\n        subMenu,\r\n        eventData: event?.detail,\r\n\r\n        onClose: () => {\r\n          this.services.uiDialogService.dismiss({ id: 'context-menu' });\r\n        },\r\n\r\n        /**\r\n         * Displays a sub-menu, removing this menu\r\n         * @param {*} item\r\n         * @param {*} itemRef\r\n         * @param {*} subProps\r\n         */\r\n        onShowSubMenu: (item, itemRef, subProps) => {\r\n          if (!itemRef.subMenu) {\r\n            console.warn('No submenu defined for', item, itemRef, subProps);\r\n            return;\r\n          }\r\n          this.showContextMenu(\r\n            {\r\n              ...contextMenuProps,\r\n              menuId: itemRef.subMenu,\r\n            },\r\n            viewportElement,\r\n            defaultPointsPosition\r\n          );\r\n        },\r\n\r\n        // Default is to run the specified commands.\r\n        onDefault: (item, itemRef, subProps) => {\r\n          this.commandsManager.run(item, {\r\n            ...selectorProps,\r\n            ...itemRef,\r\n            subProps,\r\n          });\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  static getDefaultPosition = (): Point => {\r\n    return {\r\n      x: 0,\r\n      y: 0,\r\n    };\r\n  };\r\n\r\n  static _getEventDefaultPosition = eventDetail => ({\r\n    x: eventDetail && eventDetail.currentPoints.client[0],\r\n    y: eventDetail && eventDetail.currentPoints.client[1],\r\n  });\r\n\r\n  static _getElementDefaultPosition = element => {\r\n    if (element) {\r\n      const boundingClientRect = element.getBoundingClientRect();\r\n      return {\r\n        x: boundingClientRect.x,\r\n        y: boundingClientRect.y,\r\n      };\r\n    }\r\n\r\n    return {\r\n      x: undefined,\r\n      y: undefined,\r\n    };\r\n  };\r\n\r\n  static _getCanvasPointsPosition = (points = [], element) => {\r\n    const viewerPos = ContextMenuController._getElementDefaultPosition(element);\r\n\r\n    for (let pointIndex = 0; pointIndex < points.length; pointIndex++) {\r\n      const point = {\r\n        x: points[pointIndex][0] || points[pointIndex]['x'],\r\n        y: points[pointIndex][1] || points[pointIndex]['y'],\r\n      };\r\n      if (\r\n        ContextMenuController._isValidPosition(point) &&\r\n        ContextMenuController._isValidPosition(viewerPos)\r\n      ) {\r\n        return {\r\n          x: point.x + viewerPos.x,\r\n          y: point.y + viewerPos.y,\r\n        };\r\n      }\r\n    }\r\n  };\r\n\r\n  static _isValidPosition = (source): boolean => {\r\n    return (\r\n      source && typeof source.x === 'number' && typeof source.y === 'number'\r\n    );\r\n  };\r\n\r\n  /**\r\n   * Returns the context menu default position. It look for the positions of: canvasPoints (got from selected), event that triggers it, current viewport element\r\n   */\r\n  static _getDefaultPosition = (canvasPoints, eventDetail, viewerElement) => {\r\n    function* getPositionIterator() {\r\n      yield ContextMenuController._getCanvasPointsPosition(\r\n        canvasPoints,\r\n        viewerElement\r\n      );\r\n      yield ContextMenuController._getEventDefaultPosition(eventDetail);\r\n      yield ContextMenuController._getElementDefaultPosition(viewerElement);\r\n      yield ContextMenuController.getDefaultPosition();\r\n    }\r\n\r\n    const positionIterator = getPositionIterator();\r\n\r\n    let current = positionIterator.next();\r\n    let position = current.value;\r\n\r\n    while (!current.done) {\r\n      position = current.value;\r\n\r\n      if (ContextMenuController._isValidPosition(position)) {\r\n        positionIterator.return();\r\n      }\r\n      current = positionIterator.next();\r\n    }\r\n\r\n    return position;\r\n  };\r\n}\r\n","const defaultContextMenu = {\r\n  id: 'measurementsContextMenu',\r\n  customizationType: 'ohif.contextMenu',\r\n  menus: [\r\n    // Get the items from the UI Customization for the menu name (and have a custom name)\r\n    {\r\n      id: 'forExistingMeasurement',\r\n      selector: ({ nearbyToolData }) => !!nearbyToolData,\r\n      items: [\r\n        {\r\n          label: 'Delete measurement',\r\n          commands: [\r\n            {\r\n              commandName: 'deleteMeasurement',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          label: 'Add Label',\r\n          commands: [\r\n            {\r\n              commandName: 'setMeasurementLabel',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n\r\nexport default defaultContextMenu;\r\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { VariableSizeList as List } from 'react-window';\r\nimport classNames from 'classnames';\r\nimport debounce from 'lodash.debounce';\r\n\r\nconst lineHeightPx = 20;\r\nconst lineHeightClassName = `leading-[${lineHeightPx}px]`;\r\nconst rowVerticalPaddingPx = 10;\r\nconst rowBottomBorderPx = 1;\r\nconst rowVerticalPaddingStyle = { padding: `${rowVerticalPaddingPx}px 0` };\r\nconst rowStyle = {\r\n  borderBottomWidth: `${rowBottomBorderPx}px`,\r\n  ...rowVerticalPaddingStyle,\r\n};\r\n\r\nfunction ColumnHeaders({ tagRef, vrRef, keywordRef, valueRef }) {\r\n  return (\r\n    <div\r\n      className={classNames(\r\n        'flex flex-row w-full bg-secondary-dark ohif-scrollbar overflow-y-scroll'\r\n      )}\r\n      style={rowVerticalPaddingStyle}\r\n    >\r\n      <div className=\"px-3 w-4/24\">\r\n        <label\r\n          ref={tagRef}\r\n          className=\"flex flex-col flex-1 text-white text-lg pl-1 select-none\"\r\n        >\r\n          <span className=\"flex flex-row items-center focus:outline-none\">\r\n            Tag\r\n          </span>\r\n        </label>\r\n      </div>\r\n      <div className=\"px-3 w-2/24\">\r\n        <label\r\n          ref={vrRef}\r\n          className=\"flex flex-col flex-1 text-white text-lg pl-1 select-none\"\r\n        >\r\n          <span className=\"flex flex-row items-center focus:outline-none\">\r\n            VR\r\n          </span>\r\n        </label>\r\n      </div>\r\n      <div className=\"px-3 w-6/24\">\r\n        <label\r\n          ref={keywordRef}\r\n          className=\"flex flex-col flex-1 text-white text-lg pl-1 select-none\"\r\n        >\r\n          <span className=\"flex flex-row items-center focus:outline-none\">\r\n            Keyword\r\n          </span>\r\n        </label>\r\n      </div>\r\n      <div className=\"px-3 w-5/24 grow\">\r\n        <label\r\n          ref={valueRef}\r\n          className=\"flex flex-col flex-1 text-white text-lg pl-1 select-none\"\r\n        >\r\n          <span className=\"flex flex-row items-center focus:outline-none\">\r\n            Value\r\n          </span>\r\n        </label>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction DicomTagTable({ rows }) {\r\n  const listRef = useRef();\r\n  const canvasRef = useRef();\r\n\r\n  const [tagHeaderElem, setTagHeaderElem] = useState(null);\r\n  const [vrHeaderElem, setVrHeaderElem] = useState(null);\r\n  const [keywordHeaderElem, setKeywordHeaderElem] = useState(null);\r\n  const [valueHeaderElem, setValueHeaderElem] = useState(null);\r\n\r\n  // Here the refs are inturn stored in state to trigger a render of the table.\r\n  // This virtualized table does NOT render until the header is rendered because the header column widths are used to determine the row heights in the table.\r\n  // Therefore whenever the refs change (in particular the first time the refs are set), we want to trigger a render of the table.\r\n  const tagRef = elem => {\r\n    if (elem) {\r\n      setTagHeaderElem(elem);\r\n    }\r\n  };\r\n  const vrRef = elem => {\r\n    if (elem) {\r\n      setVrHeaderElem(elem);\r\n    }\r\n  };\r\n  const keywordRef = elem => {\r\n    if (elem) {\r\n      setKeywordHeaderElem(elem);\r\n    }\r\n  };\r\n  const valueRef = elem => {\r\n    if (elem) {\r\n      setValueHeaderElem(elem);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * When new rows are set, scroll to the top and reset the virtualization.\r\n   */\r\n  useEffect(() => {\r\n    if (!listRef?.current) {\r\n      return;\r\n    }\r\n\r\n    listRef.current.scrollTo(0);\r\n    listRef.current.resetAfterIndex(0);\r\n  }, [rows]);\r\n\r\n  /**\r\n   * When the browser window resizes, update the row virtualization (i.e. row heights)\r\n   */\r\n  useEffect(() => {\r\n    const debouncedResize = debounce(\r\n      () => listRef.current.resetAfterIndex(0),\r\n      100\r\n    );\r\n\r\n    window.addEventListener('resize', debouncedResize);\r\n\r\n    return () => {\r\n      debouncedResize.cancel();\r\n      window.removeEventListener('resize', debouncedResize);\r\n    };\r\n  }, []);\r\n\r\n  const Row = useCallback(\r\n    ({ index, style }) => {\r\n      const row = rows[index];\r\n\r\n      return (\r\n        <div\r\n          style={{ ...style, ...rowStyle }}\r\n          className={classNames(\r\n            'hover:bg-secondary-main transition duration-300 bg-black flex flex-row w-full border-secondary-light items-center text-base break-all',\r\n            lineHeightClassName\r\n          )}\r\n          key={`DICOMTagRow-${index}`}\r\n        >\r\n          <div className=\"px-3 w-4/24\">{row[0]}</div>\r\n          <div className=\"px-3 w-2/24\">{row[1]}</div>\r\n          <div className=\"px-3 w-6/24\">{row[2]}</div>\r\n          <div className=\"px-3 w-5/24 grow\">{row[3]}</div>\r\n        </div>\r\n      );\r\n    },\r\n    [rows]\r\n  );\r\n\r\n  /**\r\n   * Whenever any one of the column headers is set, then the header is rendered.\r\n   * Here we chose the tag header.\r\n   */\r\n  const isHeaderRendered = useCallback(() => tagHeaderElem !== null, [\r\n    tagHeaderElem,\r\n  ]);\r\n\r\n  /**\r\n   * Get the item/row size. We use the header column widths to calculate the various row heights.\r\n   * @param index the row index\r\n   * @returns the row height\r\n   */\r\n  const getItemSize = useCallback(\r\n    index => {\r\n      const headerWidths = [\r\n        tagHeaderElem.offsetWidth,\r\n        vrHeaderElem.offsetWidth,\r\n        keywordHeaderElem.offsetWidth,\r\n        valueHeaderElem.offsetWidth,\r\n      ];\r\n\r\n      const context = canvasRef.current.getContext('2d');\r\n      context.font = getComputedStyle(canvasRef.current).font;\r\n\r\n      return rows[index]\r\n        .map((colText, index) => {\r\n          const colOneLineWidth = context.measureText(colText).width;\r\n          const numLines = Math.ceil(colOneLineWidth / headerWidths[index]);\r\n          return (\r\n            numLines * lineHeightPx +\r\n            2 * rowVerticalPaddingPx +\r\n            rowBottomBorderPx\r\n          );\r\n        })\r\n        .reduce((maxHeight, colHeight) => Math.max(maxHeight, colHeight));\r\n    },\r\n    [rows, keywordHeaderElem, tagHeaderElem, valueHeaderElem, vrHeaderElem]\r\n  );\r\n\r\n  return (\r\n    <div>\r\n      <canvas\r\n        style={{ visibility: 'hidden', position: 'absolute' }}\r\n        className=\"text-base\"\r\n        ref={canvasRef}\r\n      />\r\n      <ColumnHeaders\r\n        tagRef={tagRef}\r\n        vrRef={vrRef}\r\n        keywordRef={keywordRef}\r\n        valueRef={valueRef}\r\n      />\r\n      <div\r\n        className=\"m-auto relative border-2 border-black bg-black\"\r\n        style={{ height: '32rem' }}\r\n      >\r\n        {isHeaderRendered() && (\r\n          <List\r\n            ref={listRef}\r\n            height={500}\r\n            itemCount={rows.length}\r\n            itemSize={getItemSize}\r\n            width={'100%'}\r\n            className=\"ohif-scrollbar\"\r\n          >\r\n            {Row}\r\n          </List>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default DicomTagTable;\r\n","import dcmjs from 'dcmjs';\r\nimport moment from 'moment';\r\nimport React, { useState, useMemo, useEffect, useRef } from 'react';\r\nimport { classes } from '@ohif/core';\r\nimport { Icon, InputRange, Select, Typography } from '@ohif/ui';\r\nimport debounce from 'lodash.debounce';\r\nimport classNames from 'classnames';\r\n\r\nimport DicomTagTable from './DicomTagTable';\r\nimport './DicomTagBrowser.css';\r\n\r\nconst { ImageSet } = classes;\r\nconst { DicomMetaDictionary } = dcmjs.data;\r\nconst { nameMap } = DicomMetaDictionary;\r\n\r\nconst DicomTagBrowser = ({ displaySets, displaySetInstanceUID }) => {\r\n  // The column indices that are to be excluded during a filter of the table.\r\n  // At present the column indices are:\r\n  // 0: DICOM tag\r\n  // 1: VR\r\n  // 2: Keyword\r\n  // 3: Value\r\n  const excludedColumnIndicesForFilter: Set<number> = new Set([1]);\r\n\r\n  const [\r\n    selectedDisplaySetInstanceUID,\r\n    setSelectedDisplaySetInstanceUID,\r\n  ] = useState(displaySetInstanceUID);\r\n  const [instanceNumber, setInstanceNumber] = useState(1);\r\n  const [filterValue, setFilterValue] = useState('');\r\n\r\n  const onSelectChange = value => {\r\n    setSelectedDisplaySetInstanceUID(value.value);\r\n    setInstanceNumber(1);\r\n  };\r\n\r\n  const searchInputRef = useRef(null);\r\n\r\n  const activeDisplaySet = displaySets.find(\r\n    ds => ds.displaySetInstanceUID === selectedDisplaySetInstanceUID\r\n  );\r\n\r\n  const isImageStack = _isImageStack(activeDisplaySet);\r\n  const showInstanceList = isImageStack && activeDisplaySet.images.length > 1;\r\n\r\n  const displaySetList = useMemo(() => {\r\n    displaySets.sort((a, b) => a.SeriesNumber - b.SeriesNumber);\r\n    return displaySets.map(displaySet => {\r\n      const {\r\n        displaySetInstanceUID,\r\n        SeriesDate,\r\n        SeriesTime,\r\n        SeriesNumber,\r\n        SeriesDescription,\r\n        Modality,\r\n      } = displaySet;\r\n\r\n      /* Map to display representation */\r\n      const dateStr = `${SeriesDate}:${SeriesTime}`.split('.')[0];\r\n      const date = moment(dateStr, 'YYYYMMDD:HHmmss');\r\n      const displayDate = date.format('ddd, MMM Do YYYY');\r\n\r\n      return {\r\n        value: displaySetInstanceUID,\r\n        label: `${SeriesNumber} (${Modality}): ${SeriesDescription}`,\r\n        description: displayDate,\r\n      };\r\n    });\r\n  }, [displaySets]);\r\n\r\n  const rows = useMemo(() => {\r\n    let metadata;\r\n    if (isImageStack) {\r\n      metadata = activeDisplaySet.images[instanceNumber - 1];\r\n    } else {\r\n      metadata = activeDisplaySet.instance || activeDisplaySet;\r\n    }\r\n    const tags = getSortedTags(metadata);\r\n    return getFormattedRowsFromTags(tags, metadata);\r\n  }, [instanceNumber, selectedDisplaySetInstanceUID]);\r\n\r\n  const filteredRows = useMemo(() => {\r\n    if (!filterValue) {\r\n      return rows;\r\n    }\r\n\r\n    const filterValueLowerCase = filterValue.toLowerCase();\r\n    return rows.filter(row => {\r\n      return row.reduce((keepRow, col, colIndex) => {\r\n        if (keepRow) {\r\n          // We are already keeping the row, why do more work so return now.\r\n          return keepRow;\r\n        }\r\n\r\n        if (excludedColumnIndicesForFilter.has(colIndex)) {\r\n          return keepRow;\r\n        }\r\n\r\n        return keepRow || col.toLowerCase().includes(filterValueLowerCase);\r\n      }, false);\r\n    });\r\n  }, [rows, filterValue]);\r\n\r\n  const debouncedSetFilterValue = useMemo(() => {\r\n    return debounce(setFilterValue, 200);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      debouncedSetFilterValue?.cancel();\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"dicom-tag-browser-content\">\r\n      <div className=\"flex flex-row mb-6 items-center pl-1\">\r\n        <div className=\"flex flex-row items-center w-1/2\">\r\n          <Typography variant=\"subtitle\" className=\"mr-4\">\r\n            Series\r\n          </Typography>\r\n          <div className=\"grow mr-8\">\r\n            <Select\r\n              id=\"display-set-selector\"\r\n              isClearable={false}\r\n              onChange={onSelectChange}\r\n              options={displaySetList}\r\n              value={displaySetList.find(\r\n                ds => ds.value === selectedDisplaySetInstanceUID\r\n              )}\r\n              className=\"text-white\"\r\n            />\r\n          </div>\r\n        </div>\r\n        <div className=\"flex flex-row items-center w-1/2\">\r\n          {showInstanceList && (\r\n            <Typography variant=\"subtitle\" className=\"mr-4\">\r\n              Instance Number\r\n            </Typography>\r\n          )}\r\n          {showInstanceList && (\r\n            <div className=\"grow\">\r\n              <InputRange\r\n                value={instanceNumber}\r\n                key={selectedDisplaySetInstanceUID}\r\n                onChange={value => {\r\n                  setInstanceNumber(parseInt(value));\r\n                }}\r\n                minValue={1}\r\n                maxValue={activeDisplaySet.images.length}\r\n                step={1}\r\n                inputClassName=\"w-full\"\r\n                labelPosition=\"left\"\r\n                trackColor={'#3a3f99'}\r\n              />\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n      <div className=\"w-full h-1 bg-black\"></div>\r\n      <div className=\"flex flex-row my-3 w-1/2\">\r\n        {/* TODO - refactor the following into its own reusable component */}\r\n        <label className=\"relative block w-full mr-8\">\r\n          <span className=\"absolute inset-y-0 left-0 flex items-center pl-2\">\r\n            <Icon name=\"icon-search\"></Icon>\r\n          </span>\r\n          <input\r\n            ref={searchInputRef}\r\n            type=\"text\"\r\n            className=\"block bg-black w-full shadow transition duration-300 appearance-none border border-inputfield-main focus:border-inputfield-focus focus:outline-none disabled:border-inputfield-disabled rounded w-full py-2 px-9 text-base leading-tight placeholder:text-inputfield-placeholder\"\r\n            placeholder=\"Search metadata...\"\r\n            onChange={event => debouncedSetFilterValue(event.target.value)}\r\n            autoComplete=\"off\"\r\n          ></input>\r\n          <span className=\"absolute inset-y-0 right-0 flex items-center pr-2\">\r\n            <Icon\r\n              name=\"icon-clear-field\"\r\n              className={classNames(\r\n                'cursor-pointer',\r\n                filterValue ? '' : 'hidden'\r\n              )}\r\n              onClick={() => {\r\n                searchInputRef.current.value = '';\r\n                debouncedSetFilterValue('');\r\n              }}\r\n            ></Icon>\r\n          </span>\r\n        </label>\r\n      </div>\r\n      <DicomTagTable rows={filteredRows} />\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction getFormattedRowsFromTags(tags, metadata) {\r\n  const rows = [];\r\n\r\n  tags.forEach(tagInfo => {\r\n    if (tagInfo.vr === 'SQ') {\r\n      rows.push([\r\n        `${tagInfo.tagIndent}${tagInfo.tag}`,\r\n        tagInfo.vr,\r\n        tagInfo.keyword,\r\n        '',\r\n      ]);\r\n\r\n      const { values } = tagInfo;\r\n\r\n      values.forEach((item, index) => {\r\n        const formatedRowsFromTags = getFormattedRowsFromTags(item, metadata);\r\n\r\n        rows.push([\r\n          `${item[0].tagIndent}(FFFE,E000)`,\r\n          '',\r\n          `Item #${index}`,\r\n          '',\r\n        ]);\r\n\r\n        rows.push(...formatedRowsFromTags);\r\n      });\r\n    } else {\r\n      if (tagInfo.vr === 'xs') {\r\n        try {\r\n          const tag = dcmjs.data.Tag.fromPString(tagInfo.tag).toCleanString();\r\n          const originalTagInfo = metadata[tag];\r\n          tagInfo.vr = originalTagInfo.vr;\r\n        } catch (error) {\r\n          console.error(\r\n            `Failed to parse value representation for tag '${tagInfo.keyword}'`\r\n          );\r\n        }\r\n      }\r\n      rows.push([\r\n        `${tagInfo.tagIndent}${tagInfo.tag}`,\r\n        tagInfo.vr,\r\n        tagInfo.keyword,\r\n        tagInfo.value,\r\n      ]);\r\n    }\r\n  });\r\n\r\n  return rows;\r\n}\r\n\r\nfunction getSortedTags(metadata) {\r\n  const tagList = getRows(metadata);\r\n\r\n  // Sort top level tags, sequence groups are sorted when created.\r\n  _sortTagList(tagList);\r\n\r\n  return tagList;\r\n}\r\n\r\nfunction getRows(metadata, depth = 0) {\r\n  // Tag, Type, Value, Keyword\r\n\r\n  const keywords = Object.keys(metadata);\r\n\r\n  let tagIndent = '';\r\n\r\n  for (let i = 0; i < depth; i++) {\r\n    tagIndent += '>';\r\n  }\r\n\r\n  if (depth > 0) {\r\n    tagIndent += ' '; // If indented, add a space after the indents.\r\n  }\r\n\r\n  const rows = [];\r\n  for (let i = 0; i < keywords.length; i++) {\r\n    let keyword = keywords[i];\r\n\r\n    if (keyword === '_vrMap') {\r\n      continue;\r\n    }\r\n\r\n    const tagInfo = nameMap[keyword];\r\n\r\n    let value = metadata[keyword];\r\n\r\n    if (tagInfo && tagInfo.vr === 'SQ') {\r\n      const sequenceAsArray = toArray(value);\r\n\r\n      // Push line defining the sequence\r\n\r\n      const sequence = {\r\n        tag: tagInfo.tag,\r\n        tagIndent,\r\n        vr: tagInfo.vr,\r\n        keyword,\r\n        values: [],\r\n      };\r\n\r\n      rows.push(sequence);\r\n\r\n      if (value === null) {\r\n        // Type 2 Sequence\r\n        continue;\r\n      }\r\n\r\n      sequenceAsArray.forEach(item => {\r\n        const sequenceRows = getRows(item, depth + 1);\r\n\r\n        if (sequenceRows.length) {\r\n          // Sort the sequence group.\r\n          _sortTagList(sequenceRows);\r\n          sequence.values.push(sequenceRows);\r\n        }\r\n      });\r\n\r\n      continue;\r\n    }\r\n\r\n    if (Array.isArray(value)) {\r\n      if (value.length > 0 && typeof value[0] != 'object') {\r\n        value = value.join('\\\\');\r\n      }\r\n    }\r\n\r\n    if (typeof value === 'number') {\r\n      value = value.toString();\r\n    }\r\n\r\n    if (typeof value !== 'string') {\r\n      if (value === null) {\r\n        value = ' ';\r\n      } else {\r\n        if (typeof value === 'object') {\r\n          if (value.InlineBinary) {\r\n            value = 'Inline Binary';\r\n          } else if (value.BulkDataURI) {\r\n            value = `Bulk Data URI`; //: ${value.BulkDataURI}`;\r\n          } else if (value.Alphabetic) {\r\n            value = value.Alphabetic;\r\n          } else {\r\n            console.warn(`Unrecognised Value: ${value} for ${keyword}:`);\r\n            console.warn(value);\r\n            value = ' ';\r\n          }\r\n        } else {\r\n          console.warn(`Unrecognised Value: ${value} for ${keyword}:`);\r\n          value = ' ';\r\n        }\r\n      }\r\n    }\r\n\r\n    // tag / vr/ keyword/ value\r\n\r\n    // Remove retired tags\r\n    keyword = keyword.replace('RETIRED_', '');\r\n    if (tagInfo) {\r\n      rows.push({\r\n        tag: tagInfo.tag,\r\n        tagIndent,\r\n        vr: tagInfo.vr,\r\n        keyword,\r\n        value,\r\n      });\r\n    } else {\r\n      // skip properties without hex tag numbers\r\n      const regex = /[0-9A-Fa-f]{6}/g;\r\n      if (keyword.match(regex)) {\r\n        const tag = `(${keyword.substring(0, 4)},${keyword.substring(4, 8)})`;\r\n        rows.push({\r\n          tag,\r\n          tagIndent,\r\n          vr: '',\r\n          keyword: 'Private Tag',\r\n          value,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  return rows;\r\n}\r\n\r\nfunction _isImageStack(displaySet) {\r\n  return displaySet instanceof ImageSet;\r\n}\r\n\r\nfunction toArray(objectOrArray) {\r\n  return Array.isArray(objectOrArray) ? objectOrArray : [objectOrArray];\r\n}\r\n\r\nfunction _sortTagList(tagList) {\r\n  tagList.sort((a, b) => {\r\n    if (a.tag < b.tag) {\r\n      return -1;\r\n    }\r\n\r\n    return 1;\r\n  });\r\n}\r\n\r\nexport default DicomTagBrowser;\r\n","import { HangingProtocolService, StateSyncService, Types } from '@ohif/core';\r\n\r\nexport type ReturnType = {\r\n  hangingProtocolStageIndexMap: Record<string, Types.HangingProtocol.HPInfo>;\r\n  viewportGridStore: Record<string, unknown>;\r\n  displaySetSelectorMap: Record<string, string>;\r\n};\r\n\r\n/**\r\n * Calculates a set of state information for hanging protocols and viewport grid\r\n * which defines the currently applied hanging protocol state.\r\n * @param state is the viewport grid state\r\n * @param syncService is the state sync service to use for getting existing state\r\n * @returns Set of states that can be applied to the state sync to remember\r\n *   the current view state.\r\n */\r\nconst reuseCachedLayout = (\r\n  state,\r\n  hangingProtocolService: HangingProtocolService,\r\n  syncService: StateSyncService\r\n): ReturnType => {\r\n  const { activeViewportIndex, viewports, layout } = state;\r\n  const hpInfo = hangingProtocolService.getState();\r\n  const { protocolId, stageIndex, activeStudyUID } = hpInfo;\r\n  const { protocol } = hangingProtocolService.getActiveProtocol();\r\n  const stage = protocol.stages[stageIndex];\r\n  const storeId = `${activeStudyUID}:${protocolId}:${stageIndex}`;\r\n  const syncState = syncService.getState();\r\n  const cacheId = `${activeStudyUID}:${protocolId}`;\r\n  const viewportGridStore = { ...syncState.viewportGridStore };\r\n  const hangingProtocolStageIndexMap = {\r\n    ...syncState.hangingProtocolStageIndexMap,\r\n  };\r\n  const displaySetSelectorMap = { ...syncState.displaySetSelectorMap };\r\n  const { rows, columns } = stage.viewportStructure.properties;\r\n  const custom =\r\n    stage.viewports.length !== state.viewports.length ||\r\n    state.layout.numRows !== rows ||\r\n    state.layout.numCols !== columns;\r\n\r\n  hangingProtocolStageIndexMap[cacheId] = hpInfo;\r\n\r\n  if (storeId && custom) {\r\n    viewportGridStore[storeId] = { ...state };\r\n  }\r\n\r\n  for (let idx = 0; idx < state.viewports.length; idx++) {\r\n    const viewport = state.viewports[idx];\r\n    const { displaySetOptions, displaySetInstanceUIDs } = viewport;\r\n    if (!displaySetOptions) continue;\r\n    for (let i = 0; i < displaySetOptions.length; i++) {\r\n      const displaySetUID = displaySetInstanceUIDs[i];\r\n      if (!displaySetUID) continue;\r\n      if (idx === activeViewportIndex && i === 0) {\r\n        displaySetSelectorMap[\r\n          `${activeStudyUID}:activeDisplaySet:0`\r\n        ] = displaySetUID;\r\n      }\r\n      if (displaySetOptions[i]?.id) {\r\n        displaySetSelectorMap[\r\n          `${activeStudyUID}:${displaySetOptions[i].id}:${displaySetOptions[i]\r\n            .matchedDisplaySetsIndex || 0}`\r\n        ] = displaySetUID;\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    hangingProtocolStageIndexMap,\r\n    viewportGridStore,\r\n    displaySetSelectorMap,\r\n  };\r\n};\r\n\r\nexport default reuseCachedLayout;\r\n","import { StateSyncService, Types } from '@ohif/core';\r\n\r\n/**\r\n * This find or create viewport is paired with the reduce results from\r\n * below, and the action of this viewport is to look for previously filled\r\n * viewports, and to re-use by position id.  If there is no filled viewport,\r\n * then one can be re-used from the display set if it isn't going to be displayed.\r\n * @param hangingProtocolService - bound parameter supplied before using this\r\n * @param viewportsByPosition - bound parameter supplied before using this\r\n * @param viewportIndex - the index to retrieve\r\n * @param positionId - the current position on screen to retrieve\r\n * @param options - the set of options used, so that subsequent calls can\r\n *                  store state that is reset by the setLayout.\r\n *                  This class uses the options to store the already viewed\r\n *                  display sets, filling it initially with the pre-existing viewports.\r\n */\r\nexport const findOrCreateViewport = (\r\n  hangingProtocolService,\r\n  viewportsByPosition,\r\n  viewportIndex: number,\r\n  positionId: string,\r\n  options: Record<string, unknown>\r\n) => {\r\n  const byPositionViewport = viewportsByPosition?.[positionId];\r\n  if (byPositionViewport) return { ...byPositionViewport };\r\n  const { protocolId, stageIndex } = hangingProtocolService.getState();\r\n\r\n  // Setup the initial in display correctly for initial view/select\r\n  if (!options.inDisplay) {\r\n    options.inDisplay = [...viewportsByPosition.initialInDisplay];\r\n  }\r\n  // See if there is a default viewport for new views.\r\n  const missing = hangingProtocolService.getMissingViewport(\r\n    protocolId,\r\n    stageIndex,\r\n    options\r\n  );\r\n  if (missing) {\r\n    const displaySetInstanceUIDs = missing.displaySetsInfo.map(\r\n      it => it.displaySetInstanceUID\r\n    );\r\n    options.inDisplay.push(...displaySetInstanceUIDs);\r\n    return {\r\n      displaySetInstanceUIDs,\r\n      displaySetOptions: missing.displaySetsInfo.map(\r\n        it => it.displaySetOptions\r\n      ),\r\n      viewportOptions: {\r\n        ...missing.viewportOptions,\r\n      },\r\n    };\r\n  }\r\n  return {};\r\n};\r\n\r\n/**\r\n * Records the information on what viewports are displayed in which position.\r\n * Also records what instances from the existing positions are going to be in\r\n * view initially.\r\n * @param state is the viewport grid state\r\n * @param syncService is the state sync service to use for getting existing state\r\n * @returns Set of states that can be applied to the state sync to remember\r\n *   the current view state.\r\n */\r\nconst findViewportsByPosition = (\r\n  state,\r\n  { numRows, numCols },\r\n  syncService: StateSyncService\r\n): Record<string, Record<string, unknown>> => {\r\n  const { viewports } = state;\r\n  const syncState = syncService.getState();\r\n  const viewportsByPosition = { ...syncState.viewportsByPosition };\r\n  const initialInDisplay = [];\r\n\r\n  for (const viewport of viewports) {\r\n    if (viewport.positionId) {\r\n      const storedViewport = {\r\n        ...viewport,\r\n        viewportOptions: { ...viewport.viewportOptions },\r\n      };\r\n      viewportsByPosition[viewport.positionId] = storedViewport;\r\n      // The cache doesn't store the viewport options - it is only useful\r\n      // for remembering the type of viewport and UIDs\r\n      delete storedViewport.viewportId;\r\n      delete storedViewport.viewportOptions.viewportId;\r\n    }\r\n  }\r\n\r\n  for (let row = 0; row < numRows; row++) {\r\n    for (let col = 0; col < numCols; col++) {\r\n      const pos = col + row * numCols;\r\n      const positionId = viewports?.[pos]?.positionId || `${col}-${row}`;\r\n      const viewport = viewportsByPosition[positionId];\r\n      if (viewport?.displaySetInstanceUIDs) {\r\n        initialInDisplay.push(...viewport.displaySetInstanceUIDs);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Store the initially displayed elements\r\n  viewportsByPosition.initialInDisplay = initialInDisplay;\r\n\r\n  return { viewportsByPosition };\r\n};\r\n\r\nexport default findViewportsByPosition;\r\n","import { ServicesManager, utils, Types } from '@ohif/core';\r\n\r\nimport {\r\n  ContextMenuController,\r\n  defaultContextMenu,\r\n} from './CustomizableContextMenu';\r\nimport DicomTagBrowser from './DicomTagBrowser/DicomTagBrowser';\r\nimport reuseCachedLayouts from './utils/reuseCachedLayouts';\r\nimport findViewportsByPosition, {\r\n  findOrCreateViewport as layoutFindOrCreate,\r\n} from './findViewportsByPosition';\r\n\r\nimport { ContextMenuProps } from './CustomizableContextMenu/types';\r\nimport { NavigateHistory } from './types/commandModuleTypes';\r\nimport { history } from '@ohif/viewer';\r\n\r\nconst { subscribeToNextViewportGridChange } = utils;\r\n\r\nexport type HangingProtocolParams = {\r\n  protocolId?: string;\r\n  stageIndex?: number;\r\n  activeStudyUID?: string;\r\n  stageId?: string;\r\n};\r\n\r\nexport type UpdateViewportDisplaySetParams = {\r\n  direction: number;\r\n  excludeNonImageModalities?: boolean;\r\n};\r\n\r\n/**\r\n * Determine if a command is a hanging protocol one.\r\n * For now, just use the two hanging protocol commands that are in this\r\n * commands module, but if others get added elsewhere this may need enhancing.\r\n */\r\nconst isHangingProtocolCommand = command =>\r\n  command &&\r\n  (command.commandName === 'setHangingProtocol' ||\r\n    command.commandName === 'toggleHangingProtocol');\r\n\r\nconst commandsModule = ({\r\n  servicesManager,\r\n  commandsManager,\r\n}: Types.Extensions.ExtensionParams): Types.Extensions.CommandsModule => {\r\n  const {\r\n    customizationService,\r\n    measurementService,\r\n    hangingProtocolService,\r\n    uiNotificationService,\r\n    viewportGridService,\r\n    displaySetService,\r\n    stateSyncService,\r\n    toolbarService,\r\n  } = (servicesManager as ServicesManager).services;\r\n\r\n  // Define a context menu controller for use with any context menus\r\n  const contextMenuController = new ContextMenuController(\r\n    servicesManager,\r\n    commandsManager\r\n  );\r\n\r\n  const actions = {\r\n    /**\r\n     * Show the context menu.\r\n     * @param options.menuId defines the menu name to lookup, from customizationService\r\n     * @param options.defaultMenu contains the default menu set to use\r\n     * @param options.element is the element to show the menu within\r\n     * @param options.event is the event that caused the context menu\r\n     * @param options.selectorProps is the set of selection properties to use\r\n     */\r\n    showContextMenu: (options: ContextMenuProps) => {\r\n      const {\r\n        menuCustomizationId,\r\n        element,\r\n        event,\r\n        selectorProps,\r\n        defaultPointsPosition = [],\r\n      } = options;\r\n\r\n      const optionsToUse = { ...options };\r\n\r\n      if (menuCustomizationId) {\r\n        Object.assign(\r\n          optionsToUse,\r\n          customizationService.get(menuCustomizationId, defaultContextMenu)\r\n        );\r\n      }\r\n\r\n      // TODO - make the selectorProps richer by including the study metadata and display set.\r\n      const { protocol, stage } = hangingProtocolService.getActiveProtocol();\r\n      optionsToUse.selectorProps = {\r\n        event,\r\n        protocol,\r\n        stage,\r\n        ...selectorProps,\r\n      };\r\n\r\n      contextMenuController.showContextMenu(\r\n        optionsToUse,\r\n        element,\r\n        defaultPointsPosition\r\n      );\r\n    },\r\n\r\n    /** Close a context menu currently displayed */\r\n    closeContextMenu: () => {\r\n      contextMenuController.closeContextMenu();\r\n    },\r\n\r\n    displayNotification: ({ text, title, type }) => {\r\n      uiNotificationService.show({\r\n        title: title,\r\n        message: text,\r\n        type: type,\r\n      });\r\n    },\r\n    clearMeasurements: () => {\r\n      measurementService.clear();\r\n    },\r\n\r\n    /**\r\n     * Toggles off all tools which contain a commandName of setHangingProtocol\r\n     * or toggleHangingProtocol, and which match/don't match the protocol id/stage\r\n     */\r\n    toggleHpTools: () => {\r\n      const {\r\n        protocol,\r\n        stageIndex: toggleStageIndex,\r\n        stage,\r\n      } = hangingProtocolService.getActiveProtocol();\r\n      const enableListener = button => {\r\n        if (!button.id) return;\r\n        const { commands, items } = button.props || button;\r\n        if (items) {\r\n          items.forEach(enableListener);\r\n        }\r\n        const hpCommand = commands?.find?.(isHangingProtocolCommand);\r\n        if (!hpCommand) return;\r\n        const { protocolId, stageIndex, stageId } = hpCommand.commandOptions;\r\n        const isActive =\r\n          (!protocolId || protocolId === protocol.id) &&\r\n          (stageIndex === undefined || stageIndex === toggleStageIndex) &&\r\n          (!stageId || stageId === stage.id);\r\n        toolbarService.setActive(button.id, isActive);\r\n      };\r\n      Object.values(toolbarService.getButtons()).forEach(enableListener);\r\n    },\r\n\r\n    /**\r\n     *  Sets the specified protocol\r\n     *    1. Records any existing state using the viewport grid service\r\n     *    2. Finds the destination state - this can be one of:\r\n     *       a. The specified protocol stage\r\n     *       b. An alternate (toggled or restored) protocol stage\r\n     *       c. A restored custom layout\r\n     *    3. Finds the parameters for the specified state\r\n     *       a. Gets the displaySetSelectorMap\r\n     *       b. Gets the map by position\r\n     *       c. Gets any toggle mapping to map position to/from current view\r\n     *    4. If restore, then sets layout\r\n     *       a. Maps viewport position by currently displayed viewport map id\r\n     *       b. Uses toggle information to map display set id\r\n     *    5. Else applies the hanging protocol\r\n     *       a. HP Service is provided displaySetSelectorMap\r\n     *       b. HP Service will throw an exception if it isn't applicable\r\n     * @param options - contains information on the HP to apply\r\n     * @param options.activeStudyUID - the updated study to apply the HP to\r\n     * @param options.protocolId - the protocol ID to change to\r\n     * @param options.stageId - the stageId to apply\r\n     * @param options.stageIndex - the index of the stage to go to.\r\n     * @param options.reset - flag to indicate if the HP should be reset to its original and not restored to a previous state\r\n     */\r\n    setHangingProtocol: ({\r\n      activeStudyUID = '',\r\n      protocolId,\r\n      stageId,\r\n      stageIndex,\r\n      reset = false,\r\n    }: HangingProtocolParams): boolean => {\r\n      try {\r\n        // Stores in the state the display set selector id to displaySetUID mapping\r\n        // Pass in viewportId for the active viewport.  This item will get set as\r\n        // the activeViewportId\r\n        const state = viewportGridService.getState();\r\n        const hpInfo = hangingProtocolService.getState();\r\n        const {\r\n          protocol: oldProtocol,\r\n        } = hangingProtocolService.getActiveProtocol();\r\n        const stateSyncReduce = reuseCachedLayouts(\r\n          state,\r\n          hangingProtocolService,\r\n          stateSyncService\r\n        );\r\n        const {\r\n          hangingProtocolStageIndexMap,\r\n          viewportGridStore,\r\n          displaySetSelectorMap,\r\n        } = stateSyncReduce;\r\n\r\n        if (!protocolId) {\r\n          // Re-use the previous protocol id, and optionally stage\r\n          protocolId = hpInfo.protocolId;\r\n          if (stageId === undefined && stageIndex === undefined) {\r\n            stageIndex = hpInfo.stageIndex;\r\n          }\r\n        } else if (stageIndex === undefined && stageId === undefined) {\r\n          // Re-set the same stage as was previously used\r\n          const hangingId = `${activeStudyUID ||\r\n            hpInfo.activeStudyUID}:${protocolId}`;\r\n          stageIndex = hangingProtocolStageIndexMap[hangingId]?.stageIndex;\r\n        }\r\n\r\n        const useStageIdx =\r\n          stageIndex ??\r\n          hangingProtocolService.getStageIndex(protocolId, {\r\n            stageId,\r\n            stageIndex,\r\n          });\r\n\r\n        if (activeStudyUID) {\r\n          hangingProtocolService.setActiveStudyUID(activeStudyUID);\r\n        }\r\n\r\n        const storedHanging = `${\r\n          hangingProtocolService.getState().activeStudyUID\r\n        }:${protocolId}:${useStageIdx || 0}`;\r\n\r\n        const restoreProtocol = !reset && viewportGridStore[storedHanging];\r\n\r\n        if (\r\n          protocolId === hpInfo.protocolId &&\r\n          useStageIdx === hpInfo.stageIndex &&\r\n          !activeStudyUID\r\n        ) {\r\n          // Clear the HP setting to reset them\r\n          hangingProtocolService.setProtocol(protocolId, {\r\n            stageId,\r\n            stageIndex: useStageIdx,\r\n          });\r\n        } else {\r\n          hangingProtocolService.setProtocol(protocolId, {\r\n            displaySetSelectorMap,\r\n            stageId,\r\n            stageIndex: useStageIdx,\r\n            restoreProtocol,\r\n          });\r\n          if (restoreProtocol) {\r\n            viewportGridService.set(viewportGridStore[storedHanging]);\r\n          }\r\n        }\r\n        // Do this after successfully applying the update\r\n        // Note, don't store the active display set - it is only needed while\r\n        // changing display sets.  This causes jump to measurement to fail on\r\n        // multi-study display.\r\n        delete displaySetSelectorMap[\r\n          `${activeStudyUID || hpInfo.activeStudyUID}:activeDisplaySet:0`\r\n        ];\r\n        stateSyncService.store(stateSyncReduce);\r\n        // This is a default action applied\r\n        actions.toggleHpTools(hangingProtocolService.getActiveProtocol());\r\n        // Send the notification about updating the state\r\n        if (protocolId !== hpInfo.protocolId) {\r\n          const { protocol } = hangingProtocolService.getActiveProtocol();\r\n          // The old protocol callbacks are used for turning off things\r\n          // like crosshairs when moving to the new HP\r\n          commandsManager.run(oldProtocol.callbacks?.onProtocolExit);\r\n          // The new protocol callback is used for things like\r\n          // activating modes etc.\r\n          commandsManager.run(protocol.callbacks?.onProtocolEnter);\r\n        }\r\n        return true;\r\n      } catch (e) {\r\n        actions.toggleHpTools(hangingProtocolService.getActiveProtocol());\r\n        uiNotificationService.show({\r\n          title: 'Apply Hanging Protocol',\r\n          message: 'The hanging protocol could not be applied.',\r\n          type: 'error',\r\n          duration: 3000,\r\n        });\r\n        return false;\r\n      }\r\n    },\r\n\r\n    toggleHangingProtocol: ({\r\n      protocolId,\r\n      stageIndex,\r\n    }: HangingProtocolParams): boolean => {\r\n      const {\r\n        protocol,\r\n        stageIndex: desiredStageIndex,\r\n        activeStudy,\r\n      } = hangingProtocolService.getActiveProtocol();\r\n      const { toggleHangingProtocol } = stateSyncService.getState();\r\n      const storedHanging = `${\r\n        activeStudy.StudyInstanceUID\r\n      }:${protocolId}:${stageIndex | 0}`;\r\n      if (\r\n        protocol.id === protocolId &&\r\n        (stageIndex === undefined || stageIndex === desiredStageIndex)\r\n      ) {\r\n        // Toggling off - restore to previous state\r\n        const previousState = toggleHangingProtocol[storedHanging] || {\r\n          protocolId: 'default',\r\n        };\r\n        return actions.setHangingProtocol(previousState);\r\n      } else {\r\n        stateSyncService.store({\r\n          toggleHangingProtocol: {\r\n            ...toggleHangingProtocol,\r\n            [storedHanging]: {\r\n              protocolId: protocol.id,\r\n              stageIndex: desiredStageIndex,\r\n            },\r\n          },\r\n        });\r\n        return actions.setHangingProtocol({\r\n          protocolId,\r\n          stageIndex,\r\n          reset: true,\r\n        });\r\n      }\r\n    },\r\n\r\n    deltaStage: ({ direction }) => {\r\n      const {\r\n        protocolId,\r\n        stageIndex: oldStageIndex,\r\n      } = hangingProtocolService.getState();\r\n      const { protocol } = hangingProtocolService.getActiveProtocol();\r\n      for (\r\n        let stageIndex = oldStageIndex + direction;\r\n        stageIndex >= 0 && stageIndex < protocol.stages.length;\r\n        stageIndex += direction\r\n      ) {\r\n        if (protocol.stages[stageIndex].status !== 'disabled') {\r\n          return actions.setHangingProtocol({\r\n            protocolId,\r\n            stageIndex,\r\n          });\r\n        }\r\n      }\r\n      uiNotificationService.show({\r\n        title: 'Change Stage',\r\n        message: 'The hanging protocol has no more applicable stages',\r\n        type: 'info',\r\n        duration: 3000,\r\n      });\r\n    },\r\n\r\n    /**\r\n     * Changes the viewport grid layout in terms of the MxN layout.\r\n     */\r\n    setViewportGridLayout: ({ numRows, numCols }) => {\r\n      const { protocol } = hangingProtocolService.getActiveProtocol();\r\n      const onLayoutChange = protocol.callbacks?.onLayoutChange;\r\n      if (commandsManager.run(onLayoutChange, { numRows, numCols }) === false) {\r\n        console.log(\r\n          'setViewportGridLayout running',\r\n          onLayoutChange,\r\n          numRows,\r\n          numCols\r\n        );\r\n        // Don't apply the layout if the run command returns false\r\n        return;\r\n      }\r\n\r\n      const completeLayout = () => {\r\n        const state = viewportGridService.getState();\r\n        const stateReduce = findViewportsByPosition(\r\n          state,\r\n          { numRows, numCols },\r\n          stateSyncService\r\n        );\r\n        const findOrCreateViewport = layoutFindOrCreate.bind(\r\n          null,\r\n          hangingProtocolService,\r\n          stateReduce.viewportsByPosition\r\n        );\r\n\r\n        viewportGridService.setLayout({\r\n          numRows,\r\n          numCols,\r\n          findOrCreateViewport,\r\n        });\r\n        stateSyncService.store(stateReduce);\r\n      };\r\n      // Need to finish any work in the callback\r\n      window.setTimeout(completeLayout, 0);\r\n    },\r\n\r\n    toggleOneUp() {\r\n      const viewportGridState = viewportGridService.getState();\r\n      const { activeViewportIndex, viewports, layout } = viewportGridState;\r\n      const {\r\n        displaySetInstanceUIDs,\r\n        displaySetOptions,\r\n        viewportOptions,\r\n      } = viewports[activeViewportIndex];\r\n\r\n      if (layout.numCols === 1 && layout.numRows === 1) {\r\n        // The viewer is in one-up. Check if there is a state to restore/toggle back to.\r\n        const { toggleOneUpViewportGridStore } = stateSyncService.getState();\r\n\r\n        if (!toggleOneUpViewportGridStore.layout) {\r\n          return;\r\n        }\r\n        // There is a state to toggle back to. The viewport that was\r\n        // originally toggled to one up was the former active viewport.\r\n        const viewportIndexToUpdate =\r\n          toggleOneUpViewportGridStore.activeViewportIndex;\r\n\r\n        // Determine which viewports need to be updated. This is particularly\r\n        // important when MPR is toggled to one up and a different reconstructable\r\n        // is swapped in. Note that currently HangingProtocolService.getViewportsRequireUpdate\r\n        // does not support viewport with multiple display sets.\r\n        const updatedViewports =\r\n          displaySetInstanceUIDs.length > 1\r\n            ? []\r\n            : displaySetInstanceUIDs\r\n                .map(displaySetInstanceUID =>\r\n                  hangingProtocolService.getViewportsRequireUpdate(\r\n                    viewportIndexToUpdate,\r\n                    displaySetInstanceUID\r\n                  )\r\n                )\r\n                .flat();\r\n\r\n        // This findOrCreateViewport returns either one of the updatedViewports\r\n        // returned from the HP service OR if there is not one from the HP service then\r\n        // simply returns what was in the previous state.\r\n        const findOrCreateViewport = (viewportIndex: number) => {\r\n          const viewport = updatedViewports.find(\r\n            viewport => viewport.viewportIndex === viewportIndex\r\n          );\r\n\r\n          return viewport\r\n            ? { viewportOptions, displaySetOptions, ...viewport }\r\n            : toggleOneUpViewportGridStore.viewports[viewportIndex];\r\n        };\r\n\r\n        const layoutOptions = viewportGridService.getLayoutOptionsFromState(\r\n          toggleOneUpViewportGridStore\r\n        );\r\n\r\n        // Restore the previous layout including the active viewport.\r\n        viewportGridService.setLayout({\r\n          numRows: toggleOneUpViewportGridStore.layout.numRows,\r\n          numCols: toggleOneUpViewportGridStore.layout.numCols,\r\n          activeViewportIndex: viewportIndexToUpdate,\r\n          layoutOptions,\r\n          findOrCreateViewport,\r\n        });\r\n      } else {\r\n        // We are not in one-up, so toggle to one up.\r\n\r\n        // Store the current viewport grid state so we can toggle it back later.\r\n        stateSyncService.store({\r\n          toggleOneUpViewportGridStore: viewportGridState,\r\n        });\r\n\r\n        // This findOrCreateViewport only return one viewport - the active\r\n        // one being toggled to one up.\r\n        const findOrCreateViewport = () => {\r\n          return {\r\n            displaySetInstanceUIDs,\r\n            displaySetOptions,\r\n            viewportOptions,\r\n          };\r\n        };\r\n\r\n        // Set the layout to be 1x1/one-up.\r\n        viewportGridService.setLayout({\r\n          numRows: 1,\r\n          numCols: 1,\r\n          findOrCreateViewport,\r\n        });\r\n\r\n        // Subscribe to ANY (i.e. manual and hanging protocol) layout changes so that\r\n        // any grid layout state to toggle to from one up is cleared. This is performed on\r\n        // a timeout to avoid clearing the state for the actual to one up change.\r\n        // Whenever the next layout change event is fired, the subscriptions are unsubscribed.\r\n        const clearToggleOneUpViewportGridStore = () => {\r\n          const toggleOneUpViewportGridStore = {};\r\n          stateSyncService.store({\r\n            toggleOneUpViewportGridStore,\r\n          });\r\n        };\r\n\r\n        subscribeToNextViewportGridChange(\r\n          viewportGridService,\r\n          clearToggleOneUpViewportGridStore\r\n        );\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Exposes the browser history navigation used by OHIF. This command can be used to either replace or\r\n     * push a new entry into the browser history. For example, the following will replace the current\r\n     * browser history entry with the specified relative URL which changes the study displayed to the\r\n     * study with study instance UID 1.2.3. Note that as a result of using `options.replace = true`, the\r\n     * page prior to invoking this command cannot be returned to via the browser back button.\r\n     *\r\n     * navigateHistory({\r\n     *   to: 'viewer?StudyInstanceUIDs=1.2.3',\r\n     *   options: { replace: true },\r\n     * });\r\n     *\r\n     * @param historyArgs - arguments for the history function;\r\n     *                      the `to` property is the URL;\r\n     *                      the `options.replace` is a boolean indicating if the current browser history entry\r\n     *                      should be replaced or a new entry pushed onto the history (stack); the default value\r\n     *                      for `replace` is false\r\n     */\r\n    navigateHistory(historyArgs: NavigateHistory) {\r\n      history.navigate(historyArgs.to, historyArgs.options);\r\n    },\r\n\r\n    openDICOMTagViewer() {\r\n      const { activeViewportIndex, viewports } = viewportGridService.getState();\r\n      const activeViewportSpecificData = viewports[activeViewportIndex];\r\n      const { displaySetInstanceUIDs } = activeViewportSpecificData;\r\n\r\n      const displaySets = displaySetService.activeDisplaySets;\r\n      const { UIModalService } = servicesManager.services;\r\n\r\n      const displaySetInstanceUID = displaySetInstanceUIDs[0];\r\n      UIModalService.show({\r\n        content: DicomTagBrowser,\r\n        contentProps: {\r\n          displaySets,\r\n          displaySetInstanceUID,\r\n          onClose: UIModalService.hide,\r\n        },\r\n        title: 'DICOM Tag Browser',\r\n      });\r\n    },\r\n\r\n    /**\r\n     * Toggle viewport overlay (the information panel shown on the four corners\r\n     * of the viewport)\r\n     * @see ViewportOverlay and CustomizableViewportOverlay components\r\n     */\r\n    toggleOverlays: () => {\r\n      const overlays = document.getElementsByClassName('viewport-overlay');\r\n      for (let i = 0; i < overlays.length; i++) {\r\n        overlays.item(i).classList.toggle('hidden');\r\n      }\r\n    },\r\n\r\n    scrollActiveThumbnailIntoView: () => {\r\n      const { activeViewportIndex, viewports } = viewportGridService.getState();\r\n\r\n      if (\r\n        !viewports ||\r\n        activeViewportIndex < 0 ||\r\n        activeViewportIndex > viewports.length - 1\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      const activeViewport = viewports[activeViewportIndex];\r\n      const activeDisplaySetInstanceUID =\r\n        activeViewport.displaySetInstanceUIDs[0];\r\n\r\n      const thumbnailList = document.querySelector('#ohif-thumbnail-list');\r\n\r\n      if (!thumbnailList) {\r\n        return;\r\n      }\r\n\r\n      const thumbnailListBounds = thumbnailList.getBoundingClientRect();\r\n\r\n      const thumbnail = document.querySelector(\r\n        `#thumbnail-${activeDisplaySetInstanceUID}`\r\n      );\r\n\r\n      if (!thumbnail) {\r\n        return;\r\n      }\r\n\r\n      const thumbnailBounds = thumbnail.getBoundingClientRect();\r\n\r\n      // This only handles a vertical thumbnail list.\r\n      if (\r\n        thumbnailBounds.top >= thumbnailListBounds.top &&\r\n        thumbnailBounds.top <= thumbnailListBounds.bottom\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      thumbnail.scrollIntoView({ behavior: 'smooth' });\r\n    },\r\n\r\n    updateViewportDisplaySet: ({\r\n      direction,\r\n      excludeNonImageModalities,\r\n    }: UpdateViewportDisplaySetParams) => {\r\n      const nonImageModalities = [\r\n        'SR',\r\n        'SEG',\r\n        'SM',\r\n        'RTSTRUCT',\r\n        'RTPLAN',\r\n        'RTDOSE',\r\n      ];\r\n\r\n      // Sort the display sets as per the hanging protocol service viewport/display set scoring system.\r\n      // The thumbnail list uses the same sorting.\r\n      const dsSortFn = hangingProtocolService.getDisplaySetSortFunction();\r\n      const currentDisplaySets = [...displaySetService.activeDisplaySets];\r\n\r\n      currentDisplaySets.sort(dsSortFn);\r\n\r\n      const { activeViewportIndex, viewports } = viewportGridService.getState();\r\n\r\n      const { displaySetInstanceUIDs } = viewports[activeViewportIndex];\r\n\r\n      const activeDisplaySetIndex = currentDisplaySets.findIndex(displaySet =>\r\n        displaySetInstanceUIDs.includes(displaySet.displaySetInstanceUID)\r\n      );\r\n\r\n      let displaySetIndexToShow: number;\r\n\r\n      for (\r\n        displaySetIndexToShow = activeDisplaySetIndex + direction;\r\n        displaySetIndexToShow > -1 &&\r\n        displaySetIndexToShow < currentDisplaySets.length;\r\n        displaySetIndexToShow += direction\r\n      ) {\r\n        if (\r\n          !excludeNonImageModalities ||\r\n          !nonImageModalities.includes(\r\n            currentDisplaySets[displaySetIndexToShow].Modality\r\n          )\r\n        ) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        displaySetIndexToShow < 0 ||\r\n        displaySetIndexToShow >= currentDisplaySets.length\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      const { displaySetInstanceUID } = currentDisplaySets[\r\n        displaySetIndexToShow\r\n      ];\r\n\r\n      let updatedViewports = [];\r\n\r\n      try {\r\n        updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\r\n          activeViewportIndex,\r\n          displaySetInstanceUID\r\n        );\r\n      } catch (error) {\r\n        console.warn(error);\r\n        uiNotificationService.show({\r\n          title: 'Navigate Viewport Display Set',\r\n          message:\r\n            'The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.',\r\n          type: 'info',\r\n          duration: 3000,\r\n        });\r\n      }\r\n\r\n      viewportGridService.setDisplaySetsForViewports(updatedViewports);\r\n\r\n      setTimeout(() => actions.scrollActiveThumbnailIntoView(), 0);\r\n    },\r\n  };\r\n\r\n  const definitions = {\r\n    showContextMenu: {\r\n      commandFn: actions.showContextMenu,\r\n    },\r\n    closeContextMenu: {\r\n      commandFn: actions.closeContextMenu,\r\n    },\r\n    clearMeasurements: {\r\n      commandFn: actions.clearMeasurements,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    displayNotification: {\r\n      commandFn: actions.displayNotification,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    setHangingProtocol: {\r\n      commandFn: actions.setHangingProtocol,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    toggleHangingProtocol: {\r\n      commandFn: actions.toggleHangingProtocol,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    navigateHistory: {\r\n      commandFn: actions.navigateHistory,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    nextStage: {\r\n      commandFn: actions.deltaStage,\r\n      storeContexts: [],\r\n      options: { direction: 1 },\r\n    },\r\n    previousStage: {\r\n      commandFn: actions.deltaStage,\r\n      storeContexts: [],\r\n      options: { direction: -1 },\r\n    },\r\n    setViewportGridLayout: {\r\n      commandFn: actions.setViewportGridLayout,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    toggleOneUp: {\r\n      commandFn: actions.toggleOneUp,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    openDICOMTagViewer: {\r\n      commandFn: actions.openDICOMTagViewer,\r\n    },\r\n    updateViewportDisplaySet: {\r\n      commandFn: actions.updateViewportDisplaySet,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n  };\r\n\r\n  return {\r\n    actions,\r\n    definitions,\r\n    defaultContext: 'DEFAULT',\r\n  };\r\n};\r\n\r\nexport default commandsModule;\r\n","import { Types } from '@ohif/core';\r\n\r\n/**\r\n * This hanging protocol can be activated on the primary mode by directly\r\n * referencing it in a URL or by directly including it within a mode, e.g.:\r\n * `&hangingProtocolId=@ohif/mnGrid` added to the viewer URL\r\n * It is not included in the viewer mode by default.\r\n */\r\nconst hpMN: Types.HangingProtocol.Protocol = {\r\n  hasUpdatedPriorsInformation: false,\r\n  id: '@ohif/mnGrid',\r\n  description: 'Has various hanging protocol grid layouts',\r\n  name: '2x2',\r\n  protocolMatchingRules: [\r\n    {\r\n      id: 'OneOrMoreSeries',\r\n      weight: 25,\r\n      attribute: 'numberOfDisplaySetsWithImages',\r\n      constraint: {\r\n        greaterThan: 0,\r\n      },\r\n    },\r\n  ],\r\n  toolGroupIds: ['default'],\r\n  displaySetSelectors: {\r\n    defaultDisplaySetId: {\r\n      seriesMatchingRules: [\r\n        {\r\n          attribute: 'numImageFrames',\r\n          constraint: {\r\n            greaterThan: { value: 0 },\r\n          },\r\n        },\r\n        // This display set will select the specified items by preference\r\n        // It has no affect if nothing is specified in the URL.\r\n        {\r\n          attribute: 'isDisplaySetFromUrl',\r\n          weight: 10,\r\n          constraint: {\r\n            equals: true,\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  defaultViewport: {\r\n    viewportOptions: {\r\n      viewportType: 'stack',\r\n      toolGroupId: 'default',\r\n      allowUnmatchedView: true,\r\n    },\r\n    displaySets: [\r\n      {\r\n        id: 'defaultDisplaySetId',\r\n        matchedDisplaySetsIndex: -1,\r\n      },\r\n    ],\r\n  },\r\n  stages: [\r\n    {\r\n      id: '2x2',\r\n      stageActivation: {\r\n        enabled: {\r\n          minViewportsMatched: 4,\r\n        },\r\n      },\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              matchedDisplaySetsIndex: 1,\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              matchedDisplaySetsIndex: 2,\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              matchedDisplaySetsIndex: 3,\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n\r\n    // 3x1 stage\r\n    {\r\n      id: '3x1',\r\n      // Obsolete settings:\r\n      requiredViewports: 1,\r\n      preferredViewports: 3,\r\n      // New equivalent:\r\n      stageActivation: {\r\n        enabled: {\r\n          minViewportsMatched: 3,\r\n        },\r\n      },\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 3,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n              matchedDisplaySetsIndex: 1,\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n              matchedDisplaySetsIndex: 2,\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n\r\n    // A 2x1 stage\r\n    {\r\n      id: '2x1',\r\n      requiredViewports: 1,\r\n      preferredViewports: 2,\r\n      stageActivation: {\r\n        enabled: {\r\n          minViewportsMatched: 2,\r\n        },\r\n      },\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              matchedDisplaySetsIndex: 1,\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n\r\n    // A 1x1 stage - should be automatically activated if there is only 1 viewable instance\r\n    {\r\n      id: '1x1',\r\n      requiredViewports: 1,\r\n      preferredViewports: 1,\r\n      stageActivation: {\r\n        enabled: {\r\n          minViewportsMatched: 1,\r\n        },\r\n      },\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 1,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            allowUnmatchedView: true,\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n  numberOfPriorsReferenced: -1,\r\n};\r\n\r\nexport default hpMN;\r\n","import hpMNGrid from './hpMNGrid';\r\n\r\nconst defaultProtocol = {\r\n  id: 'default',\r\n  locked: true,\r\n  // Don't store this hanging protocol as it applies to the currently active\r\n  // display set by default\r\n  // cacheId: null,\r\n  hasUpdatedPriorsInformation: false,\r\n  name: 'Default',\r\n  createdDate: '2021-02-23T19:22:08.894Z',\r\n  modifiedDate: '2023-04-01',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  toolGroupIds: ['default'],\r\n  // -1 would be used to indicate active only, whereas other values are\r\n  // the number of required priors referenced - so 0 means active with\r\n  // 0 or more priors.\r\n  numberOfPriorsReferenced: 0,\r\n  // Default viewport is used to define the viewport when\r\n  // additional viewports are added using the layout tool\r\n  defaultViewport: {\r\n    viewportOptions: {\r\n      viewportType: 'stack',\r\n      toolGroupId: 'default',\r\n      allowUnmatchedView: true,\r\n    },\r\n    displaySets: [\r\n      {\r\n        id: 'defaultDisplaySetId',\r\n        matchedDisplaySetsIndex: -1,\r\n      },\r\n    ],\r\n  },\r\n  displaySetSelectors: {\r\n    defaultDisplaySetId: {\r\n      // Matches displaysets, NOT series\r\n      seriesMatchingRules: [\r\n        // Try to match series with images by default, to prevent weird display\r\n        // on SEG/SR containing studies\r\n        {\r\n          attribute: 'numImageFrames',\r\n          constraint: {\r\n            greaterThan: { value: 0 },\r\n          },\r\n        },\r\n        // This display set will select the specified items by preference\r\n        // It has no affect if nothing is specified in the URL.\r\n        {\r\n          attribute: 'isDisplaySetFromUrl',\r\n          weight: 10,\r\n          constraint: {\r\n            equals: true,\r\n          },\r\n        },\r\n      ],\r\n      // Can be used to select matching studies\r\n      // studyMatchingRules: [],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      name: 'default',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 1,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            viewportType: 'stack',\r\n            toolGroupId: 'default',\r\n            // This will specify the initial image options index if it matches in the URL\r\n            // and will otherwise not specify anything.\r\n            initialImageOptions: {\r\n              custom: 'sopInstanceLocation',\r\n            },\r\n            // Other options for initialImageOptions, which can be included in the default\r\n            // custom attribute, or can be provided directly.\r\n            //   index: 180,\r\n            //   preset: 'middle', // 'first', 'last', 'middle'\r\n            // },\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n      createdDate: '2021-02-23T18:32:42.850Z',\r\n    },\r\n  ],\r\n};\r\n\r\nfunction getHangingProtocolModule() {\r\n  return [\r\n    {\r\n      name: defaultProtocol.id,\r\n      protocol: defaultProtocol,\r\n    },\r\n    // Create a MxN hanging protocol available by default\r\n    {\r\n      name: hpMNGrid.id,\r\n      protocol: hpMNGrid,\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getHangingProtocolModule;\r\n","import React from 'react';\r\nimport classnames from 'classnames';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAppConfig } from '@state';\r\n\r\nimport { Button } from '@ohif/ui';\r\n\r\nfunction DataSourceSelector() {\r\n  const [appConfig] = useAppConfig();\r\n  const navigate = useNavigate();\r\n\r\n  // This is frowned upon, but the raw config is needed here to provide\r\n  // the selector\r\n  const dsConfigs = appConfig.dataSources;\r\n\r\n  return (\r\n    <div style={{ width: '100%', height: '100%' }}>\r\n      <div className=\"h-screen w-screen flex justify-center items-center \">\r\n        <div className=\"py-8 px-8 mx-auto bg-secondary-dark drop-shadow-md space-y-2 rounded-lg\">\r\n          <img\r\n            className=\"block mx-auto h-14\"\r\n            src=\"./ohif-logo.svg\"\r\n            alt=\"OHIF\"\r\n          />\r\n          <div className=\"text-center space-y-2 pt-4\">\r\n            {dsConfigs\r\n              .filter(\r\n                it =>\r\n                  it.sourceName !== 'dicomjson' &&\r\n                  it.sourceName !== 'dicomlocal'\r\n              )\r\n              .map(ds => (\r\n                <div key={ds.sourceName}>\r\n                  <h1 className=\"text-white\">{ds.friendlyName}</h1>\r\n                  <Button\r\n                    className={classnames('font-bold', 'ml-2')}\r\n                    onClick={() => {\r\n                      navigate({\r\n                        pathname: '/',\r\n                        search: `datasources=${ds.sourceName}`,\r\n                      });\r\n                    }}\r\n                  >\r\n                    {ds.sourceName}\r\n                  </Button>\r\n                  <br />\r\n                </div>\r\n              ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default DataSourceSelector;\r\n","import OHIF from '@ohif/core';\r\n\r\nimport {\r\n  InstanceMetadata,\r\n  PhilipsPETPrivateGroup,\r\n} from '@cornerstonejs/calculate-suv/src/types';\r\n\r\nconst metadataProvider = OHIF.classes.MetadataProvider;\r\n\r\nexport default function getPTImageIdInstanceMetadata(\r\n  imageId: string\r\n): InstanceMetadata {\r\n  const dicomMetaData = metadataProvider.get('instance', imageId);\r\n\r\n  if (!dicomMetaData) {\r\n    throw new Error('dicom metadata are required');\r\n  }\r\n\r\n  if (\r\n    dicomMetaData.SeriesDate === undefined ||\r\n    dicomMetaData.SeriesTime === undefined ||\r\n    dicomMetaData.PatientWeight === undefined ||\r\n    dicomMetaData.CorrectedImage === undefined ||\r\n    dicomMetaData.Units === undefined ||\r\n    !dicomMetaData.RadiopharmaceuticalInformationSequence ||\r\n    dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n      .RadionuclideHalfLife === undefined ||\r\n    dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n      .RadionuclideTotalDose === undefined ||\r\n    dicomMetaData.DecayCorrection === undefined ||\r\n    dicomMetaData.AcquisitionDate === undefined ||\r\n    dicomMetaData.AcquisitionTime === undefined ||\r\n    (dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n      .RadiopharmaceuticalStartDateTime === undefined &&\r\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n        .RadiopharmaceuticalStartTime === undefined)\r\n  ) {\r\n    throw new Error('required metadata are missing');\r\n  }\r\n\r\n  const instanceMetadata: InstanceMetadata = {\r\n    CorrectedImage: dicomMetaData.CorrectedImage,\r\n    Units: dicomMetaData.Units,\r\n    RadionuclideHalfLife:\r\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n        .RadionuclideHalfLife,\r\n    RadionuclideTotalDose:\r\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n        .RadionuclideTotalDose,\r\n    RadiopharmaceuticalStartDateTime:\r\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n        .RadiopharmaceuticalStartDateTime,\r\n    RadiopharmaceuticalStartTime:\r\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0]\r\n        .RadiopharmaceuticalStartTime,\r\n    DecayCorrection: dicomMetaData.DecayCorrection,\r\n    PatientWeight: dicomMetaData.PatientWeight,\r\n    SeriesDate: dicomMetaData.SeriesDate,\r\n    SeriesTime: dicomMetaData.SeriesTime,\r\n    AcquisitionDate: dicomMetaData.AcquisitionDate,\r\n    AcquisitionTime: dicomMetaData.AcquisitionTime,\r\n  };\r\n\r\n  if (\r\n    dicomMetaData['70531000'] ||\r\n    dicomMetaData['70531000'] !== undefined ||\r\n    dicomMetaData['70531009'] ||\r\n    dicomMetaData['70531009'] !== undefined\r\n  ) {\r\n    const philipsPETPrivateGroup: PhilipsPETPrivateGroup = {\r\n      SUVScaleFactor: dicomMetaData['70531000'],\r\n      ActivityConcentrationScaleFactor: dicomMetaData['70531009'],\r\n    };\r\n    instanceMetadata.PhilipsPETPrivateGroup = philipsPETPrivateGroup;\r\n  }\r\n\r\n  if (dicomMetaData['0009100d'] && dicomMetaData['0009100d'] !== undefined) {\r\n    instanceMetadata.GEPrivatePostInjectionDateTime = dicomMetaData['0009100d'];\r\n  }\r\n\r\n  if (\r\n    dicomMetaData.FrameReferenceTime &&\r\n    dicomMetaData.FrameReferenceTime !== undefined\r\n  ) {\r\n    instanceMetadata.FrameReferenceTime = dicomMetaData.FrameReferenceTime;\r\n  }\r\n\r\n  if (\r\n    dicomMetaData.ActualFrameDuration &&\r\n    dicomMetaData.ActualFrameDuration !== undefined\r\n  ) {\r\n    instanceMetadata.ActualFrameDuration = dicomMetaData.ActualFrameDuration;\r\n  }\r\n\r\n  if (dicomMetaData.PatientSex && dicomMetaData.PatientSex !== undefined) {\r\n    instanceMetadata.PatientSex = dicomMetaData.PatientSex;\r\n  }\r\n\r\n  if (dicomMetaData.PatientSize && dicomMetaData.PatientSize !== undefined) {\r\n    instanceMetadata.PatientSize = dicomMetaData.PatientSize;\r\n  }\r\n\r\n  return instanceMetadata;\r\n}\r\n\r\nfunction convertInterfaceTimeToString(time): string {\r\n  const hours = `${time.hours || '00'}`.padStart(2, '0');\r\n  const minutes = `${time.minutes || '00'}`.padStart(2, '0');\r\n  const seconds = `${time.seconds || '00'}`.padStart(2, '0');\r\n\r\n  const fractionalSeconds = `${time.fractionalSeconds || '000000'}`.padEnd(\r\n    6,\r\n    '0'\r\n  );\r\n\r\n  const timeString = `${hours}${minutes}${seconds}.${fractionalSeconds}`;\r\n  return timeString;\r\n}\r\n\r\nfunction convertInterfaceDateToString(date): string {\r\n  const month = `${date.month}`.padStart(2, '0');\r\n  const day = `${date.day}`.padStart(2, '0');\r\n  const dateString = `${date.year}${month}${day}`;\r\n  return dateString;\r\n}\r\n\r\nexport { getPTImageIdInstanceMetadata };\r\n","import { DicomMetadataStore, classes } from '@ohif/core';\r\nimport { calculateSUVScalingFactors } from '@cornerstonejs/calculate-suv';\r\n\r\nimport getPTImageIdInstanceMetadata from './getPTImageIdInstanceMetadata';\r\n\r\nconst metadataProvider = classes.MetadataProvider;\r\n\r\n/**\r\n *\r\n * @param {Object} servicesManager\r\n * @param {Object} configuration\r\n */\r\nexport default function init({ servicesManager, configuration = {} }): void {\r\n  const { stateSyncService } = servicesManager.services;\r\n  // Add\r\n  DicomMetadataStore.subscribe(\r\n    DicomMetadataStore.EVENTS.INSTANCES_ADDED,\r\n    handlePETImageMetadata\r\n  );\r\n\r\n  // If the metadata for PET has changed by the user (e.g. manually changing the PatientWeight)\r\n  // we need to recalculate the SUV Scaling Factors\r\n  DicomMetadataStore.subscribe(\r\n    DicomMetadataStore.EVENTS.SERIES_UPDATED,\r\n    handlePETImageMetadata\r\n  );\r\n\r\n  // viewportGridStore is a sync state which stores the entire\r\n  // ViewportGridService getState, by the keys `<activeStudyUID>:<protocolId>:<stageIndex>`\r\n  // Used to recover manual changes to the layout of a stage.\r\n  stateSyncService.register('viewportGridStore', { clearOnModeExit: true });\r\n\r\n  // displaySetSelectorMap stores a map from\r\n  // `<activeStudyUID>:<displaySetSelectorId>:<matchOffset>` to\r\n  // a displaySetInstanceUID, used to display named display sets in\r\n  // specific spots within a hanging protocol and be able to remember what the\r\n  // user did with those named spots between stages and protocols.\r\n  stateSyncService.register('displaySetSelectorMap', { clearOnModeExit: true });\r\n\r\n  // Stores a map from `<activeStudyUID>:${protocolId}` to the getHPInfo results\r\n  // in order to recover the correct stage when returning to a Hanging Protocol.\r\n  stateSyncService.register('hangingProtocolStageIndexMap', {\r\n    clearOnModeExit: true,\r\n  });\r\n\r\n  // Stores a map from the to be applied hanging protocols `<activeStudyUID>:<protocolId>`\r\n  // to the previously applied hanging protolStageIndexMap key, in order to toggle\r\n  // off the applied protocol and remember the old state.\r\n  stateSyncService.register('toggleHangingProtocol', { clearOnModeExit: true });\r\n\r\n  // Stores the viewports by `rows-cols` position so that when the layout\r\n  // changes numRows and numCols, the viewports can be remembers and then replaced\r\n  // afterwards.\r\n  stateSyncService.register('viewportsByPosition', { clearOnModeExit: true });\r\n}\r\n\r\nconst handlePETImageMetadata = ({ SeriesInstanceUID, StudyInstanceUID }) => {\r\n  const { instances } = DicomMetadataStore.getSeries(\r\n    StudyInstanceUID,\r\n    SeriesInstanceUID\r\n  );\r\n\r\n  const modality = instances[0].Modality;\r\n  if (modality !== 'PT') {\r\n    return;\r\n  }\r\n  const imageIds = instances.map(instance => instance.imageId);\r\n  const instanceMetadataArray = [];\r\n  imageIds.forEach(imageId => {\r\n    const instanceMetadata = getPTImageIdInstanceMetadata(imageId);\r\n    if (instanceMetadata) {\r\n      instanceMetadataArray.push(instanceMetadata);\r\n    }\r\n  });\r\n\r\n  if (!instanceMetadataArray.length) {\r\n    return;\r\n  }\r\n\r\n  // try except block to prevent errors when the metadata is not correct\r\n  let suvScalingFactors;\r\n  try {\r\n    suvScalingFactors = calculateSUVScalingFactors(instanceMetadataArray);\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n\r\n  if (!suvScalingFactors) {\r\n    return;\r\n  }\r\n\r\n  instanceMetadataArray.forEach((instanceMetadata, index) => {\r\n    metadataProvider.addCustomMetadata(\r\n      imageIds[index],\r\n      'scalingModule',\r\n      suvScalingFactors[index]\r\n    );\r\n  });\r\n};\r\n","import { Types } from '@ohif/core';\r\n\r\nimport getDataSourcesModule from './getDataSourcesModule.js';\r\nimport getLayoutTemplateModule from './getLayoutTemplateModule.js';\r\nimport getPanelModule from './getPanelModule';\r\nimport getSopClassHandlerModule from './getSopClassHandlerModule.js';\r\nimport getToolbarModule from './getToolbarModule';\r\nimport getCommandsModule from './commandsModule';\r\nimport getHangingProtocolModule from './getHangingProtocolModule';\r\nimport getStudiesForPatientByMRN from './Panels/getStudiesForPatientByMRN';\r\nimport getCustomizationModule from './getCustomizationModule';\r\nimport { id } from './id.js';\r\nimport preRegistration from './init';\r\nimport {\r\n  ContextMenuController,\r\n  CustomizableContextMenuTypes,\r\n} from './CustomizableContextMenu';\r\nimport * as dicomWebUtils from './DicomWebDataSource/utils';\r\n\r\nconst defaultExtension: Types.Extensions.Extension = {\r\n  /**\r\n   * Only required property. Should be a unique value across all extensions.\r\n   */\r\n  id,\r\n  preRegistration,\r\n  getDataSourcesModule,\r\n  getLayoutTemplateModule,\r\n  getPanelModule,\r\n  getHangingProtocolModule,\r\n  getSopClassHandlerModule,\r\n  getToolbarModule,\r\n  getCommandsModule,\r\n  getUtilityModule({ servicesManager }) {\r\n    return [\r\n      {\r\n        name: 'common',\r\n        exports: {\r\n          getStudiesForPatientByMRN,\r\n        },\r\n      },\r\n    ];\r\n  },\r\n\r\n  getCustomizationModule,\r\n};\r\n\r\nexport default defaultExtension;\r\n\r\nexport {\r\n  ContextMenuController,\r\n  CustomizableContextMenuTypes,\r\n  getStudiesForPatientByMRN,\r\n  dicomWebUtils,\r\n};\r\n","import ViewerLayout from './ViewerLayout';\r\n/*\r\n- Define layout for the viewer in mode configuration.\r\n- Pass in the viewport types that can populate the viewer.\r\n- Init layout based on the displaySets and the objects.\r\n*/\r\n\r\nexport default function({\r\n  servicesManager,\r\n  extensionManager,\r\n  commandsManager,\r\n  hotkeysManager,\r\n}) {\r\n  function ViewerLayoutWithServices(props) {\r\n    return ViewerLayout({\r\n      servicesManager,\r\n      extensionManager,\r\n      commandsManager,\r\n      hotkeysManager,\r\n      ...props,\r\n    });\r\n  }\r\n\r\n  return [\r\n    // Layout Template Definition\r\n    // TODO: this is weird naming\r\n    {\r\n      name: 'viewerLayout',\r\n      id: 'viewerLayout',\r\n      component: ViewerLayoutWithServices,\r\n    },\r\n  ];\r\n}\r\n","import { ToolbarButton } from '@ohif/ui';\r\nimport ToolbarDivider from './Toolbar/ToolbarDivider.tsx';\r\nimport ToolbarLayoutSelector from './Toolbar/ToolbarLayoutSelector.tsx';\r\nimport ToolbarSplitButton from './Toolbar/ToolbarSplitButton.tsx';\r\n\r\nexport default function getToolbarModule({ commandsManager, servicesManager }) {\r\n  return [\r\n    {\r\n      name: 'ohif.divider',\r\n      defaultComponent: ToolbarDivider,\r\n      clickHandler: () => {},\r\n    },\r\n    {\r\n      name: 'ohif.action',\r\n      defaultComponent: ToolbarButton,\r\n      clickHandler: () => {},\r\n    },\r\n    {\r\n      name: 'ohif.radioGroup',\r\n      defaultComponent: ToolbarButton,\r\n      clickHandler: () => {},\r\n    },\r\n    {\r\n      name: 'ohif.splitButton',\r\n      defaultComponent: ToolbarSplitButton,\r\n      clickHandler: () => {},\r\n    },\r\n    {\r\n      name: 'ohif.layoutSelector',\r\n      defaultComponent: ToolbarLayoutSelector,\r\n      clickHandler: (evt, clickedBtn, btnSectionName) => {},\r\n    },\r\n    {\r\n      name: 'ohif.toggle',\r\n      defaultComponent: ToolbarButton,\r\n      clickHandler: () => {},\r\n    },\r\n  ];\r\n}\r\n","import { CustomizationService } from '@ohif/core';\r\nimport React from 'react';\r\nimport DataSourceSelector from './Panels/DataSourceSelector';\r\n\r\n/**\r\n *\r\n * Note: this is an example of how the customization module can be used\r\n * using the customization module. Below, we are adding a new custom route\r\n * to the application at the path /custom and rendering a custom component\r\n * Real world use cases of the having a custom route would be to add a\r\n * custom page for the user to view their profile, or to add a custom\r\n * page for login etc.\r\n */\r\nexport default function getCustomizationModule() {\r\n  return [\r\n    {\r\n      name: 'helloPage',\r\n      value: {\r\n        id: 'customRoutes',\r\n        routes: [\r\n          {\r\n            path: '/custom',\r\n            children: () => (\r\n              <h1 style={{ color: 'white' }}>Hello Custom Route</h1>\r\n            ),\r\n          },\r\n        ],\r\n      },\r\n    },\r\n\r\n    // Example customization to list a set of datasources\r\n    {\r\n      name: 'datasources',\r\n      value: {\r\n        id: 'customRoutes',\r\n        routes: [\r\n          {\r\n            path: '/datasources',\r\n            children: DataSourceSelector,\r\n          },\r\n        ],\r\n      },\r\n    },\r\n\r\n    {\r\n      name: 'default',\r\n      value: [\r\n        /**\r\n         * Customization Component Type definition for overlay items.\r\n         * Overlay items are texts (or other components) that will be displayed\r\n         * on a Viewport Overlay, which contains the information panels on the\r\n         * four corners of a viewport.\r\n         *\r\n         * @definition of a overlay item using this type\r\n         * The value to be displayed is defined by\r\n         *  - setting DICOM image instance's property to this field,\r\n         *  - or defining contentF()\r\n         *\r\n         * {\r\n         *   id: string - unique id for the overlay item\r\n         *   customizationType: string - indicates customization type definition to this\r\n         *   label: string - Label, to be displayed for the item\r\n         *   title: string - Tooltip, for the item\r\n         *   color: string - Color of the text\r\n         *   condition: ({ instance }) => boolean - decides whether to display the overlay item or not\r\n         *   attribute: string - property name of the DICOM image instance\r\n         *   contentF: ({ instance, formatters }) => string | component,\r\n         * }\r\n         *\r\n         * @example\r\n         *  {\r\n         *    id: 'PatientNameOverlay',\r\n         *    customizationType: 'ohif.overlayItem',\r\n         *    label: 'PN:',\r\n         *    title: 'Patient Name',\r\n         *    color: 'yellow',\r\n         *    condition: ({ instance }) => instance && instance.PatientName && instance.PatientName.Alphabetic,\r\n         *    attribute: 'PatientName',\r\n         *    contentF: ({ instance, formatters: { formatPN } }) => `${formatPN(instance.PatientName.Alphabetic)} ${(instance.PatientSex ? '(' + instance.PatientSex + ')' : '')}`,\r\n         *  },\r\n         *\r\n         * @see CustomizableViewportOverlay\r\n         */\r\n        {\r\n          id: 'ohif.overlayItem',\r\n          content: function (props) {\r\n            if (this.condition && !this.condition(props)) return null;\r\n\r\n            const { instance } = props;\r\n            const value =\r\n              instance && this.attribute\r\n                ? instance[this.attribute]\r\n                : this.contentF && typeof this.contentF === 'function'\r\n                  ? this.contentF(props)\r\n                  : null;\r\n            if (!value) return null;\r\n\r\n            return (\r\n              <span\r\n                className=\"overlay-item flex flex-row\"\r\n                style={{ color: this.color || undefined }}\r\n                title={this.title || ''}\r\n              >\r\n                {this.label && (\r\n                  <span className=\"mr-1 shrink-0\">{this.label}</span>\r\n                )}\r\n                <span className=\"font-light\">{value}</span>\r\n              </span>\r\n            );\r\n          },\r\n        },\r\n\r\n        {\r\n          id: 'ohif.contextMenu',\r\n\r\n          /** Applies the customizationType to all the menu items.\r\n           * This function clones the object and child objects to prevent\r\n           * changes to the original customization object.\r\n           */\r\n          transform: function (customizationService: CustomizationService) {\r\n            // Don't modify the children, as those are copied by reference\r\n            const clonedObject = { ...this };\r\n            clonedObject.menus = this.menus.map(menu => ({ ...menu }));\r\n\r\n            for (const menu of clonedObject.menus) {\r\n              const { items: originalItems } = menu;\r\n              menu.items = [];\r\n              for (const item of originalItems) {\r\n                menu.items.push(customizationService.transform(item));\r\n              }\r\n            }\r\n            return clonedObject;\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  ];\r\n}\r\n"],"names":["getString","getName","getModalities","DICOMWeb","processResults","qidoStudies","length","studies","forEach","qidoStudy","push","studyInstanceUid","date","time","accession","mrn","patientName","utils","instances","Number","description","modalities","async","search","dicomWebClient","seriesInstanceUid","queryParameters","searchForStudies","undefined","queryParams","mapParams","params","options","arguments","commaSeparatedFields","join","supportsWildcard","withWildcard","value","parameters","PatientName","patientId","AccessionNumber","accessionNumber","StudyDescription","studyDescription","ModalitiesInStudy","modalitiesInStudy","limit","offset","fuzzymatching","supportsFuzzyMatching","includefield","startDate","endDate","StudyDate","today","Date","DD","String","getDate","padStart","MM","getMonth","todayStr","getFullYear","oldDateStr","studyUids","Array","isArray","replace","StudyInstanceUID","final","Object","keys","key","getImageId","_ref","instance","frame","config","thumbnail","url","renderingAttr","uri","baseWadoRsUri","SeriesInstanceUID","SOPInstanceUID","wadoRoot","buildInstanceWadoRsUri","buildInstanceFrameWadoRsUri","getWADORSImageId","wadouri","paramString","wadoUriRoot","buildInstanceWadoUrl","imageId","RetrieveMetadataLoader","constructor","client","studyInstanceUID","filters","sortCriteria","sortFunction","this","preLoadData","preLoad","loadData","load","posLoad","loaders","result","loader","e","next","done","Error","RetrieveMetadataLoaderSync","getOptions","seriesInstanceUID","retrieveSeriesMetadata","bind","retrieveStudyMetadata","getLoaders","runLoaders","RetrieveMetadataLoaderAsync","preLoaders","searchForSeries","getPreLoaders","naturalizeDataset","dcmjs","naturalized","map","sortStudySeries","sortingCriteria","seriesAsyncLoader","seriesInstanceUIDList","freeze","hasNext","shift","makeSeriesAsyncLoader","s","promises","enableStudyLazyLoad","retrieveMetadataLoader","execLoad","moduleName","StudyMetaDataPromises","Map","has","get","promise","Promise","resolve","reject","RetrieveMetadata","then","data","set","deleteStudyMetadataPromise","delete","StaticWadoClient","api","qidoConfig","super","staticWado","searchResult","lowerParams","toLowerParams","filter","study","studyFilterKeys","filterItem","series","seriesFilterKeys","compareValues","desired","actual","find","item","actualItem","Alphabetic","indexOf","substring","compareDateRange","range","dash","start","end","sourceFilterMap","altKey","testValue","valueElem","vr","Value","entries","toLowerCase","studyinstanceuid","patientname","studydescription","studydate","modalitiesinstudy","accessionnumber","seriesinstanceuid","seriesnumber","modality","getDirectURL","singlepart","tag","defaultPath","defaultType","fetchPart","DirectRetrieveURL","InlineBinary","blob","URL","createObjectURL","retrieveBulkData","arr","Blob","type","console","warn","BulkDataURI","hasQuery","hasAccept","fixBulkDataURI","dicomWebConfig","startsWith","origin","bulkDataURI","relativeResolution","DicomMetaDictionary","DicomDict","denaturalizeDataset","ImplementationClassUID","ImplementationVersionName","EXPLICIT_VR_LITTLE_ENDIAN","metadataProvider","classes","createDicomWebApi","userAuthenticationService","qidoRoot","supportsReject","dicomWebConfigCopy","JSON","parse","stringify","headers","getAuthorizationHeader","errorInterceptor","errorHandler","wadoConfig","qidoDicomWebClient","wadoDicomWebClient","implementation","initialize","query","StudyInstanceUIDs","paramsStudyInstanceUIDs","queryStudyInstanceUIDs","getAll","origParams","mappedParams","qidoSearch","qidoSeries","seriesNumber","seriesDate","numSeriesInstances","processSeriesResults","seriesInStudy","retrieve","directURL","_ref2","multipart","val","metadata","madeInClient","_retrieveSeriesMetadataAsync","_retrieveSeriesMetadataSync","store","dicom","dataset","request","ArrayBuffer","datasets","storeInstances","meta","FileMetaInformationVersion","_meta","MediaStorageSOPClassUID","SOPClassUID","MediaStorageSOPInstanceUID","TransferSyntaxUID","denaturalized","dicomDict","dict","write","naturalizedInstancesMetadata","seriesSummaryMetadata","instancesPerSeries","SeriesDescription","SeriesNumber","SeriesTime","ProtocolName","Modality","getImageIdsForInstance","addImageIdToUIDs","seriesMetadata","values","DicomMetadataStore","seriesPromises","addRetrieveBulkData","enabled","ret","arrayBuffer","byteLength","aSeries","seriesDeliveredPromises","naturalizedInstances","index","wadoUri","all","isLoaded","getImageIdsForDisplaySet","displaySet","images","imageIds","NumberOfFrames","_ref3","getConfig","xhr","XMLHttpRequest","open","log","onreadystatechange","readyState","status","responseText","send","dcm4cheeReject","IWebApiDataSource","OHIF","mappings","_store","urls","getMetaDataByURL","metaData","findStudies","aStudy","createDicomJSONApi","dicomJsonConfig","name","response","fetch","json","studyInstanceUIDs","naturalizedDicom","param","mappedParam","NumInstances","Modalities","PatientID","StudyTime","debug","customSort","seriesSummary","numberOfSeries","obj","i","EVENTS","END_MODALITIES","SR","SEG","DOC","compareValue","v1","v2","seriesA","seriesB","instanceA","instanceB","modalityA","modalityB","isEndA","isEndB","createDicomLocalApi","dicomLocalConfig","StudyInstanceUIDsAsArray","sort","numInstances","Set","add","firstInstance","from","SeriesDate","SERIES_ADDED","isMultiframe","frameIndex","INSTANCES_ADDED","naturalizedReport","reportBlob","objectUrl","window","location","assign","createDicomWebProxyApi","dicomWebProxyConfig","UserAuthenticationService","dicomWebDelegate","servers","dicomWeb","split","createDataSource","Toolbar","servicesManager","toolbarService","services","toolbarButtons","setToolbarButtons","useState","buttonState","setButtonState","primaryToolId","toggles","groups","useEffect","unsubscribe","unsub1","subscribe","TOOL_BAR_MODIFIED","getButtonSection","unsub2","TOOL_BAR_STATE_MODIFIED","state","React","toolDef","id","Component","componentProps","isActive","className","classnames","_extends","bState","onInteraction","args","recordInteraction","availableLanguages","defaultLanguage","currentLanguage","i18n","ViewerLayout","extensionManager","hotkeysManager","commandsManager","viewports","ViewportGridComp","leftPanels","rightPanels","leftPanelDefaultClosed","rightPanelDefaultClosed","appConfig","useAppConfig","navigate","useNavigate","useLocation","t","useTranslation","show","hide","useModal","showLoadingIndicator","setShowLoadingIndicator","hangingProtocolService","hotkeyDefinitions","hotkeyDefaults","menuOptions","title","icon","onClick","content","AboutModal","contentProps","versionNumber","process","buildNumber","UserPreferences","getValidHotkeyDefinitions","onCancel","hotkeys","onSubmit","language","setHotkeys","onReset","restoreDefaultBindings","hotkeysModule","oidc","encodeURIComponent","href","document","body","classList","remove","getComponent","entry","getModuleEntry","component","getPanelData","iconName","iconLabel","label","HangingProtocolService","leftPanelComponents","rightPanelComponents","viewportComponents","viewportComponent","namespace","displaySetsToDisplay","Header","isReturnEnabled","showStudyList","onClickReturnButton","pathname","dataSourceIdx","configUrl","URLSearchParams","searchQuery","append","decodeURIComponent","toString","WhiteLabeling","whiteLabeling","ErrorBoundary","context","style","height","LoadingIndicatorProgress","SidePanel","side","activeTabIndex","tabs","propTypes","PropTypes","isRequired","CommandsManager","ServicesManager","children","sortStudyInstances","formatDate","PanelStudyBrowser","getImageSrc","getStudiesForPatientByMRN","requestDisplaySetCreationForStudy","dataSource","displaySetService","uiNotificationService","useImageViewer","activeViewportIndex","viewportGridService","useViewportGrid","activeTabName","setActiveTabName","expandedStudyInstanceUIDs","setExpandedStudyInstanceUIDs","studyDisplayList","setStudyDisplayList","displaySets","setDisplaySets","thumbnailImageSrcMap","setThumbnailImageSrcMap","isMounted","useRef","sid","qidoForStudyUID","qidoStudiesForPatient","error","actuallyMappedStudies","prevArray","it","fetchStudiesForPatient","activeDisplaySets","newImageSrcEntry","getDisplaySetByUID","dSet","displaySetInstanceUID","Math","floor","current","prevState","mappedDisplaySets","_mapDisplaySets","SubscriptionDisplaySetsAdded","DISPLAY_SETS_ADDED","displaySetsAdded","initialViewport","SubscriptionDisplaySetsChanged","DISPLAY_SETS_CHANGED","changedDisplaySets","primaryStudyInstanceUIDs","primaryStudies","recentStudies","allStudies","displaySetsForStudy","ds","tabStudy","includes","_createStudyBrowserTabs","activeDisplaySetInstanceUIDs","displaySetInstanceUIDs","StudyBrowser","onDoubleClickThumbnail","updatedViewports","viewportIndex","getViewportsRequireUpdate","message","duration","setDisplaySetsForViewports","onClickStudy","shouldCollapseStudy","updatedExpandedStudyInstanceUIDs","stdyUid","onClickTab","clickedTabName","thumbnailDisplaySets","thumbnailNoImageDisplaySets","excludeFromThumbnailBrowser","imageSrc","componentType","thumbnailNoImageModalities","_getComponentType","seriesTime","numImageFrames","countIcon","dragData","cornerstone","canvas","createElement","utilities","loadImageToCanvas","toDataURL","catch","some","WrappedPanelStudyBrowser","getDataSources","_getStudiesForPatientByMRN","_getImageSrcFromImageId","exports","getCornerstoneLibraries","getImageSrcFromImageId","ex","_createGetImageSrcFromImageIdFn","_requestDisplaySetCreationForStudy","ActionButtons","onExportClick","onCreateReportClick","ButtonGroup","color","size","Button","defaultProps","alert","CREATE_REPORT_DIALOG_RESPONSE","CANCEL","CREATE_REPORT","Loading","measurements","uiDialogService","loadingDialogId","create","showOverlay","isDraggable","centralize","runCommand","measurementData","additionalFindingTypes","getMostRecentDisplaySet","dismiss","MIN_SR_SERIES_NUMBER","findSRWithSameSeriesDescription","sameSeries","getActiveDisplaySets","InstanceNumber","srSeriesNumbers","max","getNextSRSeriesNumber","downloadCSVReport","PanelMeasurementTable","viewportGrid","measurementService","displayMeasurements","setDisplayMeasurements","debouncedSetDisplayMeasurements","debounce","_getMappedMeasurements","added","MEASUREMENT_ADDED","addedRaw","RAW_MEASUREMENT_ADDED","updated","MEASUREMENT_UPDATED","removed","MEASUREMENT_REMOVED","cleared","MEASUREMENTS_CLEARED","subscriptions","evt","unsub","cancel","onMeasurementItemClickHandler","_ref6","uid","measurement","m","MeasurementTable","jumpToMeasurement","onEdit","getMeasurement","onSubmitHandler","_ref4","action","update","Dialog","noCloseButton","_ref5","setValue","Input","autoFocus","containerClassName","onChange","event","persist","target","onKeyPress","actions","text","getMeasurements","onClearMeasurementsClick","clearMeasurements","activeViewport","trackedMeasurements","referenceStudyUID","promptResult","dialogId","dataSourcesOpts","dataSourceMap","configuration","dataSourceDefs","supportsStow","placeHolder","useLastPosition","dataSourceName","activeDataSource","onClose","_handleClose","Select","closeMenuOnSelect","placeholder","option","v","isClearable","required","createReportDialogPrompt","createReportAsync","types","displayText","baseDisplayText","baseLabel","selected","findingSites","finding","firstSite","siteText","site","measurementType","_mapMeasurementToDisplay","VALUE_TYPES","secondaryLabel","wrappedMeasurementPanel","packageJson","sopClassHandlerName","isMultiFrame","makeDisplaySet","imageSet","ImageSet","isReconstructable","averageSpacingBetweenFrames","isDisplaySetReconstructable","setAttributes","FrameRate","FrameTime","SOPClassHandlerId","sortBy","a","b","parseInt","isSingleImageModality","getDisplaySetsFromSeries","sopClassUids","uniqueSopClassUidsInSeries","getSopClassUids","stackableInstances","isImage","Rows","isClip","instanceNumber","acquisitionDatetime","AcquisitionDateTime","setAttribute","sopClassDictionary","ToolbarDivider","LayoutSelector","rows","columns","rest","isOpen","setIsOpen","closeOnOutsideClick","PROTOCOL_CHANGED","protocol","addEventListener","removeEventListener","DropdownContent","OHIFLayoutSelector","ToolbarButton","onInteractionHandler","rounded","dropdownContent","onSelection","props","interactionType","commands","commandName","commandOptions","onLayoutChange","SplitButton","getMenuItems","selectorProps","menus","menuIdFilter","subProps","menu","subMenu","findIt","menuId","findMenuById","selector","findMenuDefault","findMenuIterator","return","findMenu","items","menuItems","delegating","toAdd","newItem","actionType","iconRight","itemRef","detail","element","call","adaptItem","ContextMenuController","closeContextMenu","showContextMenu","contextMenuProps","viewportElement","defaultPointsPosition","ContextMenuItemsBuilder","preservePosition","preventCutOf","defaultPosition","_getDefaultPosition","ContextMenu","onClickOutside","eventData","onShowSubMenu","onDefault","run","getDefaultPosition","x","y","_getEventDefaultPosition","eventDetail","currentPoints","_getElementDefaultPosition","boundingClientRect","getBoundingClientRect","_getCanvasPointsPosition","points","viewerPos","pointIndex","point","_isValidPosition","source","canvasPoints","viewerElement","positionIterator","getPositionIterator","position","customizationType","nearbyToolData","rowVerticalPaddingStyle","padding","rowStyle","borderBottomWidth","ColumnHeaders","tagRef","vrRef","keywordRef","valueRef","classNames","ref","listRef","canvasRef","tagHeaderElem","setTagHeaderElem","vrHeaderElem","setVrHeaderElem","keywordHeaderElem","setKeywordHeaderElem","valueHeaderElem","setValueHeaderElem","scrollTo","resetAfterIndex","debouncedResize","Row","useCallback","row","isHeaderRendered","getItemSize","headerWidths","offsetWidth","getContext","font","getComputedStyle","colText","colOneLineWidth","measureText","width","ceil","reduce","maxHeight","colHeight","visibility","elem","List","itemCount","itemSize","nameMap","getFormattedRowsFromTags","tags","tagInfo","tagIndent","keyword","formatedRowsFromTags","toCleanString","originalTagInfo","getRows","depth","keywords","sequenceAsArray","objectOrArray","sequence","sequenceRows","_sortTagList","regex","match","tagList","excludedColumnIndicesForFilter","selectedDisplaySetInstanceUID","setSelectedDisplaySetInstanceUID","setInstanceNumber","filterValue","setFilterValue","searchInputRef","activeDisplaySet","isImageStack","showInstanceList","displaySetList","useMemo","dateStr","moment","format","getSortedTags","filteredRows","filterValueLowerCase","keepRow","col","colIndex","debouncedSetFilterValue","Typography","variant","InputRange","minValue","maxValue","step","inputClassName","labelPosition","trackColor","Icon","autoComplete","DicomTagTable","reuseCachedLayout","syncService","layout","hpInfo","getState","protocolId","stageIndex","activeStudyUID","getActiveProtocol","stage","stages","storeId","syncState","cacheId","viewportGridStore","hangingProtocolStageIndexMap","displaySetSelectorMap","viewportStructure","properties","custom","numRows","numCols","idx","viewport","displaySetOptions","displaySetUID","matchedDisplaySetsIndex","findOrCreateViewport","viewportsByPosition","positionId","byPositionViewport","inDisplay","initialInDisplay","missing","getMissingViewport","displaySetsInfo","viewportOptions","findViewportsByPosition","storedViewport","viewportId","pos","subscribeToNextViewportGridChange","isHangingProtocolCommand","command","customizationService","stateSyncService","contextMenuController","menuCustomizationId","optionsToUse","defaultContextMenu","displayNotification","clear","toggleHpTools","toggleStageIndex","enableListener","button","hpCommand","stageId","setActive","getButtons","setHangingProtocol","reset","oldProtocol","stateSyncReduce","reuseCachedLayouts","hangingId","useStageIdx","getStageIndex","setActiveStudyUID","storedHanging","restoreProtocol","setProtocol","callbacks","onProtocolExit","onProtocolEnter","toggleHangingProtocol","desiredStageIndex","activeStudy","previousState","deltaStage","direction","oldStageIndex","setViewportGridLayout","setTimeout","completeLayout","stateReduce","layoutFindOrCreate","setLayout","toggleOneUp","viewportGridState","toggleOneUpViewportGridStore","viewportIndexToUpdate","flat","layoutOptions","getLayoutOptionsFromState","clearToggleOneUpViewportGridStore","navigateHistory","historyArgs","history","to","openDICOMTagViewer","activeViewportSpecificData","UIModalService","DicomTagBrowser","toggleOverlays","overlays","getElementsByClassName","toggle","scrollActiveThumbnailIntoView","activeDisplaySetInstanceUID","thumbnailList","querySelector","thumbnailListBounds","thumbnailBounds","top","bottom","scrollIntoView","behavior","updateViewportDisplaySet","_ref7","excludeNonImageModalities","nonImageModalities","dsSortFn","getDisplaySetSortFunction","currentDisplaySets","displaySetIndexToShow","findIndex","definitions","commandFn","storeContexts","nextStage","previousStage","defaultContext","hasUpdatedPriorsInformation","protocolMatchingRules","weight","attribute","constraint","greaterThan","toolGroupIds","displaySetSelectors","defaultDisplaySetId","seriesMatchingRules","equals","defaultViewport","viewportType","toolGroupId","allowUnmatchedView","stageActivation","minViewportsMatched","layoutType","requiredViewports","preferredViewports","numberOfPriorsReferenced","defaultProtocol","locked","createdDate","modifiedDate","availableTo","editableBy","initialImageOptions","hpMNGrid","dsConfigs","dataSources","src","alt","sourceName","friendlyName","handlePETImageMetadata","instanceMetadataArray","instanceMetadata","dicomMetaData","PatientWeight","CorrectedImage","Units","RadiopharmaceuticalInformationSequence","RadionuclideHalfLife","RadionuclideTotalDose","DecayCorrection","AcquisitionDate","AcquisitionTime","RadiopharmaceuticalStartDateTime","RadiopharmaceuticalStartTime","philipsPETPrivateGroup","SUVScaleFactor","ActivityConcentrationScaleFactor","PhilipsPETPrivateGroup","GEPrivatePostInjectionDateTime","FrameReferenceTime","ActualFrameDuration","PatientSex","PatientSize","getPTImageIdInstanceMetadata","suvScalingFactors","calculateSUVScalingFactors","addCustomMetadata","preRegistration","register","clearOnModeExit","getDataSourcesModule","getLayoutTemplateModule","getPanelModule","getHangingProtocolModule","getSopClassHandlerModule","getToolbarModule","defaultComponent","clickHandler","ToolbarSplitButton","ToolbarLayoutSelector","clickedBtn","btnSectionName","getCommandsModule","getUtilityModule","getCustomizationModule","routes","path","DataSourceSelector","condition","contentF","transform","clonedObject","originalItems"],"sourceRoot":""}