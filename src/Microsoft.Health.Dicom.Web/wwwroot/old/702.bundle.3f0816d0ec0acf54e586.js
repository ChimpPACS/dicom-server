"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[702],{14702:(e,t,a)=>{a.r(t),a.d(t,{ContextMenuController:()=>ut,CustomizableContextMenuTypes:()=>n,default:()=>Bt,dicomWebUtils:()=>s,getStudiesForPatientByMRN:()=>Ce});var n={};a.r(n);var s={};a.r(s),a.d(s,{fixBulkDataURI:()=>N});var o=a(75935),r=a(16283),i=a(9159),c=a(31492),l=a(16786),u=a(71818),d=a(76643),m=a(87853);const{getString:p,getName:g,getModalities:f}=d.default;function I(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:p(e["0020000D"]),date:p(e["00080020"]),time:p(e["00080030"]),accession:p(e["00080050"])||"",mrn:p(e["00100020"])||"",patientName:c.default.formatPN(g(e["00100010"]))||"",instances:Number(p(e["00201208"]))||0,description:p(e["00081030"])||"",modalities:p(f(e["00080060"],e["00080061"]))||""}))),t}async function y(e,t,a,n){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:n})}function S(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return;const a=["00081030","00080060"].join(","),{supportsWildcard:n}=t,s=e=>n&&e?`*${e}*`:e,o={PatientName:s(e.patientName),"00100020":s(e.patientId),AccessionNumber:s(e.accessionNumber),StudyDescription:s(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)o.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),s=`${t.getFullYear()}${n}${a}`;o.StudyDate=`${e.startDate}-${s}`}else if(e.endDate){const t="19700102";o.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),o.StudyInstanceUID=t}const r={};return Object.keys(o).forEach((e=>{void 0!==o[e]&&""!==o[e]&&(r[e]=o[e])})),r}function h(e){let{instance:t,frame:a,config:n,thumbnail:s=!1}=e;if(!t)return;if(t.url)return t.url;const o=s?"thumbnailRendering":"imageRendering";if(n[o]&&"wadouri"!==n[o])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${s}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(t,n,a);{const e=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,o=[];o.push("requestType=WADO"),o.push(`studyUID=${a}`),o.push(`seriesUID=${n}`),o.push(`objectUID=${s}`),o.push("contentType=application/dicom"),o.push("transferSyntax=*");const r=o.join("&");return`${e.wadoUriRoot}?${r}`}(n,t);let s="dicomweb:"+e;return void 0!==a&&(s+="&frame="+a),s}}var v=a(22737);class D{constructor(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;this.client=e,this.studyInstanceUID=t,this.filters=a,this.sortCriteria=n,this.sortFunction=s}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const a of e)try{if(t=await a(),t&&t.length)break}catch(e){throw e}if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class w extends D{getOptions(){const{studyInstanceUID:e,filters:t}=this,a={studyInstanceUID:e},{seriesInstanceUID:n}=t;return n&&(a.seriesInstanceUID=n),a}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;a&&e.push(n.retrieveSeriesMetadata.bind(n,{studyInstanceUID:t,seriesInstanceUID:a})),e.push(n.retrieveStudyMetadata.bind(n,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}class b extends D{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;if(a){const s={studyInstanceUID:t,queryParams:{SeriesInstanceUID:a}};e.push(n.searchForSeries.bind(n,s))}e.push(n.searchForSeries.bind(n,{studyInstanceUID:t})),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),a=this.sortCriteria,n=this.sortFunction,{naturalizeDataset:s}=v.default.data.DicomMetaDictionary,o=t.map(s);return(0,m.IO)(o,a||m.S1.seriesSortCriteria.seriesInfoSortingCriteria,n)}async load(e){const{client:t,studyInstanceUID:a}=this,n=function(e,t,a){return Object.freeze({hasNext:()=>a.length>0,async next(){const n=a.shift();return e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:n})}})}(t,a,e.map((e=>e.SeriesInstanceUID))),s=[];for(;n.hasNext();)s.push(n.next());return{preLoadData:e,promises:s}}async posLoad(e){let{preLoadData:t,promises:a}=e;return{preLoadData:t,promises:a}}}const E=async function(e,t,a){const n=new(!1!==a?b:w)(e,t,arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},arguments.length>4?arguments[4]:void 0,arguments.length>5?arguments[5]:void 0);return await n.execLoad()},U="RetrieveStudyMetadata",M=new Map;function x(e,t,a,n,s,o){if(!e)throw new Error(`${U}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${U}: Required 'StudyInstanceUID' parameter not provided.`);if(M.has(t))return M.get(t);const r=new Promise(((r,i)=>{E(e,t,a,n,s,o).then((function(e){r(e)}),i)}));return M.set(t,r),r}function R(e){M.has(e)&&M.delete(e)}class C extends o.api.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(C.studyFilterKeys))if(!this.filterItem(t,n,e,C.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(C.seriesFilterKeys))if(!this.filterItem(t,n,e,C.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const a=e.indexOf("-");if(-1===a)return this.compareValues(e,t);const n=e.substring(0,a),s=e.substring(a+1);return(!n||t>=n)&&(!s||t<=s)}filterItem(e,t,a,n){const s=n[e]||e;if(!t)return!0;const o=t[e]||t[s];if(!o)return!0;const r=a[e]||a[s];if(!r)return!1;if("DA"==r.vr)return this.compareDateRange(o,r.Value[0]);const i=r.Value;return this.compareValues(o,i)}toLowerParams(e){const t={};return Object.entries(e).forEach((e=>{let[a,n]=e;t[a.toLowerCase()]=n})),t}}C.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},C.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const P=(e,t)=>{const{wadoRoot:a,singlepart:n}=e,{instance:s,tag:o="PixelData",defaultPath:r="/pixeldata",defaultType:i="video/mp4",singlepart:l="video"}=t,u=s[o];if(!u)return;if(u.DirectRetrieveURL)return u.DirectRetrieveURL;if(u.InlineBinary){const e=c.default.b64toBlob(u.InlineBinary,i);return u.DirectRetrieveURL=URL.createObjectURL(e),u.DirectRetrieveURL}if(!n||!0!==n&&-1===n.indexOf(l))return u.retrieveBulkData?u.retrieveBulkData().then((e=>(u.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:i})),u.DirectRetrieveURL))):void console.warn("Unable to retrieve",o,"from",s);const{StudyInstanceUID:d,SeriesInstanceUID:m,SOPInstanceUID:p}=s,g=u&&u.BulkDataURI||`series/${m}/instances/${p}${r}`,f=-1!==g.indexOf("?"),I=-1!==g.indexOf("accept=");return"PixelData"===o||"EncapsulatedDocument"===o?`${a}/studies/${d}/series/${m}/instances/${p}/rendered`:g+(I?"":(f?"&":"?")+`accept=${i}`)};function N(e,t,a){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&a.wadoRoot.startsWith("http")){const t=new URL(a.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===a.bulkDataURI?.relativeResolution?e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==a.bulkDataURI?.relativeResolution&&a.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:T,DicomDict:O}=v.default.data,{naturalizeDataset:A,denaturalizeDataset:k}=T,L="2.25.270695996825855179949881587723571202391.2.0.0",F="OHIF-VIEWER-2.0.0",V="1.2.840.10008.1.2.1",$=r.default.MetadataProvider;function q(e,t){const{qidoRoot:a,wadoRoot:n,enableStudyLazyLoad:s,supportsFuzzyMatching:r,supportsWildcard:d,supportsReject:g,staticWado:f,singlepart:v}=e,D=JSON.parse(JSON.stringify(e)),w={url:a,staticWado:f,singlepart:v,headers:t.getAuthorizationHeader(),errorInterceptor:i.Z.getHTTPErrorHandler()},b={url:n,staticWado:f,singlepart:v,headers:t.getAuthorizationHeader(),errorInterceptor:i.Z.getHTTPErrorHandler()},E=f?new C(w):new o.api.DICOMwebClient(w),U=f?new C(b):new o.api.DICOMwebClient(b),M={initialize:e=>{let{params:t,query:a}=e;const{StudyInstanceUIDs:n}=t,s=c.default.splitComma(a.getAll("StudyInstanceUIDs")),o=s.length&&s||n;return o&&Array.isArray(o)?o:[o]},query:{studies:{mapParams:S.bind(),search:async function(e){const a=t.getAuthorizationHeader();a&&(E.headers=a);const{studyInstanceUid:n,seriesInstanceUid:s,...o}=S(e,{supportsFuzzyMatching:r,supportsWildcard:d})||{};return I(await y(E,0,0,o))},processResults:I.bind()},series:{search:async function(e){const a=t.getAuthorizationHeader();a&&(E.headers=a);return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:p(e["0020000D"]),seriesInstanceUid:p(e["0020000E"]),modality:p(e["00080060"]),seriesNumber:p(e["00200011"]),seriesDate:c.default.formatDate(p(e["00080021"])),numSeriesInstances:Number(p(e["00201209"])),description:p(e["0008103E"])}))),(0,m.IO)(t),t}(await function(e,t){const a={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:a})}(E,e))}},instances:{search:(e,a)=>{const n=t.getAuthorizationHeader();n&&(E.headers=n),y.call(void 0,E,e,null,a)}}},retrieve:{directURL:e=>P({wadoRoot:n,singlepart:v},e),bulkDataURI:async e=>{let{StudyInstanceUID:t,BulkDataURI:a}=e;const n={multipart:!1,BulkDataURI:a,StudyInstanceUID:t};return E.retrieveBulkData(n).then((e=>e&&e[0]||void 0))},series:{metadata:async function(){let{StudyInstanceUID:e,filters:a,sortCriteria:n,sortFunction:o,madeInClient:r=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=t.getAuthorizationHeader();if(i&&(U.headers=i),!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return s?M._retrieveSeriesMetadataAsync(e,a,n,o,r):M._retrieveSeriesMetadataSync(e,a,n,o,r)}}},store:{dicom:async(e,a)=>{const n=t.getAuthorizationHeader();if(n&&(U.headers=n),e instanceof ArrayBuffer){const t={datasets:[e],request:a};await U.storeInstances(t)}else{const t={FileMetaInformationVersion:e._meta.FileMetaInformationVersion.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:V,ImplementationClassUID:L,ImplementationVersionName:F},n=k(t),s=new O(n);s.dict=k(e);const o={datasets:[s.write()],request:a};await U.storeInstances(o)}}},_retrieveSeriesMetadataSync:async(e,t,a,n,s)=>{const o=(await x(U,e,!1,t,a,n)).map(A),r={},i={};o.forEach((t=>{r[t.SeriesInstanceUID]||(r[t.SeriesInstanceUID]={StudyInstanceUID:t.StudyInstanceUID,StudyDescription:t.StudyDescription,SeriesInstanceUID:t.SeriesInstanceUID,SeriesDescription:t.SeriesDescription,SeriesNumber:t.SeriesNumber,SeriesTime:t.SeriesTime,SOPClassUID:t.SOPClassUID,ProtocolName:t.ProtocolName,Modality:t.Modality}),i[t.SeriesInstanceUID]||(i[t.SeriesInstanceUID]=[]);const a=M.getImageIdsForInstance({instance:t});t.imageId=a,$.addImageIdToUIDs(a,{StudyInstanceUID:e,SeriesInstanceUID:t.SeriesInstanceUID,SOPInstanceUID:t.SOPInstanceUID}),i[t.SeriesInstanceUID].push(t)}));const c=Object.values(r);l.default.addSeriesMetadata(c,s),Object.keys(i).forEach((e=>l.default.addInstances(i[e],s)))},_retrieveSeriesMetadataAsync:async function(t,a,n,s){let o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const{preLoadData:r,promises:i}=await x(U,t,!0,a,n,s),c=t=>{const a=A(t);return e.bulkDataURI?.enabled?(Object.keys(a).forEach((t=>{const n=a[t];n&&n.BulkDataURI&&!n.Value&&(n.retrieveBulkData=()=>{N(n,a,e);const t={multipart:!1,BulkDataURI:n.BulkDataURI,StudyInstanceUID:a.StudyInstanceUID};return E.retrieveBulkData(t).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return n.Value=t,t}))})})),a):a};r.forEach((e=>{e.StudyInstanceUID=t})),l.default.addSeriesMetadata(r,o);const u=i.map((a=>a.then((a=>{!function(a){const n=a.map(c);n.forEach(((a,n)=>{a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri;const s=M.getImageIdsForInstance({instance:a});a.imageId=s,$.addImageIdToUIDs(s,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID})})),l.default.addInstances(n,o)}(a)}))));await Promise.all(u),l.default.getStudy(t,o).isLoaded=!0},deleteStudyMetadataPromise:R,getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance(t){let{instance:a,frame:n}=t;return h({instance:a,frame:n,config:e})},getConfig:()=>D};return g&&(M.reject=function(e){return{series:(t,a)=>new Promise(((n,s)=>{const o=`${e}/studies/${t}/series/${a}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",o,!0),console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 204:n(r.responseText);break;case 404:s("Your dataSource does not support reject functionality")}},r.send()}))}}(n)),u.Z.create(M)}var B=a(84334);const H=B.default.classes.MetadataProvider,Z={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let _={urls:[]};const j=e=>_.urls.find((t=>t.url===e)),G=(e,t)=>{let a=[];return _.urls.map((n=>{n.studies.map((n=>{n[e]===t&&a.push(n)}))})),a};function z(e){const{name:t,wadoRoot:a}=e,n={initialize:async e=>{let{params:t,query:a,url:n}=e;n||(n=a.get("url"));let s=j(n);if(s)return s.studies.map((e=>e.StudyInstanceUID));const o=await fetch(n);let r=await o.json();const i=r.studies.map((e=>e.StudyInstanceUID));let c,l;return r.studies.forEach((e=>{c=e.StudyInstanceUID,e.series.forEach((e=>{l=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;H.addImageIdToUIDs(t,{StudyInstanceUID:c,SeriesInstanceUID:l,SOPInstanceUID:a.SOPInstanceUID})}))}))})),_.urls.push({url:n,studies:[...r.studies]}),i},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],n=Z[t];return G(n,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>P(a,e),series:{metadata:function(){let{StudyInstanceUID:e,madeInClient:t=!1,customSort:a}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=G("StudyInstanceUID",e)[0];let s;s=a?a(n.series):n.series;const o=s.map((e=>{const t={StudyInstanceUID:n.StudyInstanceUID,...e};return delete t.instances,t}));l.default.addSeriesMetadata(o,t);const r=s.length;s.forEach(((a,s)=>{const o=a.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...a,...n};return delete t.instances,delete t.series,t}));var i;i=o,l.default.addInstances(i,t),s===r-1&&(l.default.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(t){const a=t.images,n=[];return a?(t.images.forEach((t=>{const a=t.NumberOfFrames;if(a>1)for(let s=0;s<a;s++){const a=h({instance:t,frame:s,config:e});n.push(a)}else{const a=h({instance:t,config:e});n.push(a)}})),n):n},getImageIdsForInstance(e){let{instance:t,frame:a}=e;return h({instance:t,frame:a})}};return u.Z.create(n)}const W=B.default.classes.MetadataProvider,{EVENTS:X}=l.default,Y={SR:!0,SEG:!0,DOC:!0},J=function(e,t){return e===t?arguments.length>2&&void 0!==arguments[2]?arguments[2]:0:e<t?-1:1},K=(e,t)=>{const a=e.instances[0],n=t.instances[0],s=a.Modality,o=n.Modality,r=Y[s],i=Y[o];return r&&i?J(a.SeriesNumber,n.SeriesNumber):r||i?r?-1:1:J(n.SeriesNumber,a.SeriesNumber)};function Q(e){const{name:t}=e,a={initialize:e=>{let{params:t,query:a}=e;const{StudyInstanceUIDs:n}=t,s=a.getAll("StudyInstanceUIDs")||n,o=s&&Array.isArray(s)?s:[s];return o.forEach((e=>{const t=l.default.getStudy(e);t.series=t.series.sort(K)})),o},query:{studies:{mapParams:()=>{},search:e=>l.default.getStudyInstanceUIDs().map((e=>{let t=0;const a=new Set,n=l.default.getStudy(e);n.series.forEach((e=>{t+=e.instances.length,a.add(e.instances[0].Modality)}));const s=n?.series[0]?.instances[0];if(s)return{accession:s.AccessionNumber,date:s.StudyDate,description:s.StudyDescription,mrn:s.PatientID,patientName:c.default.formatPN(s.PatientName),studyInstanceUid:s.StudyInstanceUID,time:s.StudyTime,instances:t,modalities:Array.from(a).join("/"),NumInstances:t}})),processResults:()=>{console.debug(" DICOMLocal QUERY processResults")}},series:{search:e=>l.default.getStudy(e).series.map((t=>{const a=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:a.SeriesInstanceUID,modality:a.Modality,seriesNumber:a.SeriesNumber,seriesDate:a.SeriesDate,numSeriesInstances:t.instances.length,description:a.SeriesDescription}}))},instances:{search:()=>{console.debug(" DICOMLocal QUERY instances SEARCH")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e,s=t[a];if(s instanceof Array&&s[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([s[0]],{type:n}))},series:{metadata:async function(){let{StudyInstanceUID:e,madeInClient:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=l.default.getStudy(e,t);l.default._broadcastEvent(X.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),a.series.forEach((a=>{const{SeriesInstanceUID:n}=a,s=a.instances[0].NumberOfFrames>1;a.instances.forEach(((e,t)=>{const{url:a,StudyInstanceUID:n,SeriesInstanceUID:o,SOPInstanceUID:r}=e;e.imageId=a,W.addImageIdToUIDs(a,{StudyInstanceUID:n,SeriesInstanceUID:o,SOPInstanceUID:r,frameIndex:s?t:1})})),l.default._broadcastEvent(X.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:n,madeInClient:t})}))}}},store:{dicom:e=>{const t=v.default.data.datasetToBlob(e);var a=URL.createObjectURL(t);window.location.assign(a)}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:a}=e;const{StudyInstanceUID:n,SeriesInstanceUID:s,SOPInstanceUID:o}=t;let r=l.default.getInstance(n,s,o).url;return void 0!==a&&(r+=`&frame=${a}`),r},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")}};return u.Z.create(a)}function ee(e,t){const{name:a}=e;let n;const s={initialize:async e=>{let{params:s,query:o}=e,r=[];const i=o.get("studyInstanceUIDs")||o.get("studyInstanceUids");if(!i)throw new Error(`No studyInstanceUids in request for '${a}'`);const c=o.get("url");if(!c)throw new Error(`No url for '${a}'`);{const e=await fetch(c);let a=await e.json();if(!a.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");n=q(a.servers.dicomWeb[0],t),r=i.split(";")}return r},query:{studies:{search:e=>n.query.studies.search(e)},series:{search:function(){return n.query.series.search(...arguments)}},instances:{search:(e,t)=>n.query.instances.search(e,t)}},retrieve:{directURL:function(){return n.retrieve.directURL(...arguments)},series:{metadata:function(){return n.retrieve.series.metadata(...arguments)}}},store:{dicom:function(){return n.store(...arguments)}},deleteStudyMetadataPromise:function(){return n.deleteStudyMetadataPromise(...arguments)},getImageIdsForDisplaySet:function(){return n.getImageIdsForDisplaySet(...arguments)},getImageIdsForInstance:function(){return n.getImageIdsForInstance(...arguments)}};return u.Z.create(s)}const te=function(){return[{name:"dicomweb",type:"webApi",createDataSource:q},{name:"dicomwebproxy",type:"webApi",createDataSource:ee},{name:"dicomjson",type:"jsonApi",createDataSource:z},{name:"dicomlocal",type:"localApi",createDataSource:Q}]};var ae=a(32735),ne=a(60216),se=a.n(ne),oe=a(14935),re=a(21572),ie=a(63677),ce=a(93058),le=a(43004),ue=a(66082),de=a(25825),me=a(22896),pe=a(40841),ge=a.n(pe);function fe(){return fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},fe.apply(this,arguments)}function Ie(e){let{servicesManager:t}=e;const{toolbarService:a}=t.services,[n,s]=(0,ae.useState)([]),[o,r]=(0,ae.useState)({primaryToolId:"",toggles:{},groups:{}});return(0,ae.useEffect)((()=>{const{unsubscribe:e}=a.subscribe(a.EVENTS.TOOL_BAR_MODIFIED,(()=>s(a.getButtonSection("primary")))),{unsubscribe:t}=a.subscribe(a.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>r({...a.state})));return()=>{e(),t()}}),[a]),ae.createElement(ae.Fragment,null,n.map(((e,n)=>{const{id:s,Component:r,componentProps:i}=e;let c;return"toggle"===i.type&&(c=o.toggles[s]),ae.createElement("div",{key:s,className:ge()("mr-1")},ae.createElement(r,fe({id:s},i,{bState:o,isActive:c,onInteraction:e=>a.recordInteraction(e),servicesManager:t})))})))}const{availableLanguages:ye,defaultLanguage:Se,currentLanguage:he}=ce.default;function ve(e){let{extensionManager:t,servicesManager:a,hotkeysManager:n,commandsManager:s,viewports:o,ViewportGridComp:r,leftPanels:i=[],rightPanels:c=[],leftPanelDefaultClosed:l=!1,rightPanelDefaultClosed:u=!1}=e;const[d]=(0,me.M)(),m=(0,oe.s0)(),p=(0,oe.TH)(),{t:g}=(0,re.$G)(),{show:f,hide:I}=(0,ie.dd)(),[y,S]=(0,ae.useState)(d.showLoadingIndicator),{hangingProtocolService:h}=a.services,{hotkeyDefinitions:v,hotkeyDefaults:D}=n,w=[{title:g("Header:About"),icon:"info",onClick:()=>f({content:ie.tk,title:"About OHIF Viewer",contentProps:{versionNumber:"3.3.0",buildNumber:"0"}})},{title:g("Header:Preferences"),icon:"settings",onClick:()=>f({title:g("UserPreferencesModal:User Preferences"),content:ie.i1,contentProps:{hotkeyDefaults:n.getValidHotkeyDefinitions(D),hotkeyDefinitions:v,currentLanguage:he(),availableLanguages:ye,defaultLanguage:Se,onCancel:()=>{B.dD.stopRecord(),B.dD.unpause(),I()},onSubmit:e=>{let{hotkeyDefinitions:t,language:a}=e;ce.default.changeLanguage(a.value),n.setHotkeys(t),I()},onReset:()=>n.restoreDefaultBindings(),hotkeysModule:B.dD}})}];d.oidc&&w.push({title:g("Header:Logout"),icon:"power-off",onClick:async()=>{m(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),(0,ae.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const b=e=>{const a=t.getModuleEntry(e);if(!a)throw new Error(`${e} is not a valid entry for an extension module, please check your configuration or make sure the extension is registered.`);let n;if(!a||!a.component)throw new Error(`No component found from extension ${e}. Check the reference string to the extension in your Mode configuration`);return n=a.component,{entry:a,content:n}},E=e=>{const{content:t,entry:a}=b(e);return{id:a.id,iconName:a.iconName,iconLabel:a.iconLabel,label:a.label,name:a.name,content:t}};(0,ae.useEffect)((()=>{const{unsubscribe:e}=h.subscribe(le.Z.EVENTS.PROTOCOL_CHANGED,(()=>{S(!1)}));return()=>{e()}}),[h]);const U=i.map(E),M=c.map(E),x=o.map((e=>{const{entry:t}=b(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return ae.createElement("div",null,ae.createElement(ie.h4,{menuOptions:w,isReturnEnabled:!!d.showStudyList,onClickReturnButton:()=>{const{pathname:e}=p,t=e.indexOf("/",1),a=new URLSearchParams(window.location.search).get("configUrl"),n=new URLSearchParams;-1!==t&&n.append("datasources",e.substring(t+1)),a&&n.append("configUrl",a),m({pathname:"/",search:decodeURIComponent(n.toString())})},WhiteLabeling:d.whiteLabeling},ae.createElement(ie.SV,{context:"Primary Toolbar"},ae.createElement("div",{className:"relative flex justify-center"},ae.createElement(Ie,{servicesManager:a})))),ae.createElement("div",{className:"bg-black flex flex-row items-stretch w-full overflow-hidden flex-nowrap relative",style:{height:"calc(100vh - 52px"}},ae.createElement(ae.Fragment,null,y&&ae.createElement(ie.LE,{className:"h-full w-full bg-black"}),U.length?ae.createElement(ie.SV,{context:"Left Panel"},ae.createElement(ie.hs,{side:"left",activeTabIndex:l?null:0,tabs:U,servicesManager:a})):null,ae.createElement("div",{className:"flex flex-col flex-1 h-full"},ae.createElement("div",{className:"flex items-center justify-center flex-1 h-full overflow-hidden bg-black relative"},ae.createElement(ie.SV,{context:"Grid"},ae.createElement(r,{servicesManager:a,viewportComponents:x,commandsManager:s})))),M.length?ae.createElement(ie.SV,{context:"Right Panel"},ae.createElement(ie.hs,{side:"right",activeTabIndex:u?null:0,tabs:M,servicesManager:a})):null)))}ve.propTypes={extensionManager:se().shape({getModuleEntry:se().func.isRequired}).isRequired,commandsManager:se().instanceOf(ue.Z),servicesManager:se().instanceOf(de.Z),leftPanels:se().array,rightPanels:se().array,leftPanelDefaultClosed:se().bool.isRequired,rightPanelDefaultClosed:se().bool.isRequired,children:se().oneOfType([se().node,se().func]).isRequired};const De=ve;const{sortStudyInstances:we,formatDate:be}=c.default;function Ee(e){let{servicesManager:t,getImageSrc:a,getStudiesForPatientByMRN:n,requestDisplaySetCreationForStudy:s,dataSource:o}=e;const{hangingProtocolService:r,displaySetService:i,uiNotificationService:c}=t.services,{StudyInstanceUIDs:l}=(0,ie.zG)(),[{activeViewportIndex:u,viewports:d},m]=(0,ie.O_)(),[p,g]=(0,ae.useState)("primary"),[f,I]=(0,ae.useState)([...l]),[y,S]=(0,ae.useState)([]),[h,v]=(0,ae.useState)([]),[D,w]=(0,ae.useState)({}),b=(0,ae.useRef)(!0);(0,ae.useEffect)((()=>{l.forEach((e=>async function(e){const t=await o.query.studies.search({studyInstanceUid:e});let a=t;try{a=await n(t)}catch(e){console.warn(e)}const s=a.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:be(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));S((e=>{const t=[...e];for(const a of s)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[l,n]),(0,ae.useEffect)((()=>(i.activeDisplaySets.forEach((async e=>{const t={},n=i.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(n),r=s[Math.floor(s.length/2)];r&&(t[e.displaySetInstanceUID]=await a(r),b.current&&w((e=>({...e,...t}))))})),()=>{b.current=!1})),[]),(0,ae.useEffect)((()=>{const e=Me(i.activeDisplaySets,D);we(e),v(e)}),[D]),(0,ae.useEffect)((()=>{const e=i.subscribe(i.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:t}=e;t.forEach((async e=>{const t={},n=i.getDisplaySetByUID(e.displaySetInstanceUID),s=o.getImageIdsForDisplaySet(n),r=s[Math.floor(s.length/2)];r&&(t[e.displaySetInstanceUID]=await a(r,e.initialViewport),b.current&&w((e=>({...e,...t}))))}))})),t=i.subscribe(i.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=Me(e,D);v(t)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[]);const E=function(e,t,a){const n=[],s=[],o=[];t.forEach((t=>{const r=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),i=Object.assign({},t,{displaySets:r});e.includes(t.studyInstanceUid)?n.push(i):(s.push(i),o.push(i))}));const r=[{name:"primary",label:"Primary",studies:n},{name:"recent",label:"Recent",studies:s},{name:"all",label:"All",studies:o}];return r}(l,y,h);const U=d[u]?.displaySetInstanceUIDs;return ae.createElement(ie.eX,{tabs:E,servicesManager:t,activeTabName:p,onDoubleClickThumbnail:e=>{let t=[];const a=u;try{t=r.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),c.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}m.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:U,expandedStudyInstanceUIDs:f,onClickStudy:function(e){const t=f.includes(e),a=t?[...f.filter((t=>t!==e))]:[...f,e];if(I(a),!t){s(i,e,!0)}},onClickTab:e=>{g(e)}})}Ee.propTypes={servicesManager:se().object.isRequired,dataSource:se().shape({getImageIdsForDisplaySet:se().func.isRequired}).isRequired,getImageSrc:se().func.isRequired,getStudiesForPatientByMRN:se().func.isRequired,requestDisplaySetCreationForStudy:se().func.isRequired};const Ue=Ee;function Me(e,t){const a=[],n=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const s=t[e.displaySetInstanceUID],o=function(e){if(xe.includes(e))return"thumbnailNoImage";return"thumbnail"}(e.Modality);("thumbnail"===o?a:n).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,componentType:o,imageSrc:s,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID}})})),[...a,...n]}const xe=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const Re=function(e,t){return new Promise(((a,n)=>{const s=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:s,imageId:t}).then((e=>{a(s.toDataURL())})).catch(n)}))};const Ce=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const Pe=function(e,t,a,n){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};function Ne(e){let{commandsManager:t,extensionManager:a,servicesManager:n}=e;const s=a.getDataSources()[0],o=Ce.bind(null,s),r=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return Re.bind(null,e)}catch(e){throw new Error("Required command not found")}}(a),i=Pe.bind(null,s);return ae.createElement(Ue,{servicesManager:n,dataSource:s,getImageSrc:r,getStudiesForPatientByMRN:o,requestDisplaySetCreationForStudy:i})}Ne.propTypes={commandsManager:se().object.isRequired,extensionManager:se().object.isRequired,servicesManager:se().object.isRequired};const Te=Ne;function Oe(e){let{onExportClick:t,onCreateReportClick:a}=e;const{t:n}=(0,re.$G)("MeasurementTable");return ae.createElement(ae.Fragment,null,ae.createElement(ie.hE,{color:"black",size:"inherit"},ae.createElement(ie.zx,{className:"px-2 py-2 text-base",onClick:t},n("Export CSV")),ae.createElement(ie.zx,{className:"px-2 py-2 text-base",onClick:a},n("Create Report"))))}Oe.propTypes={onExportClick:se().func,onCreateReportClick:se().func},Oe.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Ae=Oe;var ke=a(40001),Le=a.n(ke);const Fe={CANCEL:0,CREATE_REPORT:1};function Ve(){return ae.createElement("div",{className:"text-primary-active"},"Loading...")}const $e=async function(e,t,a,n,s){const{displaySetService:o,uiNotificationService:r,uiDialogService:i}=e.services,c=i.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:Ve});try{const e=await t.runCommand("storeMeasurements",{measurementData:n,dataSource:a,additionalFindingTypes:["ArrowAnnotate"],options:s},"CORNERSTONE_STRUCTURED_REPORT");l.default.addInstances([e],!0);const i=o.getMostRecentDisplaySet();return r.show({title:"Create Report",message:"Measurements saved successfully",type:"success"}),[i]}catch(e){r.show({title:"Create Report",message:e.message||"Failed to store measurements",type:"error"})}finally{i.dismiss({id:c})}},qe=4700;function Be(e,t){const a=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(a){console.log("Storing to same series",a);const{instance:e}=a,{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:o,SeriesNumber:r,Modality:i}=e;return{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:o,SeriesNumber:r,Modality:i,InstanceNumber:a.instances.length+1}}const n=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,qe)+1}(t);return{SeriesDescription:e,SeriesNumber:n}}const{downloadCSVReport:He}=c.default;function Ze(e){let{servicesManager:t,commandsManager:a,extensionManager:n}=e;const[s,o]=(0,ie.O_)(),{activeViewportIndex:r,viewports:i}=s,{measurementService:c,uiDialogService:l,uiNotificationService:u,displaySetService:d}=t.services,[m,p]=(0,ae.useState)([]);(0,ae.useEffect)((()=>{const e=Le()(p,100);p(_e(c));const t=c.EVENTS.MEASUREMENT_ADDED,a=c.EVENTS.RAW_MEASUREMENT_ADDED,n=c.EVENTS.MEASUREMENT_UPDATED,s=c.EVENTS.MEASUREMENT_REMOVED,o=c.EVENTS.MEASUREMENTS_CLEARED,r=[];return[t,a,n,s,o].forEach((t=>{r.push(c.subscribe(t,(()=>{e(_e(c))})).unsubscribe)})),()=>{r.forEach((e=>{e()})),e.cancel()}}),[]);const g=e=>{let{uid:t,isActive:a}=e;if(!a){const e=[...m],a=e.find((e=>e.uid===t));e.forEach((e=>e.isActive=e.uid===t)),a.isActive=!0,p(e)}};return ae.createElement(ae.Fragment,null,ae.createElement("div",{className:"overflow-x-hidden overflow-y-auto ohif-scrollbar","data-cy":"measurements-panel"},ae.createElement(ie.wt,{title:"Measurements",servicesManager:t,data:m,onClick:e=>{let{uid:t,isActive:a}=e;c.jumpToMeasurement(s.activeViewportIndex,t),g({uid:t,isActive:a})},onEdit:e=>{let{uid:t,isActive:a}=e;const n=c.getMeasurement(t),s=e=>{let{action:a,value:s}=e;if("save"===a.id)c.update(t,{...n,...s},!0);l.dismiss({id:"enter-annotation"})};l.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:ie.Vq,contentProps:{title:"Enter your annotation",noCloseButton:!0,value:{label:n.label||""},body:e=>{let{value:t,setValue:a}=e;return ae.createElement("div",{className:"p-4 bg-primary-dark"},ae.createElement(ie.II,{autoFocus:!0,id:"annotation",className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.label,onChange:e=>{e.persist(),a((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&s({value:t,action:{id:"save"}})}}))},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:s}})}})),ae.createElement("div",{className:"flex justify-center p-4"},ae.createElement(Ae,{onExportClick:async function(){const e=c.getMeasurements();He(e,c)},onClearMeasurementsClick:async function(){c.clearMeasurements()},onCreateReportClick:async function(){const e=i[r],s=c.getMeasurements(),o=d.getDisplaySetByUID(e.displaySetInstanceUIDs[0]),m=s.filter((e=>o.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void u.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await function(e,t){let{extensionManager:a}=t;return new Promise((function(t,n){let s;const o=Object.keys(a.dataSourceMap).filter((e=>{const t=a.dataSourceDefs[e]?.configuration;return t?.supportsStow??t?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));s=e.create({centralize:!0,isDraggable:!1,content:ie.Vq,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Provide a name for your report",value:{label:"",dataSourceName:a.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:s}),t({action:Fe.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:a=>{let{action:n,value:o}=a;switch(e.dismiss({id:s}),n.id){case"save":t({action:Fe.CREATE_REPORT,value:o.label,dataSourceName:o.dataSourceName});break;case"cancel":t({action:Fe.CANCEL,value:void 0,dataSourceName:void 0})}},body:a=>{let{value:n,setValue:r}=a;return ae.createElement(ae.Fragment,null,ae.createElement("div",{className:"p-4 bg-primary-dark"},o.length>1&&ae.createElement(ie.Ph,{closeMenuOnSelect:!0,className:"mr-2 bg-black border-primary-main",options:o,placeholder:o.find((e=>e.value===n.dataSourceName)).placeHolder,value:n.dataSourceName,onChange:e=>{r((t=>({...t,dataSourceName:e.value})))},isClearable:!1})),ae.createElement("div",{className:"p-4 bg-primary-dark"},ae.createElement(ie.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",placeholder:"Enter Report Name",containerClassName:"mr-2",value:n.label,onChange:e=>{e.persist(),r((t=>({...t,label:e.target.value})))},onKeyPress:a=>{"Enter"===a.key&&(e.dismiss({id:s}),t({action:Fe.CREATE_REPORT,value:n.label}))},required:!0})))}}})}))}(l,{extensionManager:n});if(p.action===Fe.CREATE_REPORT){const e=n.getDataSources(p.dataSourceName)[0],s=Be(void 0===p.value||""===p.value?"Research Derived Series":p.value,d);return $e(t,a,e,m,s)}}})))}function _e(e){return e.getMeasurements().map(((t,a)=>function(e,t,a){const{displayText:n,uid:s,label:o,type:r,selected:i,findingSites:c,finding:l}=e,u=c?.[0],d=o||l?.text||u?.text||"(empty)";let m=n||[];if(c){const e=[];c.forEach((t=>{t?.text!==d&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==d&&(m=[l.text,...m]);return{uid:s,label:d,baseLabel:o,measurementType:r,displayText:m,baseDisplayText:n,isActive:i,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}Ze.propTypes={servicesManager:se().instanceOf(de.Z).isRequired};const je=function(e){let{commandsManager:t,extensionManager:a,servicesManager:n}=e;return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:Te.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:()=>ae.createElement(Ze,{commandsManager:t,servicesManager:n,extensionManager:a})}]};var Ge=a(81596),ze=a(32746),We=a(4797),Xe=a(6604);const Ye=JSON.parse('{"u2":"@ohif/extension-default"}').u2,Je="stack",Ke=e=>e.NumberOfFrames>1,Qe=e=>{const t=e[0],a=new We.Z(e),{value:n,averageSpacingBetweenFrames:s}=(0,Xe.Z)(e);a.setAttributes({displaySetInstanceUID:a.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:Ke(t),countIcon:n?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${Ye}.sopClassHandlerModule.${Je}`,isReconstructable:n,averageSpacingBetweenFrames:s||null});return a.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),a},et=e=>"CR"===e||"MG"===e||"DX"===e;function tt(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],a=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),n=[];if(e.forEach((e=>{if(!(0,Ge.O)(e.SOPClassUID)&&!e.Rows)return;let s;Ke(e)?(s=Qe([e]),s.setAttributes({sopClassUids:a,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):et(e.Modality)?(s=Qe([e]),s.setAttributes({sopClassUids:a,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):n.push(e)})),n.length){const s=Qe(n);s.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),s.setAttributes({sopClassUids:a}),t.push(s)}return t}const at=[ze.Z.ComputedRadiographyImageStorage,ze.Z.DigitalXRayImageStorageForPresentation,ze.Z.DigitalXRayImageStorageForProcessing,ze.Z.DigitalMammographyXRayImageStorageForPresentation,ze.Z.DigitalMammographyXRayImageStorageForProcessing,ze.Z.DigitalIntraOralXRayImageStorageForPresentation,ze.Z.DigitalIntraOralXRayImageStorageForProcessing,ze.Z.CTImageStorage,ze.Z.EnhancedCTImageStorage,ze.Z.LegacyConvertedEnhancedCTImageStorage,ze.Z.UltrasoundMultiframeImageStorage,ze.Z.MRImageStorage,ze.Z.EnhancedMRImageStorage,ze.Z.EnhancedMRColorImageStorage,ze.Z.LegacyConvertedEnhancedMRImageStorage,ze.Z.UltrasoundImageStorage,ze.Z.UltrasoundImageStorageRET,ze.Z.SecondaryCaptureImageStorage,ze.Z.MultiframeSingleBitSecondaryCaptureImageStorage,ze.Z.MultiframeGrayscaleByteSecondaryCaptureImageStorage,ze.Z.MultiframeGrayscaleWordSecondaryCaptureImageStorage,ze.Z.MultiframeTrueColorSecondaryCaptureImageStorage,ze.Z.XRayAngiographicImageStorage,ze.Z.EnhancedXAImageStorage,ze.Z.XRayRadiofluoroscopicImageStorage,ze.Z.EnhancedXRFImageStorage,ze.Z.XRay3DAngiographicImageStorage,ze.Z.XRay3DCraniofacialImageStorage,ze.Z.BreastTomosynthesisImageStorage,ze.Z.BreastProjectionXRayImageStorageForPresentation,ze.Z.BreastProjectionXRayImageStorageForProcessing,ze.Z.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,ze.Z.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,ze.Z.NuclearMedicineImageStorage,ze.Z.VLEndoscopicImageStorage,ze.Z.VideoEndoscopicImageStorage,ze.Z.VLMicroscopicImageStorage,ze.Z.VideoMicroscopicImageStorage,ze.Z.VLSlideCoordinatesMicroscopicImageStorage,ze.Z.VLPhotographicImageStorage,ze.Z.VideoPhotographicImageStorage,ze.Z.OphthalmicPhotography8BitImageStorage,ze.Z.OphthalmicPhotography16BitImageStorage,ze.Z.OphthalmicTomographyImageStorage,ze.Z.VLWholeSlideMicroscopyImageStorage,ze.Z.PositronEmissionTomographyImageStorage,ze.Z.EnhancedPETImageStorage,ze.Z.LegacyConvertedEnhancedPETImageStorage,ze.Z.RTImageStorage,ze.Z.EnhancedUSVolumeStorage];const nt=function(){return[{name:Je,sopClassUids:at,getDisplaySetsFromSeries:tt}]};function st(){return ae.createElement("span",{className:"self-center w-4 h-8 mx-2 border-l border-common-dark"})}function ot(e){let{rows:t,columns:a,className:n,servicesManager:s,...o}=e;const[r,i]=(0,ae.useState)(!1),{hangingProtocolService:c,toolbarService:l}=s.services,u=()=>{r&&i(!1)};(0,ae.useEffect)((()=>{const{unsubscribe:e}=c.subscribe(c.EVENTS.PROTOCOL_CHANGED,(e=>{const{protocol:t}=e}));return()=>{e()}}),[c]),(0,ae.useEffect)((()=>(window.addEventListener("click",u),()=>{window.removeEventListener("click",u)})),[r]);const d=r?ie.OF:null;return ae.createElement(ie.hA,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>i(!r),className:n,rounded:o.rounded,dropdownContent:null!==d&&ae.createElement(d,{rows:t,columns:a,onSelection:e=>{l.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}}),isActive:r,type:"toggle"})}ot.propTypes={rows:se().number,columns:se().number,onLayoutChange:se().func,servicesManager:se().instanceOf(de.Z)},ot.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const rt=ot,it=ie.aW;function ct(e,t,a,n){const s={selectorProps:e,event:t},o=function(e,t,a){const{subMenu:n}=t,s=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,a||n),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let o=s.next(),r=o.value;for(;!o.done;)r=o.value,r&&s.return(),o=s.next();return console.log("Menu chosen",r?.id||"NONE"),r}(a,s,n);if(!o)return;if(!o.items)return console.warn("Must define items in menu",o),[];let r=[];return o.items.forEach((n=>{const{delegating:o,selector:i,subMenu:c}=n;if(!i||i(e))if(o)r=[...r,...ct(e,t,a,c)];else{const e=function(e,t){const a={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||a.iconRight||(a.iconRight="chevron-menu");e.action||(a.action=(e,n)=>{const{event:s={}}=n,{detail:o={}}=s;a.element=o.element,n.onClose();const r=n[`on${e.actionType||"Default"}`];r?r.call(n,a,e,t):console.warn("No action defined for",e)});return a}(n,s);r.push(e)}})),r}var lt=a(63021);class ut{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,a){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:n,subMenu:s,menuId:o,menus:r,selectorProps:i}=e;console.log("Getting items from",r);const c=ct(i||e,n,r,o);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:ut._getDefaultPosition(a,n?.detail,t),event:n,content:lt.Z,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:c,selectorProps:i,menus:r,event:n,subMenu:s,eventData:n?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(n,s,o)=>{s.subMenu?this.showContextMenu({...e,menuId:s.subMenu},t,a):console.warn("No submenu defined for",n,s,o)},onDefault:(e,t,a)=>{this.commandsManager.run(e,{...i,...t,subProps:a})}}})}}ut.getDefaultPosition=()=>({x:0,y:0}),ut._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),ut._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},ut._getCanvasPointsPosition=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;const a=ut._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const n={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(ut._isValidPosition(n)&&ut._isValidPosition(a))return{x:n.x+a.x,y:n.y+a.y}}},ut._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,ut._getDefaultPosition=(e,t,a)=>{const n=function*(){yield ut._getCanvasPointsPosition(e,a),yield ut._getEventDefaultPosition(t),yield ut._getElementDefaultPosition(a),yield ut.getDefaultPosition()}();let s=n.next(),o=s.value;for(;!s.done;)o=s.value,ut._isValidPosition(o)&&n.return(),s=n.next();return o};const dt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:e=>{let{nearbyToolData:t}=e;return!!t},items:[{label:"Delete measurement",commands:[{commandName:"deleteMeasurement"}]},{label:"Add Label",commands:[{commandName:"setMeasurementLabel"}]}]}]};var mt=a(53806),pt=a.n(mt),gt=a(21767);const ft={padding:"10px 0"},It={borderBottomWidth:"1px",...ft};function yt(e){let{tagRef:t,vrRef:a,keywordRef:n,valueRef:s}=e;return ae.createElement("div",{className:ge()("flex flex-row w-full bg-secondary-dark ohif-scrollbar overflow-y-scroll"),style:ft},ae.createElement("div",{className:"px-3 w-4/24"},ae.createElement("label",{ref:t,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},ae.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),ae.createElement("div",{className:"px-3 w-2/24"},ae.createElement("label",{ref:a,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},ae.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),ae.createElement("div",{className:"px-3 w-6/24"},ae.createElement("label",{ref:n,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},ae.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),ae.createElement("div",{className:"px-3 w-5/24 grow"},ae.createElement("label",{ref:s,className:"flex flex-col flex-1 text-white text-lg pl-1 select-none"},ae.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const St=function(e){let{rows:t}=e;const a=(0,ae.useRef)(),n=(0,ae.useRef)(),[s,o]=(0,ae.useState)(null),[r,i]=(0,ae.useState)(null),[c,l]=(0,ae.useState)(null),[u,d]=(0,ae.useState)(null);(0,ae.useEffect)((()=>{a?.current&&(a.current.scrollTo(0),a.current.resetAfterIndex(0))}),[t]),(0,ae.useEffect)((()=>{const e=Le()((()=>a.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const m=(0,ae.useCallback)((e=>{let{index:a,style:n}=e;const s=t[a];return ae.createElement("div",{style:{...n,...It},className:ge()("hover:bg-secondary-main transition duration-300 bg-black flex flex-row w-full border-secondary-light items-center text-base break-all","leading-[20px]"),key:`DICOMTagRow-${a}`},ae.createElement("div",{className:"px-3 w-4/24"},s[0]),ae.createElement("div",{className:"px-3 w-2/24"},s[1]),ae.createElement("div",{className:"px-3 w-6/24"},s[2]),ae.createElement("div",{className:"px-3 w-5/24 grow"},s[3]))}),[t]),p=(0,ae.useCallback)((()=>null!==s),[s]),g=(0,ae.useCallback)((e=>{const a=[s.offsetWidth,r.offsetWidth,c.offsetWidth,u.offsetWidth],o=n.current.getContext("2d");return o.font=getComputedStyle(n.current).font,t[e].map(((e,t)=>{const n=o.measureText(e).width;return 20*Math.ceil(n/a[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[t,c,s,u,r]);return ae.createElement("div",null,ae.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:n}),ae.createElement(yt,{tagRef:e=>{e&&o(e)},vrRef:e=>{e&&i(e)},keywordRef:e=>{e&&l(e)},valueRef:e=>{e&&d(e)}}),ae.createElement("div",{className:"m-auto relative border-2 border-black bg-black",style:{height:"32rem"}},p()&&ae.createElement(gt.S_,{ref:a,height:500,itemCount:t.length,itemSize:g,width:"100%",className:"ohif-scrollbar"},m)))},{ImageSet:ht}=r.default,{DicomMetaDictionary:vt}=v.default.data,{nameMap:Dt}=vt;function wt(e,t){const a=[];return e.forEach((e=>{if("SQ"===e.vr){a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:n}=e;n.forEach(((e,n)=>{const s=wt(e,t);a.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${n}`,""]),a.push(...s)}))}else{if("xs"===e.vr)try{const a=v.default.data.Tag.fromPString(e.tag).toCleanString(),n=t[a];e.vr=n.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),a}function bt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const a=Object.keys(e);let n="";for(let e=0;e<t;e++)n+=">";t>0&&(n+=" ");const s=[];for(let r=0;r<a.length;r++){let i=a[r];if("_vrMap"===i)continue;const c=Dt[i];let l=e[i];if(c&&"SQ"===c.vr){const e=(o=l,Array.isArray(o)?o:[o]),a={tag:c.tag,tagIndent:n,vr:c.vr,keyword:i,values:[]};if(s.push(a),null===l)continue;e.forEach((e=>{const n=bt(e,t+1);n.length&&(Et(n),a.values.push(n))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${i}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${i}:`),l=" ")),i=i.replace("RETIRED_",""),c)s.push({tag:c.tag,tagIndent:n,vr:c.vr,keyword:i,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(i.match(e)){const e=`(${i.substring(0,4)},${i.substring(4,8)})`;s.push({tag:e,tagIndent:n,vr:"",keyword:"Private Tag",value:l})}}}var o;return s}function Et(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const Ut=e=>{let{displaySets:t,displaySetInstanceUID:a}=e;const n=new Set([1]),[s,o]=(0,ae.useState)(a),[r,i]=(0,ae.useState)(1),[c,l]=(0,ae.useState)(""),u=(0,ae.useRef)(null),d=t.find((e=>e.displaySetInstanceUID===s)),m=d instanceof ht;const p=m&&d.images.length>1,g=(0,ae.useMemo)((()=>(t.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),t.map((e=>{const{displaySetInstanceUID:t,SeriesDate:a,SeriesTime:n,SeriesNumber:s,SeriesDescription:o,Modality:r}=e,i=`${a}:${n}`.split(".")[0];return{value:t,label:`${s} (${r}): ${o}`,description:pt()(i,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[t]),f=(0,ae.useMemo)((()=>{let e;e=m?d.images[r-1]:d.instance||d;const t=function(e){const t=bt(e);return Et(t),t}(e);return wt(t,e)}),[r,s]),I=(0,ae.useMemo)((()=>{if(!c)return f;const e=c.toLowerCase();return f.filter((t=>t.reduce(((t,a,s)=>t||(n.has(s)?t:t||a.toLowerCase().includes(e))),!1)))}),[f,c]),y=(0,ae.useMemo)((()=>Le()(l,200)),[]);return(0,ae.useEffect)((()=>()=>{y?.cancel()}),[]),ae.createElement("div",{className:"dicom-tag-browser-content"},ae.createElement("div",{className:"flex flex-row mb-6 items-center pl-1"},ae.createElement("div",{className:"flex flex-row items-center w-1/2"},ae.createElement(ie.ZT,{variant:"subtitle",className:"mr-4"},"Series"),ae.createElement("div",{className:"grow mr-8"},ae.createElement(ie.Ph,{id:"display-set-selector",isClearable:!1,onChange:e=>{o(e.value),i(1)},options:g,value:g.find((e=>e.value===s)),className:"text-white"}))),ae.createElement("div",{className:"flex flex-row items-center w-1/2"},p&&ae.createElement(ie.ZT,{variant:"subtitle",className:"mr-4"},"Instance Number"),p&&ae.createElement("div",{className:"grow"},ae.createElement(ie.OX,{value:r,key:s,onChange:e=>{i(parseInt(e))},minValue:1,maxValue:d.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),ae.createElement("div",{className:"w-full h-1 bg-black"}),ae.createElement("div",{className:"flex flex-row my-3 w-1/2"},ae.createElement("label",{className:"relative block w-full mr-8"},ae.createElement("span",{className:"absolute inset-y-0 left-0 flex items-center pl-2"},ae.createElement(ie.JO,{name:"icon-search"})),ae.createElement("input",{ref:u,type:"text",className:"block bg-black w-full shadow transition duration-300 appearance-none border border-inputfield-main focus:border-inputfield-focus focus:outline-none disabled:border-inputfield-disabled rounded w-full py-2 px-9 text-base leading-tight placeholder:text-inputfield-placeholder",placeholder:"Search metadata...",onChange:e=>y(e.target.value),autoComplete:"off"}),ae.createElement("span",{className:"absolute inset-y-0 right-0 flex items-center pr-2"},ae.createElement(ie.JO,{name:"icon-clear-field",className:ge()("cursor-pointer",c?"":"hidden"),onClick:()=>{u.current.value="",y("")}})))),ae.createElement(St,{rows:I}))},Mt=(e,t,a)=>{const{activeViewportIndex:n,viewports:s,layout:o}=e,r=t.getState(),{protocolId:i,stageIndex:c,activeStudyUID:l}=r,{protocol:u}=t.getActiveProtocol(),d=u.stages[c],m=`${l}:${i}:${c}`,p=a.getState(),g=`${l}:${i}`,f={...p.viewportGridStore},I={...p.hangingProtocolStageIndexMap},y={...p.displaySetSelectorMap},{rows:S,columns:h}=d.viewportStructure.properties,v=d.viewports.length!==e.viewports.length||e.layout.numRows!==S||e.layout.numCols!==h;I[g]=r,m&&v&&(f[m]={...e});for(let t=0;t<e.viewports.length;t++){const a=e.viewports[t],{displaySetOptions:s,displaySetInstanceUIDs:o}=a;if(s)for(let e=0;e<s.length;e++){const a=o[e];a&&(t===n&&0===e&&(y[`${l}:activeDisplaySet:0`]=a),s[e]?.id&&(y[`${l}:${s[e].id}:${s[e].matchedDisplaySetsIndex||0}`]=a))}}return{hangingProtocolStageIndexMap:I,viewportGridStore:f,displaySetSelectorMap:y}},xt=(e,t,a,n,s)=>{const o=t?.[n];if(o)return{...o};const{protocolId:r,stageIndex:i}=e.getState();s.inDisplay||(s.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(r,i,s);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return s.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},Rt=(e,t,a)=>{let{numRows:n,numCols:s}=t;const{viewports:o}=e,r={...a.getState().viewportsByPosition},i=[];for(const e of o)if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};r[e.positionId]=t,delete t.viewportId,delete t.viewportOptions.viewportId}for(let e=0;e<n;e++)for(let t=0;t<s;t++){const a=t+e*s,n=r[o?.[a]?.positionId||`${t}-${e}`];n?.displaySetInstanceUIDs&&i.push(...n.displaySetInstanceUIDs)}return r.initialInDisplay=i,{viewportsByPosition:r}};var Ct=a(64134);const{subscribeToNextViewportGridChange:Pt}=c.default,Nt=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),Tt=e=>{let{servicesManager:t,commandsManager:a}=e;const{customizationService:n,measurementService:s,hangingProtocolService:o,uiNotificationService:r,viewportGridService:i,displaySetService:c,stateSyncService:l,toolbarService:u}=t.services,d=new ut(t,a),m={showContextMenu:e=>{const{menuCustomizationId:t,element:a,event:s,selectorProps:r,defaultPointsPosition:i=[]}=e,c={...e};t&&Object.assign(c,n.get(t,dt));const{protocol:l,stage:u}=o.getActiveProtocol();c.selectorProps={event:s,protocol:l,stage:u,...r},d.showContextMenu(c,a,i)},closeContextMenu:()=>{d.closeContextMenu()},displayNotification:e=>{let{text:t,title:a,type:n}=e;r.show({title:a,message:t,type:n})},clearMeasurements:()=>{s.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:a}=o.getActiveProtocol(),n=s=>{if(!s.id)return;const{commands:o,items:r}=s.props||s;r&&r.forEach(n);const i=o?.find?.(Nt);if(!i)return;const{protocolId:c,stageIndex:l,stageId:d}=i.commandOptions,m=!(c&&c!==e.id||void 0!==l&&l!==t||d&&d!==a.id);u.setActive(s.id,m)};Object.values(u.getButtons()).forEach(n)},setHangingProtocol:e=>{let{activeStudyUID:t="",protocolId:n,stageId:s,stageIndex:c,reset:u=!1}=e;try{const e=i.getState(),r=o.getState(),{protocol:d}=o.getActiveProtocol(),p=Mt(e,o,l),{hangingProtocolStageIndexMap:g,viewportGridStore:f,displaySetSelectorMap:I}=p;if(n){if(void 0===c&&void 0===s){const e=`${t||r.activeStudyUID}:${n}`;c=g[e]?.stageIndex}}else n=r.protocolId,void 0===s&&void 0===c&&(c=r.stageIndex);const y=c??o.getStageIndex(n,{stageId:s,stageIndex:c});t&&o.setActiveStudyUID(t);const S=`${o.getState().activeStudyUID}:${n}:${y||0}`,h=!u&&f[S];if(n!==r.protocolId||y!==r.stageIndex||t?(o.setProtocol(n,{displaySetSelectorMap:I,stageId:s,stageIndex:y,restoreProtocol:h}),h&&i.set(f[S])):o.setProtocol(n,{stageId:s,stageIndex:y}),delete I[`${t||r.activeStudyUID}:activeDisplaySet:0`],l.store(p),m.toggleHpTools(o.getActiveProtocol()),n!==r.protocolId){const{protocol:e}=o.getActiveProtocol();a.run(d.callbacks?.onProtocolExit),a.run(e.callbacks?.onProtocolEnter)}return!0}catch(e){return m.toggleHpTools(o.getActiveProtocol()),r.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:e=>{let{protocolId:t,stageIndex:a}=e;const{protocol:n,stageIndex:s,activeStudy:r}=o.getActiveProtocol(),{toggleHangingProtocol:i}=l.getState(),c=`${r.StudyInstanceUID}:${t}:${0|a}`;if(n.id!==t||void 0!==a&&a!==s)return l.store({toggleHangingProtocol:{...i,[c]:{protocolId:n.id,stageIndex:s}}}),m.setHangingProtocol({protocolId:t,stageIndex:a,reset:!0});{const e=i[c]||{protocolId:"default"};return m.setHangingProtocol(e)}},deltaStage:e=>{let{direction:t}=e;const{protocolId:a,stageIndex:n}=o.getState(),{protocol:s}=o.getActiveProtocol();for(let e=n+t;e>=0&&e<s.stages.length;e+=t)if("disabled"!==s.stages[e].status)return m.setHangingProtocol({protocolId:a,stageIndex:e});r.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:e=>{let{numRows:t,numCols:n}=e;const{protocol:s}=o.getActiveProtocol(),r=s.callbacks?.onLayoutChange;if(!1===a.run(r,{numRows:t,numCols:n}))return void console.log("setViewportGridLayout running",r,t,n);window.setTimeout((()=>{const e=i.getState(),a=Rt(e,{numRows:t,numCols:n},l),s=xt.bind(null,o,a.viewportsByPosition);i.setLayout({numRows:t,numCols:n,findOrCreateViewport:s}),l.store(a)}),0)},toggleOneUp(){const e=i.getState(),{activeViewportIndex:t,viewports:a,layout:n}=e,{displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:c}=a[t];if(1===n.numCols&&1===n.numRows){const{toggleOneUpViewportGridStore:e}=l.getState();if(!e.layout)return;const t=e.activeViewportIndex,a=s.length>1?[]:s.map((e=>o.getViewportsRequireUpdate(t,e))).flat(),n=t=>{const n=a.find((e=>e.viewportIndex===t));return n?{viewportOptions:c,displaySetOptions:r,...n}:e.viewports[t]},u=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportIndex:t,layoutOptions:u,findOrCreateViewport:n})}else{l.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:s,displaySetOptions:r,viewportOptions:c});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});Pt(i,(()=>{l.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){Ct.m.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportIndex:e,viewports:a}=i.getState(),n=a[e],{displaySetInstanceUIDs:s}=n,o=c.activeDisplaySets,{UIModalService:r}=t.services,l=s[0];r.show({content:Ut,contentProps:{displaySets:o,displaySetInstanceUID:l,onClose:r.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportIndex:e,viewports:t}=i.getState();if(!t||e<0||e>t.length-1)return;const a=t[e].displaySetInstanceUIDs[0],n=document.querySelector("#ohif-thumbnail-list");if(!n)return;const s=n.getBoundingClientRect(),o=document.querySelector(`#thumbnail-${a}`);if(!o)return;const r=o.getBoundingClientRect();r.top>=s.top&&r.top<=s.bottom||o.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:e=>{let{direction:t,excludeNonImageModalities:a}=e;const n=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],s=o.getDisplaySetSortFunction(),l=[...c.activeDisplaySets];l.sort(s);const{activeViewportIndex:u,viewports:d}=i.getState(),{displaySetInstanceUIDs:p}=d[u];let g;for(g=l.findIndex((e=>p.includes(e.displaySetInstanceUID)))+t;g>-1&&g<l.length&&(a&&n.includes(l[g].Modality));g+=t);if(g<0||g>=l.length)return;const{displaySetInstanceUID:f}=l[g];let I=[];try{I=o.getViewportsRequireUpdate(u,f)}catch(e){console.warn(e),r.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}i.setDisplaySetsForViewports(I),setTimeout((()=>m.scrollActiveThumbnailIntoView()),0)}},p={showContextMenu:{commandFn:m.showContextMenu},closeContextMenu:{commandFn:m.closeContextMenu},clearMeasurements:{commandFn:m.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:m.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:m.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:m.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:m.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:m.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:m.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:m.toggleOneUp,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:m.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:m.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:m,definitions:p,defaultContext:"DEFAULT"}},Ot={hasUpdatedPriorsInformation:!1,id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},At={id:"default",locked:!0,hasUpdatedPriorsInformation:!1,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const kt=function(){return[{name:At.id,protocol:At},{name:Ot.id,protocol:Ot}]};const Lt=function(){const[e]=(0,me.M)(),t=(0,oe.s0)(),a=e.dataSources;return ae.createElement("div",{style:{width:"100%",height:"100%"}},ae.createElement("div",{className:"h-screen w-screen flex justify-center items-center "},ae.createElement("div",{className:"py-8 px-8 mx-auto bg-secondary-dark drop-shadow-md space-y-2 rounded-lg"},ae.createElement("img",{className:"block mx-auto h-14",src:"./ohif-logo.svg",alt:"OHIF"}),ae.createElement("div",{className:"text-center space-y-2 pt-4"},a.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>ae.createElement("div",{key:e.sourceName},ae.createElement("h1",{className:"text-white"},e.friendlyName),ae.createElement(ie.zx,{className:ge()("font-bold","ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),ae.createElement("br",null))))))))};var Ft=a(71251);const Vt=B.default.classes.MetadataProvider;const $t=r.default.MetadataProvider;const qt=e=>{let{SeriesInstanceUID:t,StudyInstanceUID:a}=e;const{instances:n}=l.default.getSeries(a,t);if("PT"!==n[0].Modality)return;const s=n.map((e=>e.imageId)),o=[];if(s.forEach((e=>{const t=function(e){const t=Vt.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.PatientWeight||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");const a={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};a.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(a.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(a.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(a.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(a.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(a.PatientSize=t.PatientSize),a}(e);t&&o.push(t)})),!o.length)return;let r;try{r=(0,Ft.d)(o)}catch(e){console.log(e)}r&&o.forEach(((e,t)=>{$t.addCustomMetadata(s[t],"scalingModule",r[t])}))},Bt={id:Ye,preRegistration:function(e){let{servicesManager:t,configuration:a={}}=e;const{stateSyncService:n}=t.services;l.default.subscribe(l.default.EVENTS.INSTANCES_ADDED,qt),l.default.subscribe(l.default.EVENTS.SERIES_UPDATED,qt),n.register("viewportGridStore",{clearOnModeExit:!0}),n.register("displaySetSelectorMap",{clearOnModeExit:!0}),n.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),n.register("toggleHangingProtocol",{clearOnModeExit:!0}),n.register("viewportsByPosition",{clearOnModeExit:!0})},getDataSourcesModule:te,getLayoutTemplateModule:function(e){let{servicesManager:t,extensionManager:a,commandsManager:n,hotkeysManager:s}=e;return[{name:"viewerLayout",id:"viewerLayout",component:function(e){return De({servicesManager:t,extensionManager:a,commandsManager:n,hotkeysManager:s,...e})}}]},getPanelModule:je,getHangingProtocolModule:kt,getSopClassHandlerModule:nt,getToolbarModule:function(e){let{commandsManager:t,servicesManager:a}=e;return[{name:"ohif.divider",defaultComponent:st,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:ie.hA,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:ie.hA,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:it,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:rt,clickHandler:(e,t,a)=>{}},{name:"ohif.toggle",defaultComponent:ie.hA,clickHandler:()=>{}}]},getCommandsModule:Tt,getUtilityModule(e){let{servicesManager:t}=e;return[{name:"common",exports:{getStudiesForPatientByMRN:Ce}}]},getCustomizationModule:function(){return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>ae.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:Lt}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,a=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return a?ae.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&ae.createElement("span",{className:"mr-1 shrink-0"},this.label),ae.createElement("span",{className:"font-light"},a)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const a of t.menus){const{items:t}=a;a.items=[];for(const n of t)a.items.push(e.transform(n))}return t}}]}]}}}}]);
//# sourceMappingURL=702.bundle.3f0816d0ec0acf54e586.js.map