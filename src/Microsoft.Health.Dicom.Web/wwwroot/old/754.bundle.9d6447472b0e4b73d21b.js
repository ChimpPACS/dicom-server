(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[754],{3346:(e,t,n)=>{"use strict";n.r(t),n.d(t,{CornerstoneExtensionTypes:()=>o,default:()=>jo,getActiveViewportEnabledElement:()=>pe,measurementMappingUtils:()=>r,toolNames:()=>Se});var o={};n.r(o);var r={};n.r(r),n.d(r,{getFirstAnnotationSelected:()=>ln,getHandlesFromPoints:()=>Zo,getModalityUnit:()=>Ce,getSOPInstanceAttributes:()=>be.Z,isAnnotationSelected:()=>an,setAnnotationSelected:()=>sn});var i=n(32735),a=n(28773),s=n(86251),l=n(47908),c=n(52425),d=n(87051),m=n(3692),u=n(36260),p=n(84334),g=n(78041),h=n(60754),I=n(96720),f=n(1182),S=n(44158),v=n(25792),w=n(45791),E=n(64819),y=n(71478),D=n(57082),b=n(76467),T=n(509),O=n(4409),N=n(44906),C=n(37893),U=n(93853),A=n(99605),M=n.n(A),_=n(43264),V=n.n(_),P=n(9159);const{registerVolumeLoader:R}=E;let L=!1;function x(e,t){M().external.cornerstone=a,M().external.dicomParser=V(),R("cornerstoneStreamingImageVolume",U.Z),M().configure({decodeConfig:{convertFloatPixelDataToInt:!1},beforeSend:function(n){const o=e.getAuthorizationHeader(),r={Accept:t.omitQuotationForMultipartRequest?"multipart/related; type=application/octet-stream":'multipart/related; type="application/octet-stream"'};return o&&Object.assign(r,o),r},errorInterceptor:e=>{P.Z.getHTTPErrorHandler(e)}}),function(e){const t={maxWebWorkers:Math.min(Math.max(navigator.hardwareConcurrency-1,1),e.maxNumberOfWebWorkers),startWebWorkersOnDemand:!0,taskConfiguration:{decodeTask:{initializeCodecsOnStartup:!1,usePDFJS:!1,strict:!1}}};L||(M().webWorkerManager.initialize(t),L=!0)}(t)}var F=n(7468),Z=n(68618),G=n(45283),k=n(56577),$=n(84994),j=n(66730),B=n(20168),z=n(35253),q=n(79122),W=n(59210),H=n(12111),K=n(37398),Y=n(96018),J=n(55338),Q=n(94968),X=n(67848),ee=n(32997),te=n(62906),ne=n(51180),oe=n(48925),re=n(44554),ie=n(7515),ae=n(59045),se=n(2737),le=n(12200),ce=n(53070),de=n(63677);const me=function(e,t,n){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const r="dialog-enter-annotation",a=t?!(arguments.length>3&&void 0!==arguments[3])||arguments[3]?t.text:t.label:"",{dialogTitle:s="Enter your annotation",inputLabel:l="",validateFunc:c=(e=>!0)}=o,d=t=>{let{action:o,value:i}=t;switch(o.id){case"save":if("function"==typeof c&&!c(i.label))return;n(i.label,o.id);break;case"cancel":n("",o.id)}e.dismiss({id:r})};e&&e.create({id:r,centralize:!0,isDraggable:!1,showOverlay:!0,content:de.Vq,contentProps:{title:s,value:{label:a},noCloseButton:!0,onClose:()=>e.dismiss({id:r}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:d,body:e=>{let{value:t,setValue:n}=e;return i.createElement("div",{className:"p-4 bg-primary-dark"},i.createElement(de.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",id:"annotation",containerClassName:"mr-2",label:l,labelClassName:"text-primary-light",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&d({value:t,action:{id:"save"}})}}))}}})};var ue=n(21922);function pe(e){const{activeViewportIndex:t}=e.getState(),{element:n}=(0,ue.K8)(t)||{};return(0,I.ZP)(n)}const{calibrateImageSpacing:ge}=ce;class he extends K.Z{constructor(){super(...arguments),this._renderingViewport=void 0,this._lengthToolRenderAnnotation=this.renderAnnotation,this.renderAnnotation=(e,t)=>{const{viewport:n}=e;return this._renderingViewport=n,this._lengthToolRenderAnnotation(e,t)}}_getTextLines(e,t){const[n,o]=e.handles.points.map((e=>this._renderingViewport.worldToCanvas(e)));return[`${Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(n*n+o*o)}(n,o))/100}px`]}}he.toolName="CalibrationLine";const Ie=he;function fe(e,t){const{uiDialogService:n,viewportGridService:o}=e.services,r=t.detail,{annotation:{metadata:i,data:a}}=r,{referencedImageId:s}=i,l=pe(o),{viewport:c}=l,d=Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(n*n+o*o+r*r)}(a.handles.points[0],a.handles.points[1]))/100,m=y.get("calibratedPixelSpacing",s),u=y.get("imagePlaneModule",s),p=m?.[0]||u?.rowPixelSpacing||1,g=m?.[1]||u?.columnPixelSpacing||1;return new Promise(((e,t)=>{n?me(n,{text:"",label:`${d}`},((n,o)=>{"save"===o?((e=>{const t=e/d,n=t*p,o=t*g;ge(s,c.getRenderingEngine(),n,o)})(Number.parseFloat(n)),e(!0)):t("cancel")}),!1,{dialogTitle:"Calibration",inputLabel:"Actual Physical distance (mm)",validateFunc:e=>{try{const t=Number.parseFloat(e);return!isNaN(t)&&0!==t}catch{return!1}}}):t("UIDialogService is not initiated")}))}const Se={Pan:k.Z.toolName,ArrowAnnotate:ee.Z.toolName,WindowLevel:$.Z.toolName,StackScroll:B.Z.toolName,StackScrollMouseWheel:j.Z.toolName,Zoom:z.Z.toolName,VolumeRotateMouseWheel:W.Z.toolName,MipJumpToClick:H.Z.toolName,Length:K.Z.toolName,DragProbe:te.Z.toolName,Probe:q.Z.toolName,RectangleROI:Y.Z.toolName,EllipticalROI:J.Z.toolName,CircleROI:Q.Z.toolName,Bidirectional:X.Z.toolName,Angle:ne.Z.toolName,CobbAngle:oe.Z.toolName,PlanarFreehandROI:re.Z.toolName,Magnify:ie.Z.toolName,Crosshairs:F.Z.toolName,SegmentationDisplay:ae.Z.toolName,ReferenceLines:C.Z.toolName,CalibrationLine:Ie.toolName,TrackballRotateTool:se.Z.toolName};var ve=n(7576),we=n(69786),Ee=n(16786),ye=n(69639);const De=["Length","EllipticalROI","CircleROI","Bidirectional","ArrowAnnotate","Angle","CobbAngle","Probe","RectangleROI","PlanarFreehandROI"];var be=n(63130),Te=n(31492);const Oe={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return[];const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{length:m}=n,u="mm";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,length:m})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,SeriesNumber:r,SOPInstanceUID:i,frameNumber:a}=e[0],s=t.images.find((e=>e.SOPInstanceUID===i));let l;s&&(l=s.InstanceNumber);const c=l?` I: ${l}`:"",d=t.isMultiFrame?` F: ${a}`:"";if(null==o)return n;const m=Te.default.roundNumber(o,2);return n.push(`${m} mm (S: ${r}${c}${d})`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:Length"),e.forEach((e=>{const{length:t}=e;o.push("Length (mm)"),r.push(t)})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Ne={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i,referencedSeriesInstanceUID:a}=n;if(!Object.keys(r).length)return[];const s=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:a,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,a,l),{SeriesNumber:d}=c,{length:m,width:u}=n,p="mm";s.push({SeriesInstanceUID:a,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:p,length:m,width:u})})),s}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,width:r,SeriesNumber:i,SOPInstanceUID:a,frameNumber:s}=e[0],l=Te.default.roundNumber(o,2),c=Te.default.roundNumber(r,2),d=t.images.find((e=>e.SOPInstanceUID===a));let m;d&&(m=d.InstanceNumber);const u=m?` I: ${m}`:"",p=t.isMultiFrame?` F: ${s}`:"";return n.push(`L: ${l} mm (S: ${i}${u}${p})`),n.push(`W: ${c} mm`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:Bidirectional"),e.forEach((e=>{const{length:t,width:n}=e;o.push("Length (mm)","Width (mm)"),r.push(t,n)})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Ce=function(e){return"CT"===e?"HU":"PT"===e?"SUV":""};const Ue={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return[];const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=Ce(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:r,frameNumber:i}=e[0],a=t.images.find((e=>e.SOPInstanceUID===r));let s;a&&(s=a.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${i}`:"",d=Te.default.roundNumber(o||0,2);return n.push(`${d} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:r}=e;let i="";if(o){i=`Max: ${Te.default.roundNumber(o,2)} <small>${t}</small> `}const a=`${i}(S:${r}${l}${c})`;n.includes(a)||n.push(a)})),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:EllipticalROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:i,area:a,unit:s}=e;t&&s&&i&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),r.push(i,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}},Ae={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return[];const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=Ce(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:r,frameNumber:i}=e[0],a=t.images.find((e=>e.SOPInstanceUID===r));let s;a&&(s=a.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${i}`:"",d=Te.default.roundNumber(o||0,2);return n.push(`${d} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:r}=e;let i="";if(o){i=`Max: ${Te.default.roundNumber(o,2)} <small>${t}</small> `}const a=`${i}(S:${r}${l}${c})`;n.includes(a)||n.push(a)})),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:CircleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:i,area:a,unit:s}=e;t&&s&&i&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),r.push(i,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Me=Ae;const _e={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{text:r}=o,{referencedImageId:i}=n,a=[],{SOPInstanceUID:s,SeriesInstanceUID:l,frameNumber:c}=(0,be.Z)(i),d=t.getDisplaySetForSOPInstanceUID(s,l,c),{SeriesNumber:m}=d;return a.push({SeriesInstanceUID:l,SOPInstanceUID:s,SeriesNumber:m,frameNumber:c,text:r}),a}(r,t),S=function(e,t){if(!e)return"";const n=[],{SeriesNumber:o,SOPInstanceUID:r,frameNumber:i}=e[0],a=t.images.find((e=>e.SOPInstanceUID===r));let s;a&&(s=a.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${i}`:"";return n.push(`(S: ${o}${l}${c})`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.text,text:s.text,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>{throw new Error("Not implemented")}}}},Ve={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Cobb Angle tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return;const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:r,SeriesNumber:i,SOPInstanceUID:a,frameNumber:s}=e[0],l=t.images.find((e=>e.SOPInstanceUID===a));let c;l&&(c=l.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const u=Te.default.roundNumber(o,2);return n.push(`${u} ${r} (S: ${i}${d}${m})`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f?.[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:CobbAngle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),r.push(t)})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Pe=Ve,Re={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return;const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:r,SeriesNumber:i,SOPInstanceUID:a,frameNumber:s}=e[0],l=t.images.find((e=>e.SOPInstanceUID===a));let c;l&&(c=l.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const u=Te.default.roundNumber(o,2);return n.push(`${u} ${r} (S: ${i}${d}${m})`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f?.[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:Angle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),r.push(t)})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Le=Re,xe={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("PlanarFreehandROI tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles;!function(e,t){const{metadata:n,data:o}=e,{label:r}=o,{referencedImageId:i}=n,a=[],{SOPInstanceUID:s,SeriesInstanceUID:l}=(0,be.Z)(i)||{};if(!s||!l)return a;const c=t.getDisplaySetForSOPInstanceUID(s,l),{SeriesNumber:d,SeriesInstanceUID:m}=c;a.push({SeriesInstanceUID:m,SeriesNumber:d,label:r,data:o})}(r,t);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:"",data:{...s,...s.cachedStats},type:o(c),getReport:()=>({columns:[],values:[]})}}};const Fe=xe,Ze={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:r,viewportId:i}=e,{metadata:a,data:s,annotationUID:l}=r;if(!a||!s)return console.warn("Rectangle ROI tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=a;if(!De.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:p,StudyInstanceUID:g}=(0,be.Z)(d,n,i);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,p):t.getDisplaySetsForSeries(p);const{points:I}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{cachedStats:r}=o,{referencedImageId:i}=n;if(!Object.keys(r).length)return[];const a=[];return Object.keys(r).forEach((e=>{const n=r[e];if(!i)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,be.Z)(i),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:p,area:g,Modality:h}=n,I=Ce(h);a.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:p,area:g})})),a}(r,t),S=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:r,frameNumber:i}=e[0],a=t.images.find((e=>e.SOPInstanceUID===r));let s;a&&(s=a.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${i}`:"",d=Te.default.roundNumber(o||0,2);return n.push(`${d} mm<sup>2</sup>`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:r}=e;let i="";if(o){i=`Max: ${Te.default.roundNumber(o,2)} <small>${t}</small> `}const a=`${i}(S:${r}${l}${c})`;n.includes(a)||n.push(a)})),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,metadata:a,referenceSeriesUID:p,referenceStudyUID:g,frameNumber:f[0]?.frameNumber||1,toolName:a.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:S,data:s.cachedStats,type:o(c),getReport:()=>function(e,t,n){const o=[],r=[];o.push("AnnotationType"),r.push("Cornerstone:RectangleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:i,area:a,unit:s}=e;t&&s&&i&&a&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"area (mm2)"),r.push(i,t,n,a))})),n&&(o.push("FrameOfReferenceUID"),r.push(n));t&&(o.push("points"),r.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:r}}(f,I,m)}}};const Ge=Ze,ke=(e,t,n)=>{const o=e=>{const{POLYLINE:t,ELLIPSE:n,CIRCLE:o,RECTANGLE:r,BIDIRECTIONAL:i,POINT:a,ANGLE:s}=ye.default.VALUE_TYPES;return{Length:t,EllipticalROI:n,CircleROI:o,RectangleROI:r,PlanarFreehandROI:t,Bidirectional:i,ArrowAnnotate:a,CobbAngle:s,Angle:s}[e]};return{Length:{toAnnotation:Oe.toAnnotation,toMeasurement:e=>Oe.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.POLYLINE,points:2}]},Bidirectional:{toAnnotation:Ne.toAnnotation,toMeasurement:e=>Ne.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.POLYLINE,points:2},{valueType:ye.default.VALUE_TYPES.POLYLINE,points:2}]},EllipticalROI:{toAnnotation:Ue.toAnnotation,toMeasurement:e=>Ue.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.ELLIPSE}]},CircleROI:{toAnnotation:Me.toAnnotation,toMeasurement:e=>Me.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.CIRCLE}]},RectangleROI:{toAnnotation:Ge.toAnnotation,toMeasurement:e=>Ge.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.POLYLINE}]},PlanarFreehandROI:{toAnnotation:Fe.toAnnotation,toMeasurement:e=>Fe.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.POLYLINE}]},ArrowAnnotate:{toAnnotation:_e.toAnnotation,toMeasurement:e=>_e.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.POINT,points:1}]},CobbAngle:{toAnnotation:Pe.toAnnotation,toMeasurement:e=>Pe.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.ANGLE}]},Angle:{toAnnotation:Le.toAnnotation,toMeasurement:e=>Le.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:ye.default.VALUE_TYPES.ANGLE}]}}},{removeAnnotation:$e}=ve,je=we.default,Be="Cornerstone3DTools",ze=e=>{const{measurementService:t,displaySetService:n,cornerstoneViewportService:o}=e.services,r=((e,t,n)=>{const{Length:o,Bidirectional:r,EllipticalROI:i,CircleROI:a,ArrowAnnotate:s,Angle:l,CobbAngle:c,RectangleROI:d,PlanarFreehandROI:m}=ke(e,t,n),u=e.createSource(Be,"0.1");return e.addMapping(u,"Length",o.matchingCriteria,o.toAnnotation,o.toMeasurement),e.addMapping(u,"Bidirectional",r.matchingCriteria,r.toAnnotation,r.toMeasurement),e.addMapping(u,"EllipticalROI",i.matchingCriteria,i.toAnnotation,i.toMeasurement),e.addMapping(u,"CircleROI",a.matchingCriteria,a.toAnnotation,a.toMeasurement),e.addMapping(u,"ArrowAnnotate",s.matchingCriteria,s.toAnnotation,s.toMeasurement),e.addMapping(u,"CobbAngle",c.matchingCriteria,c.toAnnotation,c.toMeasurement),e.addMapping(u,"Angle",l.matchingCriteria,l.toAnnotation,l.toMeasurement),e.addMapping(u,"RectangleROI",d.matchingCriteria,d.toAnnotation,d.toMeasurement),e.addMapping(u,"PlanarFreehandROI",m.matchingCriteria,m.toAnnotation,m.toMeasurement),e.addMapping(u,"CalibrationLine",o.matchingCriteria,o.toAnnotation,o.toMeasurement),u})(t,n,o);qe(t,o,r);const{annotationToMeasurement:i,remove:a}=r;function s(t){try{const n=t.detail,{annotation:{metadata:r,annotationUID:a}}=n,{toolName:s}=r;t.type===d&&s===Se.CalibrationLine?fe(e,t).then((()=>{console.log("calibration applied")}),(()=>!0)).finally((()=>{$e(a),l(t),o.resize()})):(n.uid=a,i(s,n))}catch(e){console.warn("Failed to update measurement:",e)}}function l(e){try{try{const n=e.detail,{annotation:{annotationUID:o}}=n;t.getMeasurement(o)&&(console.log("~~ removeEvt",e),a(o,n))}catch(e){console.warn("Failed to update measurement:",e)}}catch(e){console.warn("Failed to remove measurement:",e)}}const c=je.ANNOTATION_ADDED,d=je.ANNOTATION_COMPLETED,m=je.ANNOTATION_MODIFIED,u=je.ANNOTATION_REMOVED,p=je.ANNOTATION_SELECTION_CHANGE;return T.Z.addEventListener(c,s),T.Z.addEventListener(d,s),T.Z.addEventListener(m,(function(e){try{const n=e.detail,{annotation:{metadata:o,annotationUID:r}}=n;if(!t.getMeasurement(r))return;const{toolName:a}=o;n.uid=r,i(a,n,!0)}catch(e){console.warn("Failed to update measurement:",e)}})),T.Z.addEventListener(u,l),T.Z.addEventListener(p,(function(e){try{const n=e.detail,{added:o,removed:r}=n;r&&r.forEach((e=>t.setMeasurementSelected(e,!1))),o&&o.forEach((e=>t.setMeasurementSelected(e,!0)))}catch(e){console.warn("Failed to select and unselect measurements:",e)}})),r},qe=(e,t,n)=>{const{MEASUREMENT_REMOVED:o,MEASUREMENTS_CLEARED:r,MEASUREMENT_UPDATED:i,RAW_MEASUREMENT_ADDED:a}=e.EVENTS;e.getSource(Be,"0.1");e.subscribe(r,(e=>{let{measurements:t}=e;if(Object.keys(t).length)for(const e of Object.values(t)){const{uid:t,source:n}=e;n.name===Be&&$e(t)}})),e.subscribe(i,(e=>{let{source:t,measurement:n,notYetUpdatedAtSource:o}=e;if(t.name!==Be)return;if(!1===o)return;const{uid:r,label:i}=n,a=ve.getAnnotation(r),{data:s,metadata:l}=a;s&&(s.label!==i&&(s.label=i),"ArrowAnnotate"===l.toolName&&(s.text=i))})),e.subscribe(a,(e=>{let{source:t,measurement:n,data:o,dataSource:r}=e;if(t.name!==Be)return;const{referenceSeriesUID:i,referenceStudyUID:a,SOPInstanceUID:s}=n,l=Ee.default.getInstance(a,i,s);let c,d=1;n?.metadata?.referencedImageId?(c=n.metadata.referencedImageId,d=(0,be.Z)(n.metadata.referencedImageId).frameNumber):c=r.getImageIdsForInstance({instance:l});ve.getAnnotationManager().addAnnotation({annotationUID:n.uid,highlighted:!1,isLocked:!1,invalidated:!1,metadata:{toolName:n.toolName,FrameOfReferenceUID:n.FrameOfReferenceUID,referencedImageId:c},data:{text:o.annotation.data.text,handles:{...o.annotation.data.handles},cachedStats:{...o.annotation.data.cachedStats},label:o.annotation.data.label,frameNumber:d}})})),e.subscribe(o,(e=>{let{source:n,measurement:o}=e;if(n?.name&&n.name!==Be)return;$e(o);t.getRenderingEngine().render()}))};var We=n(68081);const He=function(e){e.setServiceImplementation({playClip:(e,t)=>We.e(e,t),stopClip:e=>We.z(e)})};var Ke=n(92891);const Ye=new Map,Je=new Map;function Qe(e){let{data:{viewportId:t,volumeInputArray:n},displaySetsMatchDetails:o,viewportMatchDetails:r}=e;Je.set(t,n);for(const e of n){const{volumeId:t}=e,n=h.ZP.getVolume(t);if(!n)return;if(!Ye.has(t)){const{metadata:e}=n;Ye.set(t,e.SeriesInstanceUID)}}if(r.size!==Je.size)return;for(const[e,t]of o.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(Ye.values()).includes(e))return}const i=Array.from(Ye.keys()).slice().map((e=>h.ZP.getVolume(e))),a=[];i.forEach((e=>{const t=e.getImageLoadRequests();if(!t.length||!t[0]||!t[0].imageId)return;const n=function(e){const t=e.length-1,n=Math.floor(e.length/2);let o=n,r=n;const i=[{imageId:e[n],imageIdIndex:n}],a={currentPositionDownToMinimum:!1,currentPositionUpToMaximum:!1};for(0===n?a.currentPositionDownToMinimum=!0:n===t&&(a.currentPositionUpToMaximum=!0);!a.currentPositionDownToMinimum||!a.currentPositionUpToMaximum;)a.currentPositionDownToMinimum||(o--,i.push({imageId:e[o],imageIdIndex:o}),0===o&&(a.currentPositionDownToMinimum=!0)),a.currentPositionUpToMaximum||(r++,i.push({imageId:e[r],imageIdIndex:r}),r===t&&(a.currentPositionUpToMaximum=!0));return i}(t.map((e=>e.imageId))).map((e=>{let{imageId:n}=e;return t.find((e=>e.imageId===n))}));a.push(n)}));const s=(0,Ke.compact)((0,Ke.flatten)((0,Ke.zip)(...a))),d=[];s.forEach((e=>{const{imageId:t}=e;a.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&d.push(n)}))}));const m=l.Z.Prefetch;d.forEach((e=>{let{callLoadImage:t,additionalDetails:n,imageId:o,imageIdIndex:r,options:i}=e;const a=t.bind(null,o,r,i);c.Z.addRequest(a,m,n,0)})),Ye.clear();const u=new Map(Je);return Je.clear(),u}const Xe=new Map,et=new Map;function tt(e){let{data:{viewportId:t,volumeInputArray:n},displaySetsMatchDetails:o}=e;et.set(t,n);for(const e of n){const{volumeId:t}=e,n=h.ZP.getVolume(t);if(!n)return void console.log("interleaveNthLoader::No volume, can't load it");if(!Xe.has(t)){const{metadata:e}=n;Xe.set(t,e.SeriesInstanceUID)}}const r=function(e){if(!e||!e.length)return[];if(1===e.length)return e[0];console.time("interleave");const t=[...e],n=[];for(let e=0;t.length>0;e++)for(const o of t)e>=o.length?t.splice(t.indexOf(o),1):n.push(o[e]);return console.timeEnd("interleave"),n}(Array.from(Xe.keys()).slice().map((e=>h.ZP.getVolume(e))).map((e=>e.getImageLoadRequests())).filter((e=>e?.[0]?.imageId)).map((e=>function(e){const t=[[],[],[],[],[]],n=e.length/2-3,o=n+6;for(let r=0;r<e.length;r++)r<2||r>e.length-4||r>n&&r<o?t[0].push(e[r]):r%7==2?t[1].push(e[r]):r%7==5?t[2].push(e[r]):t[r%2+3].push(e[r]);return[...t[0],...t[1],...t[2],...t[3],...t[4]]}(e)))),i=l.Z.Prefetch;r.forEach((e=>{let{callLoadImage:t,additionalDetails:n,imageId:o,imageIdIndex:r,options:a}=e;const s=t.bind(null,o,r,a);c.Z.addRequest(s,i,n,0)})),Xe.clear();const a=new Map(et);return et.clear(),a}const nt=new Map,ot=new Map;function rt(e){let{data:{viewportId:t,volumeInputArray:n},displaySetsMatchDetails:o,viewportMatchDetails:r}=e;ot.set(t,n);for(const e of n){const{volumeId:t}=e,n=h.ZP.getVolume(t);if(!n)return;if(!nt.has(t)){const{metadata:e}=n;nt.set(t,e.SeriesInstanceUID)}}if(r.size!==ot.size)return;for(const[e,t]of o.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(nt.values()).includes(e))return}const i=Array.from(nt.keys()).slice().map((e=>h.ZP.getVolume(e))),a=[];i.forEach((e=>{const t=e.getImageLoadRequests();t.length&&t[0]&&t[0].imageId&&a.push(t.reverse())}));const s=(0,Ke.compact)((0,Ke.flatten)((0,Ke.zip)(...a))),d=[];s.forEach((e=>{const{imageId:t}=e;a.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&d.push(n)}))}));const m=l.Z.Prefetch;d.forEach((e=>{let{callLoadImage:t,additionalDetails:n,imageId:o,imageIdIndex:r,options:i}=e;const a=t.bind(null,o,r,i);c.Z.addRequest(a,m,n,0)})),nt.clear();const u=new Map(ot);return ot.clear(),u}const it=(e,t)=>{if(!t?.detail)return;const{element:n,currentPoints:o}=t.detail;return e.runCommand("getNearbyAnnotation",{element:n,canvasCoordinates:o?.canvas},"CORNERSTONE")},at=we.default,st={button1:{commands:[{commandName:"closeContextMenu"}]},button3:{commands:[{commandName:"showCornerstoneContextMenu",commandOptions:{menuId:"measurementsContextMenu"}}]}};const lt=function(e){let{cornerstoneViewportService:t,customizationService:n,commandsManager:o}=e;const r=e=>{const t=function(e){const t=e.detail.event.which,n=[];return e.detail.event.altKey&&n.push("alt"),e.detail.event.ctrlKey&&n.push("ctrl"),e.detail.event.shiftKey&&n.push("shift"),n.push("button"),n.push(t),n.join("")}(e);((e,t)=>{const r=(n.get("cornerstoneViewportClickCommands")||st)[e];console.log("initContextMenu::cornerstoneViewportHandleEvent",e,r);const i={nearbyToolData:it(o,t),event:t};o.run(r,i)})(t,e)};T.Z.addEventListener(b.default.ELEMENT_ENABLED,function(e){const{viewportId:n,element:o}=e.detail,i=t.getViewportInfo(n);if(!i)return;const a=i.getViewportIndex();(0,ue.Yc)(a,o),o.addEventListener(at.MOUSE_CLICK,r)}.bind(null)),T.Z.addEventListener(b.default.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(at.MOUSE_CLICK,r)}.bind(null))},ct=we.default,dt={doubleClick:{commandName:"toggleOneUp",commandOptions:{}}};const mt=function(e){let{customizationService:t,commandsManager:n}=e;const o=e=>{if(it(n,e))return;const o=function(e){const t=[];return e.detail.event.altKey&&t.push("alt"),e.detail.event.ctrlKey&&t.push("ctrl"),e.detail.event.shiftKey&&t.push("shift"),t.push("doubleClick"),t.join("")}(e),r=(t.get("cornerstoneViewportClickCommands")||dt)[o];r&&n.run(r)};T.Z.addEventListener(b.default.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(ct.MOUSE_DOUBLE_CLICK,o)}.bind(null)),T.Z.addEventListener(b.default.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(ct.MOUSE_DOUBLE_CLICK,o)}.bind(null))};async function ut(e){let{servicesManager:t,commandsManager:n,extensionManager:o,configuration:r,appConfig:i}=e;await(0,g.S1)(),g.dQ(Boolean(i.useCPURendering)),g.Dg({...g.P_(),rendering:{...g.P_().rendering,strictZSpacingForVolumeViewport:i.strictZSpacingForVolumeViewport}});const a=i.maxCacheSize;h.ZP.setMaxCacheSize(a||1073741824),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};F.Z.isAnnotation=!1,C.Z.isAnnotation=!1,(0,Z.S1)(e),(0,G.LK)(k.Z),(0,G.LK)($.Z),(0,G.LK)(j.Z),(0,G.LK)(B.Z),(0,G.LK)(z.Z),(0,G.LK)(q.Z),(0,G.LK)(W.Z),(0,G.LK)(H.Z),(0,G.LK)(K.Z),(0,G.LK)(Y.Z),(0,G.LK)(J.Z),(0,G.LK)(Q.Z),(0,G.LK)(X.Z),(0,G.LK)(ee.Z),(0,G.LK)(te.Z),(0,G.LK)(ne.Z),(0,G.LK)(oe.Z),(0,G.LK)(re.Z),(0,G.LK)(ie.Z),(0,G.LK)(F.Z),(0,G.LK)(ae.Z),(0,G.LK)(C.Z),(0,G.LK)(Ie),(0,G.LK)(se.Z);const t=le.Z.getDefaultToolStyles();le.Z.setDefaultToolStyles({global:{...t.global,textBoxFontSize:"15px",lineWidth:"1.5"}})}(),w.Z.getRuntimeSettings().set("useCursors",Boolean(i.useCursors));const{userAuthenticationService:s,measurementService:l,customizationService:d,displaySetService:m,uiDialogService:u,uiModalService:A,uiNotificationService:M,cineService:_,cornerstoneViewportService:V,hangingProtocolService:P,toolGroupService:R,viewportGridService:L,stateSyncService:ce}=t.services;window.services=t.services,window.extensionManager=o,window.commandsManager=n,i.showWarningMessageForCrossOrigin&&!window.crossOriginIsolated&&M.show({title:"Cross Origin Isolation",message:"Cross Origin Isolation is not enabled, volume rendering will not work (e.g., MPR)",type:"warning"}),i.showCPUFallbackMessage&&g.L_()&&function(e,t){const n=t=>{if(100===t)return e.show({content:pt,title:"OHIF Fell Back to CPU Rendering"}),!0},{unsubscribe:o}=t.subscribe(t.EVENTS.PROTOCOL_CHANGED,(()=>{n(100)&&o()}))}(A,P),ce.register("lutPresentationStore",{clearOnModeExit:!0}),ce.register("positionPresentationStore",{clearOnModeExit:!0}),ce.register("toggleOneUpViewportGridStore",{clearOnModeExit:!0});const de=f.Z.Labelmap;S.eu(de,{fillAlpha:.3,fillAlphaInactive:.2,outlineOpacity:1,outlineOpacityInactive:.65});const me=p.default.classes.MetadataProvider;E.registerVolumeLoader("cornerstoneStreamingImageVolume",U.Z),P.registerImageLoadStrategy("interleaveCenter",Qe),P.registerImageLoadStrategy("interleaveTopToBottom",rt),P.registerImageLoadStrategy("nth",tt),y.addProvider(D.Z.get.bind(D.Z)),y.addProvider(me.get.bind(me),9999),c.Z.maxNumRequests={interaction:i?.maxNumRequests?.interaction||100,thumbnail:i?.maxNumRequests?.thumbnail||75,prefetch:i?.maxNumRequests?.prefetch||10},x(s,i),this.measurementServiceSource=ze(t),He(_),P.subscribe(P.EVENTS.CUSTOM_IMAGE_LOAD_PERFORMED,(e=>{for(const t of e.entries()){const[e,n]=t,o=V.getCornerstoneViewport(e),r=V.getViewportInfo(e),{lutPresentationStore:i,positionPresentationStore:a}=ce.getState(),{presentationIds:s}=r.getViewportOptions(),l={positionPresentation:a[s?.positionPresentationId],lutPresentation:i[s?.lutPresentationId]};V.setVolumesForViewport(o,n,l)}})),lt({cornerstoneViewportService:V,customizationService:d,commandsManager:n}),mt({customizationService:d,commandsManager:n});const ue=e=>{const{element:t}=e.detail;O.wp(t)},pe=e=>{const{element:t}=e.detail,{viewportId:n,renderingEngineId:o}=I.ZP(t),r=v.Z(n,o);if(!r||!r._toolInstances?.Crosshairs)return;const i=r._toolInstances.Crosshairs.mode;i===N.default.Active?r.setToolActive("Crosshairs"):i===N.default.Passive?r.setToolPassive("Crosshairs"):i===N.default.Enabled&&r.setToolEnabled("Crosshairs")};T.Z.addEventListener(b.default.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(b.default.CAMERA_RESET,pe),T.Z.addEventListener(b.default.STACK_VIEWPORT_NEW_STACK,ue)}.bind(null)),T.Z.addEventListener(b.default.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(b.default.CAMERA_RESET,pe)}.bind(null)),L.subscribe(L.EVENTS.ACTIVE_VIEWPORT_INDEX_CHANGED,(e=>{let{viewportIndex:t,viewportId:n}=e;n=n||`viewport-${t}`;const o=R.getToolGroupForViewport(n);if(!o||!o._toolInstances?.ReferenceLines)return;o._toolInstances.ReferenceLines.mode===N.default.Enabled&&(o.setToolConfiguration(C.Z.toolName,{sourceViewportId:n},!0),o.setToolEnabled(C.Z.toolName))}))}function pt(){return i.createElement("div",null,i.createElement("p",null,"Your computer does not have enough GPU power to support the default GPU rendering mode. OHIF has switched to CPU rendering mode. Please note that CPU rendering does not support all features such as Volume Rendering, Multiplanar Reconstruction, and Segmentation Overlays."))}window.cornerstone=a,window.cornerstoneTools=s;var gt=n(49154),ht=n(7439),It=n(60216),ft=n.n(It),St=n(40841),vt=n.n(St),wt=n(28250);const Et={PROGRESS:"event:DicomFileUploader:progress"};let yt=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Success=2]="Success",e[e.Failed=3]="Failed",e[e.Cancelled=4]="Cancelled",e}({});class Dt{constructor(e,t){this.message=void 0,this.status=void 0,this.message=t,this.status=e}}class bt extends wt.h{constructor(e,t){super(Et),this._file=void 0,this._fileId=void 0,this._dataSource=void 0,this._loadPromise=void 0,this._abortController=new AbortController,this._status=yt.NotStarted,this._percentComplete=0,this._file=e,this._fileId=M().wadouri.fileManager.add(e),this._dataSource=t}getFileId(){return this._fileId}getFileName(){return this._file.name}getFileSize(){return this._file.size}cancel(){this._abortController.abort()}getStatus(){return this._status}getPercentComplete(){return this._percentComplete}async load(){return this._loadPromise||(this._loadPromise=new Promise(((e,t)=>{const n={progress:e=>{e.lengthComputable&&(this._status=yt.InProgress,this._percentComplete=Math.round(100*e.loaded/e.total),this._broadcastEvent(Et.PROGRESS,{fileId:this._fileId,percentComplete:this._percentComplete}))},timeout:()=>{this._reject(t,new Dt(yt.Failed,"The request timed out."))},abort:()=>{this._reject(t,new Dt(yt.Cancelled,"Cancelled"))},error:()=>{this._reject(t,new Dt(yt.Failed,"The request failed."))}};M().wadouri.loadFileRequest(this._fileId).then((o=>{if(this._abortController.signal.aborted)return void this._reject(t,new Dt(yt.Cancelled,"Cancelled"));if(!this._checkDicomFile(o))return void this._reject(t,new Dt(yt.Failed,"Not a valid DICOM file."));const r=new XMLHttpRequest;return this._addRequestCallbacks(r,n),this._dataSource.store.dicom(o,r).then((()=>{this._status=yt.Success,e()})).catch((e=>{this._reject(t,e)}))})).catch((e=>{this._reject(t,e)}))}))),this._loadPromise}_isRejected(){return this._status===yt.Failed||this._status===yt.Cancelled}_reject(e,t){if(!this._isRejected()){if(t instanceof Dt)return this._status=t.status,void e(t);this._status=yt.Failed,t.message?e(new Dt(yt.Failed,t.message)):e(new Dt(yt.Failed,t))}}_addRequestCallbacks(e,t){const n=()=>e.abort();this._abortController.signal.addEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.addEventListener(n,o);const o=()=>{this._abortController.signal.removeEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.removeEventListener(n,o);e.removeEventListener("loadend",o)};e.addEventListener("loadend",o)}_checkDicomFile(e){if(e.length<=132)return!1;const t=new Uint8Array(e.slice(128,132));return Array.from("DICM").every(((e,n)=>e.charCodeAt(0)===t[n]))}}const Tt=(0,i.memo)((e=>{let{dicomFileUploader:t}=e;const[n,o]=(0,i.useState)(t.getPercentComplete()),[r,a]=(0,i.useState)(""),[s,l]=(0,i.useState)(t.getStatus());console.info(`${t.getFileId()}`);const c=(0,i.useCallback)((()=>s===yt.Failed||s===yt.Cancelled||s===yt.Success),[s]);(0,i.useEffect)((()=>{const e=t.subscribe(Et.PROGRESS,(e=>{o(e.percentComplete)}));return t.load().catch((e=>{l(e.status),a(e.message??"")})).finally((()=>l(t.getStatus()))),()=>e.unsubscribe()}),[]);const d=(0,i.useCallback)((()=>{t.cancel()}),[]);return i.createElement("div",{className:"flex w-full p-2.5 text-lg min-h-14 items-center border-b border-secondary-light overflow-hidden"},i.createElement("div",{className:"flex flex-col gap-1 self-top w-0 grow shrink"},i.createElement("div",{className:"flex gap-4"},i.createElement("div",{className:"flex w-6 justify-center items-center shrink-0"},(()=>{switch(t.getStatus()){case yt.Success:return i.createElement(de.JO,{name:"status-tracked",className:"text-primary-light"});case yt.InProgress:return i.createElement(de.JO,{name:"icon-transferring"});case yt.Failed:return i.createElement(de.JO,{name:"icon-alert-small"});case yt.Cancelled:return i.createElement(de.JO,{name:"icon-alert-outline"});default:return i.createElement(i.Fragment,null)}})()),i.createElement("div",{className:"text-ellipsis whitespace-nowrap overflow-hidden"},t.getFileName())),r&&i.createElement("div",{className:"pl-10"},r)),i.createElement("div",{className:"w-24 flex items-center"},!c()&&i.createElement(i.Fragment,null,t.getStatus()===yt.InProgress&&i.createElement("div",{className:"w-10 text-right"},n,"%"),i.createElement("div",{className:"flex cursor-pointer ml-auto"},i.createElement(de.JO,{className:"w-6 h-6 self-center text-primary-active",name:"close",onClick:d})))))}));Tt.propTypes={dicomFileUploader:ft().instanceOf(bt).isRequired};const Ot=Tt,Nt=1e3,Ct=6e4,Ut=36e5,At=15e3,Mt="text-ellipsis whitespace-nowrap overflow-hidden";function _t(e){let{dicomFileUploaderArr:t,onComplete:n}=e;const[o]=(0,i.useState)(t.reduce(((e,t)=>e+t.getFileSize()),0)),r=(0,i.useRef)(0),a=(0,i.useRef)(0),[s,l]=(0,i.useState)(null),[c,d]=(0,i.useState)(0),[m,u]=(0,i.useState)(0),[p,g]=(0,i.useState)(0),[h,I]=(0,i.useState)(!1),f=(0,i.useRef)();(0,i.useEffect)((()=>{let e,t=0,n=Date.now();const i=()=>{const s=r.current-t,l=Date.now(),c=l-n;a.current=s/c,t=r.current,n=l,o-r.current>0&&(e=a.current>=75?setTimeout(i,At):setTimeout(i,3e4))};return e=setTimeout(i,At),()=>{clearTimeout(e)}}),[]),(0,i.useEffect)((()=>{let e=null;const n=t.map((t=>{let n=0;const i=i=>{const s=n;if(n=Math.round(i/100*t.getFileSize()),r.current=Math.min(o,r.current-s+n),d(r.current/o*100),0!==a.current){const t=o-r.current,n=Math.round(t/a.current);if(null===e)return e=n,void l(e);if(n<Ct){const t=Math.ceil(e/Nt),o=Math.ceil(n/Nt)-t;return void((o<0||o>2)&&(e=n,l(e)))}if(n<Ut){const t=Math.ceil(e/Ct),o=Math.ceil(n/Ct)-t;return void((o<0||o>2)&&(e=n,l(e)))}e=n,l(e)}};return t.load().catch((e=>{e.status===yt.Failed&&g((e=>e+1))})).finally((()=>{i(100),u((e=>e+1))})),t.subscribe(Et.PROGRESS,(e=>{i(e.percentComplete)}))}));return()=>{n.forEach((e=>e.unsubscribe()))}}),[]);const S=(0,i.useCallback)((async()=>{for(const e of t){new Promise(((t,n)=>{setTimeout((()=>{e.cancel(),t()}),0)}))}}),[]),v=(0,i.useCallback)((()=>{if(null==s)return"";if(s<Ct){const e=Math.ceil(s/Nt);return`${e} ${1===e?"second":"seconds"}`}if(s<Ut){const e=Math.ceil(s/Ct);return`${e} ${1===e?"minute":"minutes"}`}const e=Math.ceil(s/Ut);return`${e} ${1===e?"hour":"hours"}`}),[s]),w=(0,i.useCallback)((()=>Math.min(100,Math.round(c))),[c]),E=(0,i.useCallback)((()=>w()<1&&(f?.current?.offsetWidth??0)*(c/100)<1),[w,c]),y=(0,i.useCallback)((()=>({width:`${2*t.length.toString().length+4}ch`})),[]),D=()=>i.createElement("div",{className:"ml-auto flex justify-center w-6"},p>0&&i.createElement("div",{onClick:()=>I((e=>!e))},i.createElement(de.JO,{className:"cursor-pointer",name:"icon-status-alert"})));return i.createElement("div",{className:"flex flex-col grow"},i.createElement("div",{className:"text-lg px-1 pb-4 h-14 flex bg-primary-dark items-center"},m===t.length?i.createElement(i.Fragment,null,i.createElement("span",{className:Mt},`${t.length} ${t.length>1?"files":"file"} completed.`),i.createElement(de.zx,{variant:"contained",color:"primary",disabled:!1,className:"ml-auto",onClick:n},"Close")):i.createElement(i.Fragment,null,i.createElement("span",{style:y(),className:vt()(Mt,"text-end")},`${m} of ${t.length}`," "),i.createElement("span",{className:Mt}," files completed."," "),i.createElement("span",{className:Mt},s?`Less than ${v()} remaining. `:""),i.createElement("span",{className:vt()(Mt,"cursor-pointer text-primary-active hover:text-primary-light active:text-aqua-pale ml-auto"),onClick:S},"Cancel All Uploads"))),i.createElement("div",{className:"flex flex-col bg-black text-lg overflow-hidden grow"},i.createElement("div",{className:"overflow-y-scroll ohif-scrollbar px-2 border-b border-secondary-light"},i.createElement("div",{className:"flex w-full p-2.5 items-center min-h-14"},m===t.length?i.createElement(i.Fragment,null,i.createElement("div",{className:"text-xl text-primary-light"},p>0?`Completed with ${p} ${p>1?"errors":"error"}!`:"Completed!"),D()):i.createElement(i.Fragment,null,i.createElement("div",{ref:f,className:"flex-grow"},i.createElement(de.YE,{progress:E()?void 0:Math.min(100,c)})),i.createElement("div",{className:"w-24 ml-1 flex items-center"},i.createElement("div",{className:"w-10 text-right"},`${w()}%`),D())))),i.createElement("div",{className:"overflow-y-scroll ohif-scrollbar px-2 grow h-1"},t.filter((e=>!h||e.getStatus()===yt.Failed)).map((e=>i.createElement(Ot,{key:e.getFileId(),dicomFileUploader:e}))))))}_t.propTypes={dicomFileUploaderArr:ft().arrayOf(ft().instanceOf(bt)).isRequired,onComplete:ft().func.isRequired};const Vt=_t;function Pt(){return Pt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Pt.apply(this,arguments)}function Rt(e){let{dataSource:t,onComplete:n,onStarted:o}=e;const r="min-h-[480px] flex flex-col bg-black select-none",[a,s]=(0,i.useState)([]),l=(0,i.useCallback)((async e=>{o(),s(e.map((e=>new bt(e,t))))}),[]);return i.createElement(i.Fragment,null,a.length?i.createElement("div",{className:vt()("h-[calc(100vh-300px)]",r)},i.createElement(Vt,{dicomFileUploaderArr:Array.from(a),onComplete:n})):i.createElement("div",{className:vt()("h-[480px]",r)},i.createElement(ht.Z,{onDrop:e=>{l(e)},noClick:!0},(e=>{let{getRootProps:t}=e;return i.createElement("div",Pt({},t(),{className:"m-5 dicom-upload-drop-area-border-dash flex flex-col items-center justify-center h-full"}),i.createElement("div",{className:"flex gap-3"},i.createElement(ht.Z,{onDrop:l,noDrag:!0},(e=>{let{getRootProps:t,getInputProps:n}=e;return i.createElement("div",t(),i.createElement(de.zx,{variant:"contained",color:"primary",disabled:!1,onClick:()=>{}},"Add files",i.createElement("input",n())))})),i.createElement(ht.Z,{onDrop:l,noDrag:!0},(e=>{let{getRootProps:t,getInputProps:n}=e;return i.createElement("div",t(),i.createElement(de.zx,{variant:"contained",color:"primaryDark",border:"primaryActive",disabled:!1,onClick:()=>{}},"Add folder",i.createElement("input",Pt({},n(),{webkitdirectory:"true",mozdirectory:"true"}))))}))),i.createElement("div",{className:"pt-5"},"or drag images or folders here"),i.createElement("div",{className:"pt-3 text-aqua-pale text-lg"},"(DICOM files supported)"))}))))}Rt.propTypes={dataSource:ft().object.isRequired,onComplete:ft().func.isRequired,onStarted:ft().func.isRequired};const Lt=Rt,xt={active:[{toolName:Se.WindowLevel,bindings:[{mouseButton:gt.p.Primary}]},{toolName:Se.Pan,bindings:[{mouseButton:gt.p.Auxiliary}]},{toolName:Se.Zoom,bindings:[{mouseButton:gt.p.Secondary}]},{toolName:Se.StackScrollMouseWheel,bindings:[]}],enabled:[{toolName:Se.SegmentationDisplay}]};const Ft=function(){return[{name:"cornerstoneDicomUploadComponent",value:{id:"dicomUploadComponent",component:Lt}},{name:"default",value:[{id:"cornerstone.overlayViewportTools",tools:xt}]}]};var Zt=n(51567),Gt=n(12145),kt=n(75089),$t=n(14284),jt=n(70808),Bt=n(33477),zt=n(58361),qt=n(63691),Wt=n(32974);const Ht=512,Kt=1e4,Yt="cornerstone-viewport-download-form",Jt=e=>{let{onClose:t,activeViewportIndex:n,cornerstoneViewportService:o}=e;const r=(0,ue.K8)(n),a=r?.element,s=(0,I.ZP)(a),{viewportId:l,renderingEngineId:c}=s,d=v.Z(l,c),m=Object.keys(d.toolOptions).reduce(((e,t)=>{const n=d.toolOptions[t],{mode:o,bindings:r}=n;return{...e,[t]:{mode:o,bindings:r}}}),{});(0,i.useEffect)((()=>()=>{Object.keys(m).forEach((e=>{const{mode:t,bindings:n}=m[e];d.setToolMode(e,t,{bindings:n})}))}),[]);return i.createElement(de.mQ,{onClose:t,minimumSize:100,maximumSize:Kt,defaultSize:Ht,canvasClass:"cornerstone-canvas",activeViewportElement:a,enableViewport:e=>{if(e){const{renderingEngine:t,viewport:n}=(0,I.ZP)(a),o={viewportId:Yt,element:e,type:n.type,defaultOptions:{background:n.defaultOptions.background,orientation:n.defaultOptions.orientation}};t.enableElement(o)}},disableViewport:e=>{if(e){const{renderingEngine:t}=(0,I.ZP)(e);return new Promise((e=>{t.disableElement(Yt)}))}},updateViewportPreview:(e,t,n)=>new Promise((t=>{const o=(0,I.ZP)(e),{viewport:r,renderingEngine:i}=o;i.resize(),r.render(),e.addEventListener(b.default.IMAGE_RENDERED,(function o(r){const i=(0,I.ZP)(r.target),{viewport:a}=i,{element:s}=a,l=(0,Wt.Z)(s),c="image/"+n,d=l.toDataURL(c,1);let m=s.offsetHeight,u=s.offsetWidth;if(m>Ht||u>Ht){const e=Ht/Math.max(m,u);u*=e,m*=e}t({dataUrl:d,width:m,height:u}),e.removeEventListener(b.default.IMAGE_RENDERED,o)}))})),loadImage:(e,t,n,r)=>new Promise((i=>{if(e&&t){const t=(0,I.ZP)(e);if(!t)return;const{viewport:a}=t,s=o.getRenderingEngine().getViewport(Yt);if(s instanceof Gt.Z){const e=a.getCurrentImageId(),t=a.getProperties();s.setStack([e]).then((()=>{s.setProperties(t);const e=Math.min(n||image.width,Kt),o=Math.min(r||image.height,Kt);i({width:e,height:o})}))}else if(s instanceof kt.Z){a.getActors().forEach((e=>{s.addActor(e)})),s.setCamera(a.getCamera()),s.render();const e=Math.min(n||image.width,Kt),t=Math.min(r||image.height,Kt);i({width:e,height:t})}}})),toggleAnnotations:(e,t,n)=>{const o=(0,I.ZP)(n),r=(0,I.ZP)(t),{viewportId:i,renderingEngineId:a}=o,{viewportId:s}=r;if(!o||!r)return;const l=v.Z(i,a);l.addViewport(s,a),Object.keys(l._toolInstances).forEach((t=>{if(e&&"Crosshairs"!==t)try{l.setToolEnabled(t)}catch(e){console.log(e)}else l.setToolDisabled(t)}))},downloadBlob:(e,t)=>{const n=`${e}.${t}`,o=document.querySelector(`div[data-viewport-uid="${Yt}"]`);(0,qt.Z)(o).then((e=>{const o=document.createElement("a");o.download=n,o.href=e.toDataURL(t,1),o.click()}))}})};Jt.propTypes={onClose:ft().func,activeViewportIndex:ft().number.isRequired};const Qt=Jt;var Xt=n(26222),en=n(28788);const tn=e=>{const t=[];for(let n=0;n<e.length;n++)for(let o=n+1;o<e.length;o++)t.push([e[n],e[o]]);return t};let nn=[];function on(e){let{toggledState:t,servicesManager:n,getEnabledElement:o}=e;const{syncGroupService:r,viewportGridService:i,displaySetService:a,cornerstoneViewportService:s}=n.services;if(!t)return void nn.forEach((e=>{const{viewports:t,synchronizerId:n}=e;t.forEach((e=>{let{viewportId:t,renderingEngineId:o}=e;r.removeViewportFromSyncGroup(t,o,n)}))}));nn=[];let{viewports:l}=i.getState();l=l.filter((e=>e.displaySetInstanceUIDs&&e.displaySetInstanceUIDs.length)),l=l.filter((e=>{const{displaySetInstanceUIDs:t}=e;for(const e of t){const t=a.getDisplaySetByUID(e);return!(!t||!t.isReconstructable)}}));const c=l.reduce(((e,t)=>{const{viewportId:n,viewportType:r}=t.viewportOptions;if("stack"!==r)return console.warn("Viewport is not a stack, cannot sync images yet"),e;const{element:i}=s.getViewportInfo(n),{viewport:a,renderingEngineId:l}=o(i),{viewPlaneNormal:c}=a.getCamera(),d=c.map((e=>Math.round(e))).join(",");return e[d]||(e[d]=[]),e[d].push({viewportId:n,renderingEngineId:l}),e}),{});Object.values(c).map((e=>{let t=e.map((e=>{let{viewportId:t}=e;return t})).join(",");t=`imageSync_${t}`,function(e){const t=tn(e);for(const[e,n]of t){const t=(0,Xt.Pr)(e.renderingEngineId),o=(0,Xt.Pr)(n.renderingEngineId),r=t.getViewport(e.viewportId),i=o.getViewport(n.viewportId);en.Z(r,i)}}(e),e.forEach((e=>{let{viewportId:n,renderingEngineId:o}=e;r.addViewportToSyncGroup(n,o,{type:"stackimage",id:t,source:!0,target:!0})})),nn.push({synchronizerId:t,viewports:e})}))}var rn=n(98336);function an(e){return rn.isAnnotationSelected(e)}function sn(e,t){an(e)!==t&&rn.setAnnotationSelected(e,t)}function ln(e){const[t]=rn.getAnnotationsSelected()||[];if(t)return ve.getAnnotation(t)}const cn=function(e){let{servicesManager:t,commandsManager:n}=e;const{viewportGridService:o,toolGroupService:r,cineService:i,toolbarService:a,uiDialogService:s,cornerstoneViewportService:l,uiNotificationService:c,measurementService:d}=t.services,{measurementServiceSource:m}=this;function u(){return pe(o)}const p={showCornerstoneContextMenu:e=>{const t=u()?.viewport?.element,o={...e,element:t},{useSelectedAnnotation:r,nearbyToolData:i,event:a}=o;if(r&&!i){const e=ln();if(!(!o.allowedSelectedTools||o.allowedSelectedTools.includes(e?.metadata?.toolName)))return;o.nearbyToolData=e}o.defaultPointsPosition=[],o.selectorProps={toolName:o.nearbyToolData?.metadata?.toolName,value:o.nearbyToolData,uid:o.nearbyToolData?.annotationUID,nearbyToolData:o.nearbyToolData,event:a,...o.selectorProps},n.run(e,o)},getNearbyToolData(e){let{nearbyToolData:t,element:n,canvasCoordinates:o}=e;return t??jt.r(n,o)},getNearbyAnnotation(e){let{element:t,canvasCoordinates:n}=e;const o=p.getNearbyToolData({nearbyToolData:null,element:t,canvasCoordinates:n});return o?.metadata?.toolName&&(e=>{const n=(0,I.ZP)(t);if(!n)return;const{renderingEngineId:o,viewportId:r}=n,i=v.Z(r,o).getToolInstance(e);return i?.constructor?.isAnnotation??!0})(o.metadata.toolName)?o:null},deleteMeasurement:e=>{let{uid:t}=e;t&&m.remove(t)},setMeasurementLabel:e=>{let{uid:t}=e;const n=d.getMeasurement(t);me(s,n,((e,t)=>{if("cancel"===t)return;const o=Object.assign({},n,{label:e});d.update(o.uid,o,!0)}),!1)},updateMeasurement:e=>{const{code:t,uid:n,textLabel:o,label:r}=e,i={...d.getMeasurement(n)};if(void 0!==o&&(i.label=o),void 0!==t){const e=t.type||"finding";if(t.ref&&!t.CodeValue){const e=t.ref.indexOf(":");t.CodeValue=t.ref.substring(e+1),t.CodeMeaning=t.text||r,t.CodingSchemeDesignator=t.ref.substring(0,e)}i[e]=t,"finding"!==e&&(i.findingSites?(i.findingSites=i.findingSites.filter((t=>t.type!==e)),i.findingSites.push(t)):i.findingSites=[t])}d.update(i.uid,i,!0)},getActiveViewportEnabledElement:u,setViewportActive:e=>{let{viewportId:t}=e;const n=l.getViewportInfo(t);if(!n)return void console.warn("No viewport found for viewportId:",t);const r=n.getViewportIndex();o.setActiveViewportIndex(r)},arrowTextCallback:e=>{let{callback:t,data:n}=e;me(s,n,t)},toggleCine:()=>{const{viewports:e}=o.getState(),{isCineEnabled:t}=i.getState();i.setIsCineEnabled(!t),a.setButton("Cine",{props:{isActive:!t}}),e.forEach(((e,t)=>i.setCine({id:t,isPlaying:!1})))},setWindowLevel(e){let{window:t,level:n,toolGroupId:o}=e;const i=Number(t),a=Number(n),{viewportId:s}=u(),c=r.getToolGroupForViewport(s);if(o&&o!==c)return;const d=l.getRenderingEngine().getViewport(s),{lower:m,upper:p}=Zt.toLowHighRange(i,a);d.setProperties({voiRange:{upper:p,lower:m}}),d.render()},toolbarServiceRecordInteraction:e=>{a.recordInteraction(e)},setToolActive:e=>{let{toolName:t,toolGroupId:n=null}=e;if("Crosshairs"===t){if(!r.getToolGroup(null)._toolInstances.Crosshairs)throw c.show({title:"Crosshairs",message:"You need to be in a MPR view to use Crosshairs. Click on MPR button in the toolbar to activate it.",type:"info",duration:3e3}),new Error("Crosshairs tool is not available in this viewport")}const{viewports:i}=o.getState()||{viewports:[]},a=r.getToolGroup(n),s=a?.getViewportIds?.();if(!s||!s.length)return;if(!i.filter((e=>!!e.viewportOptions&&s.includes(e.viewportOptions.viewportId))).length)return;if(!a.getToolInstance(t))throw c.show({title:`${t} tool`,message:`The ${t} tool is not available in this viewport.`,type:"info",duration:3e3}),new Error(`ToolGroup ${a.id} does not have this tool.`);const l=a.getActivePrimaryMouseButtonTool();l&&("Crosshairs"===l?a.setToolDisabled(l):a.setToolPassive(l)),a.setToolActive(t,{bindings:[{mouseButton:gt.p.Primary}]})},showDownloadViewportModal:()=>{const{activeViewportIndex:e}=o.getState();if(!l.getCornerstoneViewportByIndex(e))return void c.show({title:"Download Image",message:"Image cannot be downloaded",type:"error"});const{uiModalService:n}=t.services;n&&n.show({content:Qt,title:"Download High Quality Image",contentProps:{activeViewportIndex:e,onClose:n.hide,cornerstoneViewportService:l}})},rotateViewport:e=>{let{rotation:t}=e;const n=u();if(!n)return;const{viewport:o}=n;if(o instanceof Gt.Z){const{rotation:e}=o.getProperties(),n=(e+t)%360;o.setProperties({rotation:n}),o.render()}},flipViewportHorizontal:()=>{const e=u();if(!e)return;const{viewport:t}=e;if(t instanceof Gt.Z){const{flipHorizontal:e}=t.getCamera();t.setCamera({flipHorizontal:!e}),t.render()}},flipViewportVertical:()=>{const e=u();if(!e)return;const{viewport:t}=e;if(t instanceof Gt.Z){const{flipVertical:e}=t.getCamera();t.setCamera({flipVertical:!e}),t.render()}},invertViewport:e=>{let t,{element:n}=e;if(t=void 0===n?u():n,!t)return;const{viewport:o}=t;if(o instanceof Gt.Z){const{invert:e}=o.getProperties();o.setProperties({invert:!e}),o.render()}},resetViewport:()=>{const e=u();if(!e)return;const{viewport:t}=e;t instanceof Gt.Z?(t.resetProperties(),t.resetCamera()):t.resetCamera(),t.render()},scaleViewport:e=>{let{direction:t}=e;const n=u(),o=t>0?.9:1.1;if(!n)return;const{viewport:r}=n;if(r instanceof Gt.Z)if(t){const{parallelScale:e}=r.getCamera();r.setCamera({parallelScale:e*o}),r.render()}else r.resetCamera(),r.render()},jumpToImage:e=>{let t,{imageIndex:n,viewport:o}=e;if(o)t=l.getCornerstoneViewport(o.id);else{const e=u();if(!e)return;t=e.viewport}let r=0;if(t instanceof Gt.Z)r=t.getImageIds().length;else{if(!(t instanceof kt.Z))throw new Error("Unsupported viewport type");r=$t.Z(t).numberOfSlices}const i=n<0?r+n:n;if(i>=r||i<0)throw new Error(`Can't jump to ${n}`);const a={imageIndex:i};Bt.Z(t.element,a)},scroll:e=>{let{direction:t}=e;const n=u();if(!n)return;const{viewport:o}=n,r={delta:t};zt.Z(o,r)},setViewportColormap:e=>{let{viewportIndex:t,displaySetInstanceUID:n,colormap:o,immediate:r=!1}=e;const i=l.getCornerstoneViewportByIndex(t),a=i.getActors().find((e=>e.uid.includes(n))),{actor:s,uid:c}=a;i.setProperties({colormap:o,volumeActor:s},c),r&&i.render()},incrementActiveViewport:()=>{const{activeViewportIndex:e,viewports:t}=o.getState(),n=(e+1)%t.length;o.setActiveViewportIndex(n)},decrementActiveViewport:()=>{const{activeViewportIndex:e,viewports:t}=o.getState(),n=(e-1+t.length)%t.length;o.setActiveViewportIndex(n)},toggleStackImageSync:e=>{let{toggledState:n}=e;on({getEnabledElement:I.ZP,servicesManager:t,toggledState:n})},toggleReferenceLines:e=>{let{toggledState:t}=e;const{activeViewportIndex:n}=o.getState(),i=l.getViewportInfoByIndex(n).getViewportId(),a=r.getToolGroupForViewport(i);t||a.setToolDisabled(C.Z.toolName),a.setToolConfiguration(C.Z.toolName,{sourceViewportId:i},!0),a.setToolEnabled(C.Z.toolName)}},g={showCornerstoneContextMenu:{commandFn:p.showCornerstoneContextMenu,storeContexts:[],options:{menuCustomizationId:"measurementsContextMenu",commands:[{commandName:"showContextMenu"}]}},getNearbyToolData:{commandFn:p.getNearbyToolData},getNearbyAnnotation:{commandFn:p.getNearbyAnnotation,storeContexts:[],options:{}},deleteMeasurement:{commandFn:p.deleteMeasurement},setMeasurementLabel:{commandFn:p.setMeasurementLabel},updateMeasurement:{commandFn:p.updateMeasurement},setWindowLevel:{commandFn:p.setWindowLevel},toolbarServiceRecordInteraction:{commandFn:p.toolbarServiceRecordInteraction},setToolActive:{commandFn:p.setToolActive},rotateViewportCW:{commandFn:p.rotateViewport,options:{rotation:90}},rotateViewportCCW:{commandFn:p.rotateViewport,options:{rotation:-90}},incrementActiveViewport:{commandFn:p.incrementActiveViewport},decrementActiveViewport:{commandFn:p.decrementActiveViewport},flipViewportHorizontal:{commandFn:p.flipViewportHorizontal},flipViewportVertical:{commandFn:p.flipViewportVertical},invertViewport:{commandFn:p.invertViewport},resetViewport:{commandFn:p.resetViewport},scaleUpViewport:{commandFn:p.scaleViewport,options:{direction:1}},scaleDownViewport:{commandFn:p.scaleViewport,options:{direction:-1}},fitViewportToWindow:{commandFn:p.scaleViewport,options:{direction:0}},nextImage:{commandFn:p.scroll,options:{direction:1}},previousImage:{commandFn:p.scroll,options:{direction:-1}},firstImage:{commandFn:p.jumpToImage,options:{imageIndex:0}},lastImage:{commandFn:p.jumpToImage,options:{imageIndex:-1}},jumpToImage:{commandFn:p.jumpToImage},showDownloadViewportModal:{commandFn:p.showDownloadViewportModal},toggleCine:{commandFn:p.toggleCine},arrowTextCallback:{commandFn:p.arrowTextCallback},setViewportActive:{commandFn:p.setViewportActive},setViewportColormap:{commandFn:p.setViewportColormap},toggleStackImageSync:{commandFn:p.toggleStackImageSync},toggleReferenceLines:{commandFn:p.toggleReferenceLines}};return{actions:p,definitions:g,defaultContext:"CORNERSTONE"}},dn={id:"mpr",name:"Multi-Planar Reconstruction",locked:!0,hasUpdatedPriorsInformation:!1,createdDate:"2021-02-23",modifiedDate:"2023-04-03",availableTo:{},editableBy:{},numberOfPriorsReferenced:0,protocolMatchingRules:[],imageLoadStrategy:"nth",callbacks:{onLayoutChange:[{commandName:"toggleHangingProtocol",commandOptions:{protocolId:"mpr"},context:"DEFAULT"}],onProtocolExit:[{commandName:"toolbarServiceRecordInteraction",commandOptions:{interactionType:"tool",commands:[{commandOptions:{toolName:"WindowLevel"},context:"CORNERSTONE"}]}}]},displaySetSelectors:{activeDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{name:"MPR 1x3",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3,layoutOptions:[{x:0,y:0,width:1/3,height:1},{x:1/3,y:0,width:1/3,height:1},{x:2/3,y:0,width:1/3,height:1}]}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]}]}]},mn={id:"mprAnd3DVolumeViewport",locked:!0,hasUpdatedPriorsInformation:!1,name:"mpr",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0}]}},stages:[{id:"mpr3Stage",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]};const un=function(){return[{name:dn.id,protocol:dn},{name:mn.id,protocol:mn}]};var pn=n(26408),gn=n(14100),hn=n(38379),In=n(77095),fn=n(5841);const Sn={VIEWPORT_ADDED:"event::cornerstone::toolgroupservice:viewportadded",TOOLGROUP_CREATED:"event::cornerstone::toolgroupservice:toolgroupcreated"};class vn{constructor(e){this.serviceManager=void 0,this.toolGroupIds=new Set,this.listeners=void 0,this.EVENTS=void 0;const{cornerstoneViewportService:t,viewportGridService:n}=e.services;this.cornerstoneViewportService=t,this.viewportGridService=n,this.listeners={},this.EVENTS=Sn,Object.assign(this,wt.Z)}onModeExit(){this.destroy()}getToolGroup(e){let t=e;if(!t){const e=pe(this.viewportGridService);if(!e)return;const{renderingEngineId:n,viewportId:o}=e,r=v.Z(o,n);if(!r)return void console.warn("No tool group found for viewportId:",o,"and renderingEngineId:",n);t=r.id}return pn.Z(t)}getToolGroupIds(){return Array.from(this.toolGroupIds)}getToolGroupForViewport(e){const t=this.cornerstoneViewportService.getRenderingEngine();return v.Z(e,t.id)}getActiveToolForViewport(e){const t=v.Z(e);return t?t.getActivePrimaryMouseButtonTool():null}destroy(){gn.Z(),this.toolGroupIds=new Set}destroyToolGroup(e){hn.Z(e),this.toolGroupIds.delete(e)}removeViewportFromToolGroup(e,t,n){const o=v.Z(e,t);if(!o)return;o.removeViewports(t,e);0===o.getViewportIds().length&&n&&hn.Z(o.id)}addViewportToToolGroup(e,t,n){if(n){let o=pn.Z(n);o||(o=this.createToolGroup(n)),o.addViewport(e,t)}else{In.Z().forEach((n=>{n.addViewport(e,t)}))}this._broadcastEvent(Sn.VIEWPORT_ADDED,{viewportId:e,toolGroupId:n})}createToolGroup(e){if(this.getToolGroup(e))throw new Error(`ToolGroup ${e} already exists`);const t=fn.Z(e);return this.toolGroupIds.add(e),this._broadcastEvent(Sn.TOOLGROUP_CREATED,{toolGroupId:e}),t}addToolsToToolGroup(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=pn.Z(e);this._addTools(o,t,n),this._setToolsMode(o,t)}createToolGroupAndAddTools(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=this.createToolGroup(e);return this.addToolsToToolGroup(e,t,n),o}getToolConfiguration(e,t){const n=pn.Z(e);if(!n)return null;const o=n.getToolInstance(t);return o?o.configuration:null}setToolConfiguration(e,t,n){pn.Z(e).getToolInstance(t).configuration=n}_getToolNames(e){const t=[];return e.active&&e.active.forEach((e=>{t.push(e.toolName)})),e.passive&&e.passive.forEach((e=>{t.push(e.toolName)})),e.enabled&&e.enabled.forEach((e=>{t.push(e.toolName)})),e.disabled&&e.disabled.forEach((e=>{t.push(e.toolName)})),t}_setToolsMode(e,t){const{active:n,passive:o,enabled:r,disabled:i}=t;n&&n.forEach((t=>{let{toolName:n,bindings:o}=t;e.setToolActive(n,{bindings:o})})),o&&o.forEach((t=>{let{toolName:n}=t;e.setToolPassive(n)})),r&&r.forEach((t=>{let{toolName:n}=t;e.setToolEnabled(n)})),i&&i.forEach((t=>{let{toolName:n}=t;e.setToolDisabled(n)}))}_addTools(e,t,n){this._getToolNames(t).forEach((t=>{const o=n[t]??{};e.addTool(t,{...o})}))}}vn.REGISTRATION={name:"toolGroupService",altName:"ToolGroupService",create:e=>{let{servicesManager:t}=e;return new vn(t)}};const wn=vn;var En=n(75080),yn=n(91751),Dn=n(94457),bn=n(38609),Tn=n(59396),On=n(67358),Nn=n(55907),Cn=n(76829);const Un={TOOL_GROUP_CREATED:"event::cornerstone::syncgroupservice:toolgroupcreated"};class An{constructor(e){this.servicesManager=void 0,this.listeners={},this.EVENTS=void 0,this.synchronizerCreators={cameraposition:En.Z,voi:yn.Z,zoompan:Dn.Z,stackimage:bn.Z},this.servicesManager=e,this.listeners={},this.EVENTS=Un,Object.assign(this,wt.Z)}_createSynchronizer(e,t,n){const o=this.synchronizerCreators[e.toLowerCase()];if(o)return o(t,n);console.warn("Unknown synchronizer type",e,t)}setSynchronizer(e,t){this.synchronizerCreators[e.toLowerCase()]=t}_getOrCreateSynchronizer(e,t,n){let o=Tn.Z(t);return o||(o=this._createSynchronizer(e,t,n)),o}addViewportToSyncGroup(e,t,n){if(!n)return;(Array.isArray(n)?n:[n]).forEach((n=>{const o=(e=>"string"==typeof e?{type:e}:e)(n),{type:r,target:i=!0,source:a=!0,options:s={},id:l=r}=o,c=this._getOrCreateSynchronizer(r,l,s);c.setOptions(e,s);const d={viewportId:e,renderingEngineId:t};i&&a?c.add(d):a?c.addSource(d):i&&c.addTarget(d)}))}destroy(){On.Z()}removeViewportFromSyncGroup(e,t,n){const o=Nn.Z();(n?o.filter((e=>e.id===n)):o).forEach((n=>{if(!n)return;n.remove({viewportId:e,renderingEngineId:t});const o=n.getSourceViewports(),r=n.getTargetViewports();o.length||r.length||Cn.Z(n.id)}))}}An.REGISTRATION={name:"syncGroupService",altName:"SyncGroupService",create:e=>{let{servicesManager:t}=e;return new An(t)}};const Mn=An;var _n=n(71975),Vn=n.n(_n),Pn=n(81653),Rn=n(8009),Ln=n(57135),xn=n(77100),Fn=n(17945),Zn=n(87044),Gn=n(57756),kn=n(90021),$n=n(35316),jn=n(54080),Bn=n(56394),zn=n(87406),qn=n(60443),Wn=n(27977),Hn=n(33861),Kn=n(68652),Yn=n.n(Kn);function Jn(e,t){const n=1-t;return e<1/4?4*Math.pow(2*e,3)*n+t:e<.5?(1-Math.pow(-4*e+2,3)/2)*n+t:e<3/4?(1-Math.pow(4*e-2,3)/2)*n+t:-4*Math.pow(2*e-2,3)*n+t}const{COLOR_LUT:Qn}=xn,Xn=f.Z.Labelmap,eo=f.Z.Contour,to={SEGMENTATION_UPDATED:"event::segmentation_updated",SEGMENTATION_DATA_MODIFIED:"event::segmentation_data_modified",SEGMENTATION_ADDED:"event::segmentation_added",SEGMENTATION_REMOVED:"event::segmentation_removed",SEGMENTATION_CONFIGURATION_CHANGED:"event::segmentation_configuration_changed",SEGMENT_LOADING_COMPLETE:"event::segment_loading_complete",SEGMENTATION_LOADING_COMPLETE:"event::segmentation_loading_complete"},no={opacity:255,isVisible:!0,isLocked:!1};class oo extends wt.h{constructor(e){var t;let{servicesManager:n}=e;super(to),t=this,this.segmentations=void 0,this.servicesManager=void 0,this.highlightIntervalId=null,this.EVENTS=to,this.destroy=()=>{T.Z.removeEventListener(we.default.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),T.Z.removeEventListener(we.default.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified),Object.keys(this.segmentations).forEach((e=>{this._removeSegmentationFromCornerstone(e)})),this.segmentations={},this.listeners={}},this.setSegmentRGBA=(e,t,n,o)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,true),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,true),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this.createSegmentationForDisplaySet=async(e,t)=>{const{displaySetService:n}=this.servicesManager.services,o=n.getDisplaySetByUID(e),r=Xn,i=this._getVolumeIdForDisplaySet(o),a=t?.segmentationId??`${Pn.Z()}`;await E.createAndCacheDerivedVolume(i,{volumeId:a,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:!0}});const s={...this._getDefaultSegmentationScheme(),id:a,displaySetInstanceUID:e,label:t?.label,isActive:!0,type:r,representationData:{LABELMAP:{volumeId:a,referencedVolumeId:i}}};return this.addOrUpdateSegmentation(s),a},this.toggleSegmentationVisibility=e=>{this._toggleSegmentationVisibility(e,!1)},this.addSegmentationRepresentationToToolGroup=async function(e,n){let o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:f.Z.Labelmap;const i=t.getSegmentation(n);if(!i)throw new Error(`Segmentation with segmentationId ${n} not found.`);o&&(i.hydrated=!0);const{colorLUTIndex:a}=i,s=await Fn.Z(e,[{segmentationId:n,type:r}]);t._setActiveSegmentationForToolGroup(n,e,s[0]),Zn.setColorLUT(e,s[0],a);for(const o of i.segments){if(null==o)continue;const{segmentIndex:r,color:i,isLocked:a,isVisible:s,opacity:l}=o,c=!0;void 0!==i&&t._setSegmentColor(n,r,i,e,c),void 0!==l&&t._setSegmentOpacity(n,r,l,e,c),void 0!==s&&t._setSegmentVisibility(n,r,s,e,c),void 0!==a&&t._setSegmentLocked(n,r,a,c)}},this.setSegmentRGBAColorForSegmentation=(e,t,n,o)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,!0),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,!0),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this.getToolGroupIdsWithSegmentation=e=>Gn.getToolGroupIdsWithSegmentation(e),this.hydrateSegmentation=function(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o=t.getSegmentation(e);if(!o)throw new Error(`Segmentation with segmentationId ${e} not found.`);o.hydrated=!0,n||t._broadcastEvent(t.EVENTS.SEGMENTATION_UPDATED,{segmentation:o})},this.getConfiguration=e=>{e=e??this._getFirstToolGroupId();const t=this.getSegmentationRepresentationsForToolGroup(e),n=t?.[0]?.type||Xn,o=S.Hi(),{renderInactiveSegmentations:r}=o,i=o.representations[n],{renderOutline:a,outlineWidthActive:s,renderFill:l,fillAlpha:c,fillAlphaInactive:d,outlineOpacity:m,outlineOpacityInactive:u}=i;return{brushSize:1,brushThresholdGate:1,fillAlpha:c,fillAlphaInactive:d,outlineWidthActive:s,renderFill:l,renderInactiveSegmentations:r,renderOutline:a,outlineOpacity:m,outlineOpacityInactive:u}},this.setConfiguration=e=>{const{brushSize:n,brushThresholdGate:o,fillAlpha:r,fillAlphaInactive:i,outlineWidthActive:a,outlineOpacity:s,renderFill:l,renderInactiveSegmentations:c,renderOutline:d}=e,m=function(e,n){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==n){const r=o?o(n):n;t._setSegmentationConfig(e,r)}};if(m("renderOutline",d),m("outlineWidthActive",a),m("outlineOpacity",s,(e=>e/100)),m("fillAlpha",r,(e=>e/100)),m("renderFill",l),m("fillAlphaInactive",i,(e=>e/100)),m("outlineOpacityInactive",i,(e=>Math.max(.75,e/100))),void 0!==c){const e=S.Hi();e.renderInactiveSegmentations=c,S.Qb(e)}this._broadcastEvent(this.EVENTS.SEGMENTATION_CONFIGURATION_CHANGED,this.getConfiguration())},this.getLabelmapVolume=e=>h.ZP.getVolume(e),this.getSegmentationRepresentationsForToolGroup=e=>Gn.getSegmentationRepresentations(e),this._toggleSegmentationVisibility=function(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o=t.segmentations[e];if(!o)throw new Error(`Segmentation with segmentationId ${e} not found.`);o.isVisible=!o.isVisible,t._updateCornerstoneSegmentationVisibility(e),!1===n&&t._broadcastEvent(t.EVENTS.SEGMENTATION_UPDATED,{segmentation:o})},this._setSegmentColor=function(e,n,o,r){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const a=t.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const s=t._getSegmentInfo(a,n);if(void 0===s)throw new Error(`Segment ${n} not yet added to segmentation: ${e}`);r=r??t._getFirstToolGroupId();const l=t._getSegmentationRepresentation(e,r);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=Zn.getColorForSegmentIndex(r,c,n);Zn.setColorForSegmentIndex(r,c,n,[...o,d[3]]),s.color=o,!1===i&&t._broadcastEvent(t.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})},this._setSegmentOpacity=function(e,n,o,r){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const a=t.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const s=t._getSegmentInfo(a,n);if(void 0===s)throw new Error(`Segment ${n} not yet added to segmentation: ${e}`);r=r??t._getFirstToolGroupId();const l=t._getSegmentationRepresentation(e,r);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=Zn.getColorForSegmentIndex(r,c,n);Zn.setColorForSegmentIndex(r,c,n,[d[0],d[1],d[2],o]),s.opacity=o,!1===i&&t._broadcastEvent(t.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})},this._setSegmentationConfig=(e,t)=>{const n=this.getSegmentations()[0].type,{cornerstoneViewportService:o}=this.servicesManager.services,r=S.Hi();r.representations[n][e]=t,S.Qb(r);const i=o.getRenderingEngine(),a=o.getViewportIds();i.renderViewports(a)},this._onSegmentationDataModified=e=>{const{segmentationId:t}=e.detail,n=this.getSegmentation(t);void 0!==n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_DATA_MODIFIED,{segmentation:n})},this._onSegmentationModifiedFromSource=e=>{const{segmentationId:t}=e.detail,n=this.segmentations[t];if(void 0===n)return;const o=Gn.getSegmentation(t);if(!o)return;const{activeSegmentIndex:r,cachedStats:i,segmentsLocked:a,label:s,type:l}=o;if(![Xn,eo].includes(l))throw new Error(`Unsupported segmentation type: ${l}. Only ${Xn} and ${eo} are supported.`);const c=o.representationData[l],d={...n,activeSegmentIndex:r,cachedStats:i,displayText:[],id:t,label:s,segmentsLocked:a,type:l,representationData:{[l]:{...c}}};try{this.addOrUpdateSegmentation(d)}catch(e){console.warn(`Failed to add/update segmentation ${t}`,e)}},this._updateCornerstoneSegmentationVisibility=e=>{Gn.getToolGroupIdsWithSegmentation(e).forEach((t=>{const n=Gn.getSegmentationRepresentations(t);if(0===n.length)return;const o=n.find((t=>t.segmentationId===e)),{segmentsHidden:r}=o,i=!(0===r.size);kn.setSegmentationVisibility(t,o.segmentationRepresentationUID,i);const{segmentation:a}=this._getSegmentationInfo(e,t);a.segments.filter(Boolean).forEach((e=>{e.isVisible=i}))}))},this._getFirstToolGroupId=()=>{const{toolGroupService:e}=this.servicesManager.services;return e.getToolGroupIds()[0]},this.getNextColorLUTIndex=()=>{let e=0;for(;;){if(void 0===Gn.getColorLUT(e))return e;e++}},this.arrayOfObjects=e=>Object.entries(e).map((e=>({[e[0]]:e[1]}))),this.segmentations={},this.servicesManager=n,this._initSegmentationService()}addSegment(e,t,n,o){if(0===t)throw new Error('Segment index 0 is reserved for "no label"');n=n??this._getFirstToolGroupId();const{segmentationRepresentationUID:r,segmentation:i}=this._getSegmentationInfo(e,n);if(this._getSegmentInfo(i,t))throw new Error(`Segment ${t} already exists`);const a=Zn.getColorForSegmentIndex(n,r,t);i.segments[t]={label:o.label,segmentIndex:t,color:[a[0],a[1],a[2]],opacity:a[3],isVisible:!0,isLocked:!1},i.segmentCount++;const s=!0;if(void 0!==o){const{color:r,opacity:i,isLocked:a,visibility:l,active:c}=o;void 0!==r&&this._setSegmentColor(e,t,r,n,s),void 0!==i&&this._setSegmentOpacity(e,t,i,n,s),void 0!==l&&this._setSegmentVisibility(e,t,l,n,s),void 0!==c&&this._setActiveSegment(e,t,s),void 0!==a&&this._setSegmentLocked(e,t,a,s)}null===i.activeSegmentIndex&&this._setActiveSegment(e,t,s),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}removeSegment(e,t){const n=this.getSegmentation(e);if(void 0===n)throw new Error(`no segmentation for segmentationId: ${e}`);if(0===t)throw new Error('Segment index 0 is reserved for "no label"');if(!this._getSegmentInfo(n,t))return;n.segmentCount--,n.segments[t]=null;const o=this.getLabelmapVolume(e),{dimensions:r}=o,i=o.getScalarData(),a=r[0]*r[1],s=r[2];let l=0;const c=new Set;for(let e=0;e<s;e++)for(let n=0;n<a;n++)i[l]===t&&(i[l]=0,c.add(e)),l++;const d=Array.from(c);if($n.triggerSegmentationDataModified(e,d),n.activeSegmentIndex===t){const t=Object.keys(n.segments),o=t.length?Number(t[0]):1;this._setActiveSegment(e,o,!0)}this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})}setSegmentVisibility(e,t,n,o){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._setSegmentVisibility(e,t,n,o,r)}setSegmentLockedForSegmentation(e,t,n){this._setSegmentLocked(e,t,n,!1)}setSegmentLabel(e,t,n){this._setSegmentLabel(e,t,n)}setSegmentColor(e,t,n,o){this._setSegmentColor(e,t,n,o)}setSegmentOpacity(e,t,n,o){this._setSegmentOpacity(e,t,n,o)}setActiveSegmentationForToolGroup(e,t){t=t??this._getFirstToolGroupId();this._setActiveSegmentationForToolGroup(e,t,!1)}setActiveSegmentForSegmentation(e,t){this._setActiveSegment(e,t,!1)}getSegmentations(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this._getSegmentations();return t&&t.filter((t=>!e||t.hydrated))}_getSegmentations(){const e=this.arrayOfObjects(this.segmentations);return e&&e.map((e=>this.segmentations[Object.keys(e)[0]]))}getSegmentation(e){return this.segmentations[e]}addOrUpdateSegmentation(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{id:o}=e;let r=this.segmentations[o];if(r)return Object.assign(r,e),this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:n}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r}),o;const i=e.type,a=e.representationData[i];jn.Z([{segmentationId:o,representation:{type:i,data:{...a}}}]);const s=this.generateNewColorLUT(),l=this.getNextColorLUTIndex();return Zn.addColorLUT(s,l),this.segmentations[o]={...e,label:e.label||"",segments:e.segments||[null],activeSegmentIndex:e.activeSegmentIndex??null,segmentCount:e.segmentCount??0,isActive:!1,colorLUTIndex:l,isVisible:!0},r=this.segmentations[o],this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:!0}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_ADDED,{segmentation:r}),r.id}async createSegmentationForSEGDisplaySet(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=Xn;t=t??e.displaySetInstanceUID;const r={...this._getDefaultSegmentationScheme(),id:t,displaySetInstanceUID:e.displaySetInstanceUID,type:o,representationData:{[Xn]:{volumeId:t,referencedVolumeId:e.referencedVolumeId}}},i=this.getLabelmapVolume(t),a=this.getSegmentation(t);if(i&&a)return this.addOrUpdateSegmentation(Object.assign(r,a),n);const{segments:s,referencedVolumeId:l}=e;if(!s||!l)throw new Error("To create the segmentation from SEG displaySet, the displaySet should be loaded first, you can perform segDisplaySet.load() before calling this method.");const c=h.ZP.getVolume(l);if(!c)throw new Error(`No volume found for referencedVolumeId: ${l}`);const d=await E.createAndCacheDerivedVolume(l,{volumeId:t,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:!0}}),[m,u]=d.dimensions,p=d.getScalarData(),{imageIds:g}=c,I=g.reduce(((e,t,n)=>{const{sopInstanceUid:o}=y.get("generalImageModule",t);return e[o]=n,e}),{}),f=Object.keys(s).length;let S=!1;const v=(t,n)=>{const{pixelData:o}=t;let i=0,a=0,s=0,l=0;for(const[e,r]of t.functionalGroups.entries()){const{ReferencedSOPInstanceUID:t}=r.DerivationImageSequence.SourceImageSequence,c=I[t];if(-1===c)return;const d=m*u,g=new Uint8Array(o.buffer,e*d,d),h=(c+1)*d;for(let e=c*d,t=0;e<h;e++,t++)0!==g[t]&&(0!==p[e]&&(S=!0),p[e]=n,i+=e%u,a+=Math.floor(e/u)%m,s+=Math.floor(e/(u*m)),l++)}const c=Math.floor(i/l),g=Math.floor(a/l),h=Math.floor(s/l),v=d.imageData.indexToWorld([c,g,h]);r.cachedStats={...r.cachedStats,segmentCenter:{...r.cachedStats.segmentCenter,[n]:{center:{image:[c,g,h],world:v},modifiedTime:e.SeriesDate}}};const w=Object.keys(r.cachedStats.segmentCenter).length,E=Math.round(w/f*100);this._broadcastEvent(to.SEGMENT_LOADING_COMPLETE,{percentComplete:E,numSegments:f})},w=[];for(const e in s){const t=s[e],n=new Promise(((n,o)=>{setTimeout((()=>{v(t,e),n()}),0)}));w.push(n)}return await Promise.all(w),r.segmentCount=Object.keys(s).length,r.segments=[null],Object.keys(s).forEach((e=>{const t=s[e],n=Number(e);r.segments[n]={label:t.label||`Segment ${n}`,segmentIndex:Number(e),color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],isVisible:!0,isLocked:!1}})),e.isLoaded=!0,this._broadcastEvent(to.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,segDisplaySet:e,overlappingSegments:S}),this.addOrUpdateSegmentation(r,n)}async createSegmentationForRTDisplaySet(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=eo;t=t??e.displaySetInstanceUID;const{structureSet:r}=e;if(!r)throw new Error("To create the contours from RT displaySet, the displaySet should be loaded first, you can perform rtDisplaySet.load() before calling this method.");const i=this._getDefaultSegmentationScheme(),a=e.displaySetInstanceUID,s=function(e,t){return e.ROIContours.map((e=>{let{contourPoints:n,ROINumber:o,ROIName:r,colorArray:i}=e;const a=r||o;return{data:n.map((e=>{let{points:t,...n}=e;return{...n,points:t.map((e=>{let{x:t,y:n,z:o}=e;return[t,n,o]}))}})),id:a,segmentIndex:o,color:i,geometryId:`${t}:${a}:segmentIndex-${o}`}}))}(r,a);s.sort(((e,t)=>e.segmentIndex-t.segmentIndex));const l=s.map((e=>{let{geometryId:t}=e;return t})),c={...i,id:t,displaySetInstanceUID:a,type:o,representationData:{[eo]:{geometryIds:l}}},d=this.getSegmentation(t);if(d)return this.addOrUpdateSegmentation(Object.assign(c,d),n);if(!r.ROIContours?.length)throw new Error("The structureSet does not contain any ROIContours. Please ensure the structureSet is loaded first.");const m={},u=async t=>{const{data:n,id:o,color:i,segmentIndex:a,geometryId:l}=t,d=(await Rn.createAndCacheGeometry(l,{geometryData:{data:n,id:o,color:i,frameOfReferenceUID:r.frameOfReferenceUID,segmentIndex:a},type:Ln.Z.CONTOUR})).data.getCentroid();m[a]={center:{world:d},modifiedTime:e.SeriesDate},c.segments[a]={label:o,segmentIndex:a,color:i,...no};const u=Object.keys(m).length,p=Math.round(u/s.length*100);this._broadcastEvent(to.SEGMENT_LOADING_COMPLETE,{percentComplete:p,numSegments:s.length})},p=[];for(let e=0;e<s.length;e++){const t=new Promise(((t,n)=>{setTimeout((()=>{u(s[e]).then((()=>{t()}))}),0)}));p.push(t)}return await Promise.all(p),c.segmentCount=s.length,e.isLoaded=!0,c.cachedStats={...c.cachedStats,segmentCenter:{...c.cachedStats.segmentCenter,...m}},this._broadcastEvent(to.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,rtDisplaySet:e}),this.addOrUpdateSegmentation(c,n)}jumpToSegmentCenter(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.9,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:750,a=arguments.length>6&&void 0!==arguments[6]&&arguments[6],s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"ease-in-out";const{toolGroupService:l}=this.servicesManager.services,c=this._getSegmentCenter(e,t),{world:d}=c;n=n||this._getToolGroupIdsWithSegmentation(e);const m=[];Array.isArray(n)?n.forEach((e=>{m.push(l.getToolGroup(e))})):m.push(l.getToolGroup(n)),m.forEach((n=>{const l=n.getViewportsInfo();for(const{viewportId:e,renderingEngineId:t}of l){const{viewport:n}=(0,I.O)(e,t);Bn.Z(n,d)}r&&this.highlightSegment(e,t,n.id,o,i,a,s)}))}highlightSegment(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.9,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:750,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];this.highlightIntervalId&&clearInterval(this.highlightIntervalId);const a=this.getSegmentation(e);n=n??this._getFirstToolGroupId();const s=this._getSegmentationRepresentation(e,n),{type:l}=s,{segments:c}=a;(l===Xn?this._highlightLabelmap.bind(this):this._highlightContour.bind(this))(t,l===Xn?o:1-o,i,c,n,r,s)}_highlightLabelmap(e,t,n,o,r,i,a){const s={[e]:{LABELMAP:{fillAlpha:t}}};if(n)for(let t=0;t<o.length;t++)t!==e&&(s[t]={LABELMAP:{fillAlpha:0}});const{fillAlpha:l}=this.getConfiguration(r);let c=null;const d=t=>{null===c&&(c=t);const n=t-c,o=Math.min(n/i,1);S.Pv(r,a.segmentationRepresentationUID,{[e]:{LABELMAP:{fillAlpha:Jn(o,l)}}}),o<1?requestAnimationFrame(d):S.Pv(r,a.segmentationRepresentationUID,{})};requestAnimationFrame(d)}_highlightContour(e,t,n,o,r,i,a){const s=performance.now(),l=t=>{const n=(t-s)/i;if(n>=1)return void S.Pv(r,a.segmentationRepresentationUID,{});const o=1-Jn(n,c=.1)+c;var c;S.Pv(r,a.segmentationRepresentationUID,{[e]:{CONTOUR:{fillAlpha:o}}}),requestAnimationFrame(l)};requestAnimationFrame(l)}removeSegmentationRepresentationFromToolGroup(e,t){const n=t||[];if(!n.length){const t=Gn.getSegmentationRepresentations(e);if(!t||!t.length)return;n.push(...t.map((e=>e.segmentationRepresentationUID)))}zn.Z(e,n)}remove(e){const t=this.segmentations[e],n=t.isActive;if(!e||!t)return void console.warn("No segmentationId provided, or unable to find segmentation by id.");const{colorLUTIndex:o}=t;if(this._removeSegmentationFromCornerstone(e),Gn.removeColorLUT(o),delete this.segmentations[e],n){const e=this._getSegmentations();if(e.length){const{id:t}=e[0];this._setActiveSegmentationForToolGroup(t,this._getFirstToolGroupId(),!1)}}this._broadcastEvent(this.EVENTS.SEGMENTATION_REMOVED,{segmentationId:e})}setSegmentLabelForSegmentation(e,t,n){this._setSegmentLabelForSegmentation(e,t,n)}_setSegmentLabelForSegmentation(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const i=r.segments[t];if(void 0===i)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);i.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})}shouldRenderSegmentation(e,t){if(!e||!e.length)return!1;const{displaySetService:n}=this.servicesManager.services;let o=!1;const r=n.getDisplaySetByUID(t),i=this._getFrameOfReferenceUIDForSeg(r);for(const t of e){const e=n.getDisplaySetByUID(t);if(e.isReconstructable&&e?.images?.[0]?.FrameOfReferenceUID===i){o=!0;break}}return o}_getDefaultSegmentationScheme(){return{activeSegmentIndex:1,cachedStats:{},label:"",segmentsLocked:[],displayText:[],hydrated:!1,segmentCount:0,segments:[],isVisible:!0,isActive:!1,colorLUTIndex:0}}_setActiveSegmentationForToolGroup(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=this._getSegmentations(),r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);o.forEach((t=>{t.isActive=t.id===e}));const i=this._getSegmentationRepresentation(e,t);qn.setActiveSegmentationRepresentation(t,i.segmentationRepresentationUID),!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})}_setActiveSegment(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=this.getSegmentation(e);if(void 0===o)throw new Error(`no segmentation for segmentationId: ${e}`);Wn.setActiveSegmentIndex(e,t),o.activeSegmentIndex=t,!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:o})}_getSegmentInfo(e,t){const n=e.segments;if(n)return n&&n.length>0?n[t]:void 0}_getVolumeIdForDisplaySet(e){return`${e.volumeLoaderSchema??"cornerstoneStreamingImageVolume"}:${e.displaySetInstanceUID}`}_getSegmentCenter(e,t){const n=this.getSegmentation(e);if(!n)return;const{cachedStats:o}=n;if(!o)return;const{segmentCenter:r}=o;if(!r)return;const{center:i}=r[t];return i}_setSegmentLocked(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const i=this._getSegmentInfo(r,t);if(void 0===i)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);i.isLocked=n,Hn.setSegmentIndexLocked(e,t,n),!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})}_setSegmentVisibility(e,t,n,o){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];o=o??this._getFirstToolGroupId();const{segmentationRepresentationUID:i,segmentation:a}=this._getSegmentationInfo(e,o);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const s=this._getSegmentInfo(a,t);if(void 0===s)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);s.isVisible=n,kn.setSegmentVisibility(o,i,t,n),a.isVisible=a.segments.filter(Boolean).every((e=>e.isVisible)),!1===r&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}_setSegmentLabel(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const i=this._getSegmentInfo(r,t);if(void 0===i)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);i.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})}_getSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentationsForToolGroup(t);if(0===n.length)return;return n.find((t=>t.segmentationId===e))}_initSegmentationService(){T.Z.addEventListener(we.default.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),T.Z.addEventListener(we.default.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified)}_getSegmentationInfo(e,t){const n=this.getSegmentation(e);if(void 0===n)throw new Error(`no segmentation for segmentationId: ${e}`);const o=this._getSegmentationRepresentation(e,t);if(!o)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:r}=o;return{segmentationRepresentationUID:r,segmentation:n}}_removeSegmentationFromCornerstone(e){const t=Gn;if(!t.getSegmentation(e))return;t.getToolGroupIdsWithSegmentation(e).forEach((n=>{const o=t.getSegmentationRepresentations(n),r=[];o.forEach((t=>{t.segmentationId===e&&r.push(t.segmentationRepresentationUID)})),zn.Z(n,r,!0)})),t.removeSegmentation(e),h.ZP.getVolumeLoadObject(e)&&h.ZP.removeVolumeLoadObject(e)}_updateCornerstoneSegmentations(e){let{segmentationId:t,notYetUpdatedAtSource:n}=e;if(!1===n)return;const o=Gn.getSegmentation(t),r=this.segmentations[t],{label:i,cachedStats:a}=r;o.label!==i&&(o.label=i),Yn()(o.cachedStats,a)||(o.cachedStats=a)}_getToolGroupIdsWithSegmentation(e){return Gn.getToolGroupIdsWithSegmentation(e)}_getFrameOfReferenceUIDForSeg(e){const t=e.instance?.FrameOfReferenceUID;if(t)return t;const n=e.instance?.ReferencedFrameOfReferenceSequence;return n?n.FrameOfReferenceUID:void 0}generateNewColorLUT(){return Vn()(Qn)}}oo.REGISTRATION={name:"segmentationService",altName:"SegmentationService",create:e=>{let{servicesManager:t}=e;return new oo({servicesManager:t})}};const ro=oo;var io=n(25197);function ao(e){const t=e.toLowerCase();if("stack"===t)return io.Z.STACK;if("volume"===t||"orthographic"===t)return io.Z.ORTHOGRAPHIC;if("volume3d"===t)return io.Z.VOLUME_3D;throw new Error(`Invalid viewport type: ${e}. Valid types are: stack, volume`)}const so="cornerstoneStreamingImageVolume";class lo{constructor(e){this.stackImageIds=new Map,this.volumeImageIds=new Map,this.servicesManager=void 0,this.servicesManager=e}getCacheSize(){return h.ZP.getCacheSize()}getCacheFreeSpace(){return h.ZP.getBytesAvailable()}async createViewportData(e,t,n,o){let r=t.viewportType;this._shouldRenderSegmentation(e)&&(r="volume",t.viewportType=r);const i=ao(r);let a;return i===io.Z.STACK&&(a=await this._getStackViewportData(n,e,o,i)),i!==io.Z.ORTHOGRAPHIC&&i!==io.Z.VOLUME_3D||(a=await this._getVolumeViewportData(n,e,i)),a.viewportType=i,a}async invalidateViewportData(e,t,n,o){if(e.viewportType===io.Z.STACK)return this._getCornerstoneStackImageIds(o.getDisplaySetByUID(t),n);const r=`${so}:${t}`;h.ZP.getVolume(r)&&(h.ZP.removeVolumeLoadObject(r),this.volumeImageIds.delete(r));const i=e.data.map((e=>{let{displaySetInstanceUID:t}=e;return o.getDisplaySetByUID(t)}));return await this._getVolumeViewportData(n,i,e.viewportType)}_getStackViewportData(e,t,n,o){const r=t[0];let i=this.stackImageIds.get(r.displaySetInstanceUID);i||(i=this._getCornerstoneStackImageIds(r,e),this.stackImageIds.set(r.displaySetInstanceUID,i));const{displaySetInstanceUID:a,StudyInstanceUID:s,isCompositeStack:l}=r,c={viewportType:o,data:{StudyInstanceUID:s,displaySetInstanceUID:a,isCompositeStack:l,imageIds:i}};return"number"==typeof n&&(c.data.initialImageIndex=n),c}async _getVolumeViewportData(e,t,n){const o=[];for(const n of t){if(n.load&&n.load instanceof Function){const{userAuthenticationService:e}=this.servicesManager.services,t=e.getAuthorizationHeader();await n.load({headers:t}),o.push({studyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID});continue}const t=`${n.volumeLoaderSchema??so}:${n.displaySetInstanceUID}`;let r=this.volumeImageIds.get(n.displaySetInstanceUID),i=h.ZP.getVolume(t);r&&i||(r=this._getCornerstoneVolumeImageIds(n,e),i=await E.createAndCacheVolume(t,{imageIds:r}),this.volumeImageIds.set(n.displaySetInstanceUID,r)),o.push({StudyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID,volume:i,volumeId:t,imageIds:r})}return{viewportType:n,data:o}}_shouldRenderSegmentation(e){const{segmentationService:t}=this.servicesManager.services,n=e.map((e=>{let{displaySetInstanceUID:t}=e;return t})),o=t.getSegmentations();for(const e of o){const o=e.displaySetInstanceUID;if(t.shouldRenderSegmentation(n,o))return!0}}_getCornerstoneStackImageIds(e,t){return t.getImageIdsForDisplaySet(e)}_getCornerstoneVolumeImageIds(e,t){return this._getCornerstoneStackImageIds(e,t)}}lo.REGISTRATION={name:"cornerstoneCacheService",altName:"CornerstoneCacheService",create:e=>{let{servicesManager:t}=e;return new lo(t)}};const co=lo;var mo=n(69903),uo=n(73921),po=n(75931),go=n(14488);const ho="OHIFCornerstoneRenderingEngine";var Io=n(51854);var fo=n(44965);const So="stack",vo="default",wo=(e,t,n)=>e.displaySetInstanceUID===t||!!(n&&e.isCompositeStack&&e.imageIds)&&!!e.imageIds.find((e=>e===n));const Eo=class{constructor(e,t){this.viewportId="",this.viewportIndex=void 0,this.element=void 0,this.viewportOptions=void 0,this.displaySetOptions=void 0,this.viewportData=void 0,this.renderingEngineId=void 0,this.destroy=()=>{this.element=null,this.viewportData=null,this.viewportOptions=null,this.displaySetOptions=null},this.viewportIndex=e,this.viewportId=t,this.setPublicViewportOptions({}),this.setPublicDisplaySetOptions([{}])}contains(e,t){return!!this.viewportData?.data&&(this.viewportData.data.length?!!this.viewportData.data.find((n=>wo(n,e,t))):wo(this.viewportData.data,e,t))}setRenderingEngineId(e){this.renderingEngineId=e}getRenderingEngineId(){return this.renderingEngineId}setViewportId(e){this.viewportId=e}setViewportIndex(e){this.viewportIndex=e}setElement(e){this.element=e}setViewportData(e){this.viewportData=e}getViewportData(){return this.viewportData}getViewportIndex(){return this.viewportIndex}getElement(){return this.element}getViewportId(){return this.viewportId}setPublicDisplaySetOptions(e){const t=this.mapDisplaySetOptions(e);this.setDisplaySetOptions(t)}hasDisplaySet(e){let t=this.getViewportData();return t.viewportType===io.Z.ORTHOGRAPHIC?t.data.some((t=>{let{displaySetInstanceUID:n}=t;return n===e})):t.data.displaySetInstanceUID===e}setPublicViewportOptions(e){let t=e.viewportType;const{toolGroupId:n=vo,presentationIds:o}=e;let r;t=ao(t?e.viewportType:So),e.viewportType?.toLowerCase()!==So&&(r=function(e){if(e)switch(e.toLowerCase()){case"axial":return fo.Z.AXIAL;case"sagittal":return fo.Z.SAGITTAL;case"coronal":return fo.Z.CORONAL;default:return fo.Z.ACQUISITION}return fo.Z.ACQUISITION}(e.orientation)),n||(n=vo),this.setViewportOptions({...e,viewportId:this.viewportId,viewportType:t,orientation:r,toolGroupId:n,presentationIds:o})}setViewportOptions(e){this.viewportOptions=e}getViewportOptions(){return this.viewportOptions}setDisplaySetOptions(e){this.displaySetOptions=e}getSyncGroups(){return this.viewportOptions.syncGroups||=[],this.viewportOptions.syncGroups}getDisplaySetOptions(){return this.displaySetOptions}getViewportType(){return this.viewportOptions.viewportType||io.Z.STACK}getToolGroupId(){return this.viewportOptions.toolGroupId}getBackground(){return this.viewportOptions.background||[0,0,0]}getOrientation(){return this.viewportOptions.orientation}getInitialImageOptions(){return this.viewportOptions.initialImageOptions}mapDisplaySetOptions(){const e=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[{}]).forEach((t=>{let n=t?.options||t;n||(n={blendMode:void 0,slabThickness:void 0,colormap:void 0,voi:{},voiInverted:!1});const o=function(e){if(!e)return Io.Z.COMPOSITE;if("mip"===e.toLowerCase())return Io.Z.MAXIMUM_INTENSITY_BLEND;throw new Error}(n.blendMode);e.push({voi:n.voi,voiInverted:n.voiInverted,colormap:n.colormap,slabThickness:n.slabThickness,blendMode:o,displayPreset:n.displayPreset})})),e}};var yo=function(e){return e.First="first",e.Last="last",e.Middle="middle",e}(yo||{});const Do=yo,bo={VIEWPORT_DATA_CHANGED:"event::cornerstoneViewportService:viewportDataChanged"};class To extends wt.h{constructor(e){super(bo),this.renderingEngine=void 0,this.viewportsInfo=new Map,this.viewportsById=new Map,this.viewportGridResizeObserver=void 0,this.viewportsDisplaySets=new Map,this.enableResizeDetector=void 0,this.resizeRefreshRateMs=void 0,this.resizeRefreshMode=void 0,this.servicesManager=null,this.renderingEngine=null,this.viewportGridResizeObserver=null,this.servicesManager=e}enableViewport(e,t,n){t.viewportId||(console.warn("Should provide viewport id externally",t),t.viewportId=this.getViewportId(e)||`viewport-${e}`);const{viewportId:o}=t,r=new Eo(e,o);if(!r.viewportId)throw new Error("Should have viewport ID afterwards");r.setElement(n),this.viewportsInfo.set(e,r),this.viewportsById.set(o,r)}getViewportIds(){const e=[];return this.viewportsInfo.forEach((t=>{e.push(t.getViewportId())})),e}getViewportId(e){return this.viewportsInfo[e]?.viewportId}getRenderingEngine(){const e=(0,Xt.Pr)(ho);return e?(this.renderingEngine=e,this.renderingEngine):(e&&!e.hasBeenDestroyed||(this.renderingEngine=new mo.ZP(ho)),this.renderingEngine)}resize(){this.renderingEngine.resize(!0,!0),this.renderingEngine.render()}destroy(){this._removeResizeObserver(),this.viewportGridResizeObserver=null;try{this.renderingEngine?.destroy?.()}catch(e){console.warn("Rendering engine not destroyed",e)}this.viewportsDisplaySets.clear(),this.renderingEngine=null,h.ZP.purgeCache()}disableElement(e){const t=this.viewportsInfo.get(e);if(!t)return;const n=t.getViewportId();this.renderingEngine&&this.renderingEngine.disableElement(n),this.viewportsInfo.get(e).destroy(),this.viewportsInfo.delete(e),this.viewportsById.delete(n)}setPresentations(e,t){const n=t?.lutPresentation?.properties;n&&e.setProperties(n);const o=t?.positionPresentation?.camera;o&&e.setCamera(o)}getPresentation(e){const t=this.viewportsInfo.get(e);if(!t)return;const{viewportType:n,presentationIds:o}=t.getViewportOptions(),r=this.getCornerstoneViewportByIndex(e);if(!r)return;const i=r.getProperties();i.isComputedVOI&&(delete i.voiRange,delete i.VOILUTFunction);return{presentationIds:o,viewportType:n&&"stack"!==n?"volume":"stack",properties:i,initialImageIndex:r.getCurrentImageIdIndex(),camera:r.getCamera()}}setViewportData(e,t,n,o,r){const i=this.getRenderingEngine(),a=n.viewportId||this.getViewportId(e);if(!a)throw new Error("Must define viewportId externally");const s=this.viewportsById.get(a);if(!s)throw new Error("Viewport info not defined");s.viewportIndex!==e&&(this.viewportsInfo.delete(s.viewportIndex),this.viewportsInfo.set(e,s),s.viewportIndex=e),s.setRenderingEngineId(i.id);const{viewportOptions:l,displaySetOptions:c}=this._getViewportAndDisplaySetOptions(n,o,s);s.setViewportOptions(l),s.setDisplaySetOptions(c),s.setViewportData(t);const d={viewportId:a,element:s.getElement(),type:s.getViewportType(),defaultOptions:{background:s.getBackground(),orientation:s.getOrientation()}};i.enableElement(d);const m=i.getViewport(a);this._setDisplaySets(m,t,s,r),this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED,{viewportData:t,viewportIndex:e,viewportId:a})}getCornerstoneViewport(e){if(!this.getViewportInfo(e)||!this.renderingEngine||this.renderingEngine.hasBeenDestroyed)return null;return this.renderingEngine.getViewport(e)}getCornerstoneViewportByIndex(e){const t=this.getViewportInfoByIndex(e);if(!t||!this.renderingEngine||this.renderingEngine.hasBeenDestroyed)return null;return this.renderingEngine.getViewport(t.getViewportId())}getViewportInfoByIndex(e){return this.viewportsInfo.get(e)}getViewportInfo(e){for(const[t,n]of this.viewportsInfo.entries())if(n.getViewportId()===e)return n;return null}_setStackViewport(e,t,n,o){const r=n.getDisplaySetOptions(),{imageIds:i,initialImageIndex:a,displaySetInstanceUID:s}=t.data;this.viewportsDisplaySets.set(e.id,[s]);let l=o?.positionPresentation?.initialImageIndex??a;null==l&&(l=this._getInitialImageIndexForViewport(n,i)||0);const c={...o.lutPresentation?.properties};if(!o.lutPresentation?.properties){const{voi:e,voiInverted:t}=r[0];if(e&&(e.windowWidth||e.windowCenter)){const{lower:t,upper:n}=Zt.toLowHighRange(e.windowWidth,e.windowCenter);c.voiRange={lower:t,upper:n}}void 0!==t&&(c.invert=t)}e.setStack(i,l).then((()=>{e.setProperties(c);const t=o.positionPresentation?.camera;t&&e.setCamera(t)}))}_getInitialImageIndexForViewport(e,t){const n=e.getInitialImageOptions();if(!n)return;const{index:o,preset:r}=n,i=e.getViewportType();let a;if(i===io.Z.STACK)a=t.length;else{if(i!==io.Z.ORTHOGRAPHIC)return;{const t=this.getCornerstoneViewport(e.getViewportId()),n=$t.Z(t);if(!n)return;({numberOfSlices:a}=n)}}return this._getInitialImageIndex(a,o,r)}_getInitialImageIndex(e,t,n){const o=e-1;return void 0!==t?po.ZP(t,0,o):n===Do.First?0:n===Do.Last?o:n===Do.Middle?o%2==0?o/2:(o+1)/2:0}async _setVolumeViewport(e,t,n,o){const r=[],i=n.getDisplaySetOptions(),{hangingProtocolService:a}=this.servicesManager.services,s=[],l=[];for(const[e,n]of t.data.entries()){const{volume:t,imageIds:o,displaySetInstanceUID:a}=n;if(l.push(a),!t){console.log("Volume display set not found");continue}s.push(t);const c=i[e],{volumeId:d}=t;r.push({imageIds:o,volumeId:d,blendMode:c.blendMode,slabThickness:this._getSlabThickness(c,d)})}return this.viewportsDisplaySets.set(e.id,l),a.hasCustomImageLoadStrategy()&&!a.customImageLoadPerformed?a.runImageLoadStrategy({viewportId:e.id,volumeInputArray:r}):(s.forEach((e=>{e.loadStatus.loaded||e.loadStatus.loading||e.load()})),this.setVolumesForViewport(e,r,o))}async setVolumesForViewport(e,t,n){const{displaySetService:o,toolGroupService:r}=this.servicesManager.services,i=this.getViewportInfo(e.id),a=i.getDisplaySetOptions(),s=t.map(((e,t)=>{const{volumeId:n}=e,o=a[t],{voi:r,voiInverted:i,colormap:s,displayPreset:l}=o,c={};if(r&&(r.windowWidth||r.windowCenter)){const{lower:e,upper:t}=Zt.toLowHighRange(r.windowWidth,r.windowCenter);c.voiRange={lower:e,upper:t}}return void 0!==i&&(c.invert=i),void 0!==s&&(c.colormap=s),void 0!==l&&(c.preset=l),{properties:c,volumeId:n}}));await e.setVolumes(t),s.forEach((t=>{let{properties:n,volumeId:o}=t;e.setProperties(n,o)})),this.setPresentations(e,n);const l=this.viewportsDisplaySets.get(e.id),c=l.map(o.getDisplaySetByUID).find((e=>e?.isOverlayDisplaySet));c?this.addOverlayRepresentationForDisplaySet(c,e):this._addSegmentationRepresentationToToolGroupIfNecessary(l,e);const d=r.getToolGroupForViewport(e.id);go.ih(d.id);const m=this._getInitialImageIndexForViewport(i);void 0!==m&&Bt.Z(e.element,{imageIndex:m}),e.render()}_addSegmentationRepresentationToToolGroupIfNecessary(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,r=o.getToolGroupForViewport(t.id),i=n.getSegmentations();for(const t of i){if((n.getSegmentationRepresentationsForToolGroup(r.id)||[]).find((e=>e.segmentationId===t.id)))continue;const{id:o,type:i}=t,a=this._getFrameOfReferenceUID(o);let s=!1;for(const t of e){if(a===this._getFrameOfReferenceUID(t)){s=!0;break}}if(!s)return;n.addSegmentationRepresentationToToolGroup(r.id,t.id,!1,t.type)}}addOverlayRepresentationForDisplaySet(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,{referencedVolumeId:r}=e,i=e.displaySetInstanceUID,a=o.getToolGroupForViewport(t.id),s=r&&void 0!==h.ZP.getVolume(r)?f.Z.Labelmap:f.Z.Contour;n.addSegmentationRepresentationToToolGroup(a.id,i,!1,s)}updateViewport(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=this.getViewportInfoByIndex(e),r=o.getViewportId(),i=this.getCornerstoneViewport(r),a=i.getCamera();i instanceof kt.Z?this._setVolumeViewport(i,t,o).then((()=>{n&&(i.setCamera(a),i.render())})):i instanceof Gt.Z&&this._setStackViewport(i,t,o)}_setDisplaySets(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(e instanceof Gt.Z)this._setStackViewport(e,t,n,o);else{if(!(e instanceof kt.Z||e instanceof uo.Z))throw new Error("Unknown viewport type");this._setVolumeViewport(e,t,n,o)}}_removeResizeObserver(){this.viewportGridResizeObserver&&this.viewportGridResizeObserver.disconnect()}_getSlabThickness(e,t){const{blendMode:n}=e;if(void 0!==n&&void 0!==e.slabThickness){if("number"==typeof e.slabThickness)return e.slabThickness;if("fullvolume"===e.slabThickness.toLowerCase()){const e=h.ZP.getVolume(t),{dimensions:n}=e;return Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])}}}_getViewportAndDisplaySetOptions(e,t,n){const o=n.getViewportIndex(),r=new Eo(o,n.getViewportId());r.setPublicViewportOptions(e),r.setPublicDisplaySetOptions(t);return{viewportOptions:r.getViewportOptions(),displaySetOptions:r.getDisplaySetOptions()}}_getFrameOfReferenceUID(e){const{displaySetService:t}=this.servicesManager.services,n=t.getDisplaySetByUID(e);if(!n)return;if(n.frameOfReferenceUID)return n.frameOfReferenceUID;if("SEG"===n.Modality){const{instance:e}=n;return e.FrameOfReferenceUID}if("RTSTRUCT"===n.Modality){const{instance:e}=n;return e.ReferencedFrameOfReferenceSequence.FrameOfReferenceUID}const{images:o}=n;return o&&o.length?o[0].FrameOfReferenceUID:void 0}getViewportIndexToJump(e,t,n){const o=this.viewportsInfo.get(e),{referencedImageId:r}=n;return o?.contains(t,r)?e:[...this.viewportsById.values()].find((e=>e.contains(t,r)))?.viewportIndex??-1}}To.REGISTRATION={name:"cornerstoneViewportService",altName:"CornerstoneViewportService",create:e=>{let{servicesManager:t}=e;return new To(t)}};const Oo=To;var No=n(31363),Co=n(75935),Uo=n(76643);const Ao=e=>{if(e)return"function"==typeof e.getImageId?e.getImageId():e.url},Mo=e=>(Array.isArray(e)?e:[e]).some((e=>!e)),_o=e=>e&&e.images&&e.images[0],Vo=e=>Ao(e),Po=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Uo.default.getAuthorizationHeader();return fetch(e,t).then((e=>e.arrayBuffer()))},Ro=e=>No.loadAndCacheImage(e).then((e=>e&&e.data&&e.data.byteArray.buffer)),Lo=function(e,t,n,o){const r={url:e,headers:arguments.length>4&&void 0!==arguments[4]?arguments[4]:Uo.default.getAuthorizationHeader(),errorInterceptor:arguments.length>5&&void 0!==arguments[5]?arguments[5]:P.Z.getHTTPErrorHandler()};return new Co.api.DICOMwebClient(r).retrieveInstance({studyInstanceUID:t,seriesInstanceUID:n,sopInstanceUID:o})};const xo=new class{getLocalData(e,t){const n=_o(e),o=(e=>e&&e.instance)(e);if(!n&&!o||!o.imageId.startsWith("dicomfile"))return;let r=Vo(n||o);return Mo(r)&&(r=((e,t)=>{const n=e.find((e=>e.displaySets.some((e=>e.displaySetInstanceUID===t)))),{series:o=[]}=n,{instances:r=[]}=o[0]||{},i=r[0];return Ao(i)})(t,e.displaySetInstanceUID)),Mo(r)?void 0:M().wadouri.loadFileRequest(r)}getDataByImageType(e){const t=_o(e);if(t){const e=Vo(t);let n=Po;const o=(e=>{const t=/^\w+\:/,n=t.exec(e);return 0===t.lastIndex&&n&&n[0]&&n[0].replace(":","")||""})(e);switch(o){case"dicomfile":n=Ro.bind(this,e);break;case"wadors":const r=t.getData().wadoRoot,i=t.getStudyInstanceUID(),a=t.getSeriesInstanceUID(),s=t.getSOPInstanceUID();if(Mo([r,i,a,s]))return;n=Lo.bind(this,r,i,a,s);break;case"wadouri":if(e=e.substring(e.indexOf(":")+1),Mo(e))return;n=Po.bind(this,e);break;default:throw new Error(`Unsupported image type: ${o} for imageId: ${e}`)}return n()}}getDataByDatasetType(e){const{StudyInstanceUID:t,SeriesInstanceUID:n,SOPInstanceUID:o,authorizationHeaders:r,wadoRoot:i,wadoUri:a}=e;return Mo(i)?Mo(a)?void 0:Po(a,{headers:r}):Lo(i,t,n,o,r)}*getLoaderIterator(e,t,n){yield this.getLocalData(e,t),yield this.getDataByImageType(e),yield this.getDataByDatasetType(e)}findDicomDataPromise(e,t,n){e.authorizationHeaders=n;const o=this.getLoaderIterator(e,t);for(const e of o)if(e)return e;throw new Error("Invalid dicom data loader")}},Fo=JSON.parse('{"u2":"@ohif/extension-cornerstone"}').u2;function Zo(e){if(e.longAxis&&e.shortAxis){const t={};return t.start=e.longAxis[0],t.end=e.longAxis[1],t.perpendicularStart=e.longAxis[0],t.perpendicularEnd=e.longAxis[1],t}return e.map(((e,t)=>t%10==0?{start:e}:{end:e})).reduce(((e,t)=>Object.assign(e,{...t})),{})}function Go(){return Go=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Go.apply(this,arguments)}const ko=i.lazy((()=>Promise.all([n.e(664),n.e(639)]).then(n.bind(n,58639)))),$o=e=>i.createElement(i.Suspense,{fallback:i.createElement("div",null,"Loading...")},i.createElement(ko,e)),jo={id:Fo,onModeExit:()=>{Object.values(l.Z).forEach((e=>{c.Z.clearRequestStack(e),d.Z.clearRequestStack(e)})),function(){const e=A.webWorkerManager.webWorkers;for(let t=0;t<e.length;t++)e[t].worker.terminate();e.length=0}(),(0,ue.mc)()},preRegistration:function(e){const{servicesManager:t}=e;return t.registerService(Oo.REGISTRATION),t.registerService(wn.REGISTRATION),t.registerService(Mn.REGISTRATION),t.registerService(ro.REGISTRATION),t.registerService(co.REGISTRATION),ut.call(this,e)},getHangingProtocolModule:un,getViewportModule(e){let{servicesManager:t,commandsManager:n}=e;return[{name:"cornerstone",component:e=>{const{toolbarService:o}=t.services;return i.createElement($o,Go({},e,{toolbarService:o,servicesManager:t,commandsManager:n}))}}]},getCommandsModule:cn,getCustomizationModule:Ft,getUtilityModule(e){let{servicesManager:t}=e;return[{name:"common",exports:{getCornerstoneLibraries:()=>({cornerstone:a,cornerstoneTools:s}),getEnabledElement:ue.K8,dicomLoaderService:xo}},{name:"core",exports:{Enums:m}},{name:"tools",exports:{toolNames:Se,Enums:u}}]}}},21922:(e,t,n)=>{"use strict";n.d(t,{K8:()=>i,Yc:()=>r,mc:()=>a});const o={DEFAULT_CONTEXT:"CORNERSTONE",enabledElements:{}},r=(e,t,n)=>{const r=n||o.DEFAULT_CONTEXT;o.enabledElements[e]={element:t,context:r}},i=e=>o.enabledElements[e],a=()=>{o.enabledElements={}}},63130:(e,t,n)=>{"use strict";n.d(t,{Z:()=>r});var o=n(71478);function r(e){if(e)return function(e){const t=o.get("instance",e);return{SOPInstanceUID:t.SOPInstanceUID,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,frameNumber:t.frameNumber||1}}(e)}},78753:()=>{}}]);
//# sourceMappingURL=754.bundle.9d6447472b0e4b73d21b.js.map