"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[116],{68390:(t,e,n)=>{n.d(e,{Z:()=>i});var a=n(55742);function i(t,e,n,i,o,s={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:d,width:r,lineWidth:l,lineDash:h}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},s);(0,a.Z)(t,e,n,i,o,{color:d,width:r,lineWidth:l,lineDash:h});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),u={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},g={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};(0,a.Z)(t,e,"2",u.start,u.end,{color:d,width:r,lineWidth:l}),(0,a.Z)(t,e,"3",g.start,g.end,{color:d,width:r,lineWidth:l})}},28823:(t,e,n)=>{n.d(e,{Z:()=>s});var a=n(84995),i=n(96824),o=n(36377);const s=function(t,e,n,s,d,r={},l=""){const{color:h,width:c,lineWidth:u,lineDash:g}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},r),v=u||c,f=(0,a.Z)(e,"ellipse",n),C=t.getSvgNode(f),m=Math.abs(s[0]-d[0]),p=Math.abs(s[1]-d[1]),E=[Math.min(s[0],d[0])+m/2,Math.min(s[1],d[1])+p/2],D={cx:`${E[0]}`,cy:`${E[1]}`,rx:`${m/2}`,ry:`${p/2}`,stroke:h,fill:"transparent","stroke-width":v,"stroke-dasharray":g};if(C)(0,i.Z)(D,C),t.setNodeTouched(f);else{const e=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==l&&e.setAttribute("data-id",l),(0,o.Z)(D,e),t.appendNode(e,f)}}},99469:(t,e,n)=>{n.d(e,{Z:()=>s});var a=n(84995),i=n(36377),o=n(96824);function s(t,e,n,s,d){if(s.length<2)return;const{color:r,width:l,lineWidth:h,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},d),u=h||l,g=(0,a.Z)(e,"polyline",n),v=t.getSvgNode(g);let f="";for(const t of s)f+=`${t[0]}, ${t[1]} `;if(d.connectLastToFirst){const t=s[0];f+=`${t[0]}, ${t[1]}`}const C={points:f,stroke:r,fill:"none","stroke-width":u,"stroke-dasharray":c};if(v)(0,o.Z)(C,v),t.setNodeTouched(g);else{const e=document.createElementNS("http://www.w3.org/2000/svg","polyline");(0,i.Z)(C,e),t.appendNode(e,g)}}},51180:(t,e,n)=>{n.d(e,{Z:()=>T});var a=n(69786),i=n(96720),o=n(97335),s=n(509),d=n(78266),r=n(41509),l=n(7576),h=n(80686),c=n(43876),u=n(31603),g=n(80084),v=n(55742),f=n(82853),C=n(40622),m=n(11207),p=n(52857),E=n(43356),D=n(23222);class w extends d.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(t,e),this.addNewAnnotation=t=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=(0,i.ZP)(a),{viewport:d,renderingEngine:r}=s;(0,D.hideElementCursor)(a),this.isDrawing=!0;const h=d.getCamera(),{viewPlaneNormal:c,viewUp:u}=h,g=this.getReferencedImageId(d,o,c,u),v=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...u],FrameOfReferenceUID:v,referencedImageId:g},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(f,a);const C=(0,m.Z)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:C,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),t.preventDefault(),(0,E.Z)(r,C),f},this.isPointNearTool=(t,e,n,a)=>{const o=(0,i.ZP)(t),{viewport:s}=o,{data:d}=e,[r,l,h]=d.handles.points,u=s.worldToCanvas(r),g=s.worldToCanvas(l),v=s.worldToCanvas(h),f={start:{x:u[0],y:u[1]},end:{x:g[0],y:g[1]}},C={start:{x:g[0],y:g[1]},end:{x:v[0],y:v[1]}},m=c.Z([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),p=c.Z([C.start.x,C.start.y],[C.end.x,C.end.y],[n[0],n[1]]);return m<=a||p<=a},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const o=(0,m.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(a),(0,D.hideElementCursor)(a);const s=(0,i.ZP)(a),{renderingEngine:d}=s;(0,E.Z)(d,o),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:d,viewportIdsToRender:r,newAnnotation:h,hasMoved:c}=this.editData,{data:u}=d;if(h&&!c)return;if(this.angleStartedNotYetCompleted&&2===u.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,u.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,D.resetElementCursor)(n);const g=(0,i.ZP)(n),{renderingEngine:v}=g;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(d.annotationUID),(0,E.Z)(v,r),h){const t=a.default.ANNOTATION_COMPLETED,e={annotation:d};(0,o.Z)(s.Z,t,e)}this.editData=null,this.isDrawing=!1},this._dragCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:o,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else{const{currentPoints:t}=e,n=t.world;r.handles.points[s]=[...n],a.invalidated=!0}this.editData.hasMoved=!0;const l=(0,i.ZP)(n),{renderingEngine:h}=l;(0,E.Z)(h,o)},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,D.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:d}=this.editData,{data:r}=e;e.highlighted=!1,r.handles.activeHandleIndex=null;const l=(0,i.ZP)(t),{renderingEngine:h}=l;if((0,E.Z)(h,n),d){const t=a.default.ANNOTATION_COMPLETED,n={annotation:e};(0,o.Z)(s.Z,t,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,e.annotationUID}},this._activateModify=t=>{C.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=t=>{C.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this._activateDraw=t=>{C.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=t=>{C.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,l.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const l=o[i],{annotationUID:c,data:u}=l,{points:C,activeHandleIndex:m}=u.handles;r.annotationUID=c;const E=this.getStyle("lineWidth",r,l),D=this.getStyle("lineDash",r,l),w=this.getStyle("color",r,l),T=C.map((t=>a.worldToCanvas(t)));let _;if(u.cachedStats[s]?l.invalidated&&this._throttledCalculateCachedStats(l,d,t):(u.cachedStats[s]={angle:null},this._calculateCachedStats(l,d,t)),(0,h.isAnnotationLocked)(l)||this.editData||null===m||(_=[T[m]]),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(_){const t="0";(0,g.Z)(e,c,t,T,{color:w,lineDash:D,lineWidth:E})}let I="1";if((0,v.Z)(e,c,I,T[0],T[1],{color:w,width:E,lineDash:D}),n=!0,3!==T.length)return n;if(I="2",(0,v.Z)(e,c,I,T[1],T[2],{color:w,width:E,lineDash:D}),!u.cachedStats[s]?.angle)continue;const x=this._getTextLines(u,s);if(!u.handles.textBox.hasMoved){const t=(0,p.Z)(T);u.handles.textBox.worldPosition=a.canvasToWorld(t)}const O=a.worldToCanvas(u.handles.textBox.worldPosition),b="1",M=(0,f.Z)(e,c,b,x,O,T,{},this.getLinkedTextBoxStyle(r,l)),{x:P,y:U,width:Z,height:L}=M;u.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([P,U]),topRight:a.canvasToWorld([P+Z,U]),bottomLeft:a.canvasToWorld([P,U+L]),bottomRight:a.canvasToWorld([P+Z,U+L])}}return n},this._throttledCalculateCachedStats=(0,r.Z)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,e,n){const a=t.detail,{element:o}=a,{data:s}=e;e.highlighted=!0;let d,r=!1;n.worldPosition?r=!0:d=s.handles.points.findIndex((t=>t===n));const l=(0,m.Z)(o,this.getToolName());this.editData={annotation:e,viewportIdsToRender:l,handleIndex:d,movingTextBox:r},this._activateModify(o),(0,D.hideElementCursor)(o);const h=(0,i.ZP)(o),{renderingEngine:c}=h;(0,E.Z)(c,l),t.preventDefault()}_getTextLines(t,e){const n=t.cachedStats[e],{angle:a}=n;if(void 0===a)return;return[`${a.toFixed(2)} ${String.fromCharCode(176)}`]}_calculateCachedStats(t,e,n){const i=t.data,{viewportId:d,renderingEngineId:r}=n;if(3!==i.handles.points.length)return;const l=i.handles.points[0],h=i.handles.points[1],c=i.handles.points[2],{cachedStats:g}=i,v=Object.keys(g);for(let t=0;t<v.length;t++){const e=v[t],n=(0,u.Z)([l,h],[h,c]);g[e]={angle:n}}t.invalidated=!1;const f=a.default.ANNOTATION_MODIFIED,C={annotation:t,viewportId:d,renderingEngineId:r};return(0,o.Z)(s.Z,f,C),g}}w.toolName="Angle";const T=w},32997:(t,e,n)=>{n.d(e,{Z:()=>_});var a=n(69786),i=n(96720),o=n(97335),s=n(509),d=n(34894),r=n(78266),l=n(7576),h=n(80686),c=n(43876),u=n(80084),g=n(68390),v=n(82853),f=n(40622),C=n(11207),m=n(52857),p=n(43356),E=n(23222);class D extends r.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:w,changeTextCallback:T,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(t,e),this.addNewAnnotation=t=>{const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=(0,i.ZP)(a),{viewport:d,renderingEngine:r}=s;(0,E.hideElementCursor)(a),this.isDrawing=!0;const h=d.getCamera(),{viewPlaneNormal:c,viewUp:u}=h,g=this.getReferencedImageId(d,o,c,u),{arrowFirst:v}=this.configuration,f=d.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...u],FrameOfReferenceUID:f,referencedImageId:g},data:{text:"",handles:{points:[[...o],[...o]],activeHandleIndex:null,arrowFirst:v,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,l.addAnnotation)(m,a);const D=(0,C.Z)(a,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:D,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),t.preventDefault(),(0,p.Z)(r,D),m},this.isPointNearTool=(t,e,n,a)=>{const o=(0,i.ZP)(t),{viewport:s}=o,{data:d}=e,[r,l]=d.handles.points,h=s.worldToCanvas(r),u=s.worldToCanvas(l),g={start:{x:h[0],y:h[1]},end:{x:u[0],y:u[1]}};return c.Z([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=a},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const o=(0,C.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(a),(0,E.hideElementCursor)(a);const s=(0,i.ZP)(a),{renderingEngine:d}=s;(0,p.Z)(d,o),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:d,viewportIdsToRender:r,newAnnotation:h,hasMoved:c}=this.editData,{data:u}=d;if(h&&!c)return;u.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n);const g=(0,i.ZP)(n),{viewportId:v,renderingEngineId:f,renderingEngine:C}=g;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(d.annotationUID),h)this.configuration.getTextCallback((t=>{if(!t)return(0,l.removeAnnotation)(d.annotationUID),(0,p.Z)(C,r),this.editData=null,void(this.isDrawing=!1);d.data.text=t;const e=a.default.ANNOTATION_COMPLETED,n={annotation:d};(0,o.Z)(s.Z,e,n),(0,p.Z)(C,r)}));else{const t=a.default.ANNOTATION_MODIFIED,e={annotation:d,viewportId:v,renderingEngineId:f};(0,o.Z)(s.Z,t,e)}this.editData=null,this.isDrawing=!1},this._dragCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:o,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else{const{currentPoints:t}=e,n=t.world;r.handles.points[s]=[...n],a.invalidated=!0}this.editData.hasMoved=!0;const l=(0,i.ZP)(n),{renderingEngine:h}=l;(0,p.Z)(h,o)},this.touchTapCallback=t=>{2==t.detail.taps&&this.doubleClickCallback(t)},this.doubleClickCallback=t=>{const e=t.detail,{element:n}=e;let a=(0,l.getAnnotations)(this.getToolName(),n);if(a=this.filterInteractableAnnotationsForElement(n,a),!a?.length)return;const i=a.find((t=>this.isPointNearTool(n,t,e.currentPoints.canvas,6)));if(!i)return;const o=i;this.configuration.changeTextCallback(i,t.detail,this._doneChangingTextCallback.bind(this,n,o)),this.editData=null,this.isDrawing=!1,t.stopImmediatePropagation(),t.preventDefault()},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,E.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:d}=this.editData,{data:r}=e;e.highlighted=!1,r.handles.activeHandleIndex=null;const l=(0,i.ZP)(t),{renderingEngine:h}=l;if((0,p.Z)(h,n),d){const t=a.default.ANNOTATION_COMPLETED,n={annotation:e};(0,o.Z)(s.Z,t,n)}return this.editData=null,e.annotationUID}},this._activateModify=t=>{f.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=t=>{f.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback)},this._activateDraw=t=>{f.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=t=>{f.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,l.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let t=0;t<o.length;t++){const i=o[t],{annotationUID:d,data:r}=i,{handles:l,text:c}=r,{points:f,activeHandleIndex:C}=l;s.annotationUID=d;const p=this.getStyle("lineWidth",s,i),E=this.getStyle("lineDash",s,i),D=this.getStyle("color",s,i),w=f.map((t=>a.worldToCanvas(t)));let T;if((0,h.isAnnotationLocked)(i)||this.editData||null===C||(T=[w[C]]),T){const t="0";(0,u.Z)(e,d,t,w,{color:D,lineWidth:p})}const _="1";if(this.configuration.arrowFirst?(0,g.Z)(e,d,_,w[1],w[0],{color:D,width:p,lineDash:E}):(0,g.Z)(e,d,_,w[0],w[1],{color:D,width:p,lineDash:E}),n=!0,!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;if(!r.handles.textBox.hasMoved){const t=(0,m.Z)(w);r.handles.textBox.worldPosition=a.canvasToWorld(t)}const I=a.worldToCanvas(r.handles.textBox.worldPosition),x="1",O=(0,v.Z)(e,d,x,[c],I,w,{},this.getLinkedTextBoxStyle(s,i)),{x:b,y:M,width:P,height:U}=O;r.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([b,M]),topRight:a.canvasToWorld([b+P,M]),bottomLeft:a.canvasToWorld([b,M+U]),bottomRight:a.canvasToWorld([b+P,M+U])}}return n}}handleSelectedCallback(t,e,n){const a=t.detail,{element:o}=a,{data:s}=e;e.highlighted=!0;let d,r=!1;n.worldPosition?r=!0:d=s.handles.points.findIndex((t=>t===n));const l=(0,C.Z)(o,this.getToolName());this.editData={annotation:e,viewportIdsToRender:l,handleIndex:d,movingTextBox:r},this._activateModify(o),(0,E.hideElementCursor)(o);const h=(0,i.ZP)(o),{renderingEngine:c}=h;(0,p.Z)(c,l),t.preventDefault()}_doneChangingTextCallback(t,e,n){e.data.text=n;const{renderingEngine:d,viewportId:r,renderingEngineId:l}=(0,i.ZP)(t),h=(0,C.Z)(t,this.getToolName());(0,p.Z)(d,h);const c=a.default.ANNOTATION_MODIFIED;(0,o.Z)(s.Z,c,{annotation:e,viewportId:r,renderingEngineId:l})}_isInsideVolume(t,e,n){return d.Z(t,n)&&d.Z(e,n)}}function w(t){return t(prompt("Enter your annotation:"))}function T(t,e,n){return n(prompt("Enter your annotation:"))}D.toolName="ArrowAnnotate";const _=D},67848:(t,e,n)=>{n.d(e,{Z:()=>M});var a=n(6807),i=n(91055),o=n(27054),s=n(96720),d=n(97335),r=n(509),l=n(34894),h=n(78266),c=n(41509),u=n(7576),g=n(80686),v=n(15849),f=n(80084),C=n(55742),m=n(82853),p=n(40622),E=n(69786),D=n(11207),w=n(43876),T=n(26562),_=n(52857),I=n(23222),x=n(43356);const{transformWorldToIndex:O}=o;class b extends h.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(t,e),this.isPointNearTool=(t,e,n,a)=>{const i=(0,s.ZP)(t),{viewport:o}=i,{data:d}=e,{points:r}=d.handles;let l=o.worldToCanvas(r[0]),h=o.worldToCanvas(r[1]),c={start:{x:l[0],y:l[1]},end:{x:h[0],y:h[1]}},u=w.Z([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return u<=a||(l=o.worldToCanvas(r[2]),h=o.worldToCanvas(r[3]),c={start:{x:l[0],y:l[1]},end:{x:h[0],y:h[1]}},u=w.Z([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),u<=a)},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const i=(0,D.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(a);const o=(0,s.ZP)(a),{renderingEngine:d}=o;(0,x.Z)(d,i),(0,I.hideElementCursor)(a),t.preventDefault()},this.handleSelectedCallback=(t,e,n)=>{const a=t.detail,{element:i}=a,o=e.data;e.highlighted=!0;let d,r=!1;n.worldPosition?r=!0:d=o.handles.points.findIndex((t=>t===n));const l=(0,D.Z)(i,this.getToolName());(0,I.hideElementCursor)(i),this.editData={annotation:e,viewportIdsToRender:l,handleIndex:d,movingTextBox:r},this._activateModify(i);const h=(0,s.ZP)(i),{renderingEngine:c}=h;(0,x.Z)(c,l),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:o,viewportIdsToRender:l,newAnnotation:h,hasMoved:c}=this.editData,{data:g}=o;if(h&&!c)return;g.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,I.resetElementCursor)(n);const v=(0,s.ZP)(n),{renderingEngine:f}=v;if(void 0!==this.editData.handleIndex){const{points:t}=g.handles,e=a.distance(t[0],t[1]);if(a.distance(t[2],t[3])>e){const e=[[...t[2]],[...t[3]]],n=[...t[0]],a=[...t[1]],o=i.Ue();i.t8(o,e[1][0]-e[0][0],e[1][1]-e[1][0]);const s=i.Ue();i.t8(s,-o[1],o[0]);const d=i.Ue();let r;i.t8(d,a[0]-n[0],a[1]-n[0]),r=i.AK(d,s)>0?[n,a]:[a,n],g.handles.points=[e[0],e[1],r[0],r[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,u.removeAnnotation)(o.annotationUID),(0,x.Z)(f,l),h){const t=E.default.ANNOTATION_COMPLETED,e={annotation:o};(0,d.Z)(r.Z,t,e)}this.editData=null,this.isDrawing=!1},this._dragDrawCallback=t=>{this.isDrawing=!0;const e=t.detail,{currentPoints:n,element:a}=e,o=(0,s.ZP)(a),{renderingEngine:d,viewport:r}=o,{worldToCanvas:l}=r,{annotation:h,viewportIdsToRender:c,handleIndex:u}=this.editData,{data:g}=h,v=n.world;g.handles.points[u]=[...v];const f=g.handles.points.map(l),C={start:{x:f[0][0],y:f[0][1]},end:{x:f[1][0],y:f[1][1]}},m=(f[2][0],f[2][1],f[3][0],f[3][1],i.TE(f[0],f[1])/3),p=C.start.x-C.end.x,E=C.start.y-C.end.y,D=Math.sqrt(p*p+E*E),w=p/D,T=E/D,_=(C.start.x+C.end.x)/2,I=(C.start.y+C.end.y)/2,O=_+m*T,b=I-m*w,M=_-m*T,P=I+m*w;g.handles.points[2]=r.canvasToWorld([O,b]),g.handles.points[3]=r.canvasToWorld([M,P]),h.invalidated=!0,(0,x.Z)(d,c),this.editData.hasMoved=!0},this._dragModifyCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,a=(0,s.ZP)(n),{renderingEngine:i}=a,{annotation:o,viewportIdsToRender:d,handleIndex:r,movingTextBox:l}=this.editData,{data:h}=o;if(l){const{deltaPoints:t}=e,n=t.world,{textBox:a}=h.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===r){const{deltaPoints:t}=e,n=t.world;h.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),o.invalidated=!0}else this._dragModifyHandle(t),o.invalidated=!0;(0,x.Z)(i,d)},this._dragModifyHandle=t=>{const e=t.detail,{currentPoints:n,element:a}=e,o=(0,s.ZP)(a),{viewport:d}=o,{annotation:r,handleIndex:l}=this.editData,{data:h}=r,c=n.world,u=[d.worldToCanvas(h.handles.points[0]),d.worldToCanvas(h.handles.points[1]),d.worldToCanvas(h.handles.points[2]),d.worldToCanvas(h.handles.points[3])],g={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},v={start:{x:u[2][0],y:u[2][1]},end:{x:u[3][0],y:u[3][1]}},f=[...c],C=d.worldToCanvas(f);if(0===l||1===l){const t=u[0===l?1:0],e=i.t8(i.Ue(),C[0]-t[0],C[1]-t[1]),n=i.t8(i.Ue(),u[l][0]-t[0],u[l][1]-t[1]);i.Fv(e,e),i.Fv(n,n);const a={start:{x:t[0],y:t[1]},end:{x:C[0],y:C[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(a,v))return;const o=t,s=this._getSignedAngle(n,e);let r=u[2][0],c=u[2][1],g=u[3][0],m=u[3][1];r-=o[0],c-=o[1],g-=o[0],m-=o[1];const p=r*Math.cos(s)-c*Math.sin(s),E=r*Math.sin(s)+c*Math.cos(s),D=g*Math.cos(s)-m*Math.sin(s),w=g*Math.sin(s)+m*Math.cos(s);r=p+o[0],c=E+o[1],g=D+o[0],m=w+o[1];const T=d.canvasToWorld([r,c]),_=d.canvasToWorld([g,m]);h.handles.points[l]=f,h.handles.points[2]=T,h.handles.points[3]=_}else{const t=2===l?3:2,e={longLineSegment:{start:g.start,end:g.end},shortLineSegment:{start:v.start,end:v.end}},n=i.$X(i.Ue(),[e.longLineSegment.end.x,e.longLineSegment.end.y],[e.longLineSegment.start.x,e.longLineSegment.start.y]),a=i.Fv(i.Ue(),n),o=i.$X(i.Ue(),[C[0],C[1]],[u[l][0],u[l][1]]),s=i.kE(o),r=this._getSignedAngle(a,o),c=Math.cos(r)*s,m=i.od(i.Ue(),[u[t][0],u[t][1]],a,c);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:C[0],y:C[1]},end:{x:m[0],y:m[1]}},{start:{x:e.longLineSegment.start.x,y:e.longLineSegment.start.y},end:{x:e.longLineSegment.end.x,y:e.longLineSegment.end.y}}))return;if(!T.Z([C[0],C[1]],[m[0],m[1]],[g.start.x,g.start.y],[g.end.x,g.end.y]))return;h.handles.points[t]=d.canvasToWorld(m),h.handles.points[l]=f}},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,I.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:a}=this.editData,{data:i}=e;e.highlighted=!1,i.handles.activeHandleIndex=null;const o=(0,s.ZP)(t),{renderingEngine:l}=o;if((0,x.Z)(l,n),a){const t=E.default.ANNOTATION_COMPLETED,n={annotation:e};(0,d.Z)(r.Z,t,n)}return this.editData=null,e.annotationUID}},this._activateDraw=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(E.default.MOUSE_UP,this._endCallback),t.addEventListener(E.default.MOUSE_DRAG,this._dragDrawCallback),t.addEventListener(E.default.MOUSE_MOVE,this._dragDrawCallback),t.addEventListener(E.default.MOUSE_CLICK,this._endCallback),t.addEventListener(E.default.TOUCH_TAP,this._endCallback),t.addEventListener(E.default.TOUCH_END,this._endCallback),t.addEventListener(E.default.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(E.default.MOUSE_UP,this._endCallback),t.removeEventListener(E.default.MOUSE_DRAG,this._dragDrawCallback),t.removeEventListener(E.default.MOUSE_MOVE,this._dragDrawCallback),t.removeEventListener(E.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(E.default.TOUCH_TAP,this._endCallback),t.removeEventListener(E.default.TOUCH_END,this._endCallback),t.removeEventListener(E.default.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(E.default.MOUSE_UP,this._endCallback),t.addEventListener(E.default.MOUSE_DRAG,this._dragModifyCallback),t.addEventListener(E.default.MOUSE_CLICK,this._endCallback),t.addEventListener(E.default.TOUCH_END,this._endCallback),t.addEventListener(E.default.TOUCH_DRAG,this._dragModifyCallback),t.addEventListener(E.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(E.default.MOUSE_UP,this._endCallback),t.removeEventListener(E.default.MOUSE_DRAG,this._dragModifyCallback),t.removeEventListener(E.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(E.default.TOUCH_END,this._endCallback),t.removeEventListener(E.default.TOUCH_DRAG,this._dragModifyCallback),t.removeEventListener(E.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(t,e)=>{let n=!0;const{viewport:a}=t,{element:i}=a;let o=(0,u.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const l=o[i],{annotationUID:h,data:c}=l,{points:u,activeHandleIndex:p}=c.handles,E=u.map((t=>a.worldToCanvas(t)));r.annotationUID=h;const D=this.getStyle("lineWidth",r,l),w=this.getStyle("lineDash",r,l),T=this.getStyle("color",r,l),I=this.getStyle("shadow",r,l);if(c.cachedStats[s]&&void 0!==c.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,d,t):(c.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(l,d,t)),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let x;if(!(0,v.isAnnotationVisible)(h))continue;if((0,g.isAnnotationLocked)(l)||this.editData||null===p||(x=[E[p]]),x){const t="0";(0,f.Z)(e,h,t,x,{color:T})}const O=`${h}-line-1`,b=`${h}-line-2`,M="0";(0,C.Z)(e,h,M,E[0],E[1],{color:T,lineDash:w,lineWidth:D,shadow:I},O);const P="1";(0,C.Z)(e,h,P,E[2],E[3],{color:T,lineDash:w,lineWidth:D,shadow:I},b),n=!0;const U=this._getTextLines(c,s);if(!U||0===U.length)continue;let Z;c.handles.textBox.hasMoved||(Z=(0,_.Z)(E),c.handles.textBox.worldPosition=a.canvasToWorld(Z));const L=a.worldToCanvas(c.handles.textBox.worldPosition),S="1",k=(0,m.Z)(e,h,S,U,L,E,{},this.getLinkedTextBoxStyle(r,l)),{x:A,y,width:N,height:R}=k;c.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([A,y]),topRight:a.canvasToWorld([A+N,y]),bottomLeft:a.canvasToWorld([A,y+R]),bottomRight:a.canvasToWorld([A+N,y+R])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(t,e)=>{const n=i.Ue();i.t8(n,e.end.x-e.start.x,e.end.y-e.start.y),i.Fv(n,n);const a={start:{x:e.start.x-10*n[0],y:e.start.y-10*n[1]},end:{x:e.end.x+10*n[0],y:e.end.y+10*n[1]}};return!T.Z([a.start.x,a.start.y],[a.end.x,a.end.y],[t.start.x,t.start.y],[t.end.x,t.end.y])},this._getTextLines=(t,e)=>{const{cachedStats:n}=t,{length:a,width:i,unit:o}=n[e];if(void 0===a)return;return[`L: ${a.toFixed(2)} ${o}`,`W: ${i.toFixed(2)} ${o}`]},this._calculateCachedStats=(t,e,n)=>{const{data:a}=t,{viewportId:i,renderingEngineId:o}=n,s=a.handles.points[0],l=a.handles.points[1],h=a.handles.points[2],c=a.handles.points[3],{cachedStats:u}=a,g=Object.keys(u);for(let t=0;t<g.length;t++){const n=g[t],a=this.getTargetIdImage(n,e);if(!a)continue;const{imageData:i,dimensions:o,hasPixelSpacing:d}=a,r=this._calculateLength(s,l),v=this._calculateLength(h,c),f=r>v?r:v,C=r>v?v:r,m=O(i,s),p=O(i,l),E=O(i,h),D=O(i,c);this._isInsideVolume(m,p,E,D,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,u[n]={length:f,width:C,unit:d?"mm":"px"}}t.invalidated=!1;const v=E.default.ANNOTATION_MODIFIED,f={annotation:t,viewportId:i,renderingEngineId:o};return(0,d.Z)(r.Z,v,f),u},this._isInsideVolume=(t,e,n,a,i)=>l.Z(t,i)&&l.Z(e,i)&&l.Z(n,i)&&l.Z(a,i),this._getSignedAngle=(t,e)=>Math.atan2(t[0]*e[1]-t[1]*e[0],t[0]*e[0]+t[1]*e[1]),this._throttledCalculateCachedStats=(0,c.Z)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(t){const e=t.detail,{currentPoints:n,element:a}=e,i=n.world,o=(0,s.ZP)(a),{viewport:d,renderingEngine:r}=o;this.isDrawing=!0;const l=d.getCamera(),{viewPlaneNormal:h,viewUp:c}=l,g=this.getReferencedImageId(d,i,h,c),v=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...c],FrameOfReferenceUID:v,referencedImageId:g},data:{handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,u.addAnnotation)(f,a);const C=(0,D.Z)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:C,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,I.hideElementCursor)(a),t.preventDefault(),(0,x.Z)(r,C),f}_calculateLength(t,e){const n=t[0]-e[0],a=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+a*a+i*i)}}b.toolName="Bidirectional";const M=b},94968:(t,e,n)=>{n.d(e,{Z:()=>k});var a=n(78266),i=n(27054),o=n(96720),s=n(97335),d=n(509),r=n(75089),l=n(22797),h=n(34894),c=n(41509),u=n(7576),g=n(80686),v=n(15849),f=n(80084),C=n(6355),m=n(82853),p=n(40622),E=n(69786),D=n(11207),w=n(52857),T=n(23123),_=n(23222),I=n(43356),x=n(91728),O=n(1117),b=n(38396),M=n(65231);function P(t){const[e,n]=t;return(0,M.Z)(e,n)}function U(t){const[e,n]=t,a=(0,M.Z)(e,n);return[[e[0]-a,e[1]-a],[e[0]+a,e[1]+a]]}var Z=n(86334);const{transformWorldToIndex:L}=i;class S extends a.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(t,e),this.isHandleOutsideImage=!1,this.addNewAnnotation=t=>{const e=t.detail,{currentPoints:n,element:a}=e,i=n.world,s=(n.canvas,(0,o.ZP)(a)),{viewport:d,renderingEngine:r}=s;this.isDrawing=!0;const l=d.getCamera(),{viewPlaneNormal:h,viewUp:c}=l,g=this.getReferencedImageId(d,i,h,c),v=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...c],FrameOfReferenceUID:v,referencedImageId:g},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i]],activeHandleIndex:null},cachedStats:{}}};(0,u.addAnnotation)(f,a);const C=(0,D.Z)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:C,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,_.hideElementCursor)(a),t.preventDefault(),(0,I.Z)(r,C),f},this.isPointNearTool=(t,e,n,a)=>{const i=(0,o.ZP)(t),{viewport:s}=i,{data:d}=e,{points:r}=d.handles,l=r.map((t=>s.worldToCanvas(t))),h=P(l),c=P([l[0],n]);return Math.abs(c-h)<a/2},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const i=(0,D.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:i,movingTextBox:!1},(0,_.hideElementCursor)(a),this._activateModify(a);const s=(0,o.ZP)(a),{renderingEngine:d}=s;(0,I.Z)(d,i),t.preventDefault()},this.handleSelectedCallback=(t,e,n)=>{const a=t.detail,{element:i}=a,{data:s}=e;e.highlighted=!0;let d,r=!1;if(n.worldPosition)r=!0;else{const{points:t}=s.handles;d=t.findIndex((t=>t===n))}const l=(0,D.Z)(i,this.getToolName());this.editData={annotation:e,viewportIdsToRender:l,handleIndex:d,movingTextBox:r},this._activateModify(i),(0,_.hideElementCursor)(i);const h=(0,o.ZP)(i),{renderingEngine:c}=h;(0,I.Z)(c,l),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:i,newAnnotation:r,hasMoved:l}=this.editData,{data:h}=a;if(r&&!l)return;a.highlighted=!1,h.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,_.resetElementCursor)(n);const c=(0,o.ZP)(n),{renderingEngine:g}=c;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,u.removeAnnotation)(a.annotationUID),(0,I.Z)(g,i),r){const t=E.default.ANNOTATION_COMPLETED,e={annotation:a};(0,s.Z)(d.Z,t,e)}},this._dragDrawCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{currentPoints:a}=e,i=a.canvas,s=(0,o.ZP)(n),{renderingEngine:d,viewport:r}=s,{canvasToWorld:l}=r,{annotation:h,viewportIdsToRender:c}=this.editData,{data:u}=h;u.handles.points=[u.handles.points[0],l(i)],h.invalidated=!0,this.editData.hasMoved=!0,(0,I.Z)(d,c)},this._dragModifyCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:i,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else this._dragHandle(t),a.invalidated=!0;const l=(0,o.ZP)(n),{renderingEngine:h}=l;(0,I.Z)(h,i)},this._dragHandle=t=>{const e=t.detail,{element:n}=e,a=(0,o.ZP)(n),{canvasToWorld:i,worldToCanvas:s}=a.viewport,{annotation:d,handleIndex:r}=this.editData,{data:l}=d,{points:h}=l.handles,c=h.map((t=>s(t))),{currentPoints:u}=e,g=u.canvas;if(0===r){const t=g[0]-c[0][0],e=g[1]-c[0][1],n=g,a=[c[1][0]+t,c[1][1]+e];h[0]=i(n),h[1]=i(a)}else h[1]=i(g)},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,_.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:a}=this.editData,{data:i}=e;e.highlighted=!1,i.handles.activeHandleIndex=null;const r=(0,o.ZP)(t),{renderingEngine:l}=r;if((0,I.Z)(l,n),a){const t=E.default.ANNOTATION_COMPLETED,n={annotation:e};(0,s.Z)(d.Z,t,n)}return this.editData=null,e.annotationUID}},this._activateModify=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(E.default.MOUSE_UP,this._endCallback),t.addEventListener(E.default.MOUSE_DRAG,this._dragModifyCallback),t.addEventListener(E.default.MOUSE_CLICK,this._endCallback),t.addEventListener(E.default.TOUCH_END,this._endCallback),t.addEventListener(E.default.TOUCH_DRAG,this._dragModifyCallback),t.addEventListener(E.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(E.default.MOUSE_UP,this._endCallback),t.removeEventListener(E.default.MOUSE_DRAG,this._dragModifyCallback),t.removeEventListener(E.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(E.default.TOUCH_END,this._endCallback),t.removeEventListener(E.default.TOUCH_DRAG,this._dragModifyCallback),t.removeEventListener(E.default.TOUCH_TAP,this._endCallback)},this._activateDraw=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(E.default.MOUSE_UP,this._endCallback),t.addEventListener(E.default.MOUSE_DRAG,this._dragDrawCallback),t.addEventListener(E.default.MOUSE_MOVE,this._dragDrawCallback),t.addEventListener(E.default.MOUSE_CLICK,this._endCallback),t.addEventListener(E.default.TOUCH_END,this._endCallback),t.addEventListener(E.default.TOUCH_DRAG,this._dragDrawCallback),t.addEventListener(E.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(E.default.MOUSE_UP,this._endCallback),t.removeEventListener(E.default.MOUSE_DRAG,this._dragDrawCallback),t.removeEventListener(E.default.MOUSE_MOVE,this._dragDrawCallback),t.removeEventListener(E.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(E.default.TOUCH_END,this._endCallback),t.removeEventListener(E.default.TOUCH_DRAG,this._dragDrawCallback),t.removeEventListener(E.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,u.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const c=o[i],{annotationUID:u,data:p}=c,{handles:E}=p,{points:D,activeHandleIndex:T}=E;h.annotationUID=u;const _=this.getStyle("lineWidth",h,c),I=this.getStyle("lineDash",h,c),x=this.getStyle("color",h,c),O=D.map((t=>a.worldToCanvas(t))),M=O[0],Z=P(O),L=U(O),{centerPointRadius:S}=this.configuration;if(p.cachedStats[s]&&void 0!==p.cachedStats[s].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,a,d,t),a instanceof r.Z)){const{referencedImageId:t}=c.metadata;for(const e in p.cachedStats)if(e.startsWith("imageId")){d.getStackViewports().find((e=>{const n=l.Z(t),a=e.hasImageURI(n),i=l.Z(e.getCurrentImageId());return a&&i!==n}))&&delete p.cachedStats[e]}}}else p.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(c,a,d,t);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let k;if(!(0,v.isAnnotationVisible)(u))continue;if((0,g.isAnnotationLocked)(c)||this.editData||null===T||(k=[O[T]]),k){const t="0";(0,f.Z)(e,u,t,k,{color:x})}const A=`${u}-circle`,y="0";(0,C.Z)(e,u,y,M,Z,{color:x,lineDash:I,lineWidth:_},A),S>0&&Z>3*S&&(0,C.Z)(e,u,`${y}-center`,M,S,{color:x,lineDash:I,lineWidth:_}),n=!0;const N=(0,b.P)(a,s),R=this.isSuvScaled(a,s,c.metadata.referencedImageId),H=this._getTextLines(p,s,N,R);if(!H||0===H.length)continue;let W;p.handles.textBox.hasMoved||(W=(0,w.Z)(L),p.handles.textBox.worldPosition=a.canvasToWorld(W));const B=a.worldToCanvas(p.handles.textBox.worldPosition),F="1",G=(0,m.Z)(e,u,F,H,B,O,{},this.getLinkedTextBoxStyle(h,c)),{x:$,y:K,width:V,height:q}=G;p.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([$,K]),topRight:a.canvasToWorld([$+V,K]),bottomLeft:a.canvasToWorld([$,K+q]),bottomRight:a.canvasToWorld([$+V,K+q])}}return n},this._getTextLines=(t,e,n,a)=>{const i=t.cachedStats[e],{radius:o,radiusUnit:s,area:d,mean:r,stdDev:l,max:h,isEmptyArea:c,Modality:u,areaUnit:g}=i,v=[],f=(0,O.F)(u,n,a);if(o){const t=c?"Radius: Oblique not supported":`Radius: ${o.toFixed(2)} ${s}`;v.push(t)}if(d){const t=c?"Area: Oblique not supported":`Area: ${d.toFixed(2)} ${g}²`;v.push(t)}return r&&v.push(`Mean: ${r.toFixed(2)} ${f}`),h&&v.push(`Max: ${h.toFixed(2)} ${f}`),l&&v.push(`Std Dev: ${l.toFixed(2)} ${f}`),v},this._calculateCachedStats=(t,e,n,a)=>{const i=t.data,{viewportId:o,renderingEngineId:r}=a,{points:l}=i.handles,h=l.map((t=>e.worldToCanvas(t))),{viewPlaneNormal:c,viewUp:u}=e.getCamera(),[g,v]=U(h),f=e.canvasToWorld(g),C=e.canvasToWorld(v),{cachedStats:m}=i,p=Object.keys(m),D=f,w=C;for(let t=0;t<p.length;t++){const e=p[t],a=this.getTargetIdImage(e,n);if(!a)continue;const{dimensions:i,imageData:o,metadata:s,hasPixelSpacing:d}=a,r=L(o,D);r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r[2]=Math.floor(r[2]);const l=L(o,w);if(l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l[2]=Math.floor(l[2]),this._isInsideVolume(r,l,i)){const t=[[Math.min(r[0],l[0]),Math.max(r[0],l[0])],[Math.min(r[1],l[1]),Math.max(r[1],l[1])],[Math.min(r[2],l[2]),Math.max(r[2],l[2])]],n={center:[(f[0]+C[0])/2,(f[1]+C[1])/2,(f[2]+C[2])/2],xRadius:Math.abs(f[0]-C[0])/2,yRadius:Math.abs(f[1]-C[1])/2,zRadius:Math.abs(f[2]-C[2])/2},{worldWidth:a,worldHeight:i}=(0,T.Z)(c,u,D,w),h=0===a&&0===i,g=Math.abs(Math.PI*(a/2)*(i/2));let v=0,p=0,E=0,_=-1/0;const I=({value:t})=>{t>_&&(_=t),p+=t,v+=1};(0,x.Z)(o,((t,e)=>(0,Z.Z)(n,t)),I,t),p/=v;const O=({value:t})=>{const e=t-p;E+=e*e};(0,x.Z)(o,((t,e)=>(0,Z.Z)(n,t)),O,t),E/=v,E=Math.sqrt(E),m[e]={Modality:s.Modality,area:g,mean:p,max:_,stdDev:E,isEmptyArea:h,areaUnit:d?"mm":"px",radius:a/2,radiusUnit:d?"mm":"px",perimeter:2*Math.PI*(a/2)}}else this.isHandleOutsideImage=!0,m[e]={Modality:s.Modality}}t.invalidated=!1;const _=E.default.ANNOTATION_MODIFIED,I={annotation:t,viewportId:o,renderingEngineId:r};return(0,s.Z)(d.Z,_,I),m},this._isInsideVolume=(t,e,n)=>h.Z(t,n)&&h.Z(e,n),this._throttledCalculateCachedStats=(0,c.Z)(this._calculateCachedStats,100,{trailing:!0})}}S.toolName="CircleROI";const k=S},48925:(t,e,n)=>{n.d(e,{Z:()=>I});var a=n(69786),i=n(96720),o=n(97335),s=n(509),d=n(78266),r=n(41509),l=n(7576),h=n(80686),c=n(43876),u=n(31603);const g=(...t)=>{const e=2===t[0].length?[0,0]:[0,0,0],n=t.length;for(const a of t)e[0]+=a[0]/n,e[1]+=a[1]/n,3===e.length&&(e[2]+=a[2]/n);return e},v=g;var f=n(80084),C=n(55742),m=n(82853),p=n(40622),E=n(11207),D=n(52857),w=n(43356),T=n(23222);class _ extends d.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(t,e),this.addNewAnnotation=t=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=(0,i.ZP)(a),{viewport:d,renderingEngine:r}=s;(0,T.hideElementCursor)(a),this.isDrawing=!0;const h=d.getCamera(),{viewPlaneNormal:c,viewUp:u}=h,g=this.getReferencedImageId(d,o,c,u),v=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...u],FrameOfReferenceUID:v,referencedImageId:g},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(f,a);const C=(0,E.Z)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:C,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),t.preventDefault(),(0,w.Z)(r,C),f},this.isPointNearTool=(t,e,n,a)=>{const o=(0,i.ZP)(t),{viewport:s}=o,{data:d}=e,[r,l,h,u]=d.handles.points,g=s.worldToCanvas(r),v=s.worldToCanvas(l),f=s.worldToCanvas(h),C=s.worldToCanvas(u),m={start:{x:g[0],y:g[1]},end:{x:v[0],y:v[1]}},p={start:{x:f[0],y:f[1]},end:{x:C[0],y:C[1]}},E=c.Z([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]),D=c.Z([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]]);return E<=a||D<=a},this.toolSelectedCallback=(t,e,n)=>{const a=t.detail,{element:o}=a;e.highlighted=!0;const s=(0,E.Z)(o,this.getToolName());this.editData={annotation:e,viewportIdsToRender:s,movingTextBox:!1},this._activateModify(o),(0,T.hideElementCursor)(o);const d=(0,i.ZP)(o),{renderingEngine:r}=d;(0,w.Z)(r,s),t.preventDefault()},this._mouseUpCallback=t=>{const e=t.detail,{element:n}=e,{annotation:d,viewportIdsToRender:r,newAnnotation:h,hasMoved:c}=this.editData,{data:u}=d;if(h&&!c)return;if(this.angleStartedNotYetCompleted&&u.handles.points.length<4)return(0,T.resetElementCursor)(n),void(this.editData.handleIndex=u.handles.points.length);this.angleStartedNotYetCompleted=!1,u.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,T.resetElementCursor)(n);const g=(0,i.ZP)(n),{renderingEngine:v}=g;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(d.annotationUID),(0,w.Z)(v,r),h){const t=a.default.ANNOTATION_COMPLETED,e={annotation:d};(0,o.Z)(s.Z,t,e)}this.editData=null,this.isDrawing=!1},this._mouseDragCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:o,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else{const{currentPoints:t}=e,n=t.world;r.handles.points[s]=[...n],a.invalidated=!0}this.editData.hasMoved=!0;const l=(0,i.ZP)(n),{renderingEngine:h}=l;(0,w.Z)(h,o)},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,T.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:d}=this.editData,{data:r}=e;e.highlighted=!1,r.handles.activeHandleIndex=null;const l=(0,i.ZP)(t),{renderingEngine:h}=l;if((0,w.Z)(h,n),d){const t=a.default.ANNOTATION_COMPLETED,n={annotation:e};(0,o.Z)(s.Z,t,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,e.annotationUID}},this._activateModify=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._mouseUpCallback),t.addEventListener(a.default.MOUSE_DRAG,this._mouseDragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._mouseUpCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._mouseDragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._mouseUpCallback),t.addEventListener(a.default.MOUSE_DRAG,this._mouseDragCallback),t.addEventListener(a.default.MOUSE_MOVE,this._mouseDragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateDraw=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._mouseUpCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._mouseDragCallback),t.removeEventListener(a.default.MOUSE_MOVE,this._mouseDragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._mouseUpCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,l.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const l=o[i],{annotationUID:c,data:u}=l,{points:g,activeHandleIndex:p}=u.handles;r.annotationUID=c;const E=this.getStyle("lineWidth",r,l),w=this.getStyle("lineDash",r,l),T=this.getStyle("color",r,l),_=g.map((t=>a.worldToCanvas(t)));let I;if(u.cachedStats[s]?l.invalidated&&this._throttledCalculateCachedStats(l,d,t):(u.cachedStats[s]={angle:null},this._calculateCachedStats(l,d,t)),(0,h.isAnnotationLocked)(l)||this.editData||null===p||(I=[_[p]]),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(I){const t="0";(0,f.Z)(e,c,t,_,{color:T,lineDash:w,lineWidth:E})}let x="1";if((0,C.Z)(e,c,x,_[0],_[1],{color:T,width:E,lineDash:w}),n=!0,_.length<4)return n;x="2",(0,C.Z)(e,c,x,_[2],_[3],{color:T,width:E,lineDash:w}),x="3";const O=v(_[0],_[1]),b=v(_[2],_[3]);if((0,C.Z)(e,c,x,O,b,{color:T,lineWidth:"1",lineDash:"1,4"}),!u.cachedStats[s]?.angle)continue;const M=this._getTextLines(u,s);if(!u.handles.textBox.hasMoved){const t=(0,D.Z)(_);u.handles.textBox.worldPosition=a.canvasToWorld(t)}const P=a.worldToCanvas(u.handles.textBox.worldPosition),U="1",Z=(0,m.Z)(e,c,U,M,P,_,{},this.getLinkedTextBoxStyle(r,l)),{x:L,y:S,width:k,height:A}=Z;u.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([L,S]),topRight:a.canvasToWorld([L+k,S]),bottomLeft:a.canvasToWorld([L,S+A]),bottomRight:a.canvasToWorld([L+k,S+A])}}return n},this._throttledCalculateCachedStats=(0,r.Z)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,e,n,a="mouse"){const o=t.detail,{element:s}=o,{data:d}=e;e.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=d.handles.points.findIndex((t=>t===n));const h=(0,E.Z)(s,this.getToolName());this.editData={annotation:e,viewportIdsToRender:h,handleIndex:r,movingTextBox:l},this._activateModify(s),(0,T.hideElementCursor)(s);const c=(0,i.ZP)(s),{renderingEngine:u}=c;(0,w.Z)(u,h),t.preventDefault()}_getTextLines(t,e){const n=t.cachedStats[e],{angle:a}=n;if(void 0===a)return;return[`${a.toFixed(2)} ${String.fromCharCode(176)}`]}_calculateCachedStats(t,e,n){const i=t.data,{viewportId:d,renderingEngineId:r}=n;if(4!==i.handles.points.length)return;const l=i.handles.points[0],h=i.handles.points[1],c=i.handles.points[2],g=i.handles.points[3],{cachedStats:v}=i,f=Object.keys(v);for(let t=0;t<f.length;t++){const e=f[t],n=(0,u.Z)([l,h],[c,g]);v[e]={angle:n}}t.invalidated=!1;const C=a.default.ANNOTATION_MODIFIED,m={annotation:t,viewportId:d,renderingEngineId:r};return(0,o.Z)(s.Z,C,m),v}}_.toolName="CobbAngle";const I=_},55338:(t,e,n)=>{n.d(e,{Z:()=>S});var a=n(78266),i=n(27054),o=n(96720),s=n(97335),d=n(509),r=n(75089),l=n(22797),h=n(34894),c=n(41509),u=n(7576),g=n(80686),v=n(15849),f=n(80084),C=n(28823),m=n(6355),p=n(82853),E=n(40622),D=n(69786),w=n(11207),T=n(52857),_=n(23123),I=n(46879),x=n(86334),O=n(23222),b=n(43356),M=n(91728),P=n(1117),U=n(38396);const{transformWorldToIndex:Z}=i;class L extends a.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(t,e),this.isHandleOutsideImage=!1,this.addNewAnnotation=t=>{const e=t.detail,{currentPoints:n,element:a}=e,i=n.world,s=n.canvas,d=(0,o.ZP)(a),{viewport:r,renderingEngine:l}=d;this.isDrawing=!0;const h=r.getCamera(),{viewPlaneNormal:c,viewUp:g}=h,v=this.getReferencedImageId(r,i,c,g),f=r.getFrameOfReferenceUID(),C={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...g],FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},initialRotation:r.getRotation()}};(0,u.addAnnotation)(C,a);const m=(0,w.Z)(a,this.getToolName());return this.editData={annotation:C,viewportIdsToRender:m,centerCanvas:s,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,O.hideElementCursor)(a),t.preventDefault(),(0,b.Z)(l,m),C},this.isPointNearTool=(t,e,n,a)=>{const i=(0,o.ZP)(t),{viewport:s}=i,{data:d}=e,{points:r}=d.handles,l=r.map((t=>s.worldToCanvas(t))),h=(0,I.Z)(l),[c,u]=h,g={left:Math.min(c[0],u[0])+a/2,top:Math.min(c[1],u[1])+a/2,width:Math.abs(c[0]-u[0])-a,height:Math.abs(c[1]-u[1])-a},v={left:Math.min(c[0],u[0])-a/2,top:Math.min(c[1],u[1])-a/2,width:Math.abs(c[0]-u[0])+a,height:Math.abs(c[1]-u[1])+a},f=this._pointInEllipseCanvas(g,n);return!(!this._pointInEllipseCanvas(v,n)||f)},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const i=(0,w.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:i,movingTextBox:!1},(0,O.hideElementCursor)(a),this._activateModify(a);const s=(0,o.ZP)(a),{renderingEngine:d}=s;(0,b.Z)(d,i),t.preventDefault()},this.handleSelectedCallback=(t,e,n)=>{const a=t.detail,{element:i}=a,{data:s}=e;e.highlighted=!0;let d,r,l,h,c,u=!1;if(n.worldPosition)u=!0;else{const{points:t}=s.handles,e=(0,o.ZP)(i),{worldToCanvas:a}=e.viewport;d=t.findIndex((t=>t===n));const u=t.map(a);c=u[d],l=Math.abs(u[2][0]-u[3][0]),h=Math.abs(u[0][1]-u[1][1]),r=[(u[2][0]+u[3][0])/2,(u[0][1]+u[1][1])/2]}const g=(0,w.Z)(i,this.getToolName());this.editData={annotation:e,viewportIdsToRender:g,handleIndex:d,canvasWidth:l,canvasHeight:h,centerCanvas:r,originalHandleCanvas:c,movingTextBox:u},this._activateModify(i),(0,O.hideElementCursor)(i);const v=(0,o.ZP)(i),{renderingEngine:f}=v;(0,b.Z)(f,g),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:i,newAnnotation:r,hasMoved:l}=this.editData,{data:h}=a;if(r&&!l)return;a.highlighted=!1,h.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,O.resetElementCursor)(n);const c=(0,o.ZP)(n),{renderingEngine:g}=c;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,u.removeAnnotation)(a.annotationUID),(0,b.Z)(g,i),r){const t=D.default.ANNOTATION_COMPLETED,e={annotation:a};(0,s.Z)(d.Z,t,e)}},this._dragDrawCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{currentPoints:a}=e,i=a.canvas,s=(0,o.ZP)(n),{renderingEngine:d,viewport:r}=s,{canvasToWorld:l}=r,{annotation:h,viewportIdsToRender:c,centerCanvas:u}=this.editData,{data:g}=h,v=Math.abs(i[0]-u[0]),f=Math.abs(i[1]-u[1]),C=[u[0],u[1]-f],m=[u[0],u[1]+f],p=[u[0]-v,u[1]],E=[u[0]+v,u[1]];g.handles.points=[l(C),l(m),l(p),l(E)],h.invalidated=!0,this.editData.hasMoved=!0,(0,b.Z)(d,c)},this._dragModifyCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:i,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else this._dragHandle(t),a.invalidated=!0;const l=(0,o.ZP)(n),{renderingEngine:h}=l;(0,b.Z)(h,i)},this._dragHandle=t=>{const e=t.detail,{element:n}=e,a=(0,o.ZP)(n),{canvasToWorld:i}=a.viewport,{annotation:s,canvasWidth:d,canvasHeight:r,handleIndex:l,centerCanvas:h,originalHandleCanvas:c}=this.editData,{data:u}=s,{points:g}=u.handles,{currentPoints:v}=e,f=v.canvas;if(0===l||1===l){const t=Math.abs(f[1]-h[1]),e=[h[0],h[1]-t],n=[h[0],h[1]+t];g[0]=i(e),g[1]=i(n);const a=d/2+(f[0]-c[0]),o=[h[0]-a,h[1]],s=[h[0]+a,h[1]];g[2]=i(o),g[3]=i(s)}else{const t=Math.abs(f[0]-h[0]),e=[h[0]-t,h[1]],n=[h[0]+t,h[1]];g[2]=i(e),g[3]=i(n);const a=r/2+(f[1]-c[1]),o=[h[0],h[1]-a],s=[h[0],h[1]+a];g[0]=i(o),g[1]=i(s)}},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,O.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:a}=this.editData,{data:i}=e;e.highlighted=!1,i.handles.activeHandleIndex=null;const r=(0,o.ZP)(t),{renderingEngine:l}=r;if((0,b.Z)(l,n),a){const t=D.default.ANNOTATION_COMPLETED,n={annotation:e};(0,s.Z)(d.Z,t,n)}return this.editData=null,e.annotationUID}},this._activateModify=t=>{E.ZP.isInteractingWithTool=!0,t.addEventListener(D.default.MOUSE_UP,this._endCallback),t.addEventListener(D.default.MOUSE_DRAG,this._dragModifyCallback),t.addEventListener(D.default.MOUSE_CLICK,this._endCallback),t.addEventListener(D.default.TOUCH_END,this._endCallback),t.addEventListener(D.default.TOUCH_DRAG,this._dragModifyCallback),t.addEventListener(D.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=t=>{E.ZP.isInteractingWithTool=!1,t.removeEventListener(D.default.MOUSE_UP,this._endCallback),t.removeEventListener(D.default.MOUSE_DRAG,this._dragModifyCallback),t.removeEventListener(D.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(D.default.TOUCH_END,this._endCallback),t.removeEventListener(D.default.TOUCH_DRAG,this._dragModifyCallback),t.removeEventListener(D.default.TOUCH_TAP,this._endCallback)},this._activateDraw=t=>{E.ZP.isInteractingWithTool=!0,t.addEventListener(D.default.MOUSE_UP,this._endCallback),t.addEventListener(D.default.MOUSE_DRAG,this._dragDrawCallback),t.addEventListener(D.default.MOUSE_MOVE,this._dragDrawCallback),t.addEventListener(D.default.MOUSE_CLICK,this._endCallback),t.addEventListener(D.default.TOUCH_END,this._endCallback),t.addEventListener(D.default.TOUCH_DRAG,this._dragDrawCallback),t.addEventListener(D.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=t=>{E.ZP.isInteractingWithTool=!1,t.removeEventListener(D.default.MOUSE_UP,this._endCallback),t.removeEventListener(D.default.MOUSE_DRAG,this._dragDrawCallback),t.removeEventListener(D.default.MOUSE_MOVE,this._dragDrawCallback),t.removeEventListener(D.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(D.default.TOUCH_END,this._endCallback),t.removeEventListener(D.default.TOUCH_DRAG,this._dragDrawCallback),t.removeEventListener(D.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,u.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const c=o[i],{annotationUID:u,data:E}=c,{handles:D}=E,{points:w,activeHandleIndex:_}=D;h.annotationUID=u;const x=this.getStyle("lineWidth",h,c),O=this.getStyle("lineDash",h,c),b=this.getStyle("color",h,c),M=w.map((t=>a.worldToCanvas(t))),P=Math.abs(a.getRotation()-(E.initialRotation||0));let Z;Z=90==P||270==P?(0,I.Z)([M[2],M[3],M[0],M[1]]):(0,I.Z)(M);const{centerPointRadius:L}=this.configuration;if(E.cachedStats[s]&&void 0!==E.cachedStats[s].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,a,d,t),a instanceof r.Z)){const{referencedImageId:t}=c.metadata;for(const e in E.cachedStats)if(e.startsWith("imageId")){d.getStackViewports().find((e=>{const n=l.Z(t),a=e.hasImageURI(n),i=l.Z(e.getCurrentImageId());return a&&i!==n}))&&delete E.cachedStats[e]}}}else E.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(c,a,d,t);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let S;if(!(0,v.isAnnotationVisible)(u))continue;if((0,g.isAnnotationLocked)(c)||this.editData||null===_||(S=[M[_]]),S){const t="0";(0,f.Z)(e,u,t,S,{color:b})}const k=`${u}-ellipse`,A="0";if((0,C.Z)(e,u,A,Z[0],Z[1],{color:b,lineDash:O,lineWidth:x},k),L>0){if(Math.min(Math.abs(Z[0][0]-Z[1][0])/2,Math.abs(Z[0][1]-Z[1][1])/2)>3*L){const t=this._getCanvasEllipseCenter(M);(0,m.Z)(e,u,`${A}-center`,t,L,{color:b,lineDash:O,lineWidth:x})}}n=!0;const y=(0,U.P)(a,s),N=this.isSuvScaled(a,s,c.metadata.referencedImageId),R=this._getTextLines(E,s,y,N);if(!R||0===R.length)continue;let H;E.handles.textBox.hasMoved||(H=(0,T.Z)(Z),E.handles.textBox.worldPosition=a.canvasToWorld(H));const W=a.worldToCanvas(E.handles.textBox.worldPosition),B="1",F=(0,p.Z)(e,u,B,R,W,M,{},this.getLinkedTextBoxStyle(h,c)),{x:G,y:$,width:K,height:V}=F;E.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([G,$]),topRight:a.canvasToWorld([G+K,$]),bottomLeft:a.canvasToWorld([G,$+V]),bottomRight:a.canvasToWorld([G+K,$+V])}}return n},this._getTextLines=(t,e,n,a)=>{const i=t.cachedStats[e],{area:o,mean:s,stdDev:d,max:r,isEmptyArea:l,Modality:h,areaUnit:c}=i,u=[],g=(0,P.F)(h,n,a);if(o){const t=l?"Area: Oblique not supported":`Area: ${o.toFixed(2)} ${c}²`;u.push(t)}return s&&u.push(`Mean: ${s.toFixed(2)} ${g}`),r&&u.push(`Max: ${r.toFixed(2)} ${g}`),d&&u.push(`Std Dev: ${d.toFixed(2)} ${g}`),u},this._calculateCachedStats=(t,e,n,a)=>{const i=t.data,{viewportId:o,renderingEngineId:r}=a,{points:l}=i.handles,h=l.map((t=>e.worldToCanvas(t))),{viewPlaneNormal:c,viewUp:u}=e.getCamera(),[g,v]=(0,I.Z)(h),f=e.canvasToWorld(g),C=e.canvasToWorld(v),{cachedStats:m}=i,p=Object.keys(m),E=f,w=C;for(let t=0;t<p.length;t++){const e=p[t],a=this.getTargetIdImage(e,n);if(!a)continue;const{dimensions:i,imageData:o,metadata:s,hasPixelSpacing:d}=a,r=Z(o,E);r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r[2]=Math.floor(r[2]);const l=Z(o,w);if(l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l[2]=Math.floor(l[2]),this._isInsideVolume(r,l,i)){const t=[[Math.min(r[0],l[0]),Math.max(r[0],l[0])],[Math.min(r[1],l[1]),Math.max(r[1],l[1])],[Math.min(r[2],l[2]),Math.max(r[2],l[2])]],n={center:[(f[0]+C[0])/2,(f[1]+C[1])/2,(f[2]+C[2])/2],xRadius:Math.abs(f[0]-C[0])/2,yRadius:Math.abs(f[1]-C[1])/2,zRadius:Math.abs(f[2]-C[2])/2},{worldWidth:a,worldHeight:i}=(0,_.Z)(c,u,E,w),h=0===a&&0===i,g=Math.abs(Math.PI*(a/2)*(i/2));let v=0,p=0,D=0,T=-1/0;const I=({value:t})=>{t>T&&(T=t),p+=t,v+=1};(0,M.Z)(o,((t,e)=>(0,x.Z)(n,t)),I,t),p/=v;const O=({value:t})=>{const e=t-p;D+=e*e};(0,M.Z)(o,((t,e)=>(0,x.Z)(n,t)),O,t),D/=v,D=Math.sqrt(D),m[e]={Modality:s.Modality,area:g,mean:p,max:T,stdDev:D,isEmptyArea:h,areaUnit:d?"mm":"px"}}else this.isHandleOutsideImage=!0,m[e]={Modality:s.Modality}}t.invalidated=!1;const T=D.default.ANNOTATION_MODIFIED,O={annotation:t,viewportId:o,renderingEngineId:r};return(0,s.Z)(d.Z,T,O),m},this._isInsideVolume=(t,e,n)=>h.Z(t,n)&&h.Z(e,n),this._throttledCalculateCachedStats=(0,c.Z)(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(t,e){const n=t.width/2,a=t.height/2;if(n<=0||a<=0)return!1;const i=[t.left+n,t.top+a],o=[e[0]-i[0],e[1]-i[1]];return o[0]*o[0]/(n*n)+o[1]*o[1]/(a*a)<=1}_getCanvasEllipseCenter(t){const[e,n,a,i]=t,o=[a[0],n[1]],s=[i[0],e[1]];return[(o[0]+s[0])/2,(o[1]+s[1])/2]}}L.toolName="EllipticalROI";const S=L},37398:(t,e,n)=>{n.d(e,{Z:()=>x});var a=n(69786),i=n(27054),o=n(96720),s=n(97335),d=n(509),r=n(34894),l=n(78266),h=n(41509),c=n(7576),u=n(80686),g=n(15849),v=n(43876),f=n(80084),C=n(55742),m=n(82853),p=n(40622),E=n(11207),D=n(52857),w=n(43356),T=n(23222);const{transformWorldToIndex:_}=i;class I extends l.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(t,e),this.addNewAnnotation=t=>{const e=t.detail,{currentPoints:n,element:a}=e,i=n.world,s=(0,o.ZP)(a),{viewport:d,renderingEngine:r}=s;(0,T.hideElementCursor)(a),this.isDrawing=!0;const l=d.getCamera(),{viewPlaneNormal:h,viewUp:u}=l,g=this.getReferencedImageId(d,i,h,u),v=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...u],FrameOfReferenceUID:v,referencedImageId:g},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,c.addAnnotation)(f,a);const C=(0,E.Z)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:C,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),t.preventDefault(),(0,w.Z)(r,C),f},this.isPointNearTool=(t,e,n,a)=>{const i=(0,o.ZP)(t),{viewport:s}=i,{data:d}=e,[r,l]=d.handles.points,h=s.worldToCanvas(r),c=s.worldToCanvas(l),u={start:{x:h[0],y:h[1]},end:{x:c[0],y:c[1]}};return v.Z([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=a},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n;e.highlighted=!0;const i=(0,E.Z)(a,this.getToolName());this.editData={annotation:e,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(a),(0,T.hideElementCursor)(a);const s=(0,o.ZP)(a),{renderingEngine:d}=s;(0,w.Z)(d,i),t.preventDefault()},this._endCallback=t=>{const e=t.detail,{element:n}=e,{annotation:i,viewportIdsToRender:r,newAnnotation:l,hasMoved:h}=this.editData,{data:u}=i;if(l&&!h)return;u.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,T.resetElementCursor)(n);const g=(0,o.ZP)(n),{renderingEngine:v}=g;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,c.removeAnnotation)(i.annotationUID),(0,w.Z)(v,r),l){const t=a.default.ANNOTATION_COMPLETED,e={annotation:i};(0,s.Z)(d.Z,t,e)}this.editData=null,this.isDrawing=!1},this._dragCallback=t=>{this.isDrawing=!0;const e=t.detail,{element:n}=e,{annotation:a,viewportIdsToRender:i,handleIndex:s,movingTextBox:d}=this.editData,{data:r}=a;if(d){const{deltaPoints:t}=e,n=t.world,{textBox:a}=r.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else if(void 0===s){const{deltaPoints:t}=e,n=t.world;r.handles.points.forEach((t=>{t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]})),a.invalidated=!0}else{const{currentPoints:t}=e,n=t.world;r.handles.points[s]=[...n],a.invalidated=!0}this.editData.hasMoved=!0;const l=(0,o.ZP)(n),{renderingEngine:h}=l;(0,w.Z)(h,i)},this.cancel=t=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(t),this._deactivateModify(t),(0,T.resetElementCursor)(t);const{annotation:e,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:r}=e;e.highlighted=!1,r.handles.activeHandleIndex=null;const l=(0,o.ZP)(t),{renderingEngine:h}=l;if((0,w.Z)(h,n),i){const t=a.default.ANNOTATION_COMPLETED,n={annotation:e};(0,s.Z)(d.Z,t,n)}return this.editData=null,e.annotationUID}},this._activateModify=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback)},this._activateDraw=t=>{p.ZP.isInteractingWithTool=!0,t.addEventListener(a.default.MOUSE_UP,this._endCallback),t.addEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.addEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.addEventListener(a.default.MOUSE_CLICK,this._endCallback),t.addEventListener(a.default.TOUCH_END,this._endCallback),t.addEventListener(a.default.TOUCH_DRAG,this._dragCallback),t.addEventListener(a.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=t=>{p.ZP.isInteractingWithTool=!1,t.removeEventListener(a.default.MOUSE_UP,this._endCallback),t.removeEventListener(a.default.MOUSE_DRAG,this._dragCallback),t.removeEventListener(a.default.MOUSE_MOVE,this._dragCallback),t.removeEventListener(a.default.MOUSE_CLICK,this._endCallback),t.removeEventListener(a.default.TOUCH_END,this._endCallback),t.removeEventListener(a.default.TOUCH_DRAG,this._dragCallback),t.removeEventListener(a.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a}=t,{element:i}=a;let o=(0,c.getAnnotations)(this.getToolName(),i);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return n;const s=this.getTargetId(a),d=a.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let i=0;i<o.length;i++){const l=o[i],{annotationUID:h,data:c}=l,{points:v,activeHandleIndex:p}=c.handles;r.annotationUID=h;const E=this.getStyle("lineWidth",r,l),w=this.getStyle("lineDash",r,l),T=this.getStyle("color",r,l),_=this.getStyle("shadow",r,l),I=v.map((t=>a.worldToCanvas(t)));let x;if(c.cachedStats[s]&&void 0!==c.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,d,t):(c.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(l,d,t)),!(0,g.isAnnotationVisible)(h))continue;if((0,u.isAnnotationLocked)(l)||this.editData||null===p||(x=[I[p]]),x){const t="0";(0,f.Z)(e,h,t,I,{color:T,lineDash:w,lineWidth:E})}const O=`${h}-line`,b="1";if((0,C.Z)(e,h,b,I[0],I[1],{color:T,width:E,lineDash:w,shadow:_},O),n=!0,!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const M=this._getTextLines(c,s);if(!c.handles.textBox.hasMoved){const t=(0,D.Z)(I);c.handles.textBox.worldPosition=a.canvasToWorld(t)}const P=a.worldToCanvas(c.handles.textBox.worldPosition),U="1",Z=(0,m.Z)(e,h,U,M,P,I,{},this.getLinkedTextBoxStyle(r,l)),{x:L,y:S,width:k,height:A}=Z;c.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([L,S]),topRight:a.canvasToWorld([L+k,S]),bottomLeft:a.canvasToWorld([L,S+A]),bottomRight:a.canvasToWorld([L+k,S+A])}}return n},this._throttledCalculateCachedStats=(0,h.Z)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(t,e,n){const a=t.detail,{element:i}=a,{data:s}=e;e.highlighted=!0;let d,r=!1;n.worldPosition?r=!0:d=s.handles.points.findIndex((t=>t===n));const l=(0,E.Z)(i,this.getToolName());this.editData={annotation:e,viewportIdsToRender:l,handleIndex:d,movingTextBox:r},this._activateModify(i),(0,T.hideElementCursor)(i);const h=(0,o.ZP)(i),{renderingEngine:c}=h;(0,w.Z)(c,l),t.preventDefault()}_getTextLines(t,e){const n=t.cachedStats[e],{length:a,unit:i}=n;if(null==a||isNaN(a))return;return[`${a.toFixed(2)} ${i}`]}_calculateLength(t,e){const n=t[0]-e[0],a=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+a*a+i*i)}_calculateCachedStats(t,e,n){const i=t.data,{viewportId:o,renderingEngineId:r}=n,l=i.handles.points[0],h=i.handles.points[1],{cachedStats:c}=i,u=Object.keys(c);for(let t=0;t<u.length;t++){const n=u[t],a=this.getTargetIdImage(n,e);if(!a)continue;const{imageData:i,dimensions:o,hasPixelSpacing:s}=a,d=this._calculateLength(l,h),r=_(i,l),g=_(i,h);this._isInsideVolume(r,g,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:d,unit:s?"mm":"px"}}t.invalidated=!1;const g=a.default.ANNOTATION_MODIFIED,v={annotation:t,viewportId:o,renderingEngineId:r};return(0,s.Z)(d.Z,g,v),c}_isInsideVolume(t,e,n){return r.Z(t,n)&&r.Z(e,n)}}I.toolName="Length";const x=I},44554:(t,e,n)=>{n.d(e,{Z:()=>te});var a=n(82338),i=n(96720),o=n(97335),s=n(509),d=n(68782),r=n(12145),l=n(75089),h=n(75454),c=n(6807),u=n(69786),g=n(78266),v=n(7576),f=n(3097),C=n(34323),m=n(52698),p=n(41509),E=n(11207),D=n(43356),w=n(23222),T=n(40622),_=n(65231),I=n(86119);function x(t){return!0===t?.interpolation?.interpolateOnAdd||!0===t?.interpolation?.interpolateOnEdit}function O(t,e,n){return(t+e+n)%e}function b(t,e,n,a){const[,i,o]=t,[,s,d]=e,r=o.length,l=d.length;let h=t[0],c=e[0];if(!(o[h]&&d[c]&&o[i]&&d[s]))return[void 0,void 0];for(;h!==i&&c!==s;){if(n(d[c],o[h]))return[h,c];h=O(h,r,a),c=O(c,l,a)}return[void 0,void 0]}function M(t,e){const[n,a]=function(t,e){for(let i=0;i<t.length;i++)for(let o=0;o<e.length;o++)if(n=t[i],a=e[o],0===_.Z(n,a))return[i,o];var n,a}(t,e)||[],i=(t,e)=>!1===function(t,e){return _.Z(t,e)<.001}(t,e),[o,s]=b([O(n,t.length,1),n,t],[O(a,e.length,1),a,e],i,1),[d]=b([O(o,t.length,-1),o,t],[O(s,e.length,-1),s,e],i,-1);return[o,d]}function P(t,e,n){const{interpolation:a}=t,i=e;if(a){const{knotsRatioPercentageOnAdd:t,knotsRatioPercentageOnEdit:i,interpolateOnAdd:o=!1,interpolateOnEdit:s=!1}=a,d=n?i:t;if(n?s:o){const[t,a]=n?M(e,n):[0,e.length-1];return e[t]&&e[a]?(0,I.Z)(e,t,a,d):e}}return i}var U=n(91055);function Z(t,e){const n=t[0],a=t[t.length-1],i=U.Ue();U.t8(i,a[0]-n[0],a[1]-n[1]),U.Fv(i,i);const o=U.Ue(),s=U.Ue();U.t8(o,-i[1],i[0]),U.t8(s,i[1],-i[0]);const d=[(n[0]+a[0])/2,(n[1]+a[1])/2],r={dist:0,index:null};for(let e=0;e<t.length;e++){const n=t[e],a=U.TK(n,d);a>r.dist&&(r.dist=a,r.index=e)}return[t[r.index],d].map(e.canvasToWorld)}const{addCanvasPointsToArray:L,pointsAreWithinCloseContourProximity:S,getFirstIntersectionWithPolyline:k,getSubPixelSpacingAndXYDirections:A}=f;function y(t,e,n){this.isDrawing=!0;const a=t.detail,{currentPoints:o,element:s}=a,d=o.canvas,r=(0,i.ZP)(s),{viewport:l}=r,{spacing:h,xDir:c,yDir:g}=A(l,this.configuration.subPixelResolution);this.drawData={canvasPoints:[d],polylineIndex:0},this.commonData={annotation:e,viewportIdsToRender:n,spacing:h,xDir:c,yDir:g,movingTextBox:!1},T.ZP.isInteractingWithTool=!0,s.addEventListener(u.default.MOUSE_UP,this.mouseUpDrawCallback),s.addEventListener(u.default.MOUSE_DRAG,this.mouseDragDrawCallback),s.addEventListener(u.default.MOUSE_CLICK,this.mouseUpDrawCallback),s.addEventListener(u.default.TOUCH_END,this.mouseUpDrawCallback),s.addEventListener(u.default.TOUCH_DRAG,this.mouseDragDrawCallback),s.addEventListener(u.default.TOUCH_TAP,this.mouseUpDrawCallback),(0,w.hideElementCursor)(s)}function N(t){T.ZP.isInteractingWithTool=!1,t.removeEventListener(u.default.MOUSE_UP,this.mouseUpDrawCallback),t.removeEventListener(u.default.MOUSE_DRAG,this.mouseDragDrawCallback),t.removeEventListener(u.default.MOUSE_CLICK,this.mouseUpDrawCallback),t.removeEventListener(u.default.TOUCH_END,this.mouseUpDrawCallback),t.removeEventListener(u.default.TOUCH_DRAG,this.mouseDragDrawCallback),t.removeEventListener(u.default.TOUCH_TAP,this.mouseUpDrawCallback),(0,w.resetElementCursor)(t)}function R(t){const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=n.canvas,d=(0,i.ZP)(a),{renderingEngine:r,viewport:l}=d,{annotation:h,viewportIdsToRender:u,xDir:g,yDir:v,spacing:f,movingTextBox:C}=this.commonData,{polylineIndex:m,canvasPoints:p}=this.drawData,E=p[p.length-1],w=l.canvasToWorld(E),T=c.create();c.subtract(T,o,w);const _=Math.abs(c.dot(T,g)),I=Math.abs(c.dot(T,v));if(!(_<=f[0]&&I<=f[1])){if(C){this.isDrawing=!1;const{deltaPoints:t}=e,n=t.world,{textBox:a}=h.data.handles,{worldPosition:i}=a;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],a.hasMoved=!0}else{const e=this.findCrossingIndexDuringCreate(t);if(void 0!==e)this.applyCreateOnCross(t,e);else{const t=L(a,p,s,this.commonData);this.drawData.polylineIndex=m+t}}(0,D.Z)(r,u)}}function H(t){const{allowOpenContours:e}=this.configuration,{canvasPoints:n}=this.drawData,a=n[0],i=n[n.length-1],o=t.detail,{element:s}=o;e&&!S(a,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(s):this.completeDrawClosedContour(s)}function W(t){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:e}=this.drawData;if(this.haltDrawing(t,e))return!1;const{annotation:n,viewportIdsToRender:a}=this.commonData,o=(0,i.ZP)(t),{viewport:s,renderingEngine:d}=o;L(t,e,e[0],this.commonData),e.pop();const r=(x(this.configuration)?P(this.configuration,e):e).map((t=>s.canvasToWorld(t)));return n.data.polyline=r,n.data.isOpenContour=!1,this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,D.Z)(d,a),this.deactivateDraw(t),!0}function B(){const{canvasPoints:t}=this.drawData,e=t.length,n=[t[0],t[e-1]],a=t.slice(0,-1).slice(1),i=k(a,n[0],n[1],!1);if(i){const e=i[1];this.drawData.canvasPoints=t.splice(0,e)}}function F(t){const{canvasPoints:e}=this.drawData;if(this.haltDrawing(t,e))return!1;const{annotation:n,viewportIdsToRender:a}=this.commonData,o=(0,i.ZP)(t),{viewport:s,renderingEngine:d}=o,r=(x(this.configuration)?P(this.configuration,e):e).map((t=>s.canvasToWorld(t)));return n.data.polyline=r,n.data.isOpenContour=!0,n.data.handles.points=[r[0],r[r.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=Z(e,s)),this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,D.Z)(d,a),this.deactivateDraw(t),!0}function G(t){const e=t.detail,{currentPoints:n,lastPoints:a}=e,i=n.canvas,o=a.canvas,{canvasPoints:s}=this.drawData,d=s.slice(0,-1),r=k(d,i,o,!1);if(void 0===r)return;return r[0]}function $(t,e){const n=t.detail,{element:a}=n,{canvasPoints:i}=this.drawData,{annotation:o,viewportIdsToRender:s}=this.commonData;L(a,i,i[e],this.commonData),i.pop();for(let t=0;t<e;t++)i.shift();this.completeDrawClosedContour(a)&&this.activateClosedContourEdit(t,o,s)}function K(t){const{allowOpenContours:e}=this.configuration,{canvasPoints:n}=this.drawData,a=n[0],i=n[n.length-1];e&&!S(a,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(t):this.completeDrawClosedContour(t)}function V(t,e){const{subPixelResolution:n}=this.configuration;if(function(t,e){const n=Math.max(3*e,3);return t.length<n}(e,n)){const{annotation:e,viewportIdsToRender:n}=this.commonData,a=(0,i.ZP)(t),{renderingEngine:o}=a;return(0,v.removeAnnotation)(e.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,D.Z)(o,n),this.deactivateDraw(t),!0}return!1}const q=function(t){t.activateDraw=y.bind(t),t.deactivateDraw=N.bind(t),t.applyCreateOnCross=$.bind(t),t.findCrossingIndexDuringCreate=G.bind(t),t.completeDrawOpenContour=F.bind(t),t.removeCrossedLinesOnCompleteDraw=B.bind(t),t.mouseDragDrawCallback=R.bind(t),t.mouseUpDrawCallback=H.bind(t),t.completeDrawClosedContour=W.bind(t),t.cancelDrawing=K.bind(t),t.haltDrawing=V.bind(t)},{addCanvasPointsToArray:Y,getFirstIntersectionWithPolyline:j}=f;function X(t,e){const n=t.detail,{element:a,currentPoints:i,lastPoints:o}=n,s=i.canvas,d=o.canvas,{editCanvasPoints:r,prevCanvasPoints:l}=this.editData,h=j(l,s,d,e);if(h)this.editData.startCrossingIndex=h[0],this.removePointsUpUntilFirstCrossing(e);else if(l.length>=2)if(r.length>this.configuration.checkCanvasEditFallbackProximity){const t=r[0],e=[];for(let n=0;n<l.length;n++){const a=l[n],i=U.TE(a,t);e.push({distance:i,index:n})}e.sort(((t,e)=>t.distance-e.distance));const n=[e[0],e[1]],a=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=a}else{const t=U.Ue();U.$X(t,r[1],r[0]),U.Fv(t,t);const n=6,i=[r[0][0]-t[0]*n,r[0][1]-t[1]*n],o=j(l,i,r[0],e);if(o){const t=[i];Y(a,t,r[0],this.commonData),r.unshift(...t),this.removePointsUpUntilFirstCrossing(e),this.editData.editIndex=r.length-1,this.editData.startCrossingIndex=o[0]}}}function z(t){const{editCanvasPoints:e,prevCanvasPoints:n}=this.editData;let a=0;for(let i=0;i<e.length-1;i++){const o=[e[i],e[i+1]];if(a++,!!j(n,o[0],o[1],t))break}e.splice(0,a),this.editData.editIndex=e.length-1}function J(t,e){const n=t.detail,{currentPoints:a,lastPoints:i}=n,o=a.canvas,s=i.canvas,{prevCanvasPoints:d}=this.editData;return!!j(d,o,s,e)}function Q(t){const{prevCanvasPoints:e,editCanvasPoints:n}=this.editData;for(let a=n.length-1;a>0;a--){const i=[n[a],n[a-1]],o=!!j(e,i[0],i[1],t);if(n.pop(),o)break}}function tt(){const{editCanvasPoints:t,prevCanvasPoints:e,startCrossingIndex:n}=this.editData;if(void 0===n)return;const a=t[t.length-1],i=[];for(let t=0;t<e.length;t++){const n=e[t],o=U.TE(n,a);i.push({distance:o,index:t})}i.sort(((t,e)=>t.distance-e.distance));const o=t.slice(0,-1);for(let n=0;n<i.length;n++){const{index:a}=i[n],s=e[a],d=t[t.length-1];if(!j(o,s,d,!1))return a}return-1}function et(t){const e=t.detail,{currentPoints:n,lastPoints:a}=e,i=n.canvas,o=a.canvas,{editCanvasPoints:s}=this.editData,d=s.slice(0,-2),r=j(d,i,o,!1);if(!r)return;const l=r[0],h=s.length-l;for(let t=0;t<h;t++)s.pop()}const nt=function(t){t.checkForFirstCrossing=X.bind(t),t.removePointsUpUntilFirstCrossing=z.bind(t),t.checkForSecondCrossing=J.bind(t),t.findSnapIndex=tt.bind(t),t.removePointsAfterSecondCrossing=Q.bind(t),t.checkAndRemoveCrossesOnEditLine=et.bind(t)},{getSubPixelSpacingAndXYDirections:at,addCanvasPointsToArray:it,calculateAreaOfPoints:ot}=f;function st(t,e,n){this.isEditingClosed=!0;const a=t.detail,{currentPoints:o,element:s}=a,d=o.canvas,r=(0,i.ZP)(s),{viewport:l}=r,h=e.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:g,yDir:v}=at(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:h,editCanvasPoints:[d],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:e,viewportIdsToRender:n,spacing:c,xDir:g,yDir:v,movingTextBox:!1},T.ZP.isInteractingWithTool=!0,s.addEventListener(u.default.MOUSE_UP,this.mouseUpClosedContourEditCallback),s.addEventListener(u.default.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),s.addEventListener(u.default.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),s.addEventListener(u.default.TOUCH_END,this.mouseUpClosedContourEditCallback),s.addEventListener(u.default.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),s.addEventListener(u.default.TOUCH_TAP,this.mouseUpClosedContourEditCallback),(0,w.hideElementCursor)(s)}function dt(t){T.ZP.isInteractingWithTool=!1,t.removeEventListener(u.default.MOUSE_UP,this.mouseUpClosedContourEditCallback),t.removeEventListener(u.default.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),t.removeEventListener(u.default.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),t.removeEventListener(u.default.TOUCH_END,this.mouseUpClosedContourEditCallback),t.removeEventListener(u.default.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),t.removeEventListener(u.default.TOUCH_TAP,this.mouseUpClosedContourEditCallback),(0,w.resetElementCursor)(t)}function rt(t){const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=n.canvas,d=(0,i.ZP)(a),{renderingEngine:r,viewport:l}=d,{viewportIdsToRender:h,xDir:u,yDir:g,spacing:v}=this.commonData,{editIndex:f,editCanvasPoints:C,startCrossingIndex:m}=this.editData,p=C[C.length-1],E=l.canvasToWorld(p),w=c.create();c.subtract(w,o,E);const T=Math.abs(c.dot(w,u)),_=Math.abs(c.dot(w,g));if(T<=v[0]&&_<=v[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(t);const I=f+it(a,C,s,this.commonData);this.editData.editIndex=I,void 0===m&&C.length>1&&this.checkForFirstCrossing(t,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(t),void 0!==m&&this.checkForSecondCrossing(t,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(t)),(0,D.Z)(r,h)):this.finishEditAndStartNewEdit(t)}function lt(t){const e=t.detail,{element:n}=e,a=(0,i.ZP)(n),{viewport:o,renderingEngine:s}=a,{annotation:d,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:h}=this.editData,c=l.map((t=>o.canvasToWorld(t)));d.data.polyline=c,d.data.isOpenContour=!1,this.triggerAnnotationModified(d,a);const u=h.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[u],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},(0,D.Z)(s,r)}function ht(t){const{prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a,snapIndex:i}=this.editData;if(void 0===a||void 0===i)return;const o=t.detail,{element:s}=o,d=[...n];let r,l;it(s,d,e[i],this.commonData),d.length>n.length&&d.pop(),a>i?(r=i,l=a):(r=a,l=i);const h=U.TE(e[r],d[0]),c=U.TE(e[r],d[d.length-1]),u=U.TE(e[l],d[0]),g=U.TE(e[l],d[d.length-1]),v=[];for(let t=0;t<r;t++){const n=e[t];v.push([n[0],n[1]])}let f=h+g,C=c+u;if(f<C)for(let t=0;t<d.length;t++){const e=d[t];v.push([e[0],e[1]])}else for(let t=d.length-1;t>=0;t--){const e=d[t];v.push([e[0],e[1]])}for(let t=l;t<e.length;t++){const n=e[t];v.push([n[0],n[1]])}const m=[];for(let t=r;t<l;t++){const n=e[t];m.push([n[0],n[1]])}if(f=u+c,C=g+h,f<C)for(let t=0;t<d.length;t++){const e=d[t];m.push([e[0],e[1]])}else for(let t=d.length-1;t>=0;t--){const e=d[t];m.push([e[0],e[1]])}return ot(v)>ot(m)?v:m}function ct(t){const e=t.detail,{element:n}=e;this.completeClosedContourEdit(n)}function ut(t){const e=(0,i.ZP)(t),{viewport:n,renderingEngine:a}=e,{annotation:o,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:d,prevCanvasPoints:r}=this.editData;if(d){const t=(x(this.configuration)?P(this.configuration,d,r):d).map((t=>n.canvasToWorld(t)));o.data.polyline=t,o.data.isOpenContour=!1,this.triggerAnnotationModified(o,e)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,(0,D.Z)(a,s),this.deactivateClosedContourEdit(t)}function gt(t){this.completeClosedContourEdit(t)}const vt=function(t){t.activateClosedContourEdit=st.bind(t),t.deactivateClosedContourEdit=dt.bind(t),t.mouseDragClosedContourEditCallback=rt.bind(t),t.mouseUpClosedContourEditCallback=ct.bind(t),t.finishEditAndStartNewEdit=lt.bind(t),t.fuseEditPointsWithClosedContour=ht.bind(t),t.cancelClosedContourEdit=gt.bind(t),t.completeClosedContourEdit=ut.bind(t)},{addCanvasPointsToArray:ft,getSubPixelSpacingAndXYDirections:Ct}=f;function mt(t,e,n){this.isEditingOpen=!0;const a=t.detail,{currentPoints:o,element:s}=a,d=o.canvas,r=(0,i.ZP)(s),{viewport:l}=r,h=e.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:g,yDir:v}=Ct(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:h,editCanvasPoints:[d],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:e,viewportIdsToRender:n,spacing:c,xDir:g,yDir:v,movingTextBox:!1},T.ZP.isInteractingWithTool=!0,s.addEventListener(u.default.MOUSE_UP,this.mouseUpOpenContourEditCallback),s.addEventListener(u.default.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),s.addEventListener(u.default.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),s.addEventListener(u.default.TOUCH_END,this.mouseUpOpenContourEditCallback),s.addEventListener(u.default.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),s.addEventListener(u.default.TOUCH_TAP,this.mouseUpOpenContourEditCallback),(0,w.hideElementCursor)(s)}function pt(t){T.ZP.isInteractingWithTool=!1,t.removeEventListener(u.default.MOUSE_UP,this.mouseUpOpenContourEditCallback),t.removeEventListener(u.default.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),t.removeEventListener(u.default.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),t.removeEventListener(u.default.TOUCH_END,this.mouseUpOpenContourEditCallback),t.removeEventListener(u.default.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),t.removeEventListener(u.default.TOUCH_TAP,this.mouseUpOpenContourEditCallback),(0,w.resetElementCursor)(t)}function Et(t){const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=n.canvas,d=(0,i.ZP)(a),{renderingEngine:r,viewport:l}=d,{viewportIdsToRender:h,xDir:u,yDir:g,spacing:v}=this.commonData,{editIndex:f,editCanvasPoints:C,startCrossingIndex:m}=this.editData,p=C[C.length-1],E=l.canvasToWorld(p),w=c.create();c.subtract(w,o,E);const T=Math.abs(c.dot(w,u)),_=Math.abs(c.dot(w,g));if(T<=v[0]&&_<=v[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(t);const I=f+ft(a,C,s,this.commonData);this.editData.editIndex=I,void 0===m&&C.length>1&&this.checkForFirstCrossing(t,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(t),void 0!==m&&this.checkForSecondCrossing(t,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(t)):this.checkIfShouldOverwriteAnEnd(t)&&this.openContourEditOverwriteEnd(t),(0,D.Z)(r,h)}function Dt(t){const e=t.detail,{element:n}=e,a=(0,i.ZP)(n),{viewport:o}=a,{annotation:s,viewportIdsToRender:d}=this.commonData,r=this.fuseEditPointsForOpenContourEndEdit().map((t=>o.canvasToWorld(t)));s.data.polyline=r,s.data.isOpenContour=!0,s.data.handles.points=[r[0],r[r.length-1]],s.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(s,a),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(t,s,d,null)}function wt(t){const e=t.detail,{currentPoints:n,lastPoints:a}=e,i=n.canvas,o=a.canvas,{snapIndex:s,prevCanvasPoints:d,startCrossingIndex:r}=this.editData;if(void 0===r||void 0===s)return!1;if(-1===s)return!0;if(0!==s&&s!==d.length-1)return!1;const l=i,h=o,c=d[s],u=U.Ue(),g=U.Ue();U.t8(u,l[0]-h[0],l[1]-h[1]),U.t8(g,l[0]-c[0],l[1]-c[1]);const v=U.AK(u,g),f=Math.sqrt(u[0]*u[0]+u[1]*u[1]),C=Math.sqrt(g[0]*g[0]+g[1]*g[1]);return Math.acos(v/(f*C))<Math.PI/2}function Tt(){const{snapIndex:t,prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a}=this.editData,i=[];if(0===t)for(let t=e.length-1;t>=a;t--){const n=e[t];i.push([n[0],n[1]])}else for(let t=0;t<a;t++){const n=e[t];i.push([n[0],n[1]])}if(U.TE(e[a],n[0])<U.TE(e[a],n[n.length-1]))for(let t=0;t<n.length;t++){const e=n[t];i.push([e[0],e[1]])}else for(let t=n.length-1;t>=0;t--){const e=n[t];i.push([e[0],e[1]])}return i}function _t(t){const{prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a,snapIndex:i}=this.editData;if(void 0===a||void 0===i)return;const o=t.detail,{element:s}=o,d=[...n];let r,l;ft(s,d,e[i],this.commonData),d.length>n.length&&d.pop(),a>i?(r=i,l=a):(r=a,l=i);const h=U.TE(e[r],d[0]),c=U.TE(e[r],d[d.length-1]),u=U.TE(e[l],d[0]),g=U.TE(e[l],d[d.length-1]),v=[];for(let t=0;t<r;t++){const n=e[t];v.push([n[0],n[1]])}if(h+g<c+u)for(let t=0;t<d.length;t++){const e=d[t];v.push([e[0],e[1]])}else for(let t=d.length-1;t>=0;t--){const e=d[t];v.push([e[0],e[1]])}for(let t=l;t<e.length;t++){const n=e[t];v.push([n[0],n[1]])}return v}function It(t){const e=t.detail,{element:n}=e,a=(0,i.ZP)(n),{viewport:o,renderingEngine:s}=a,{annotation:d,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:h}=this.editData,c=l.map((t=>o.canvasToWorld(t)));d.data.polyline=c,d.data.isOpenContour=!0,d.data.handles.points=[c[0],c[c.length-1]],this.triggerAnnotationModified(d,a);const u=h.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[u],startCrossingIndex:void 0,editIndex:0},(0,D.Z)(s,r)}function xt(t){const e=t.detail,{element:n}=e;this.completeOpenContourEdit(n)}function Ot(t){const e=(0,i.ZP)(t),{viewport:n,renderingEngine:a}=e,{annotation:o,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:d,prevCanvasPoints:r}=this.editData;if(d){const t=(x(this.configuration)?P(this.configuration,d,r):d).map((t=>n.canvasToWorld(t)));o.data.polyline=t,o.data.isOpenContour=!0,o.data.handles.points=[t[0],t[t.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=Z(d,n)),this.triggerAnnotationModified(o,e)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,(0,D.Z)(a,s),this.deactivateOpenContourEdit(t)}function bt(t){this.completeOpenContourEdit(t)}const Mt=function(t){t.activateOpenContourEdit=mt.bind(t),t.deactivateOpenContourEdit=pt.bind(t),t.mouseDragOpenContourEditCallback=Et.bind(t),t.mouseUpOpenContourEditCallback=xt.bind(t),t.fuseEditPointsWithOpenContour=_t.bind(t),t.finishEditOpenOnSecondCrossing=It.bind(t),t.checkIfShouldOverwriteAnEnd=wt.bind(t),t.fuseEditPointsForOpenContourEndEdit=Tt.bind(t),t.openContourEditOverwriteEnd=Dt.bind(t),t.cancelOpenContourEdit=bt.bind(t),t.completeOpenContourEdit=Ot.bind(t)},{getSubPixelSpacingAndXYDirections:Pt}=f;function Ut(t,e,n,a){this.isDrawing=!0;const o=t.detail,{element:s}=o,d=(0,i.ZP)(s),{viewport:r}=d,{spacing:l,xDir:h,yDir:c}=Pt(r,this.configuration.subPixelResolution),g=e.data.polyline.map(r.worldToCanvas);0===e.data.handles.activeHandleIndex&&g.reverse();let v=!1;a.worldPosition&&(v=!0),this.drawData={canvasPoints:g,polylineIndex:g.length-1},this.commonData={annotation:e,viewportIdsToRender:n,spacing:l,xDir:h,yDir:c,movingTextBox:v},T.ZP.isInteractingWithTool=!0,s.addEventListener(u.default.MOUSE_UP,this.mouseUpDrawCallback),s.addEventListener(u.default.MOUSE_DRAG,this.mouseDragDrawCallback),s.addEventListener(u.default.MOUSE_CLICK,this.mouseUpDrawCallback),s.addEventListener(u.default.TOUCH_END,this.mouseUpDrawCallback),s.addEventListener(u.default.TOUCH_DRAG,this.mouseDragDrawCallback),s.addEventListener(u.default.TOUCH_TAP,this.mouseUpDrawCallback),(0,w.hideElementCursor)(s)}const Zt=function(t){t.activateOpenContourEndEdit=Ut.bind(t)};var Lt=n(99469),St=n(80084);const{pointsAreWithinCloseContourProximity:kt}=f;function At(t,e){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id,annotationUID:e.annotationUID},a=this.getStyle("lineWidth",n,e),i=this.getStyle("lineDash",n,e),o=this.getStyle("color",n,e);return{color:void 0===o?void 0:o,width:void 0===a?void 0:a,lineDash:void 0===i?void 0:i,connectLastToFirst:!e.data.isOpenContour}}function yt(t,e,n){t?.viewport?.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(!function(t,e){e.data.openUShapeContourVectorToPeak||(e.data.openUShapeContourVectorToPeak=function(t,e){const{viewport:n}=t;return Z(e.data.polyline.map(n.worldToCanvas),n)}(t,e))}(t,n),this.renderOpenUShapedContour(t,e,n)):this.renderOpenContour(t,e,n):this.renderClosedContour(t,e,n))}function Nt(t,e,n){const{viewport:a}=t,i=this._getRenderingOptions(t,n),o=n.data.polyline.map((t=>a.worldToCanvas(t)));(0,Lt.Z)(e,n.annotationUID,"1",o,i)}function Rt(t,e,n){const{viewport:a}=t,i=this._getRenderingOptions(t,n),o=n.data.polyline.map((t=>a.worldToCanvas(t)));(0,Lt.Z)(e,n.annotationUID,"1",o,i);const s=n.data.handles.activeHandleIndex;if(!0===this.configuration.alwaysRenderOpenContourHandles?.enabled){const t=this.configuration.alwaysRenderOpenContourHandles.radius,a="0",d=[o[0],o[o.length-1]];0===s?d.shift():1===s&&d.pop(),(0,St.Z)(e,n.annotationUID,a,d,{color:i.color,handleRadius:t})}if(null!==s){const t="1",a=o[0===s?0:o.length-1];(0,St.Z)(e,n.annotationUID,t,[a],{color:i.color})}}function Ht(t,e,n){const{viewport:a}=t,{polyline:i,openUShapeContourVectorToPeak:o}=n.data;if(this.renderOpenContour(t,e,n),!o)return;const s=a.worldToCanvas(i[0]),d=a.worldToCanvas(i[i.length-1]),r=[a.worldToCanvas(o[0]),a.worldToCanvas(o[1])],l=this._getRenderingOptions(t,n);(0,Lt.Z)(e,n.annotationUID,"first-to-last",[s,d],{color:l.color,width:l.width,connectLastToFirst:!1,lineDash:"2,2"}),(0,Lt.Z)(e,n.annotationUID,"midpoint-to-open-contour",[r[0],r[1]],{color:l.color,width:l.width,connectLastToFirst:!1,lineDash:"2,2"})}function Wt(t,e,n){const a=this._getRenderingOptions(t,n),{allowOpenContours:i}=this.configuration,{canvasPoints:o}=this.drawData;if(a.connectLastToFirst=!1,(0,Lt.Z)(e,n.annotationUID,"1",o,a),i){const t=o[0],i=o[o.length-1];if(kt(t,i,this.configuration.closeContourProximity))(0,Lt.Z)(e,n.annotationUID,"2",[i,t],a);else{const i="0";(0,St.Z)(e,n.annotationUID,i,[t],{color:a.color,handleRadius:2})}}}function Bt(t,e,n){const{fusedCanvasPoints:a}=this.editData;if(void 0===a)return void this.renderClosedContour(t,e,n);const i=this._getRenderingOptions(t,n);(0,Lt.Z)(e,n.annotationUID,"preview-1",a,i)}function Ft(t,e,n){const{fusedCanvasPoints:a}=this.editData;if(void 0===a)return void this.renderOpenContour(t,e,n);const i=this._getRenderingOptions(t,n);(0,Lt.Z)(e,n.annotationUID,"preview-1",a,i)}const Gt=function(t){t.renderContour=yt.bind(t),t.renderClosedContour=Nt.bind(t),t.renderOpenContour=Rt.bind(t),t.renderOpenUShapedContour=Ht.bind(t),t.renderContourBeingDrawn=Wt.bind(t),t.renderClosedContourBeingEdited=Bt.bind(t),t.renderOpenContourBeingEdited=Ft.bind(t),t._getRenderingOptions=At.bind(t)};var $t=n(82853),Kt=n(52857),Vt=n(19068),qt=n(91728),Yt=n(38396),jt=n(1117);const{pointCanProjectOnLine:Xt}=f,{EPSILON:zt}=a,Jt=1-zt;class Qt extends g.Z{constructor(t={},e={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1}}){super(t,e),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=t=>{const e=t.detail,{currentPoints:n,element:a}=e,o=n.world,s=(0,i.ZP)(a),{viewport:d,renderingEngine:r}=s,l=d.getCamera(),{viewPlaneNormal:h,viewUp:c}=l,u=this.getReferencedImageId(d,o,h,c),g=(0,E.Z)(a,this.getToolName()),f=d.getFrameOfReferenceUID(),C={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...h],viewUp:[...c],FrameOfReferenceUID:f,referencedImageId:u,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...o]],label:"",cachedStats:{}}};return(0,v.addAnnotation)(C,a),this.activateDraw(t,C,g),t.preventDefault(),(0,D.Z)(r,g),C},this.handleSelectedCallback=(t,e,n)=>{const a=t.detail,{element:i}=a,o=(0,E.Z)(i,this.getToolName());this.activateOpenContourEndEdit(t,e,o,n)},this.toolSelectedCallback=(t,e)=>{const n=t.detail,{element:a}=n,i=(0,E.Z)(a,this.getToolName());e.data.isOpenContour?this.activateOpenContourEdit(t,e,i):this.activateClosedContourEdit(t,e,i)},this.isPointNearTool=(t,e,n,a)=>{const o=(0,i.ZP)(t),{viewport:s}=o,d=e.data.polyline;let r=s.worldToCanvas(d[0]);for(let t=1;t<d.length;t++){const e=r,i=s.worldToCanvas(d[t]);if(!0===Xt(n,e,i,a))return!0;r=i}if(e.data.isOpenContour)return!1;const l=s.worldToCanvas(d[0]),h=s.worldToCanvas(d[d.length-1]);return!0===Xt(n,l,h,a)},this.cancel=t=>{const e=this.isDrawing,n=this.isEditingOpen,a=this.isEditingClosed;e?this.cancelDrawing(t):n?this.cancelOpenContourEdit(t):a&&this.cancelClosedContourEdit(t)},this.triggerAnnotationModified=(t,e)=>{const{viewportId:n,renderingEngineId:a}=e,i=u.default.ANNOTATION_MODIFIED,d={annotation:t,viewportId:n,renderingEngineId:a};(0,o.Z)(s.Z,i,d)},this.triggerAnnotationCompleted=t=>{const e=u.default.ANNOTATION_COMPLETED,n={annotation:t};(0,o.Z)(s.Z,e,n)},this.renderAnnotation=(t,e)=>{let n=!1;const{viewport:a,renderingEngine:i}=t,{element:o}=a,s=this.getTargetId(a);let d=(0,v.getAnnotations)(this.getToolName(),o);if(!d?.length)return n;if(d=this.filterInteractableAnnotationsForElement(o,d),!d?.length)return n;const r=this.isDrawing,l=this.isEditingOpen,h=this.isEditingClosed;if(r||l||h){const a=this.commonData.annotation.annotationUID;d.forEach((n=>{if(n.annotationUID===a)if(r)this.renderContourBeingDrawn(t,e,n);else if(h)this.renderClosedContourBeingEdited(t,e,n);else{if(!l)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(t,e,n)}else this.renderContour(t,e,n)})),n=!0}else d.forEach((n=>{this.renderContour(t,e,n)}));return this.configuration.calculateStats?(d.forEach((n=>{const o=this.commonData?.annotation.annotationUID;if(n.annotationUID!==o||this.commonData?.movingTextBox){if(!this.commonData?.movingTextBox){const{data:e}=n;e.cachedStats[s]&&void 0!==e.cachedStats[s].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,a,i,t):(e.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,a,i,t))}this._renderStats(n,a,t,e)}})),n):void 0},this._calculateCachedStats=(t,e,n,a)=>{const i=t.data,{cachedStats:o,polyline:s}=i,r=Object.keys(o);for(let t=0;t<r.length;t++){const a=r[t],i=this.getTargetIdImage(a,n);if(!i)continue;const{imageData:l,metadata:h,hasPixelSpacing:c}=i,u=s.map((t=>e.worldToCanvas(t))),g=C.Z(u),v=d.Z(l,s[0]);v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]);let f=v[0],m=v[0],p=v[1],E=v[1],D=v[2],w=v[2];for(let t=1;t<s.length;t++){const e=d.Z(l,s[t]);e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.floor(e[2]),f=Math.min(f,e[0]),m=Math.max(m,e[0]),p=Math.min(p,e[1]),E=Math.max(E,e[1]),D=Math.min(D,e[2]),w=Math.max(w,e[2])}const T=.01*(m-f),_=.01*(E-p),I=.01*(w-D);f=Math.floor(f-T),m=Math.ceil(m+T),p=Math.floor(p-_),E=Math.ceil(E+_),D=Math.floor(D-I),w=Math.ceil(w+I);const x=[[f,m],[p,E],[D,w]],O=l.indexToWorld([m,E,w]),b=e.worldToCanvas(O);let M=0,P=0,U=0,Z=-1/0;const L=({value:t})=>{t>Z&&(Z=t),P+=t,U+=t**2,M+=1};let S=0,k=[],A=0;(0,qt.Z)(l,((t,n)=>{let a=!0;const i=e.worldToCanvas(t);return i[1]!=S&&(A=0,S=i[1],k=(0,Vt.ON)(u,i,[b[0],i[1]]),k.sort((function(t,e){return t[0]===e[0]?0:t[0]<e[0]?-1:1}))),k.length&&i[0]>k[0][0]&&(k.shift(),A++),A%2==0&&(a=!1),a}),L,x);const y=P/M;let N=U/M-y**2;N=Math.sqrt(N),o[a]={Modality:h.Modality,area:g,mean:y,max:Z,stdDev:N,areaUnit:c?"mm":"px"}}return t.invalidated=!1,o},this._renderStats=(t,e,n,a)=>{const i=t.data,o=this.getTargetId(e),s=(0,Yt.P)(e,o),d=this.isSuvScaled(e,o,t.metadata.referencedImageId),r=this._getTextLines(i,o,s,d);if(!r||0===r.length)return;const l=i.polyline.map((t=>e.worldToCanvas(t)));if(!i.handles.textBox.hasMoved){const t=(0,Kt.Z)(l);i.handles.textBox.worldPosition=e.canvasToWorld(t)}const h=e.worldToCanvas(i.handles.textBox.worldPosition),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},u=(0,$t.Z)(a,t.annotationUID??"","1",r,h,l,{},this.getLinkedTextBoxStyle(c,t)),{x:g,y:v,width:f,height:C}=u;i.handles.textBox.worldBoundingBox={topLeft:e.canvasToWorld([g,v]),topRight:e.canvasToWorld([g+f,v]),bottomLeft:e.canvasToWorld([g,v+C]),bottomRight:e.canvasToWorld([g+f,v+C])}},this._getTextLines=(t,e,n,a)=>{const i=t.cachedStats[e],{area:o,mean:s,stdDev:d,max:r,isEmptyArea:l,Modality:h,areaUnit:c}=i,u=[],g=(0,jt.F)(h,n,a);if(o){const t=l?"Area: Oblique not supported":`Area: ${o.toFixed(2)} ${c}²`;u.push(t)}return s&&u.push(`Mean: ${s.toFixed(2)} ${g}`),r&&u.push(`Max: ${r.toFixed(2)} ${g}`),d&&u.push(`Std Dev: ${d.toFixed(2)} ${g}`),u},q(this),nt(this),vt(this),Mt(this),Zt(this),Gt(this),this._throttledCalculateCachedStats=(0,p.Z)(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(t,e){if(!e||!e.length)return;const n=(0,i.ZP)(t),{viewport:a}=n;let o;if(a instanceof r.Z)o=(0,m.Z)(a,e);else{if(!(a instanceof l.Z))throw new Error(`Viewport Type ${a.type} not supported`);{const t=a.getCamera(),{spacingInNormalDirection:n}=h.Z(a,t);o=this.filterAnnotationsWithinSlice(e,t,n)}}return o}filterAnnotationsWithinSlice(t,e,n){const{viewPlaneNormal:a}=e,i=t.filter((t=>{const e=t.metadata.viewPlaneNormal,n=Math.abs(c.dot(a,e))>Jt;return e&&n}));if(!i.length)return[];const o=n/2,{focalPoint:s}=e,d=[];for(const t of i){const e=t.data.polyline[0];if(!t.isVisible)continue;const n=c.create();c.sub(n,s,e);const i=c.dot(n,a);Math.abs(i)<o&&d.push(t)}return d}}Qt.toolName="PlanarFreehandROI";const te=Qt},31603:(t,e,n)=>{n.d(e,{Z:()=>i});var a=n(6807);function i(t,e){const[n,i]=t,[o,s]=e,d=a.sub(a.create(),i,n),r=a.sub(a.create(),o,s),l=a.dot(d,r)/(a.length(d)*a.length(r));return 180*Math.acos(l)/Math.PI}},26562:(t,e,n)=>{function a(t){return"number"==typeof t?t?t<0?-1:1:t==t?0:NaN:NaN}function i(t,e,n,i){const[o,s]=t,[d,r]=e,[l,h]=n,[c,u]=i,g=r-s,v=o-d,f=d*s-o*r,C=g*l+v*h+f,m=g*c+v*u+f;if(0!==C&&0!==m&&a(C)===a(m))return;const p=u-h,E=l-c,D=c*h-l*u,w=p*o+E*s+D,T=p*d+E*r+D;if(0!==w&&0!==T&&a(w)===a(T))return;const _=g*E-p*v;let I;I=v*D-E*f;const x=I/_;I=p*f-g*D;return[x,I/_]}n.d(e,{Z:()=>i})},65231:(t,e,n)=>{function a(t,e){if(2!==t?.length||2!==e?.length)throw Error("points should have 2 elements of [x, y]");const[n,a]=t,[i,o]=e;return Math.sqrt(Math.pow(n-i,2)+Math.pow(a-o,2))}n.d(e,{Z:()=>a})},34323:(t,e,n)=>{function a(t){const e=t.length;let n=0,a=e-1;for(let i=0;i<e;i++)n+=(t[a][0]+t[i][0])*(t[a][1]-t[i][1]),a=i;return Math.abs(n/2)}n.d(e,{Z:()=>a})},19068:(t,e,n)=>{n.d(e,{ON:()=>i,nv:()=>o,wA:()=>s});var a=n(91055);function i(t,e,n,a=!0){const i=[],o=function(t,e,n,a=!0){let i,o;const s=[];a?(o=t.length-1,i=0):(o=0,i=1);for(let a=i;a<t.length;a++)d(e,n,t[o],t[a])&&s.push([o,a]),o=a;return s}(t,e,n,a);for(let a=0;a<o.length;a++){const s=h(e,n,t[o[a][0]],t[o[a][1]]);i.push(s)}return i}function o(t,e,n,a=!0){let i,o;a?(o=t.length-1,i=0):(o=0,i=1);for(let a=i;a<t.length;a++){if(d(e,n,t[o],t[a]))return[o,a];o=a}}function s(t,e,n,i=!0){let o,s;i?(s=t.length-1,o=0):(s=0,o=1);const r=[];for(let a=o;a<t.length;a++){const i=t[s],o=t[a];d(e,n,i,o)&&r.push([s,a]),s=a}if(0===r.length)return;const l=[];r.forEach((n=>{const i=[t[n[0]],t[n[1]]],o=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];l.push(a.TE(o,e))}));const h=Math.min(...l);return{segment:r[l.indexOf(h)],distance:h}}function d(t,e,n,a){let i=!1;const o=[r(t,e,n),r(t,e,a),r(n,a,t),r(n,a,e)];return o[0]!==o[1]&&o[2]!==o[3]||((0===o[0]&&l(t,n,e)||0===o[1]&&l(t,a,e)||0===o[2]&&l(n,t,a)||0===o[3]&&l(n,e,a))&&(i=!0),i)}function r(t,e,n){const a=(e[1]-t[1])*(n[0]-e[0])-(e[0]-t[0])*(n[1]-e[1]);return 0===a?0:a>0?1:2}function l(t,e,n){return e[0]<=Math.max(t[0],n[0])&&e[0]>=Math.min(t[0],n[0])&&e[1]<=Math.max(t[1],n[1])&&e[1]>=Math.min(t[1],n[1])}function h(t,e,n,a){const i=(a[1]-n[1])*(e[0]-t[0])-(a[0]-n[0])*(e[1]-t[1]);if(0==i)return;let o=t[1]-n[1],s=t[0]-n[0];const d=(a[0]-n[0])*o-(a[1]-n[1])*s,r=(e[0]-t[0])*o-(e[1]-t[1])*s;o=d/i,s=r/i;return[t[0]+o*(e[0]-t[0]),t[1]+o*(e[1]-t[1])]}},3097:(t,e,n)=>{n.r(e),n.d(e,{addCanvasPointsToArray:()=>c,calculateAreaOfPoints:()=>g.Z,getClosestIntersectionWithPolyline:()=>a.wA,getFirstIntersectionWithPolyline:()=>a.nv,getSubPixelSpacingAndXYDirections:()=>d,pointCanProjectOnLine:()=>u,pointsAreWithinCloseContourProximity:()=>l});var a=n(19068),i=n(12145),o=n(6807);const s=.001,d=(t,e)=>{let n,a,d;if(t instanceof i.Z){const e=t.getImageData();a=e.direction.slice(0,3),d=e.direction.slice(3,6),n=e.spacing}else{const e=t.getImageData(),{direction:i,spacing:r}=e,{viewPlaneNormal:l,viewUp:h}=t.getCamera(),c=i.slice(0,3),u=i.slice(3,6),g=i.slice(6,9),v=o.create();o.cross(v,h,l);const f=Math.abs(o.dot(v,c)),C=Math.abs(o.dot(v,u)),m=Math.abs(o.dot(v,g));let p;if(Math.abs(1-f)<s)p=r[0],a=c;else if(Math.abs(1-C)<s)p=r[1],a=u;else{if(!(Math.abs(1-m)<s))throw new Error("No support yet for oblique plane planar contours");p=r[2],a=g}const E=Math.abs(o.dot(h,c)),D=Math.abs(o.dot(h,u)),w=Math.abs(o.dot(h,g));let T;if(Math.abs(1-E)<s)T=r[0],d=c;else if(Math.abs(1-D)<s)T=r[1],d=u;else{if(!(Math.abs(1-w)<s))throw new Error("No support yet for oblique plane planar contours");T=r[2],d=g}n=[p,T]}return{spacing:[n[0]/e,n[1]/e],xDir:a,yDir:d}};var r=n(91055);const l=(t,e,n)=>r.TK(t,e)<n;var h=n(96720);const c=(t,e,n,a)=>{const{xDir:i,yDir:s,spacing:d}=a,l=(0,h.ZP)(t),{viewport:c}=l,u=c.canvasToWorld(e[e.length-1]),g=c.canvasToWorld(n),v=o.create();o.subtract(v,g,u);const f=Math.abs(o.dot(v,i)),C=Math.abs(o.dot(v,s)),m=Math.max(Math.floor(f/d[0]),Math.floor(C/d[0]));if(m>1){const t=e[e.length-1],a=r.TK(t,n),i=r.Ue();r.$X(i,n,t),r.t8(i,i[0]/a,i[1]/a);const o=a/m;for(let n=1;n<=m;n++)e.push([t[0]+o*i[0]*n,t[1]+o*i[1]*n])}else e.push(n);return m},u=(t,e,n,a)=>{const i=[t[0]-e[0],t[1]-e[1]],o=[n[0]-e[0],n[1]-e[1]],s=i[0]*o[0]+i[1]*o[1];if(s<0)return!1;const d=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(0===d)return!1;const l=s/d,h=[o[0]/d,o[1]/d],c=[h[0]*l,h[1]*l],u=[e[0]+c[0],e[1]+c[1]];return!(r.TE(t,u)>a)&&!(r.TE(e,u)>r.TE(e,n))};var g=n(34323)},86119:(t,e,n)=>{n.d(e,{Z:()=>d});var a=n(25183);function i(t,e){for(var n=new Array(e),a=0;a<e;++a)n[a]=t(a/(e-1));return n}function o(t){return t.length}function s(){return function(t){if(!(i=t.length))return[];for(var e=-1,n=function(t,e){let n;if(void 0===e)for(const e of t)null!=e&&(n>e||void 0===n&&e>=e)&&(n=e);else{let a=-1;for(let i of t)null!=(i=e(i,++a,t))&&(n>i||void 0===n&&i>=i)&&(n=i)}return n}(t,o),a=new Array(n);++e<n;)for(var i,s=-1,d=a[e]=new Array(i);++s<i;)d[s]=t[s][e];return a}(arguments)}function d(t,e,n,o){const d=n-e+1,r=Math.floor(o/100*d)??1,l=Math.floor(d/r)??1;if(isNaN(d)||!d||!l)return t;if(d/l<2)return t;const h=Math.max(0,e),c=Math.min(t.length-1,n),u=t.slice(0,h),g=t.slice(c+1,t.length),v=function(t,e){if(!e||0===e.length||e.length===t.length)return t;const n=e[e.length-1]-e[0]+1,o=(0,a.Z)(e.map((e=>t[e][0]))),d=(0,a.Z)(e.map((e=>t[e][1])));if(r=t,3===r[0]?.length){const r=(0,a.Z)(e.map((e=>t[e][2])));return s(i(o,n),i(d,n),i(r,n))}return s(i(o,n),i(d,n));var r}(t,function(t,e){const n=[],[a,i]=e,o=i-a+1,s=Math.floor(o/t);let d=0,r=Math.round((o-1)/(s-1)*d)+a;for(;r<=i;)n.push(r),d++,r=Math.round((o-1)/(s-1)*d)+a;return n}(l,[h,c]));return[...u,...v,...g]}},23123:(t,e,n)=>{n.d(e,{Z:()=>i});var a=n(6807);function i(t,e,n,i){const o=a.create();a.cross(o,e,t);const s=a.fromValues(...n),d=a.fromValues(...i),r=a.create();a.subtract(r,s,d);const l=a.length(r);if(l<1e-4)return{worldWidth:0,worldHeight:0};const h=a.dot(r,o)/(l*a.length(o));return{worldWidth:Math.sqrt(1-h*h)*l,worldHeight:h*l}}},25183:(t,e,n)=>{function a(t,e,n,a,i){var o=t*t,s=o*t;return((1-3*t+3*o-s)*e+(4-6*o+3*s)*n+(1+3*t+3*o-3*s)*a+s*i)/6}function i(t){var e=t.length-1;return function(n){var i=n<=0?n=0:n>=1?(n=1,e-1):Math.floor(n*e),o=t[i],s=t[i+1],d=i>0?t[i-1]:2*o-s,r=i<e-1?t[i+2]:2*s-o;return a((n-i/e)*e,d,o,s,r)}}n.d(e,{Z:()=>i,t:()=>a})}}]);
//# sourceMappingURL=116.bundle.02605522407a760066fb.js.map