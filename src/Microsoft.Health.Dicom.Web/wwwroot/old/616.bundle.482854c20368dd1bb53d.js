(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[616],{72776:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>R,protocols:()=>i.protocols});var i={};n.r(i),n.d(i,{Z:()=>p});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,s=`${a}.sopClassHandlerModule.dicom-seg`;var o=n(32735),r=n(92780),l=n(31492),c=n(22737);const{DicomMessage:u,DicomMetaDictionary:m}=c.default.data,g=["1.2.840.10008.5.1.4.1.1.66.4"];let d={};function S(e,t,n){const i=e[0],{StudyInstanceUID:a,SeriesInstanceUID:o,SOPInstanceUID:S,SeriesDescription:p,SeriesNumber:f,SeriesDate:b,SOPClassUID:y,wadoRoot:I,wadoUri:h,wadoUriRoot:D}=i,v={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:l.default.guid(),SeriesDescription:p,SeriesNumber:f,SeriesDate:b,SOPInstanceUID:S,SeriesInstanceUID:o,StudyInstanceUID:a,SOPClassHandlerId:s,SOPClassUID:y,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:i,instances:[i],wadoRoot:I,wadoUriRoot:D,wadoUri:h,isOverlayDisplaySet:!0},E=i.ReferencedSeriesSequence;if(!E)throw new Error("ReferencedSeriesSequence is missing for the SEG");const P=E[0];return v.referencedImages=i.ReferencedSeriesSequence.ReferencedInstanceSequence,v.referencedSeriesInstanceUID=P.SeriesInstanceUID,v.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(v.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const i=n[0];v.referencedDisplaySetInstanceUID=i.displaySetInstanceUID,v.referencedVolumeURI=i.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${v.referencedVolumeURI}`;return v.referencedVolumeId=a,i},v.load=async e=>{let{headers:i}=e;return await function(e,t,n,i){const{SOPInstanceUID:a}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&d[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,s))return d[a];return e.loading=!0,d[a]=new Promise((async(t,a)=>{if(!e.segments||0===Object.keys(e.segments).length){const t=await async function(e,t,n){const i=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{dicomLoaderService:a}=i.exports,s=await a.findDicomDataPromise(t,null,n),o=u.readFile(s),l=m.naturalizeDataset(o.dict);l._meta=m.namifyDataset(o.meta),Array.isArray(l.SegmentSequence)||(l.SegmentSequence=[l.SegmentSequence]);const g=function(e){const t={};return e.SegmentSequence.forEach((e=>{const n=e.RecommendedDisplayCIELabValue,i=c.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)));i.push(255);const a=e.SegmentNumber;t[a]={color:i,functionalGroups:[],offset:null,size:null,pixelData:null,label:e.SegmentLabel}})),e.PerFrameFunctionalGroupsSequence.forEach((e=>{const n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;t[n].functionalGroups.push(e)})),function(e,t){let n=Math.ceil(e.Rows*e.Columns/8),i=0;return Object.keys(t).forEach((a=>{const s=t[a];s.numberOfFrames=s.functionalGroups.length,s.size=s.numberOfFrames*n,s.offset=i,i=s.offset+s.size;const o=e.PixelData[0].slice(s.offset,i);s.pixelData=c.default.data.BitArray.unpack(o),s.geometry=function(e,t){let n=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,i=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,a=t[0].PlanePositionSequence;const s={};let o=n.SpacingBetweenSlices;o||n.SliceThickness&&(console.log("Using SliceThickness as SpacingBetweenSlices"),o=n.SliceThickness);s.spacing=[n.PixelSpacing[1],n.PixelSpacing[0],o].map(Number),s.dimensions=[e.Columns,e.Rows,t.length].map(Number);let l=i.ImageOrientationPatient.map(Number);const c=l.slice(0,3),u=l.slice(3,6);s.planeNormal=[],r.ZP.cross(c,u,s.planeNormal);let m=t[0].PlanePositionSequence.ImagePositionPatient.map(Number),g=t[t.length-1].PlanePositionSequence.ImagePositionPatient.map(Number);return s.sliceStep=[],r.ZP.subtract(g,m,s.sliceStep),r.ZP.normalize(s.sliceStep),s.direction=c.concat(u).concat(s.sliceStep),s.origin=a.ImagePositionPatient.map(Number),s}(e,s.functionalGroups)})),t}(e,t)}(l);return g}(n,e,i);e.segments=t}const o=!0;s.createSegmentationForSEGDisplaySet(e,null,o).then((()=>{e.loading=!1,t()})).catch((t=>{e.loading=!1,a(t)}))})),d[a]}(v,t,n,i)},[v]}const p=function(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:e=>S(e,t,n)}]};var f=n(60216),b=n.n(f),y=n(63677);const I=function(e,t,n){const i="enter-segment-label",a=t=>{let{action:a,value:s}=t;switch(a.id){case"save":n(s.label,a.id);break;case"cancel":n("",a.id)}e.dismiss({id:i})};e&&e.create({id:i,centralize:!0,isDraggable:!1,showOverlay:!0,content:y.Vq,contentProps:{title:"Enter Segment Label",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:i}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Confirm",type:"secondary"}],onSubmit:a,body:e=>{let{value:t,setValue:n}=e;return o.createElement("div",{className:"p-4 bg-primary-dark"},o.createElement(y.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&a({value:t,action:{id:"save"}})}}))}}})};var h=n(21572);function D(e){let{servicesManager:t,commandsManager:n}=e;const{segmentationService:i,uiDialogService:a}=t.services,{t:s}=(0,h.$G)("PanelSegmentation"),[r,l]=(0,o.useState)(null),[c,u]=(0,o.useState)(i.getConfiguration()),[m,g]=(0,o.useState)((()=>i.getSegmentations())),[d,S]=(0,o.useState)({}),p=(0,o.useCallback)((e=>{S((t=>({...t,[e]:!t[e]})))}),[S]);(0,o.useEffect)((()=>{const e=m[m.length-1]?.id;e&&S((t=>({...t,[e]:!1})))}),[m,S]),(0,o.useEffect)((()=>{const e=i.EVENTS.SEGMENTATION_ADDED,t=i.EVENTS.SEGMENTATION_UPDATED,n=i.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=i.subscribe(e,(()=>{const e=i.getSegmentations();g(e),u(i.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const f=e=>i.getToolGroupIdsWithSegmentation(e),b=(0,o.useCallback)(((e,t,n)=>{i.setConfiguration({segmentationId:e,[t]:n})}),[i]);return o.createElement("div",{className:"flex flex-col flex-auto min-h-0 justify-between mt-1"},m?.length?o.createElement(y.cX,{title:s("Segmentations"),showAddSegmentation:!1,segmentations:m,isMinimized:d,activeSegmentationId:r||"",onSegmentationClick:e=>{i.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{i.remove(e)},onSegmentationEdit:e=>{const t=i.getSegmentation(e),{label:n}=t;I(a,n,((t,n)=>{""!==t&&i.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{i.setActiveSegmentForSegmentation(e,t);f(e).forEach((n=>{i.setActiveSegmentationForToolGroup(e,n),i.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=i.getSegmentation(e).segments[t],{label:s}=n;I(a,s,((n,a)=>{""!==n&&i.setSegmentLabelForSegmentation(e,t,n)}))},onSegmentColorClick:(e,t)=>{},onSegmentDelete:(e,t)=>{console.warn("not implemented yet")},onToggleSegmentVisibility:(e,t)=>{const n=!i.getSegmentation(e).segments[t].isVisible;f(e).forEach((a=>{i.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentationVisibility:e=>{i.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:p,segmentationConfig:{initialConfig:c},setRenderOutline:e=>b(r,"renderOutline",e),setOutlineOpacityActive:e=>b(r,"outlineOpacity",e),setRenderFill:e=>b(r,"renderFill",e),setRenderInactiveSegmentations:e=>b(r,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>b(r,"outlineWidthActive",e),setFillAlpha:e=>b(r,"fillAlpha",e),setFillAlphaInactive:e=>b(r,"fillAlphaInactive",e)}):null)}D.propTypes={commandsManager:b().shape({runCommand:b().func.isRequired}),servicesManager:b().shape({services:b().shape({segmentationService:b().shape({getSegmentation:b().func.isRequired,getSegmentations:b().func.isRequired,toggleSegmentationVisibility:b().func.isRequired,subscribe:b().func.isRequired,EVENTS:b().object.isRequired}).isRequired}).isRequired}).isRequired};const v={id:"@ohif/seg",hasUpdatedPriorsInformation:!1,name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const E=function(){return[{name:v.id,protocol:v}]};function P(){return P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},P.apply(this,arguments)}const w=o.lazy((()=>n.e(676).then(n.bind(n,33569)))),M=e=>o.createElement(o.Suspense,{fallback:o.createElement("div",null,"Loading...")},o.createElement(w,e)),R={id:a,getPanelModule:e=>{let{servicesManager:t,commandsManager:n,extensionManager:i}=e;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>o.createElement(D,{commandsManager:n,servicesManager:t,extensionManager:i})}]},getViewportModule(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",component:e=>o.createElement(M,P({servicesManager:t,extensionManager:n},e))}]},getSopClassHandlerModule:p,getHangingProtocolModule:E}},78753:()=>{}}]);
//# sourceMappingURL=616.bundle.482854c20368dd1bb53d.js.map