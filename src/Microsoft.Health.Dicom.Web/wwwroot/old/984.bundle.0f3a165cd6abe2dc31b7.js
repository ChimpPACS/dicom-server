(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[984],{65948:(e,n,t)=>{"use strict";t.r(n),t.d(n,{createReferencedImageDisplaySet:()=>Ee,default:()=>be,hydrateStructuredReport:()=>Ce.Z,srProtocol:()=>ee});var o=t(32735);const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-sr"}').u2,r="dicom-sr",s=`${a}.sopClassHandlerModule.${r}`;var i=t(16283),c=t(31492),d=t(6807),l=t(7576),u=t(71478),S=t(78288),f=t(28941),g=t(78266),I=t(46879),p=t(55742),m=t(99469),h=t(80084),R=t(68390),C=t(28823),T=t(52857),O=t(82853),D=t(94709);const E={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"};class y extends g.Z{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}}),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:o}=t;let a=l.getAnnotations(this.getToolName(),o);if(!a?.length)return;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return;const r=(0,D.yR)(o),{activeIndex:s,trackingUniqueIdentifiers:i}=r,c=i[s],d=a.filter((e=>i.includes(e.data?.cachedStats?.TrackingUniqueIdentifier)));if(!t._actors?.size)return;const u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<d.length;e++){const o=d[e],a=o.annotationUID,{renderableData:r}=o.data.cachedStats,{cachedStats:s}=o.data,{referencedImageId:i}=o.metadata;u.annotationUID=a;const l=this.getStyle("lineWidth",u,o),S=this.getStyle("lineDash",u,o),f={color:s.TrackingUniqueIdentifier===c?"rgb(0, 255, 0)":this.getStyle("color",u,o),lineDash:S,lineWidth:l};Object.keys(r).forEach((e=>{const s=r[e];let c,d;switch(e){case E.POINT:c=this.renderPoint;break;case E.MULTIPOINT:c=this.renderMultipoint;break;case E.POLYLINE:c=this.renderPolyLine;break;case E.CIRCLE:c=this.renderEllipse;break;case E.ELLIPSE:c=this.renderEllipse,d=I.Z;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const l=c(n,t,s,a,i,f);this.renderTextBox(n,t,l,d,o,u,f)}))}}}_getTextBoxLinesFromLabels(e){const n=Math.min(e.length,3),t=[];for(let o=0;o<n;o++){const n=e[o];t.push(`${U(n.label)}${n.value}`)}return t}renderPolyLine(e,n,t,o,a,r){const s={color:r.color,width:r.lineWidth};let i=[];return t.map(((t,a)=>{const r=t.map((e=>n.worldToCanvas(e))),c=`${a}`;2===r.length?p.Z(e,o,c,r[0],r[1],s):m.Z(e,o,c,r,s),i=i.concat(r)})),i}renderMultipoint(e,n,t,o,a,r){let s;t.map(((t,a)=>{s=t.map((e=>n.worldToCanvas(e)));h.Z(e,o,"0",s,{color:r.color})}))}renderPoint(e,n,t,o,a,r){const s=[];return t.map(((t,i)=>{const c=t[0];s.push(n.worldToCanvas(c));const d=u.get("imagePixelModule",a);let l=10,g=10;if(d){const{columns:e,rows:n}=d;l=e/10,g=n/10}const I=f.Z(a,c),p=S.Z(a,[I[0]+l,I[1]+g]);s.push(n.worldToCanvas(p));const m=`${i}`;R.Z(e,o,m,s[1],s[0],{color:r.color,width:r.lineWidth})})),s}renderEllipse(e,n,t,o,a,r){let s;return t.map(((t,a)=>{if(0===t.length)return;const i=t,c=n.getRotation();let d;s=i.map((e=>n.worldToCanvas(e))),d=90==c||270==c?I.Z([s[2],s[3],s[0],s[1]]):I.Z(s);const l=`${a}`;C.Z(e,o,l,d[0],d[1],{color:r.color,width:r.lineWidth})})),s}renderTextBox(e,n,t,o,a,r){let s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};if(!t||!a)return;const{annotationUID:i,data:c={}}=a,{label:d}=c,{color:l}=s;let u=t;"function"==typeof o&&(u=o(t));const S=this._getTextBoxLinesFromLabels(d),f=T.Z(u);a.data.handles.textBox.worldPosition=n.canvasToWorld(f);const g=n.worldToCanvas(a.data.handles.textBox.worldPosition),I=this.getLinkedTextBoxStyle(r,a),p=O.Z(e,i,"1",S,g,t,{},{...I,color:l}),{x:m,y:h,width:R,height:C}=p;a.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([m,h]),topRight:n.canvasToWorld([m+R,h]),bottomLeft:n.canvasToWorld([m,h+C]),bottomRight:n.canvasToWorld([m+R,h+C])}}}y.toolName="DICOMSRDisplay";const N={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function U(e){const n=N[e];return void 0!==n?n:e}const b={DICOMSRDisplay:y.toolName,SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI"},M=1e-4;function w(e,n,t){const o=b.DICOMSRDisplay,a={TrackingUniqueIdentifier:e.TrackingUniqueIdentifier,renderableData:{},labels:e.labels,imageId:n};e.coords.forEach((t=>{const{GraphicType:o,GraphicData:r}=t;void 0===a.renderableData[o]&&(a.renderableData[o]=[]),a.renderableData[o].push(function(e,n,t,o){const[a,r]=o.split(":");let s;switch(e){case E.POINT:case E.MULTIPOINT:case E.POLYLINE:s=[];for(let e=0;e<n.length;e+=2){const o=S.Z(t,[n[e],n[e+1]]);s.push(o)}break;case E.CIRCLE:{const e=[];for(let o=0;o<n.length;o+=2){const a=S.Z(t,[n[o],n[o+1]]);e.push(a)}const o=e[0],a=e[1],r=d.distance(o,a),i=u.get("imagePlaneModule",t);if(!i)throw new Error("No imagePlaneModule found");const{columnCosines:c,rowCosines:l}=i,f=d.create();d.scaleAndAdd(f,o,c,r);const g=d.create();d.scaleAndAdd(g,o,c,-r);const I=d.create();d.scaleAndAdd(I,o,l,r);const p=d.create();d.scaleAndAdd(p,o,l,-r),s=[f,g,I,p];break}case E.ELLIPSE:{const e=[];for(let o=0;o<n.length;o+=2){const a=S.Z(t,[n[o],n[o+1]]);e.push(a)}const o=d.fromValues(...e[0]),a=d.fromValues(...e[1]),r=d.fromValues(...e[2]),i=d.fromValues(...e[3]),c=d.create();d.sub(c,a,o),d.normalize(c,c);const l=d.create();d.sub(l,i,r),d.normalize(l,l);const f=u.get("imagePlaneModule",t);if(!f)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:g}=f,I=d.fromValues(...g),p=Math.abs(d.dot(I,c)),m=Math.abs(d.dot(I,l)),h=Math.abs(p),R=Math.abs(m);s=[],Math.abs(h-1)<M?s=[e[0],e[1],e[2],e[3]]:Math.abs(R-1)<M?s=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return s}(o,r,n,e.TrackingIdentifier))}));const r=u.get("imagePlaneModule",n),s=l.getAnnotationManager(),i=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence[0]?.ReferencedFrameNumber||1,c={annotationUID:e.TrackingUniqueIdentifier,metadata:{FrameOfReferenceUID:r.frameOfReferenceUID,toolName:o,referencedImageId:n},data:{label:e.labels,handles:{textBox:{}},cachedStats:{TrackingUniqueIdentifier:a.TrackingUniqueIdentifier,renderableData:a.renderableData},frameNumber:i}};s.addAnnotation(c),e.loaded=!0,e.imageId=n,e.displaySetInstanceUID=t,e.ReferencedSOPInstanceUID=e.coords[0].ReferencedSOPSequence.ReferencedSOPInstanceUID,e.frameNumber=i,delete e.coords}var P=t(4606);const v=P.adaptersSR.Cornerstone3D.MeasurementReport.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,q=["cornerstoneTools@^4.0.0"],L=v.CORNERSTONE_3D_TAG;const{CodeScheme:k}=P.adaptersSR.Cornerstone3D,{ImageSet:A,MetadataProvider:V}=i.default,F=["1.2.840.10008.5.1.4.1.1.88.11","1.2.840.10008.5.1.4.1.1.88.22","1.2.840.10008.5.1.4.1.1.88.33","1.2.840.10008.5.1.4.1.1.88.34"],x="Cornerstone3DTools",Z="0.1",B=(e,n)=>{n.forEach((n=>{if(n.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,n),new Error(`Instances ${n.SOPInstanceUID} does not belong to ${e}`)}))},$={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",CornerstoneFreeText:k.codeValues.CORNERSTONEFREETEXT},_={SRT:"SRT",CornerstoneCodeSchemes:[k.CodingSchemeDesignator,"CST4"]},G={INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},j="CORNERSTONEFREETEXT";function H(e,n){return this.instances.push(...e),c.default.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function Y(e,n,t){if(!e||!e.length)throw new Error("No instances were provided");c.default.sortStudyInstances(e);const o=e[e.length-1],{StudyInstanceUID:a,SeriesInstanceUID:r,SOPInstanceUID:i,SeriesDescription:d,SeriesNumber:l,SeriesDate:u,ConceptNameCodeSequence:S,SOPClassUID:f}=o;if(B(o.StudyInstanceUID,e),!S||S.CodeValue!==$.ImagingMeasurementReport)return n.services.uiNotificationService.show({title:"DICOM SR",message:"OHIF only supports TID1500 Imaging Measurement Report Structured Reports. The SR youâ€™re trying to view is not supported.",type:"warning",duration:6e3}),[];const g={Modality:"SR",displaySetInstanceUID:c.default.guid(),SeriesDescription:d,SeriesNumber:l,SeriesDate:u,SOPInstanceUID:i,SeriesInstanceUID:r,StudyInstanceUID:a,SOPClassHandlerId:s,SOPClassUID:f,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,sopClassUids:F,instance:o,addInstances:H};return g.load=()=>function(e,n,t){const{displaySetService:o,measurementService:a}=n.services,r=t.getDataSources(),s=r[0],{ContentSequence:i}=e.instance;e.referencedImages=function(e){const n=J(e.find((e=>e.ConceptNameCodeSequence.CodeValue===$.ImageLibrary)).ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeValue===$.ImageLibraryGroup)),t=[];return J(n.ContentSequence).forEach((e=>{const{ReferencedSOPSequence:n}=e;if(n)for(const e of J(n))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:o}=e;t.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:o})}})),t}(i),e.measurements=function(e){const n=e.find((e=>e.ConceptNameCodeSequence.CodeValue===$.ImagingMeasurements)),t=function(e){const n={};return e.forEach((e=>{const t=J(e.ContentSequence),o=t.find((e=>e.ConceptNameCodeSequence.CodeValue===$.TrackingUniqueIdentifier));o||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const a=o.UID;void 0===n[a]?n[a]=[...t]:t.forEach((e=>{e.ConceptNameCodeSequence.CodeValue!==$.TrackingUniqueIdentifier&&n[a].push(e)}))})),n}(J(n.ContentSequence).filter((e=>e.ConceptNameCodeSequence.CodeValue===$.MeasurementGroup))),o=[];return Object.keys(t).forEach((e=>{const n=function(e){if(e.some((e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)))return function(e){const n=e.find((e=>"SCOORD"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===$.TrackingIdentifier));if(!n)return void console.warn(`graphic ValueType ${n.ValueType} not currently supported, skipping annotation.`);const a=e.filter((e=>"NUM"===e.ValueType)),r={loaded:!1,labels:[],coords:[X(n)],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:o.TextValue};return a.forEach((e=>{const{ConceptNameCodeSequence:n,MeasuredValueSequence:t}=e;t&&r.labels.push(K(n,t))})),r}(e);return function(e){const n=e.filter((e=>"NUM"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===$.TrackingIdentifier)),a=e.find((e=>e.ConceptNameCodeSequence.CodeValue===$.Finding)),r=e.filter((e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===_.SRT&&e.ConceptNameCodeSequence.CodeValue===$.FindingSite)),s={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:o.TextValue};a&&_.CornerstoneCodeSchemes.includes(a.ConceptCodeSequence.CodingSchemeDesignator)&&a.ConceptCodeSequence.CodeValue===$.CornerstoneFreeText&&s.labels.push({label:j,value:a.ConceptCodeSequence.CodeMeaning});if(r.length){const e=r.find((e=>_.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===$.CornerstoneFreeText));e&&s.labels.push({label:j,value:e.ConceptCodeSequence.CodeMeaning})}return n.forEach((e=>{const{ConceptNameCodeSequence:n,ContentSequence:t,MeasuredValueSequence:o}=e,{ValueType:a}=t;if("SCOORD"===!a)return void console.warn(`Graphic ${a} not currently supported, skipping annotation.`);const r=X(t);r&&s.coords.push(r),o&&s.labels.push(K(n,o))})),s}(e)}(t[e]);n&&o.push(n)})),o}(i);const c=a.getSourceMappings(x,Z);e.isHydrated=!1,e.isRehydratable=function(e,n){if(!n||!n.length)return!1;const t=n.map((e=>e.annotationType)),{measurements:o}=e,a=Object.keys(v).filter((e=>"function"==typeof v[e].isValidCornerstoneTrackingIdentifier)),r=[];a.forEach((e=>{t.includes(e)&&r.push(v[e])}));for(let e=0;e<o.length;e++){const{TrackingIdentifier:n}=o[e]||{};if(r.some((e=>{let[t,o]=n.split(":");q.includes(t)&&(t=L);const a=`${t}:${o}`;return e.isValidCornerstoneTrackingIdentifier(a)})))return!0;console.log("Measurement is not rehydratable",n,o[e])}return console.log("No measurements found which were rehydratable"),!1}(e,c),e.isLoaded=!0,o.activeDisplaySets.forEach((n=>{W(e,n,s)})),o.subscribe(o.EVENTS.DISPLAY_SETS_ADDED,(n=>{const{displaySetsAdded:t}=n;t.forEach((n=>{W(e,n,s)}))}))}(g,n,t),[g]}function W(e,n,t){let o=e.measurements.filter((e=>!1===e.loaded));if(0===o.length)return;if(!n instanceof A)return;const{sopClassUids:a,images:r}=n;if(o=o.filter((e=>e.coords.some((e=>a.includes(e.ReferencedSOPSequence.ReferencedSOPClassUID))))),0===o.length)return;const s=[];o.forEach((e=>{const{coords:n}=e;n.forEach((e=>{const n=e.ReferencedSOPSequence.ReferencedSOPInstanceUID;s.includes(n)||s.push(n)}))}));const i=t.getImageIdsForDisplaySet(n);for(const e of i){if(!o.length)return;const{SOPInstanceUID:t,frameNumber:a}=V.getUIDsFromImageID(e);if(s.includes(t))for(let r=o.length-1;r>=0;r--){const s=o[r];z(s,t,a)&&(w(s,e,n.displaySetInstanceUID),o.splice(r,1))}}}function z(e,n,t){const{coords:o}=e,a=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence[0]?.ReferencedFrameNumber||1;if(t&&Number(t)!==Number(a))return!1;for(let e=0;e<o.length;e++){const t=o[e],{ReferencedSOPInstanceUID:a}=t.ReferencedSOPSequence;if(a===n)return!0}}function X(e){const{ValueType:n,RelationshipType:t,GraphicType:o,GraphicData:a}=e;if(t!=G.INFERRED_FROM&&t!=G.CONTAINS)return void console.warn(`Relationshiptype === ${t}. Cannot deal with NON TID-1400 SCOORD group with RelationshipType !== "INFERRED FROM" or "CONTAINS"`);const r={ValueType:n,GraphicType:o,GraphicData:a};if("SCOORD"===n){const{ReferencedSOPSequence:n}=e.ContentSequence;r.ReferencedSOPSequence=n}else if("SCOORD3D"===n){const{ReferencedFrameOfReferenceSequence:n}=e.ContentSequence;r.ReferencedFrameOfReferenceSequence=n}return r}function K(e,n){const{CodeMeaning:t}=e,{NumericValue:o,MeasurementUnitsCodeSequence:a}=n,{CodeValue:r}=a;return{label:t,value:`${o?Number(o).toFixed(2):""} ${r}`}}function J(e){return e?Array.isArray(e)?e:[e]:[]}const Q=function(e){let{servicesManager:n,extensionManager:t}=e;return[{name:r,sopClassUids:F,getDisplaySetsFromSeries:e=>Y(e,n,t)}]},ee={id:"@ohif/sr",hasUpdatedPriorsInformation:!1,name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var ne=t(84334),te=t(16786),oe=t(22737);const{log:ae}=ne.default;const re=function(e,n){const t={};function o(o,a){if(!o.metadata?.referencedImageId)return void ae.warn(`[DICOMSR] No referencedImageId found for ${a} ${o.id}`);const r=o.metadata.referencedImageId;t[r]||(t[r]={});const s=t[r];s[a]||(s[a]={data:[]});const i=e.find((e=>e.uid===o.annotationUID)),c=s[a].data;let{finding:d}=i;const l=[];i.label&&(n.includes(a)?d={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:i.label}:l.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:i.label})),i.findingSites&&l.push(...i.findingSites);const u=Object.assign({},o,{finding:d,findingSites:l});c.push(u)}const a=e.map((e=>e.uid)).slice(),r=l.getAnnotationManager(),s=r.getFramesOfReference();for(let e=0;e<s.length;e++){const n=s[e],i=r.getAnnotations(n),c=Object.keys(i);for(let e=0;e<c.length;e++){const n=c[e],r=i[n];if(r)for(let e=0;e<r.length;e++){const s=r[e],i=a.findIndex((e=>e===s.annotationUID));if(-1!==i&&(o(s,n),a.splice(i,1),!a.length))return t}}}return t},{MeasurementReport:se}=P.adaptersSR.Cornerstone3D,{log:ie}=ne.default,ce=e=>{let{}=e;const n={downloadReport:e=>{let{measurementData:t,additionalFindingTypes:o,options:a={}}=e;const r=n.generateReport(t,o,a),s=oe.default.data.datasetToBlob(r);var i=URL.createObjectURL(s);window.location.assign(i)},storeMeasurements:async e=>{let{measurementData:n,dataSource:t,additionalFindingTypes:o,options:a={}}=e;if(ie.info("[DICOMSR] storeMeasurements"),!t||!t.store||!t.store.dicom)return ie.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const e=function(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=re(e,n),a=se.generateReport(o,u,f.Z,t),{dataset:r}=a;return void 0===r.SpecificCharacterSet&&(r.SpecificCharacterSet="ISO_IR 192"),r}(n,o,a),{StudyInstanceUID:r,ContentSequence:s}=e;if(!s?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",e),new Error("Invalid report, no content");return await t.store.dicom(e),r&&t.deleteStudyMetadataPromise(r),te.default.addInstances([e],!0),e}catch(e){throw console.warn(e),ie.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}}},t={downloadReport:{commandFn:n.downloadReport,storeContexts:[],options:{}},storeMeasurements:{commandFn:n.storeMeasurements,storeContexts:[],options:{}}};return{actions:n,definitions:t,defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};var de=t(45283),le=t(37398),ue=t(67848),Se=t(55338),fe=t(94968),ge=t(32997),Ie=t(51180),pe=t(48925),me=t(44554),he=t(12200);function Re(e,n,t){class o extends n{}o.toolName=e,(0,de.LK)(o)}var Ce=t(68525);const Te=i.default.ImageSet,Oe=(e,n)=>{const{displaySetInstanceUID:t,ReferencedSOPInstanceUID:o}=e,a=n.getDisplaySetByUID(t);if(a.images)return a.images.find((e=>e.SOPInstanceUID===o))},De=(e,n)=>{const t=[],o={};for(const a of n.measurements){const{imageId:n}=a;if(!n)continue;if(o[n])continue;const r=Oe(a,e);r?(o[n]=r,t.push(r)):console.log("Measurement",a,"had no instances found")}return t},Ee=(e,n)=>{const t=De(e,n),o=new Te(t),a=t[0];return o.setAttributes({displaySetInstanceUID:o.uid,SeriesDate:a.SeriesDate,SeriesTime:a.SeriesTime,SeriesInstanceUID:o.uid,StudyInstanceUID:a.StudyInstanceUID,SeriesNumber:a.SeriesNumber||0,SOPClassUID:a.SOPClassUID,SeriesDescription:`${n.SeriesDescription} KO ${n.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:t.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...De(e,n)),this.numImageFrames=this.images.length}}),e.addDisplaySets(o),o};function ye(){return ye=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},ye.apply(this,arguments)}const Ne=o.lazy((()=>t.e(953).then(t.bind(t,27953)))),Ue=e=>o.createElement(o.Suspense,{fallback:o.createElement("div",null,"Loading...")},o.createElement(Ne,e)),be={id:a,onModeEnter:function(e){let{servicesManager:n}=e;const{displaySetService:t}=n.services;[...t.getDisplaySetCache().values()].filter((e=>e.SOPClassHandlerId===s)).forEach((e=>{e.isHydrated=!1}))},preRegistration:function(e){let{configuration:n={}}=e;(0,de.LK)(y),Re(b.SRLength,le.Z),Re(b.SRBidirectional,ue.Z),Re(b.SREllipticalROI,Se.Z),Re(b.SRCircleROI,fe.Z),Re(b.SRArrowAnnotate,ge.Z),Re(b.SRAngle,Ie.Z),Re(b.SRCobbAngle,pe.Z),Re(b.SRPlanarFreehandROI,me.Z);const t={lineDash:"4,4"};he.Z.setToolGroupToolStyles("SRToolGroup",{SRLength:t,SRBidirectional:t,SREllipticalROI:t,SRCircleROI:t,SRArrowAnnotate:t,SRCobbAngle:t,SRAngle:t,SRPlanarFreehandROI:t,global:{}})},getViewportModule(e){let{servicesManager:n,extensionManager:t}=e;return[{name:"dicom-sr",component:e=>o.createElement(Ue,ye({servicesManager:n,extensionManager:t},e))}]},getCommandsModule:ce,getSopClassHandlerModule:Q,getUtilityModule(e){let{servicesManager:n}=e;return[{name:"tools",exports:{toolNames:b}}]}}},94709:(e,n,t)=>{"use strict";t.d(n,{l2:()=>r,yR:()=>s});var o=t(96720);const a={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function r(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const r=(0,o.ZP)(e),{viewport:s}=r;a.trackingIdentifiersByViewportId[s.id]={trackingUniqueIdentifiers:n,activeIndex:t}}function s(e){const n=(0,o.ZP)(e),{viewport:t}=n;return a.trackingIdentifiersByViewportId[t.id]?a.trackingIdentifiersByViewportId[t.id]:{trackingUniqueIdentifiers:[]}}},68525:(e,n,t)=>{"use strict";t.d(n,{Z:()=>p});var o=t(78288),a=t(71478),r=t(84334),s=t(16786);var i=t(4606);const{guid:c}=r.default.utils,{MeasurementReport:d,CORNERSTONE_3D_TAG:l}=i.adaptersSR.Cornerstone3D,u="Cornerstone3DTools",S="0.1",f=["cornerstoneTools@^4.0.0"],g=(e,n)=>{if(!n||"CORNERSTONEJS"===n.CodingSchemeDesignator)return;const t=`${n.CodingSchemeDesignator}:${n.CodeValue}`;return{...e[t],ref:t,...n,text:n.CodeMeaning}},I=(e,n)=>{if(!n||!n.length)return;const t=[];for(let o=0;o<n.length;o++){const a=g(e,n[o][0]||n[o]);a&&t.push(a)}return t.length&&t||void 0};function p(e,n){let{servicesManager:t,extensionManager:r}=e;const i=r.getActiveDataSource()[0],{measurementService:p,displaySetService:R,customizationService:C}=t.services,T=C.getCustomization("codingValues",{}),O=R.getDisplaySetByUID(n),D=p.getSourceMappings(u,S);if(!D||!D.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const E=s.default.getInstance(O.StudyInstanceUID,O.SeriesInstanceUID,O.SOPInstanceUID),y={},N={};O.measurements.forEach((e=>{const{ReferencedSOPInstanceUID:n,imageId:t,frameNumber:o}=e;y[n]||(y[n]=t,N[n]=[]),N[n][o]||(N[n][o]=t)}));const U=function(e){const n="Imaging Measurements",t="Measurement Group",o="Tracking Identifier",a=m(e.ContentSequence).find(h(n)),r=m(a.ContentSequence).filter(h(t)),s={},i=d.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,c=[];return Object.keys(i).forEach((e=>{c.push(i[e]),s[e]=[]})),r.forEach(((e,n)=>{const t=m(e.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeMeaning===o)),a=t.TextValue;let[r,s]=a.split(":");f.includes(r)&&(r=l);const i=`${r}:${s}`;t.TextValue=i})),e}(E),b=d.generateToolState(U,y,o.Z,a),M=D.map((e=>e.annotationType)),w={};Object.keys(b).forEach((e=>{M.includes(e)&&(w[e]=b[e])}));const P=[];let v;Object.keys(w).forEach((e=>{w[e].forEach((e=>{const n=e.annotation.data&&e.annotation.data.frameNumber||1,t=N[e.sopInstanceUid][n]||y[e.sopInstanceUid];P.includes(t)||P.push(t)}))}));const q=[];for(let e=0;e<P.length;e++){const n=P[e],{SeriesInstanceUID:t,StudyInstanceUID:o}=a.get("instance",n);q.includes(t)||q.push(t),v?v!==o&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):v=o}return Object.keys(w).forEach((e=>{w[e].forEach((n=>{const t=n.annotation.data&&n.annotation.data.frameNumber||1,o=N[n.sopInstanceUid][t]||y[n.sopInstanceUid];n.uid=c();const r=a.get("instance",o),{FrameOfReferenceUID:s}=r,d={annotationUID:n.annotation.annotationUID,data:n.annotation.data,metadata:{toolName:e,referencedImageId:o,FrameOfReferenceUID:s}},l=p.getSource(u,S);d.data.label=function(e){const{findingSites:n=[],finding:t}=e;let o=n.find((e=>"CORNERSTONEFREETEXT"===e.CodeValue));return o?o.CodeMeaning:t&&"CORNERSTONEFREETEXT"===t.CodeValue?t.CodeMeaning:void 0}(n),d.data.finding=g(T,n.finding?.[0]),d.data.findingSites=I(T,n.findingSites),d.data.site=d.data.findingSites?.[0];const f=D.find((n=>n.annotationType===e));p.addRawMeasurement(l,e,{annotation:d},f.toMeasurementSchema,i),P.includes(o)||P.push(o)}))})),O.isHydrated=!0,{StudyInstanceUID:v,SeriesInstanceUIDs:q}}const m=function(e){return Array.isArray(e)?e:[e]},h=e=>n=>n.ConceptNameCodeSequence.CodeMeaning===e},78753:()=>{}}]);
//# sourceMappingURL=984.bundle.0f3a165cd6abe2dc31b7.js.map